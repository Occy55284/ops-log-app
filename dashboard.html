<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Ops Log • Weekly Dashboard</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root{
      --bg:#0b1220;
      --card:#0f1a2d;
      --card2:#0c1629;
      --border:rgba(255,255,255,.08);
      --muted:rgba(255,255,255,.70);
      --muted2:rgba(255,255,255,.55);
      --text:#f9fafb;
      --accent:#60a5fa;
      --accent2:#22c55e;
      --warn:#f59e0b;
      --danger:#ef4444;
      --shadow: 0 12px 36px rgba(0,0,0,.35);
      --r:16px;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family: system-ui,-apple-system,BlinkMacSystemFont,"Segoe UI",sans-serif;
      background: radial-gradient(1200px 800px at 10% 0%, rgba(96,165,250,.12), transparent 60%),
                  radial-gradient(900px 600px at 100% 10%, rgba(34,197,94,.10), transparent 55%),
                  var(--bg);
      color:var(--text);
    }
    .wrap{
      max-width: 1240px;
      margin: 0 auto;
      padding: 22px 16px 40px;
    }

    /* Top header / controls (matches monthly styling) */
    .topbar{
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap:12px;
      margin-bottom:14px;
    }
    .titleBlock h1{
      margin:0;
      font-size: 22px;
      letter-spacing:.2px;
    }
    .titleBlock .sub{
      margin-top:6px;
      color:var(--muted);
      font-size:13px;
    }
    .controls{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      justify-content:flex-end;
      align-items:center;
    }
    .control{
      display:flex;
      flex-direction:column;
      gap:6px;
      padding:10px 12px;
      border:1px solid var(--border);
      border-radius: 12px;
      background: rgba(255,255,255,.03);
      min-width: 170px;
    }
    .control label{
      font-size:11px;
      color:var(--muted2);
      letter-spacing:.3px;
      text-transform:uppercase;
    }
    select, input[type="date"]{
      width:100%;
      background: rgba(0,0,0,.25);
      color:var(--text);
      border:1px solid var(--border);
      border-radius:10px;
      padding:8px 10px;
      outline:none;
      font-size:13px;
    }
    button{
      border:1px solid var(--border);
      background: rgba(96,165,250,.12);
      color: var(--text);
      padding: 10px 12px;
      border-radius: 12px;
      cursor:pointer;
      font-weight:600;
      letter-spacing:.2px;
    }
    button:hover{ background: rgba(96,165,250,.18); }

    /* Layout grid (monthly-style grouping) */
    .grid{
      display:grid;
      grid-template-columns: repeat(12, 1fr);
      gap:12px;
      margin-top: 14px;
    }
    .row-2{ grid-column: span 12; display:grid; grid-template-columns: repeat(12, 1fr); gap:12px; }
    .row-3{ grid-column: span 12; display:grid; grid-template-columns: repeat(12, 1fr); gap:12px; }

    .card{
      grid-column: span 12;
      background: linear-gradient(180deg, rgba(255,255,255,.04), rgba(255,255,255,.02));
      border:1px solid var(--border);
      border-radius: var(--r);
      box-shadow: var(--shadow);
      overflow:hidden;
    }
    .cardHeader{
      padding: 14px 14px 10px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      border-bottom: 1px solid rgba(255,255,255,.06);
      background: rgba(0,0,0,.12);
    }
    .cardHeader h2{
      margin:0;
      font-size: 14px;
      letter-spacing:.3px;
      text-transform:uppercase;
      color: rgba(255,255,255,.85);
    }
    .cardHeader .meta{
      font-size: 12px;
      color: var(--muted2);
    }
    .cardBody{ padding: 14px; }

    /* KPI row */
    .kpiRow{
      grid-column: span 12;
      display:grid;
      grid-template-columns: repeat(12, 1fr);
      gap:12px;
    }
    .kpi{
      grid-column: span 3;
      background: rgba(0,0,0,.18);
      border:1px solid var(--border);
      border-radius: var(--r);
      padding: 14px;
      min-height: 78px;
    }
    .kpi .label{
      font-size:11px;
      color: var(--muted2);
      letter-spacing:.3px;
      text-transform:uppercase;
    }
    .kpi .value{
      margin-top:8px;
      font-size: 22px;
      font-weight: 800;
      letter-spacing:.2px;
    }
    .kpi .hint{
      margin-top:6px;
      font-size:12px;
      color: var(--muted);
    }

    /* columns */
    .col3{ grid-column: span 3; }
    .col4{ grid-column: span 4; }
    .col6{ grid-column: span 6; }
    .col8{ grid-column: span 8; }
    .col12{ grid-column: span 12; }

    .pill{
      display:inline-flex;
      align-items:center;
      gap:8px;
      padding: 6px 10px;
      border-radius: 999px;
      border:1px solid var(--border);
      background: rgba(255,255,255,.04);
      color: rgba(255,255,255,.85);
      font-size: 12px;
      font-weight: 650;
    }
    .pill b{ font-weight:900; }

    .row{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      margin-top: 8px;
    }

    /* Tables */
    table{
      width:100%;
      border-collapse: collapse;
      overflow:hidden;
      border-radius: 12px;
      border:1px solid var(--border);
      background: rgba(0,0,0,.18);
    }
    th, td{
      padding: 10px 10px;
      border-bottom: 1px solid rgba(255,255,255,.06);
      font-size: 13px;
      vertical-align: top;
    }
    th{
      text-align:left;
      font-size: 11px;
      color: var(--muted2);
      letter-spacing:.3px;
      text-transform: uppercase;
      background: rgba(255,255,255,.03);
    }
    tr:last-child td{ border-bottom: none; }

    /* Lists */
    .list{
      display:flex;
      flex-direction:column;
      gap:10px;
    }
    .item{
      padding: 10px 12px;
      border:1px solid var(--border);
      border-radius: 12px;
      background: rgba(0,0,0,.18);
    }
    .itemTop{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      margin-bottom:6px;
    }
    .itemTop .t{
      font-weight: 750;
      font-size: 13px;
    }
    .itemTop .d{
      font-size: 12px;
      color: var(--muted2);
      white-space:nowrap;
    }
    .item p{
      margin:0;
      color: var(--muted);
      font-size: 13px;
      line-height: 1.35;
      white-space: pre-wrap;
    }
    .empty{
      color: var(--muted2);
      font-size: 13px;
      padding: 8px 0;
    }

    /* Photos */
    .thumbs{
      display:grid;
      grid-template-columns: repeat(8, 1fr);
      gap:10px;
    }
    .thumb{
      border:1px solid var(--border);
      border-radius: 14px;
      overflow:hidden;
      background: rgba(0,0,0,.25);
      cursor:pointer;
      aspect-ratio: 1 / 1;
      display:flex;
      align-items:center;
      justify-content:center;
    }
    .thumb img{
      width:100%;
      height:100%;
      object-fit:cover;
      display:block;
    }

    /* Modal */
    .modal{
      position:fixed;
      inset:0;
      background: rgba(0,0,0,.72);
      display:none;
      align-items:center;
      justify-content:center;
      padding: 18px;
      z-index: 50;
    }
    .modalInner{
      max-width: 980px;
      width: 100%;
      border:1px solid var(--border);
      border-radius: 18px;
      overflow:hidden;
      background: rgba(10,16,28,.92);
      box-shadow: var(--shadow);
    }
    .modalTop{
      padding: 12px 14px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      border-bottom:1px solid rgba(255,255,255,.08);
    }
    .modalTop .mTitle{
      font-weight: 800;
      font-size: 13px;
      color: rgba(255,255,255,.9);
    }
    .modalTop button{
      background: rgba(255,255,255,.06);
    }
    .modalImg{
      width:100%;
      display:block;
      max-height: 80vh;
      object-fit: contain;
      background: #000;
    }

    /* Inline message blocks (existing) */
    .message {
      margin-top: 10px;
      padding: 10px 12px;
      border: 1px solid var(--border);
      border-radius: 12px;
      background: rgba(239,68,68,.08);
      color: rgba(255,255,255,.88);
      display: none;
      font-size: 13px;
      white-space: pre-wrap;
    }

    /* Responsive */
    @media (max-width: 980px){
      .kpi{ grid-column: span 6; }
      .col3,.col4,.col6,.col8,.col12{ grid-column: span 12; }
      .thumbs{ grid-template-columns: repeat(4, 1fr); }
      .controls{ justify-content:flex-start; }
      .control{ min-width: 160px; }
    }
  </style>
</head>

<body>
  <div class="wrap">
    <div class="topbar">
      <div class="titleBlock">
        <h1>Weekly Dashboard</h1>
        <div class="sub" id="rangeLabel">Week: —</div>
      </div>

      <div class="controls">
        <div class="control">
          <label for="siteFilter">Site</label>
          <select id="siteFilter">
            <option value="All">All</option>
            <option value="London">London</option>
            <option value="Newcastle">Newcastle</option>
          </select>
        </div>

        <div class="control">
          <label for="weekPicker">Week (pick any day)</label>
          <input id="weekPicker" type="date" />
        </div>

        <button id="refreshBtn" type="button">Refresh</button>
      </div>
    </div>

    <div class="message" id="errorMessage"></div>

    <div class="grid">

      <!-- KPI Row -->
      <div class="kpiRow">
        <div class="kpi">
          <div class="label">Total logs</div>
          <div class="value" id="kpiTotalLogs">0</div>
          <div class="hint">Mon–Fri only</div>
        </div>
        <div class="kpi">
          <div class="label">Logs with photos</div>
          <div class="value" id="kpiLogsWithPhotos">0</div>
          <div class="hint">Any photo attached</div>
        </div>
        <div class="kpi">
          <div class="label">Incidents (total)</div>
          <div class="value" id="kpiTotalIncidents">0</div>
          <div class="hint">Maintenance + H&amp;S</div>
        </div>
        <div class="kpi">
          <div class="label">Staffing impacts (total)</div>
          <div class="value" id="kpiTotalStaffing">0</div>
          <div class="hint">Sick + Holiday + Agency</div>
        </div>
      </div>

      <!-- Row of 2 cards -->
      <div class="row-2">
        <div class="card col6">
          <div class="cardHeader">
            <h2>Staffing Summary</h2>
            <div class="meta">Week totals</div>
          </div>
          <div class="cardBody">
            <div class="row">
              <span class="pill">Sick: <b id="staffSickTotal">0</b></span>
              <span class="pill">Holiday: <b id="staffHolidayTotal">0</b></span>
              <span class="pill">Agency: <b id="staffAgencyTotal">0</b></span>
            </div>
            <div class="empty" id="staffingSummaryEmpty" style="display:none;">No staffing impacts recorded.</div>
          </div>
        </div>

        <div class="card col6">
          <div class="cardHeader">
            <h2>Hospitality</h2>
            <div class="meta">Day &amp; Night</div>
          </div>
          <div class="cardBody">
            <div class="row">
              <span class="pill">Day events: <b id="hospDayTotal">0</b></span>
              <span class="pill">Night events: <b id="hospNightTotal">0</b></span>
              <span class="pill">Total events: <b id="hospTotal">0</b></span>
            </div>
            <div class="empty" id="hospitalityEmpty" style="display:none;">No hospitality events recorded.</div>
          </div>
        </div>
      </div>

      <!-- Incidents split (monthly style) -->
      <div class="row-2">
        <div class="card col6">
          <div class="cardHeader">
            <h2>Maintenance Incidents</h2>
            <div class="meta" id="maintenanceMeta">0 items</div>
          </div>
          <div class="cardBody">
            <div class="list" id="maintenanceIncidentsList"></div>
            <div class="empty" id="maintenanceEmpty">No maintenance incidents reported.</div>
          </div>
        </div>

        <div class="card col6">
          <div class="cardHeader">
            <h2>H&amp;S Incidents</h2>
            <div class="meta" id="hsMeta">0 items</div>
          </div>
          <div class="cardBody">
            <div class="list" id="hsIncidentsList"></div>
            <div class="empty" id="hsEmpty">No H&amp;S incidents reported.</div>
          </div>
        </div>
      </div>

      <!-- Retail + Newcastle (monthly style row) -->
      <div class="row-2">
        <div class="card col6">
          <div class="cardHeader">
            <h2>Retail Lunch Specials</h2>
            <div class="meta"><span id="specialDays">0</span> day(s)</div>
          </div>
          <div class="cardBody">
            <div class="list" id="specialsList"></div>
            <div class="empty" id="specialsEmpty">No lunch specials recorded.</div>
          </div>
        </div>

        <div class="card col6">
          <div class="cardHeader">
            <h2>Newcastle Free Breakfast</h2>
            <div class="meta"><span id="freeBreakfastDays">0</span> day(s)</div>
          </div>
          <div class="cardBody">
            <div class="row">
              <span class="pill">Total free breakfasts: <b id="freeBreakfastTotal">0</b></span>
            </div>
            <div class="empty" id="freeBreakfastEmpty" style="display:none;">No free breakfasts recorded.</div>
          </div>
        </div>
      </div>

      <!-- Staffing Detail (kept from your weekly logic) -->
      <div class="card col12">
        <div class="cardHeader">
          <h2>Staffing Detail</h2>
          <div class="meta">By log</div>
        </div>
        <div class="cardBody">
          <div class="empty" id="staffingTableEmpty">No staffing detail for this week.</div>
          <div style="overflow:auto">
            <table id="staffingTable" style="display:none;">
              <thead>
                <tr>
                  <th>Date</th>
                  <th>Site</th>
                  <th>Area</th>
                  <th>Sick</th>
                  <th>Holiday</th>
                  <th>Agency</th>
                  <th>Notes</th>
                </tr>
              </thead>
              <tbody id="staffingTbody"></tbody>
            </table>
          </div>
        </div>
      </div>

      <!-- Notes + Photos (monthly style) -->
      <div class="row-2">
        <div class="card col8">
          <div class="cardHeader">
            <h2>Daily Notes</h2>
            <div class="meta">Mon → Fri</div>
          </div>
          <div class="cardBody">
            <div class="list" id="notesList"></div>
            <div class="empty" id="notesEmpty">No notes recorded for this week.</div>
          </div>
        </div>

        <div class="card col4">
          <div class="cardHeader">
            <h2>Photo Gallery</h2>
            <div class="meta"><span id="photoCount">0</span> photos</div>
          </div>
          <div class="cardBody">
            <div class="thumbs" id="photoThumbs"></div>
            <div class="empty" id="photoEmpty">No photos this week.</div>
          </div>
        </div>
      </div>

      <!-- Weekly Retail Sales (kept from your weekly logic) -->
      <div class="card col12">
        <div class="cardHeader">
          <h2>Weekly Retail Sales</h2>
          <div class="meta">Mon–Fri</div>
        </div>
        <div class="cardBody">
          <div class="empty" id="retailSalesEmpty">No retail sales data for this week.</div>
          <div style="overflow:auto">
            <table id="retailSalesTable" style="display:none;">
              <thead>
                <tr>
                  <th>Date</th>
                  <th>Site</th>
                  <th>Area</th>
                  <th>Sales</th>
                  <th>Transactions</th>
                </tr>
              </thead>
              <tbody id="retailSalesTbody"></tbody>
            </table>
          </div>
        </div>
      </div>

    </div>
  </div>

  <!-- Modal for photo preview -->
  <div class="modal" id="imgModal" aria-hidden="true">
    <div class="modalInner">
      <div class="modalTop">
        <div class="mTitle" id="modalTitle">Photo</div>
        <button type="button" id="closeModalBtn">Close</button>
      </div>
      <img id="modalImg" class="modalImg" alt="Photo preview" />
    </div>
  </div>

  <script type="module">
    import { supabase } from './supabase-config.js';

    // -------------------------
    // State & DOM
    // -------------------------
    const siteFilterEl = document.getElementById('siteFilter');
    const weekPickerEl = document.getElementById('weekPicker');
    const refreshBtn = document.getElementById('refreshBtn');

    const rangeLabelEl = document.getElementById('rangeLabel');
    const errorMessageEl = document.getElementById('errorMessage');

    const kpiTotalLogsEl = document.getElementById('kpiTotalLogs');
    const kpiLogsWithPhotosEl = document.getElementById('kpiLogsWithPhotos');
    const kpiTotalIncidentsEl = document.getElementById('kpiTotalIncidents');
    const kpiTotalStaffingEl = document.getElementById('kpiTotalStaffing');

    const staffSickTotalEl = document.getElementById('staffSickTotal');
    const staffHolidayTotalEl = document.getElementById('staffHolidayTotal');
    const staffAgencyTotalEl = document.getElementById('staffAgencyTotal');
    const staffingSummaryEmptyEl = document.getElementById('staffingSummaryEmpty');

    const hospDayTotalEl = document.getElementById('hospDayTotal');
    const hospNightTotalEl = document.getElementById('hospNightTotal');
    const hospTotalEl = document.getElementById('hospTotal');
    const hospitalityEmptyEl = document.getElementById('hospitalityEmpty');

    const maintenanceMetaEl = document.getElementById('maintenanceMeta');
    const hsMetaEl = document.getElementById('hsMeta');
    const maintenanceIncidentsListEl = document.getElementById('maintenanceIncidentsList');
    const hsIncidentsListEl = document.getElementById('hsIncidentsList');
    const maintenanceEmptyEl = document.getElementById('maintenanceEmpty');
    const hsEmptyEl = document.getElementById('hsEmpty');

    const specialsListEl = document.getElementById('specialsList');
    const specialsEmptyEl = document.getElementById('specialsEmpty');
    const specialDaysEl = document.getElementById('specialDays');

    const freeBreakfastTotalEl = document.getElementById('freeBreakfastTotal');
    const freeBreakfastDaysEl = document.getElementById('freeBreakfastDays');
    const freeBreakfastEmptyEl = document.getElementById('freeBreakfastEmpty');

    const staffingTableEl = document.getElementById('staffingTable');
    const staffingTbodyEl = document.getElementById('staffingTbody');
    const staffingTableEmptyEl = document.getElementById('staffingTableEmpty');

    const notesListEl = document.getElementById('notesList');
    const notesEmptyEl = document.getElementById('notesEmpty');

    const photoThumbsEl = document.getElementById('photoThumbs');
    const photoEmptyEl = document.getElementById('photoEmpty');
    const photoCountEl = document.getElementById('photoCount');

    const retailSalesTableEl = document.getElementById('retailSalesTable');
    const retailSalesTbodyEl = document.getElementById('retailSalesTbody');
    const retailSalesEmptyEl = document.getElementById('retailSalesEmpty');

    // modal
    const imgModalEl = document.getElementById('imgModal');
    const modalImgEl = document.getElementById('modalImg');
    const modalTitleEl = document.getElementById('modalTitle');
    document.getElementById('closeModalBtn').addEventListener('click', closeModal);
    imgModalEl.addEventListener('click', (e) => { if (e.target === imgModalEl) closeModal(); });

    function openModal(url, title) {
      modalImgEl.src = url;
      modalTitleEl.textContent = title || 'Photo';
      imgModalEl.style.display = 'flex';
      imgModalEl.setAttribute('aria-hidden', 'false');
    }
    function closeModal() {
      modalImgEl.src = '';
      imgModalEl.style.display = 'none';
      imgModalEl.setAttribute('aria-hidden', 'true');
    }

    // -------------------------
    // Date helpers (your existing logic)
    // -------------------------
    function pad(n) { return String(n).padStart(2, '0'); }

    function dateKey(d) {
      return `${d.getFullYear()}-${pad(d.getMonth() + 1)}-${pad(d.getDate())}`;
    }

    function startOfWeekMonday(anyDate) {
      const d = new Date(anyDate);
      const day = d.getDay(); // 0 Sun..6 Sat
      const diff = (day === 0 ? -6 : 1 - day);
      d.setDate(d.getDate() + diff);
      d.setHours(0,0,0,0);
      return d;
    }

    function formatDateRange(start, end) {
      const opts = { day: 'numeric', month: 'short', year: 'numeric' };
      return `Week: ${start.toLocaleDateString('en-GB', opts)} – ${end.toLocaleDateString('en-GB', opts)} (Mon–Fri)`;
    }

    function safeNum(v) {
      const n = Number(v);
      return Number.isFinite(n) ? n : 0;
    }

    function safeText(v) {
      if (v === null || v === undefined) return '';
      return String(v).trim();
    }

    function asPhotoArray(v) {
      if (!v) return [];
      if (Array.isArray(v)) return v.filter(Boolean).map(String);
      if (typeof v === 'string') return v.trim() ? [v.trim()] : [];
      return [];
    }

    function makeTitle(row) {
      const site = safeText(row.site);
      const area = safeText(row.area);
      const d = safeText(row.log_date) || (row.created_at ? String(row.created_at).slice(0,10) : '');
      const parts = [site, area].filter(Boolean).join(' – ');
      return `${parts || 'Log'} • ${d}`.trim();
    }

    // -------------------------
    // Site filter (your existing logic)
    // -------------------------
    function applySiteFilter(allRows) {
      const site = siteFilterEl.value;
      if (!site || site === 'All') return allRows;

      const isLondon = s => s && String(s).toLowerCase().includes('london');
      const isNewcastle = s => s && String(s).toLowerCase().includes('newcastle');

      return (allRows || []).filter(r => {
        const rs = (r.site || '').toString().toLowerCase();
        if (site === 'London') return isLondon(rs);
        if (site === 'Newcastle') return isNewcastle(rs);
        return true;
      });
    }

    // -------------------------
    // Empty state
    // -------------------------
    function setEmptyState() {
      kpiTotalLogsEl.textContent = '0';
      kpiLogsWithPhotosEl.textContent = '0';
      kpiTotalIncidentsEl.textContent = '0';
      kpiTotalStaffingEl.textContent = '0';

      staffSickTotalEl.textContent = '0';
      staffHolidayTotalEl.textContent = '0';
      staffAgencyTotalEl.textContent = '0';
      staffingSummaryEmptyEl.style.display = 'block';

      hospDayTotalEl.textContent = '0';
      hospNightTotalEl.textContent = '0';
      hospTotalEl.textContent = '0';
      hospitalityEmptyEl.style.display = 'block';

      maintenanceMetaEl.textContent = '0 items';
      hsMetaEl.textContent = '0 items';
      maintenanceIncidentsListEl.innerHTML = '';
      hsIncidentsListEl.innerHTML = '';
      maintenanceEmptyEl.style.display = 'block';
      hsEmptyEl.style.display = 'block';

      specialsListEl.innerHTML = '';
      specialsEmptyEl.style.display = 'block';
      specialDaysEl.textContent = '0';

      freeBreakfastTotalEl.textContent = '0';
      freeBreakfastDaysEl.textContent = '0';
      freeBreakfastEmptyEl.style.display = 'block';

      staffingTableEl.style.display = 'none';
      staffingTableEmptyEl.style.display = 'block';
      staffingTbodyEl.innerHTML = '';

      notesListEl.innerHTML = '';
      notesEmptyEl.style.display = 'block';

      photoThumbsEl.innerHTML = '';
      photoEmptyEl.style.display = 'block';
      photoCountEl.textContent = '0';

      retailSalesTableEl.style.display = 'none';
      retailSalesEmptyEl.style.display = 'block';
      retailSalesTbodyEl.innerHTML = '';
    }

    // -------------------------
    // Render helpers
    // -------------------------
    function renderList(containerEl, emptyEl, items) {
      containerEl.innerHTML = '';
      if (!items || items.length === 0) {
        emptyEl.style.display = 'block';
        return;
      }
      emptyEl.style.display = 'none';

      for (const it of items) {
        const div = document.createElement('div');
        div.className = 'item';

        const top = document.createElement('div');
        top.className = 'itemTop';

        const t = document.createElement('div');
        t.className = 't';
        t.textContent = it.title || 'Log';

        const d = document.createElement('div');
        d.className = 'd';
        d.textContent = it.date || '';

        top.appendChild(t);
        top.appendChild(d);

        const p = document.createElement('p');
        p.textContent = it.text || '';

        div.appendChild(top);
        div.appendChild(p);

        containerEl.appendChild(div);
      }
    }

    function renderThumbs(photos) {
      photoThumbsEl.innerHTML = '';
      if (!photos || photos.length === 0) {
        photoEmptyEl.style.display = 'block';
        photoCountEl.textContent = '0';
        return;
      }
      photoEmptyEl.style.display = 'none';
      photoCountEl.textContent = String(photos.length);

      for (const ph of photos.slice(0, 32)) {
        const div = document.createElement('div');
        div.className = 'thumb';
        const img = document.createElement('img');
        img.src = ph.url;
        img.alt = ph.title || 'Photo';
        div.appendChild(img);
        div.addEventListener('click', () => openModal(ph.url, ph.title));
        photoThumbsEl.appendChild(div);
      }
    }

    // -------------------------
    // Weekly Retail Sales (existing)
    // -------------------------
    async function loadWeeklyRetailSales(startDateStr, endDateStr) {
      try {
        const { data, error } = await supabase
          .from('ops_logs')
          .select('log_date, created_at, site, area, retail_sales, retail_transactions')
          .or(`and(log_date.gte.${startDateStr},log_date.lte.${endDateStr}),and(log_date.is.null,created_at.gte.${startDateStr}T00:00:00Z,created_at.lte.${endDateStr}T23:59:59Z)`)
          .order('log_date', { ascending: true })
          .order('created_at', { ascending: true });

        if (error) {
          console.error('Error loading weekly retail sales:', error);
          retailSalesEmptyEl.style.display = 'block';
          retailSalesTableEl.style.display = 'none';
          return;
        }

        const rows = applySiteFilter(data || []);
        const filtered = rows.filter(r => {
          const sales = safeNum(r.retail_sales);
          const tx = safeNum(r.retail_transactions);
          return sales > 0 || tx > 0;
        });

        retailSalesTbodyEl.innerHTML = '';

        if (!filtered.length) {
          retailSalesEmptyEl.style.display = 'block';
          retailSalesTableEl.style.display = 'none';
          return;
        }

        retailSalesEmptyEl.style.display = 'none';
        retailSalesTableEl.style.display = 'table';

        for (const r of filtered) {
          const tr = document.createElement('tr');
          const d = safeText(r.log_date) || (r.created_at ? String(r.created_at).slice(0,10) : '');

          tr.innerHTML = `
            <td>${d}</td>
            <td>${safeText(r.site)}</td>
            <td>${safeText(r.area)}</td>
            <td>£${safeNum(r.retail_sales).toFixed(2)}</td>
            <td>${safeNum(r.retail_transactions)}</td>
          `;
          retailSalesTbodyEl.appendChild(tr);
        }
      } catch (e) {
        console.error(e);
        retailSalesEmptyEl.style.display = 'block';
        retailSalesTableEl.style.display = 'none';
      }
    }

    // -------------------------
    // Main weekly load
    // -------------------------
    async function loadWeeklyData() {
      errorMessageEl.style.display = 'none';
      errorMessageEl.textContent = '';

      const picked = weekPickerEl.value ? new Date(weekPickerEl.value + 'T00:00:00') : new Date();
      const startLocal = startOfWeekMonday(picked);
      const endLocal = new Date(startLocal);
      endLocal.setDate(endLocal.getDate() + 4);
      endLocal.setHours(23,59,59,999);

      const startDateStr = dateKey(startLocal);
      const endDateStr = dateKey(endLocal);

      rangeLabelEl.textContent = formatDateRange(startLocal, endLocal);

      // Load retail sales for same Mon–Fri
      loadWeeklyRetailSales(startDateStr, endDateStr);

      // Load ops logs
      const { data, error } = await supabase
        .from('ops_logs')
        .select('*')
        .or(`and(log_date.gte.${startDateStr},log_date.lte.${endDateStr}),and(log_date.is.null,created_at.gte.${startDateStr}T00:00:00Z,created_at.lte.${endDateStr}T23:59:59Z)`)
        .order('log_date', { ascending: false })
        .order('created_at', { ascending: false });

      if (error) {
        console.error('Error loading weekly ops data:', error);
        errorMessageEl.textContent = 'There was an error loading weekly data.';
        errorMessageEl.style.display = 'block';
        setEmptyState();
        return;
      }

      const rows = applySiteFilter(data || []);
      if (!rows.length) {
        setEmptyState();
        return;
      }

      // -------------------------
      // KPIs + rollups
      // -------------------------
      kpiTotalLogsEl.textContent = String(rows.length);

      let logsWithPhotos = 0;
      let photos = [];

      let sickTotal = 0, holidayTotal = 0, agencyTotal = 0;

      let dayEvents = 0, nightEvents = 0;

      const maintenanceItems = [];
      const hsItems = [];

      const specials = [];
      const specialDaysSet = new Set();

      let freeBreakfastTotal = 0;
      const freeBreakfastDaysSet = new Set();

      const notes = [];

      // Staffing detail rows
      const staffingDetail = [];

      for (const r of rows) {
        // photos
        const p = asPhotoArray(r.photo_urls);
        if (p.length) {
          logsWithPhotos++;
          for (const url of p) {
            photos.push({ url, title: makeTitle(r) });
          }
        }

        // staffing
        sickTotal += safeNum(r.sick_count);
        holidayTotal += safeNum(r.holiday_count);
        agencyTotal += safeNum(r.agency_count);

        // hospitality
        dayEvents += safeNum(r.hospitality_day_events);
        nightEvents += safeNum(r.hospitality_night_events);

        // incidents (Maintenance + H&S split)
        const mYes = !!r.maintenance_incident;
        const mNote = safeText(r.maintenance_notes);
        if (mYes || mNote) {
          maintenanceItems.push({
            title: makeTitle(r),
            date: safeText(r.log_date) || (r.created_at ? String(r.created_at).slice(0,10) : ''),
            text: mNote || 'Maintenance incident recorded (no details entered).'
          });
        }

        const hYes = !!r.hs_incident;
        const hNote = safeText(r.hs_notes);
        if (hYes || hNote) {
          hsItems.push({
            title: makeTitle(r),
            date: safeText(r.log_date) || (r.created_at ? String(r.created_at).slice(0,10) : ''),
            text: hNote || 'H&S incident recorded (no details entered).'
          });
        }

        // lunch specials
        const sDesc = safeText(r.retail_lunch_special_details);
        if (sDesc) {
          specials.push({
            title: makeTitle(r),
            date: safeText(r.log_date) || (r.created_at ? String(r.created_at).slice(0,10) : ''),
            text: sDesc
          });
          const dk = safeText(r.log_date) || (r.created_at ? String(r.created_at).slice(0,10) : '');
          if (dk) specialDaysSet.add(dk);
        }

        // free breakfast (Newcastle)
        const fb = safeNum(r.free_breakfast_count);
        if (fb > 0) {
          freeBreakfastTotal += fb;
          const dk = safeText(r.log_date) || (r.created_at ? String(r.created_at).slice(0,10) : '');
          if (dk) freeBreakfastDaysSet.add(dk);
        }

        // notes
        const noteText = safeText(r.notes);
        if (noteText) {
          notes.push({
            title: makeTitle(r),
            date: safeText(r.log_date) || (r.created_at ? String(r.created_at).slice(0,10) : ''),
            text: noteText
          });
        }

        // staffing detail table rows (only show if any staffing values)
        const sSick = safeNum(r.sick_count);
        const sHol = safeNum(r.holiday_count);
        const sAg = safeNum(r.agency_count);
        if (sSick || sHol || sAg) {
          staffingDetail.push({
            date: safeText(r.log_date) || (r.created_at ? String(r.created_at).slice(0,10) : ''),
            site: safeText(r.site),
            area: safeText(r.area),
            sick: sSick,
            holiday: sHol,
            agency: sAg,
            notes: safeText(r.staffing_notes || r.notes || '')
          });
        }
      }

      kpiLogsWithPhotosEl.textContent = String(logsWithPhotos);

      const incidentTotal = maintenanceItems.length + hsItems.length;
      kpiTotalIncidentsEl.textContent = String(incidentTotal);

      const staffingTotal = sickTotal + holidayTotal + agencyTotal;
      kpiTotalStaffingEl.textContent = String(staffingTotal);

      // Staffing summary
      staffSickTotalEl.textContent = String(sickTotal);
      staffHolidayTotalEl.textContent = String(holidayTotal);
      staffAgencyTotalEl.textContent = String(agencyTotal);
      staffingSummaryEmptyEl.style.display = (staffingTotal === 0) ? 'block' : 'none';

      // Hospitality summary
      const hospTotal = dayEvents + nightEvents;
      hospDayTotalEl.textContent = String(dayEvents);
      hospNightTotalEl.textContent = String(nightEvents);
      hospTotalEl.textContent = String(hospTotal);
      hospitalityEmptyEl.style.display = (hospTotal === 0) ? 'block' : 'none';

      // Incidents
      maintenanceMetaEl.textContent = `${maintenanceItems.length} item(s)`;
      hsMetaEl.textContent = `${hsItems.length} item(s)`;
      renderList(maintenanceIncidentsListEl, maintenanceEmptyEl, maintenanceItems);
      renderList(hsIncidentsListEl, hsEmptyEl, hsItems);

      // Specials
      specialDaysEl.textContent = String(specialDaysSet.size);
      renderList(specialsListEl, specialsEmptyEl, specials);

      // Free breakfast
      freeBreakfastTotalEl.textContent = String(freeBreakfastTotal);
      freeBreakfastDaysEl.textContent = String(freeBreakfastDaysSet.size);
      freeBreakfastEmptyEl.style.display = (freeBreakfastTotal === 0) ? 'block' : 'none';

      // Notes
      renderList(notesListEl, notesEmptyEl, notes);

      // Photos
      renderThumbs(photos);

      // Staffing detail table
      staffingTbodyEl.innerHTML = '';
      if (!staffingDetail.length) {
        staffingTableEl.style.display = 'none';
        staffingTableEmptyEl.style.display = 'block';
      } else {
        staffingTableEmptyEl.style.display = 'none';
        staffingTableEl.style.display = 'table';

        for (const s of staffingDetail) {
          const tr = document.createElement('tr');
          tr.innerHTML = `
            <td>${safeText(s.date)}</td>
            <td>${safeText(s.site)}</td>
            <td>${safeText(s.area)}</td>
            <td>${safeNum(s.sick)}</td>
            <td>${safeNum(s.holiday)}</td>
            <td>${safeNum(s.agency)}</td>
            <td>${safeText(s.notes)}</td>
          `;
          staffingTbodyEl.appendChild(tr);
        }
      }
    }

    // -------------------------
    // Init
    // -------------------------
    const today = new Date();
    weekPickerEl.value = dateKey(today);

    refreshBtn.addEventListener('click', loadWeeklyData);
    siteFilterEl.addEventListener('change', loadWeeklyData);
    weekPickerEl.addEventListener('change', loadWeeklyData);

    loadWeeklyData();
  </script>
</body>
</html>
