<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Ops Log • Weekly Dashboard</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    body {
      margin: 0;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: #0b1220;
      color: #f9fafb;
      min-height: 100vh;
    }

    .wrap {
      max-width: 1240px;
      margin: 0 auto;
      padding: 18px 14px 42px;
    }

    .topbar {
      display: flex;
      flex-wrap: wrap;
      align-items: center;
      justify-content: space-between;
      gap: 12px;
      margin-bottom: 14px;
    }

    .brand {
      display: flex;
      gap: 10px;
      align-items: center;
    }

    .logo {
      width: 42px;
      height: 42px;
      border-radius: 12px;
      background: linear-gradient(135deg, #1f2a44, #0f172a);
      box-shadow: 0 0 0 1px rgba(255,255,255,0.06) inset, 0 12px 24px rgba(0,0,0,0.25);
      display: grid;
      place-items: center;
      font-weight: 800;
      letter-spacing: 0.5px;
      color: #93c5fd;
    }

    .titleblock .title {
      font-size: 18px;
      font-weight: 750;
      line-height: 1.2;
    }

    .titleblock .subtitle {
      font-size: 12px;
      color: rgba(255,255,255,0.68);
      margin-top: 2px;
    }

    .filters {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
      align-items: center;
      justify-content: flex-end;
    }

    .filter {
      background: rgba(255,255,255,0.05);
      border: 1px solid rgba(255,255,255,0.08);
      padding: 10px 12px;
      border-radius: 14px;
      display: flex;
      align-items: center;
      gap: 10px;
      min-width: 220px;
      box-shadow: 0 8px 18px rgba(0,0,0,0.20);
    }

    .filter label {
      font-size: 12px;
      color: rgba(255,255,255,0.72);
      white-space: nowrap;
    }

    select, input[type="date"] {
      background: rgba(0,0,0,0.25);
      border: 1px solid rgba(255,255,255,0.12);
      color: #f9fafb;
      padding: 8px 10px;
      border-radius: 10px;
      outline: none;
      width: 100%;
      font-size: 13px;
    }

    .grid {
      display: grid;
      grid-template-columns: 1fr;
      gap: 14px;
      margin-top: 14px;
    }

    .row-1, .row-2, .row-3, .row-4 {
      display: grid;
      gap: 14px;
    }

    .row-1 { grid-template-columns: repeat(4, minmax(0, 1fr)); }
    .row-2 { grid-template-columns: repeat(2, minmax(0, 1fr)); }
    .row-3 { grid-template-columns: repeat(3, minmax(0, 1fr)); }
    .row-4 { grid-template-columns: repeat(2, minmax(0, 1fr)); }

    @media (max-width: 1100px) {
      .row-1 { grid-template-columns: repeat(2, minmax(0, 1fr)); }
      .row-3 { grid-template-columns: repeat(2, minmax(0, 1fr)); }
      .row-4 { grid-template-columns: 1fr; }
    }

    @media (max-width: 640px) {
      .row-1, .row-2, .row-3 { grid-template-columns: 1fr; }
      .filter { min-width: 100%; }
    }

    .card {
      background: rgba(255,255,255,0.04);
      border: 1px solid rgba(255,255,255,0.08);
      border-radius: 18px;
      padding: 14px;
      box-shadow: 0 10px 24px rgba(0,0,0,0.24);
      position: relative;
      overflow: hidden;
    }

    .card::before {
      content: "";
      position: absolute;
      inset: -1px;
      background: radial-gradient(650px 140px at 15% 0%, rgba(59,130,246,0.18), transparent 65%),
                  radial-gradient(550px 160px at 85% 0%, rgba(236,72,153,0.14), transparent 60%);
      pointer-events: none;
    }

    .card > * { position: relative; }

    .card-header {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      gap: 10px;
      margin-bottom: 10px;
    }

    .card-title {
      font-weight: 750;
      font-size: 14px;
      letter-spacing: 0.2px;
    }

    .card-subtitle {
      font-size: 12px;
      color: rgba(255,255,255,0.65);
      margin-top: 3px;
      line-height: 1.25;
    }

    .kpis {
      display: grid;
      grid-template-columns: repeat(3, minmax(0, 1fr));
      gap: 10px;
      margin-top: 6px;
    }

    .kpi {
      background: rgba(0,0,0,0.22);
      border: 1px solid rgba(255,255,255,0.08);
      border-radius: 14px;
      padding: 10px 10px 9px;
    }

    .kpi .label {
      font-size: 11px;
      color: rgba(255,255,255,0.65);
    }

    .kpi .value {
      font-size: 20px;
      font-weight: 800;
      margin-top: 2px;
      letter-spacing: 0.2px;
    }

    .kpi .sub {
      font-size: 11px;
      color: rgba(255,255,255,0.65);
      margin-top: 2px;
    }

    .metric-row {
      display: grid;
      grid-template-columns: repeat(2, minmax(0, 1fr));
      gap: 10px;
    }

    .metric {
      background: rgba(0,0,0,0.22);
      border: 1px solid rgba(255,255,255,0.08);
      border-radius: 14px;
      padding: 10px;
    }

    .metric-label {
      font-size: 11px;
      color: rgba(255,255,255,0.65);
    }

    .metric-value {
      font-size: 18px;
      font-weight: 800;
      margin-top: 2px;
    }

    .metric-sub {
      font-size: 11px;
      color: rgba(255,255,255,0.62);
      margin-top: 2px;
    }

    .list {
      display: grid;
      gap: 8px;
      margin-top: 10px;
    }

    .item {
      background: rgba(0,0,0,0.22);
      border: 1px solid rgba(255,255,255,0.08);
      border-radius: 14px;
      padding: 10px;
    }

    .item-title {
      font-weight: 700;
      font-size: 12px;
      color: rgba(255,255,255,0.92);
    }

    .item-notes {
      font-size: 12px;
      color: rgba(255,255,255,0.75);
      margin-top: 4px;
      white-space: pre-wrap;
      line-height: 1.25;
    }

    .empty-text { padding: 8px 2px; font-size: 12px; color: rgba(255,255,255,0.65); }

    .pill {
      font-size: 11px;
      background: rgba(59,130,246,0.18);
      border: 1px solid rgba(59,130,246,0.35);
      color: rgba(219,234,254,0.92);
      padding: 6px 10px;
      border-radius: 999px;
      white-space: nowrap;
    }

    .error {
      display: none;
      margin-top: 10px;
      background: rgba(239,68,68,0.15);
      border: 1px solid rgba(239,68,68,0.35);
      color: rgba(254,226,226,0.92);
      padding: 10px 12px;
      border-radius: 14px;
      font-size: 12px;
      white-space: pre-wrap;
    }

    .btn {
      background: rgba(59,130,246,0.20);
      border: 1px solid rgba(59,130,246,0.42);
      color: rgba(219,234,254,0.95);
      padding: 10px 12px;
      border-radius: 14px;
      font-weight: 750;
      font-size: 13px;
      cursor: pointer;
      box-shadow: 0 10px 22px rgba(0,0,0,0.22);
      transition: transform .08s ease, filter .08s ease;
    }

    .btn:hover { filter: brightness(1.08); }
    .btn:active { transform: translateY(1px); }

    .photo-grid {
      display: grid;
      grid-template-columns: repeat(4, minmax(0, 1fr));
      gap: 10px;
      margin-top: 10px;
    }

    @media (max-width: 1100px) { .photo-grid { grid-template-columns: repeat(3, minmax(0, 1fr)); } }
    @media (max-width: 640px)  { .photo-grid { grid-template-columns: repeat(2, minmax(0, 1fr)); } }

    .thumb {
      border-radius: 16px;
      overflow: hidden;
      border: 1px solid rgba(255,255,255,0.10);
      background: rgba(0,0,0,0.20);
      box-shadow: 0 10px 18px rgba(0,0,0,0.20);
    }

    .thumb img {
      width: 100%;
      height: 150px;
      object-fit: cover;
      display: block;
    }

    .thumb .cap {
      padding: 8px 10px 10px;
      font-size: 11px;
      color: rgba(255,255,255,0.70);
      line-height: 1.25;
    }

    .modal {
      display: none;
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.65);
      z-index: 50;
      padding: 16px;
    }

    .modal.open { display: grid; place-items: center; }

    .modal-card {
      width: min(980px, 95vw);
      background: rgba(255,255,255,0.05);
      border: 1px solid rgba(255,255,255,0.10);
      border-radius: 18px;
      overflow: hidden;
      box-shadow: 0 20px 60px rgba(0,0,0,0.45);
    }

    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 10px 12px;
      border-bottom: 1px solid rgba(255,255,255,0.10);
      background: rgba(0,0,0,0.20);
    }

    .modal-header .mh-title {
      font-weight: 800;
      font-size: 13px;
      color: rgba(255,255,255,0.92);
    }

    .close {
      border: 1px solid rgba(255,255,255,0.12);
      background: rgba(0,0,0,0.25);
      color: rgba(255,255,255,0.85);
      border-radius: 12px;
      padding: 8px 10px;
      cursor: pointer;
      font-weight: 800;
    }

    .modal-body {
      padding: 12px;
      display: grid;
      gap: 10px;
    }

    .modal-body img {
      width: 100%;
      max-height: 70vh;
      object-fit: contain;
      background: rgba(0,0,0,0.20);
      border-radius: 14px;
      border: 1px solid rgba(255,255,255,0.10);
    }

    .modal-notes {
      font-size: 12px;
      color: rgba(255,255,255,0.75);
      white-space: pre-wrap;
      line-height: 1.25;
    }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="topbar">
      <div class="brand">
        <div class="logo">OL</div>
        <div class="titleblock">
          <div class="title">Weekly Dashboard</div>
          <div class="subtitle">
            Week view (Mon–Fri). Filter by site/area with staffing, incidents, hospitality, Newcastle metrics, retail specials, weekly retail sales, and photo gallery.
          </div>
        </div>
      </div>

      <div class="filters">
        <div class="filter">
          <label for="weekPicker">Week (pick any day)</label>
          <input type="date" id="weekPicker" />
        </div>

        <div class="filter">
          <label for="siteFilter">Site</label>
          <select id="siteFilter">
            <option value="All">All Sites</option>
            <option value="London">London</option>
            <option value="Newcastle">Newcastle</option>
          </select>
        </div>

        <div class="filter">
          <label for="areaFilter">Area</label>
          <select id="areaFilter">
            <option value="All">All Areas</option>
            <option value="Retail">Retail</option>
            <option value="Kitchen">Kitchen</option>
            <option value="Hospitality">Hospitality</option>
            <option value="All Areas">All Areas</option>
          </select>
        </div>

        <button class="btn" id="refreshBtn">Refresh</button>
      </div>
    </div>

    <div id="errorMessage" class="error"></div>

    <div class="grid">
      <div class="row-1">
        <div class="card">
          <div class="card-header">
            <div>
              <div class="card-title">Overview</div>
              <div class="card-subtitle">Totals for the selected week & filter.</div>
            </div>
            <div class="pill" id="weekRangePill">Week</div>
          </div>

          <div class="kpis">
            <div class="kpi">
              <div class="label">Total Logs</div>
              <div class="value" id="kpiTotalLogs">0</div>
              <div class="sub">All entries captured</div>
            </div>
            <div class="kpi">
              <div class="label">Logs with Photos</div>
              <div class="value" id="kpiLogsWithPhotos">0</div>
              <div class="sub">Any photo attached</div>
            </div>
            <div class="kpi">
              <div class="label">Incidents</div>
              <div class="value" id="kpiIncidents">0</div>
              <div class="sub">Maintenance + H&amp;S</div>
            </div>

            <div class="kpi">
              <div class="label">Staffing Impact</div>
              <div class="value" id="kpiStaffing">0</div>
              <div class="sub">Sick + Holiday + Agency</div>
            </div>
            <div class="kpi">
              <div class="label">Lunch Specials</div>
              <div class="value" id="kpiRetailSpecials">0</div>
              <div class="sub" id="kpiRetailSpecialsSub">Days with specials</div>
            </div>
            <div class="kpi">
              <div class="label">Retail Sales</div>
              <div class="value" id="kpiRetailSales">£0.00</div>
              <div class="sub" id="kpiRetailSalesSub">0 tx • SPH £0.00</div>
            </div>
          </div>
        </div>

        <div class="card" id="weeklySummaryBox" style="display:none;">
          <div class="card-header">
            <div>
              <div class="card-title">AI Weekly Summary</div>
              <div class="card-subtitle">Generated from the current week and filter.</div>
            </div>
            <button class="btn" id="genSummaryBtn">Generate Summary Text</button>
          </div>
          <div class="item">
            <div class="item-title">Weekly Ops Summary</div>
            <div id="weeklySummaryText" class="item-notes" style="margin-top:8px;"></div>
          </div>
        </div>
      </div>

      <div class="row-3">
        <div class="card">
          <div class="card-header">
            <div>
              <div class="card-title">Staffing Summary</div>
              <div class="card-subtitle">Totals for the week.</div>
            </div>
          </div>
          <div class="metric-row">
            <div class="metric">
              <div class="metric-label">Sickness</div>
              <div class="metric-value" id="staffSickness">0</div>
            </div>
            <div class="metric">
              <div class="metric-label">Holidays</div>
              <div class="metric-value" id="staffHoliday">0</div>
            </div>
            <div class="metric">
              <div class="metric-label">Agency</div>
              <div class="metric-value" id="staffAgency">0</div>
            </div>
          </div>
        </div>

        <div class="card">
          <div class="card-header">
            <div>
              <div class="card-title">Hospitality</div>
              <div class="card-subtitle">Day vs night events for the week.</div>
            </div>
          </div>
          <div class="metric-row">
            <div class="metric">
              <div class="metric-label">Day Events</div>
              <div class="metric-value" id="hospDay">0</div>
            </div>
            <div class="metric">
              <div class="metric-label">Night Events</div>
              <div class="metric-value" id="hospNight">0</div>
            </div>
            <div class="metric">
              <div class="metric-label">Total</div>
              <div class="metric-value" id="hospTotal">0</div>
            </div>
          </div>
        </div>

        <div class="card">
          <div class="card-header">
            <div>
              <div class="card-title">Retail Sales (Weekly Totals)</div>
              <div class="card-subtitle">Weekly totals by level plus SPH. Includes a grand total.</div>
            </div>
          </div>
          <div class="metric-row" style="grid-template-columns: 1fr;">
            <div class="metric">
              <div class="metric-label">Grand Total (Week)</div>
              <div class="metric-value" id="salesTotal">£0.00</div>
              <div class="metric-sub"><span id="salesTrans">0</span> tx • SPH <span id="salesSPH">£0.00</span></div>
            </div>
          </div>
          <div id="salesEmpty" class="empty-text">No retail sales for this week.</div>
          <div id="salesList" class="list"></div>
        </div>

        <div class="card">
          <div class="card-header">
            <div>
              <div class="card-title">Lunch Specials</div>
              <div class="card-subtitle">All specials recorded for the week.</div>
            </div>
          </div>
          <div id="specialsEmpty" class="empty-text">No lunch specials recorded.</div>
          <div id="specialsList" class="list"></div>
        </div>

        <div class="card">
          <div class="card-header">
            <div>
              <div class="card-title">Newcastle Free Breakfast</div>
              <div class="card-subtitle">Total and number of days (for the selected filter).</div>
            </div>
          </div>
          <div class="metric-row" style="grid-template-columns: 1fr;">
            <div class="metric">
              <div class="metric-label">Total Free Breakfast</div>
              <div class="metric-value" id="freeBreakfastTotal">0</div>
              <div class="metric-sub"><span id="freeBreakfastDays">0</span> day(s)</div>
            </div>
          </div>
        </div>

        <div class="card">
          <div class="card-header">
            <div>
              <div class="card-title">Newcastle Hot Lunches</div>
              <div class="card-subtitle">Weekly total and daily average (for the selected filter).</div>
            </div>
          </div>
          <div class="metric-row">
            <div class="metric">
              <div class="metric-label">Total Hot Lunch Dishes</div>
              <div class="metric-value" id="hotLunchTotal">0</div>
            </div>
            <div class="metric">
              <div class="metric-label">Average per Day</div>
              <div class="metric-value" id="hotLunchAvg">0</div>
              <div class="metric-sub"><span id="hotLunchDays">0</span> day(s)</div>
            </div>
          </div>
        </div>
      </div>

      <div class="row-2">
        <div class="card">
          <div class="card-header">
            <div>
              <div class="card-title">Maintenance Incidents</div>
              <div class="card-subtitle">All maintenance issues for the week.</div>
            </div>
          </div>
          <div id="maintEmpty" class="empty-text">No maintenance incidents.</div>
          <div id="maintList" class="list"></div>
        </div>

        <div class="card">
          <div class="card-header">
            <div>
              <div class="card-title">H&amp;S Incidents</div>
              <div class="card-subtitle">All H&amp;S issues for the week.</div>
            </div>
          </div>
          <div id="hsEmpty" class="empty-text">No H&amp;S incidents.</div>
          <div id="hsList" class="list"></div>
        </div>
      </div>

      <div class="row-4">
        <div class="card">
          <div class="card-header">
            <div>
              <div class="card-title">Daily Notes</div>
              <div class="card-subtitle">All notes captured for the week.</div>
            </div>
          </div>
          <div id="notesEmpty" class="empty-text">No notes recorded.</div>
          <div id="notesList" class="list"></div>
        </div>

        <div class="card">
          <div class="card-header">
            <div>
              <div class="card-title">Photo Gallery</div>
              <div class="card-subtitle">Thumbnails for the week. Click to view.</div>
            </div>
          </div>
          <div id="photosEmpty" class="empty-text">No photos uploaded.</div>
          <div id="photoGrid" class="photo-grid"></div>
        </div>
      </div>
    </div>
  </div>

  <div class="modal" id="photoModal">
    <div class="modal-card">
      <div class="modal-header">
        <div class="mh-title" id="modalTitle">Photo</div>
        <button class="close" id="closeModalBtn">Close</button>
      </div>
      <div class="modal-body">
        <img id="modalImg" alt="Photo" />
        <div id="modalNotes" class="modal-notes"></div>
      </div>
    </div>
  </div>

  <script type="module">
    import { supabase } from './supabase-config.js';

    const weekPickerEl = document.getElementById('weekPicker');
    const siteFilterEl = document.getElementById('siteFilter');
    const areaFilterEl = document.getElementById('areaFilter');
    const refreshBtn = document.getElementById('refreshBtn');
    const errorMessageEl = document.getElementById('errorMessage');
    const weekRangePillEl = document.getElementById('weekRangePill');

    const kpiTotalLogsEl = document.getElementById('kpiTotalLogs');
    const kpiLogsWithPhotosEl = document.getElementById('kpiLogsWithPhotos');
    const kpiIncidentsEl = document.getElementById('kpiIncidents');
    const kpiStaffingEl = document.getElementById('kpiStaffing');
    const kpiRetailSpecialsEl = document.getElementById('kpiRetailSpecials');
    const kpiRetailSpecialsSubEl = document.getElementById('kpiRetailSpecialsSub');
    const kpiRetailSalesEl = document.getElementById('kpiRetailSales');
    const kpiRetailSalesSubEl = document.getElementById('kpiRetailSalesSub');

    const staffSicknessEl = document.getElementById('staffSickness');
    const staffHolidayEl = document.getElementById('staffHoliday');
    const staffAgencyEl = document.getElementById('staffAgency');

    const hospDayEl = document.getElementById('hospDay');
    const hospNightEl = document.getElementById('hospNight');
    const hospTotalEl = document.getElementById('hospTotal');

    const freeBreakfastTotalEl = document.getElementById('freeBreakfastTotal');
    const freeBreakfastDaysEl = document.getElementById('freeBreakfastDays');

    const hotLunchTotalEl = document.getElementById('hotLunchTotal');
    const hotLunchAvgEl = document.getElementById('hotLunchAvg');
    const hotLunchDaysEl = document.getElementById('hotLunchDays');

    const maintEmptyEl = document.getElementById('maintEmpty');
    const maintListEl = document.getElementById('maintList');
    const hsEmptyEl = document.getElementById('hsEmpty');
    const hsListEl = document.getElementById('hsList');

    const specialsEmptyEl = document.getElementById('specialsEmpty');
    const specialsListEl = document.getElementById('specialsList');

    const salesTotalEl = document.getElementById('salesTotal');
    const salesTransEl = document.getElementById('salesTrans');
    const salesSPHEl = document.getElementById('salesSPH');
    const salesEmptyEl = document.getElementById('salesEmpty');
    const salesListEl = document.getElementById('salesList');

    const notesEmptyEl = document.getElementById('notesEmpty');
    const notesListEl = document.getElementById('notesList');

    const photosEmptyEl = document.getElementById('photosEmpty');
    const photoGridEl = document.getElementById('photoGrid');

    const photoModalEl = document.getElementById('photoModal');
    const modalTitleEl = document.getElementById('modalTitle');
    const modalImgEl = document.getElementById('modalImg');
    const modalNotesEl = document.getElementById('modalNotes');
    const closeModalBtn = document.getElementById('closeModalBtn');

    const weeklySummaryBox = document.getElementById('weeklySummaryBox');
    const weeklySummaryText = document.getElementById('weeklySummaryText');
    const genSummaryBtn = document.getElementById('genSummaryBtn');

    function safeNum(v) {
      const n = Number(v);
      return Number.isFinite(n) ? n : 0;
    }

    function safeText(v) {
      return (v ?? '').toString().trim();
    }

    function startOfWeekMonday(d) {
      const date = new Date(d);
      const day = date.getDay(); // 0 Sun - 6 Sat
      const diff = (day === 0 ? -6 : 1) - day;
      date.setDate(date.getDate() + diff);
      date.setHours(0,0,0,0);
      return date;
    }

    function addDays(d, days) {
      const date = new Date(d);
      date.setDate(date.getDate() + days);
      return date;
    }

    function toISODate(d) {
      const yyyy = d.getFullYear();
      const mm = String(d.getMonth() + 1).padStart(2, '0');
      const dd = String(d.getDate()).padStart(2, '0');
      return `${yyyy}-${mm}-${dd}`;
    }

    function money(n) {
      return `£${Number(n || 0).toFixed(2)}`;
    }

    function calcSPH(sales, tx) {
      const s = safeNum(sales);
      const t = safeNum(tx);
      return t > 0 ? s / t : 0;
    }

    function clearAll() {
      errorMessageEl.style.display = 'none';
      errorMessageEl.textContent = '';

      kpiTotalLogsEl.textContent = '0';
      kpiLogsWithPhotosEl.textContent = '0';
      kpiIncidentsEl.textContent = '0';
      kpiStaffingEl.textContent = '0';
      kpiRetailSpecialsEl.textContent = '0';
      kpiRetailSpecialsSubEl.textContent = 'Days with specials';
      kpiRetailSalesEl.textContent = '£0.00';
      kpiRetailSalesSubEl.textContent = '0 tx • SPH £0.00';

      staffSicknessEl.textContent = '0';
      staffHolidayEl.textContent = '0';
      staffAgencyEl.textContent = '0';

      hospDayEl.textContent = '0';
      hospNightEl.textContent = '0';
      hospTotalEl.textContent = '0';

      freeBreakfastTotalEl.textContent = '0';
      freeBreakfastDaysEl.textContent = '0';

      hotLunchTotalEl.textContent = '0';
      hotLunchAvgEl.textContent = '0';
      hotLunchDaysEl.textContent = '0';

      maintListEl.innerHTML = '';
      hsListEl.innerHTML = '';
      specialsListEl.innerHTML = '';
      salesListEl.innerHTML = '';
      notesListEl.innerHTML = '';
      photoGridEl.innerHTML = '';

      maintEmptyEl.style.display = 'block';
      hsEmptyEl.style.display = 'block';
      specialsEmptyEl.style.display = 'block';
      salesEmptyEl.style.display = 'block';
      notesEmptyEl.style.display = 'block';
      photosEmptyEl.style.display = 'block';

      salesTotalEl.textContent = '£0.00';
      salesTransEl.textContent = '0';
      salesSPHEl.textContent = '£0.00';

      if (weeklySummaryBox && weeklySummaryText) {
        weeklySummaryBox.style.display = 'none';
        weeklySummaryText.textContent = '';
      }
    }

    async function loadWeeklyOpsLogs(startDateStr, endDateStr) {
      const { data, error } = await supabase
        .from('ops_logs')
        .select('*')
        .or(`and(log_date.gte.${startDateStr},log_date.lte.${endDateStr}),and(log_date.is.null,created_at.gte.${startDateStr}T00:00:00Z,created_at.lte.${endDateStr}T23:59:59Z)`)
        .order('log_date', { ascending: true })
        .order('created_at', { ascending: true });

      if (error) throw error;
      return data || [];
    }

    async function loadWeeklyRetailSales(startDateStr, endDateStr) {
      const { data, error } = await supabase
        .from('retail_sales')
        .select('*')
        .gte('sales_date', startDateStr)
        .lte('sales_date', endDateStr)
        .order('sales_date', { ascending: true })
        .order('level', { ascending: true });

      if (error) throw error;
      return data || [];
    }

    function matchesFilter(row, site, area) {
      const rowSite = (row.site || '').toString();
      const rowArea = (row.area || '').toString();

      const siteOk = site === 'All' ? true : rowSite === site;
      const areaOk =
        area === 'All' ? true :
        area === 'All Areas' ? true :
        rowArea === area;

      return siteOk && areaOk;
    }

    function buildIncidentItems(rows, type) {
      const items = [];
      for (const r of rows) {
        const when = r.log_date || (r.created_at ? String(r.created_at).slice(0,10) : '');
        const title = `${r.site || 'Site'} – ${r.area || 'Area'} – ${when}`;
        const notes = type === 'maint'
          ? safeText(r.maintenance_notes)
          : safeText(r.hs_notes);

        const extra = type === 'maint'
          ? safeText(r.maintenance_reported)
          : safeText(r.hs_reported);

        const combined = [
          notes ? notes : null,
          extra ? `Reported: ${extra}` : null
        ].filter(Boolean).join('\n');

        items.push({ title, notes: combined || '(No notes entered)' });
      }
      return items;
    }

    function renderList(containerEl, emptyEl, items) {
      containerEl.innerHTML = '';
      if (!items || items.length === 0) {
        emptyEl.style.display = 'block';
        return;
      }
      emptyEl.style.display = 'none';

      for (const it of items) {
        const div = document.createElement('div');
        div.className = 'item';
        div.innerHTML = `
          <div class="item-title">${it.title}</div>
          <div class="item-notes">${(it.notes || '').replace(/</g, '&lt;')}</div>
        `;
        containerEl.appendChild(div);
      }
    }

    function renderSalesList(rows) {
      salesListEl.innerHTML = '';

      if (!rows || rows.length === 0) {
        salesEmptyEl.style.display = 'block';
        return;
      }
      salesEmptyEl.style.display = 'none';

      // Aggregate weekly totals by level
      const byLevel = new Map();
      for (const r of rows) {
        const lvl = (r.level || '').toString();
        const prev = byLevel.get(lvl) || { sales: 0, tx: 0 };
        prev.sales += safeNum(r.sales);
        prev.tx += safeNum(r.transactions);
        byLevel.set(lvl, prev);
      }

      const entries = Array.from(byLevel.entries()).sort((a,b) => a[0].localeCompare(b[0]));

      let grandSales = 0;
      let grandTx = 0;

      for (const [lvl, agg] of entries) {
        grandSales += agg.sales;
        grandTx += agg.tx;

        const sph = calcSPH(agg.sales, agg.tx);

        const div = document.createElement('div');
        div.className = 'item';
        div.innerHTML = `
          <div class="item-title">${lvl}</div>
          <div class="item-notes">Weekly sales: ${money(agg.sales)} • Transactions: ${Math.round(agg.tx)} • SPH: ${money(sph)}</div>
        `;
        salesListEl.appendChild(div);
      }

      const grandSPH = calcSPH(grandSales, grandTx);
      salesTotalEl.textContent = money(grandSales);
      salesTransEl.textContent = String(Math.round(grandTx));
      salesSPHEl.textContent = money(grandSPH);

      kpiRetailSalesEl.textContent = money(grandSales);
      kpiRetailSalesSubEl.textContent = `${Math.round(grandTx)} tx • SPH ${money(grandSPH)}`;
    }

    async function loadWeekly() {
      clearAll();

      const picked = weekPickerEl.value ? new Date(weekPickerEl.value + 'T00:00:00') : new Date();
      const start = startOfWeekMonday(picked);
      const end = addDays(start, 4); // Mon–Fri

      const startStr = toISODate(start);
      const endStr = toISODate(end);

      weekRangePillEl.textContent = `${startStr} → ${endStr}`;

      try {
        const [opsRowsRaw, salesRowsRaw] = await Promise.all([
          loadWeeklyOpsLogs(startStr, endStr),
          loadWeeklyRetailSales(startStr, endStr)
        ]);

        const site = siteFilterEl.value;
        const area = areaFilterEl.value;

        const opsRows = opsRowsRaw.filter(r => matchesFilter(r, site, area));

        // KPIs
        kpiTotalLogsEl.textContent = String(opsRows.length);

        const withPhotos = opsRows.filter(r => !!safeText(r.photo_url));
        kpiLogsWithPhotosEl.textContent = String(withPhotos.length);

        const incidents = opsRows.filter(r =>
          (r.maintenance_issue === 'Yes') || (r.hs_issue === 'Yes')
        );
        kpiIncidentsEl.textContent = String(incidents.length);

        const sick = opsRows.reduce((s,r) => s + safeNum(r.staff_sickness), 0);
        const hol  = opsRows.reduce((s,r) => s + safeNum(r.staff_holiday), 0);
        const agy  = opsRows.reduce((s,r) => s + safeNum(r.staff_agency), 0);
        const staffTotal = sick + hol + agy;

        kpiStaffingEl.textContent = String(Math.round(staffTotal));

        staffSicknessEl.textContent = String(Math.round(sick));
        staffHolidayEl.textContent = String(Math.round(hol));
        staffAgencyEl.textContent = String(Math.round(agy));

        const dayE = opsRows.reduce((s,r) => s + safeNum(r.hosp_day_events), 0);
        const nightE = opsRows.reduce((s,r) => s + safeNum(r.hosp_night_events), 0);
        hospDayEl.textContent = String(Math.round(dayE));
        hospNightEl.textContent = String(Math.round(nightE));
        hospTotalEl.textContent = String(Math.round(dayE + nightE));

        // Incidents lists
        const maintRows = opsRows.filter(r => r.maintenance_issue === 'Yes');
        const hsRows = opsRows.filter(r => r.hs_issue === 'Yes');

        renderList(maintListEl, maintEmptyEl, buildIncidentItems(maintRows, 'maint'));
        renderList(hsListEl, hsEmptyEl, buildIncidentItems(hsRows, 'hs'));

        // Lunch specials
        const specials = opsRows
          .filter(r => (r.retail_lunch_special === 'Yes'))
          .map(r => {
            const when = r.log_date || (r.created_at ? String(r.created_at).slice(0,10) : '');
            const desc = safeText(r.retail_lunch_desc) || '(Special recorded – no details entered)';
            const title = `${r.site || 'Site'} • ${r.area || 'Area'} • ${when}`;
            return { title, notes: desc };
          });

        renderList(specialsListEl, specialsEmptyEl, specials);

        const specialDays = new Set(specials.map(s => s.title.split(' • ').pop()));
        kpiRetailSpecialsEl.textContent = String(specialDays.size);
        kpiRetailSpecialsSubEl.textContent = `${specialDays.size} day(s) with specials`;

        // Newcastle free breakfast
        const fbRows = opsRows.filter(r => safeNum(r.free_breakfast_count) > 0);
        const fbTotal = fbRows.reduce((s,r) => s + safeNum(r.free_breakfast_count), 0);
        const fbDays = new Set(fbRows.map(r => r.log_date || (r.created_at ? String(r.created_at).slice(0,10) : '')));
        freeBreakfastTotalEl.textContent = String(fbTotal);
        freeBreakfastDaysEl.textContent = String(fbDays.size);

        // ✅ NEW: Newcastle hot lunches (total + average)
        const hlRows = opsRows.filter(r => safeNum(r.hot_lunch_dishes) >= 0 && (r.site || '') === 'Newcastle');
        const hlTotal = hlRows.reduce((s,r) => s + safeNum(r.hot_lunch_dishes), 0);
        const hlDays = new Set(hlRows.map(r => r.log_date || (r.created_at ? String(r.created_at).slice(0,10) : '')));
        const hlAvg = hlDays.size ? (hlTotal / hlDays.size) : 0;

        hotLunchTotalEl.textContent = String(Math.round(hlTotal));
        hotLunchAvgEl.textContent = String(hlDays.size ? Math.round(hlAvg) : 0);
        hotLunchDaysEl.textContent = String(hlDays.size);

        // Notes list
        const notes = opsRows
          .filter(r => safeText(r.notes))
          .map(r => ({
            title: `${r.site || 'Site'} • ${r.area || 'Area'} • ${r.log_date || (r.created_at ? String(r.created_at).slice(0,10) : '')}`,
            notes: safeText(r.notes)
          }));

        renderList(notesListEl, notesEmptyEl, notes);

        // Sales list (not filtered by site/area because retail_sales doesn’t carry area)
        // If site filter is Newcastle, keep only Newcastle levels if you have them; otherwise show all levels.
        // Current table is by 'level', so we show all for the week as per your previous request.
        renderSalesList(salesRowsRaw || []);

        // Photos
        photoGridEl.innerHTML = '';
        if (!withPhotos || withPhotos.length === 0) {
          photosEmptyEl.style.display = 'block';
        } else {
          photosEmptyEl.style.display = 'none';
          for (const r of withPhotos) {
            const when = r.log_date || (r.created_at ? String(r.created_at).slice(0,10) : '');
            const cap = `${r.site || ''} • ${r.area || ''} • ${when}`;
            const notes = safeText(r.notes);

            const div = document.createElement('div');
            div.className = 'thumb';
            div.innerHTML = `
              <img src="${r.photo_url}" alt="Photo" />
              <div class="cap">${cap}</div>
            `;
            div.addEventListener('click', () => {
              modalTitleEl.textContent = cap || 'Photo';
              modalImgEl.src = r.photo_url;
              modalNotesEl.textContent = notes || '';
              photoModalEl.classList.add('open');
            });
            photoGridEl.appendChild(div);
          }
        }

        // Enable summary box once data loaded
        if (weeklySummaryBox && weeklySummaryText && genSummaryBtn) {
          weeklySummaryBox.style.display = 'block';
        }

      } catch (err) {
        errorMessageEl.style.display = 'block';
        errorMessageEl.textContent = `Error loading weekly dashboard:\n${err?.message || err}`;
      }
    }

    function buildSummaryText() {
      const lines = [];
      lines.push(`Weekly Ops Summary`);
      lines.push(`---------------------`);
      lines.push(`Week: ${weekRangePillEl.textContent}`);
      lines.push(`Filter: ${siteFilterEl.value}${areaFilterEl.value === 'All' || areaFilterEl.value === 'All Areas' ? '' : ' • ' + areaFilterEl.value}`);
      lines.push('');
      lines.push(`Total Logs: ${kpiTotalLogsEl.textContent}`);
      lines.push(`Logs with photos: ${kpiLogsWithPhotosEl.textContent}`);
      lines.push('');
      lines.push(`Staffing Impact`);
      lines.push(`---------------------`);
      lines.push(`• Sick: ${staffSicknessEl.textContent}`);
      lines.push(`• Holiday: ${staffHolidayEl.textContent}`);
      lines.push(`• Agency: ${staffAgencyEl.textContent}`);
      lines.push('');
      lines.push(`Incidents / H&S`);
      lines.push(`---------------------`);

      if (maintListEl.children.length === 0 && hsListEl.children.length === 0) {
        lines.push(`No incidents reported.`);
      } else {
        if (maintListEl.children.length > 0) {
          lines.push(`Maintenance:`);
          for (const el of maintListEl.children) {
            const title = el.querySelector('.item-title')?.textContent || '';
            const notes = el.querySelector('.item-notes')?.textContent || '';
            lines.push(`• ${title}`);
            if (notes) lines.push(`  ${notes.replace(/\n/g, '\n  ')}`);
          }
          lines.push('');
        }
        if (hsListEl.children.length > 0) {
          lines.push(`H&S:`);
          for (const el of hsListEl.children) {
            const title = el.querySelector('.item-title')?.textContent || '';
            const notes = el.querySelector('.item-notes')?.textContent || '';
            lines.push(`• ${title}`);
            if (notes) lines.push(`  ${notes.replace(/\n/g, '\n  ')}`);
          }
          lines.push('');
        }
      }

      lines.push(`Additional Activity`);
      lines.push(`• Lunch specials ran on ${kpiRetailSpecialsEl.textContent} day(s)`);
      lines.push(`• Newcastle free breakfasts: ${freeBreakfastTotalEl.textContent} over ${freeBreakfastDaysEl.textContent} day(s)`);
      lines.push(`• Newcastle hot lunches: ${hotLunchTotalEl.textContent} total (avg ${hotLunchAvgEl.textContent}/day over ${hotLunchDaysEl.textContent} day(s))`);
      lines.push('');

      if (notesListEl.children.length > 0) {
        lines.push(`Daily Notes`);
        lines.push(`---------------------`);
        for (const el of notesListEl.children) {
          const title = el.querySelector('.item-title')?.textContent || '';
          const notes = el.querySelector('.item-notes')?.textContent || '';
          lines.push(`• ${title}`);
          if (notes) lines.push(`  ${notes.replace(/\n/g, '\n  ')}`);
          lines.push('');
        }
      }

      return lines.join('\n');
    }

    refreshBtn.addEventListener('click', loadWeekly);
    weekPickerEl.addEventListener('change', loadWeekly);
    siteFilterEl.addEventListener('change', loadWeekly);
    areaFilterEl.addEventListener('change', loadWeekly);

    closeModalBtn.addEventListener('click', () => photoModalEl.classList.remove('open'));
    photoModalEl.addEventListener('click', (e) => {
      if (e.target === photoModalEl) photoModalEl.classList.remove('open');
    });

    if (genSummaryBtn) {
      genSummaryBtn.addEventListener('click', () => {
        if (!weeklySummaryText) return;
        weeklySummaryText.textContent = buildSummaryText();
      });
    }

    // Set default weekPicker to today if empty
    if (!weekPickerEl.value) {
      weekPickerEl.value = toISODate(new Date());
    }

    loadWeekly();
  </script>
</body>
</html>
