<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Ops Log • Weekly Dashboard</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    body {
      margin: 0;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: #0b1220;
      color: #f9fafb;
      display: flex;
      align-items: center;
      justify-content: center;
      min-height: 100vh;
    }

    .page { max-width: 1200px; width: 100%; padding: 30px 16px 60px; }

    .header {
      display: flex;
      gap: 16px;
      justify-content: space-between;
      align-items: flex-start;
      margin-bottom: 18px;
      flex-wrap: wrap;
    }

    .title-wrap h1 { margin: 0; font-size: 22px; letter-spacing: .2px; }
    .subtitle { margin-top: 6px; color: rgba(255,255,255,0.7); font-size: 13px; max-width: 780px; line-height: 1.35; }

    .controls {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      align-items: center;
      justify-content: flex-end;
    }

    .pill {
      border: 1px solid rgba(255,255,255,0.08);
      background: rgba(255,255,255,0.03);
      border-radius: 14px;
      padding: 10px 12px;
      display: flex;
      flex-direction: column;
      gap: 6px;
      min-width: 160px;
    }
    .pill-label {
      font-size: 11px;
      text-transform: uppercase;
      letter-spacing: .35px;
      color: rgba(255,255,255,0.55);
    }
    .pill-value {
      font-size: 13px;
      font-weight: 700;
      color: rgba(255,255,255,0.9);
    }

    .select, .input {
      width: 100%;
      padding: 8px 10px;
      border-radius: 10px;
      border: 1px solid rgba(255,255,255,0.08);
      background: rgba(0,0,0,0.25);
      color: #f9fafb;
      outline: none;
      font-size: 13px;
    }

    .btn {
      border: 1px solid rgba(255,255,255,0.08);
      background: rgba(96,165,250,0.12);
      color: #f9fafb;
      padding: 11px 14px;
      border-radius: 14px;
      cursor: pointer;
      font-weight: 700;
      letter-spacing: .2px;
    }
    .btn:hover { background: rgba(96,165,250,0.18); }

    .error-banner {
      display: none;
      margin: 12px 0 18px;
      padding: 10px 12px;
      border-radius: 14px;
      border: 1px solid rgba(239,68,68,0.35);
      background: rgba(239,68,68,0.10);
      color: rgba(255,255,255,0.92);
      white-space: pre-wrap;
      font-size: 13px;
    }

    .grid { display: grid; grid-template-columns: 1fr; gap: 12px; }

    .row-2 { display: grid; grid-template-columns: repeat(2, 1fr); gap: 12px; }
    .row-3 { display: grid; grid-template-columns: repeat(3, 1fr); gap: 12px; }

    .card {
      border: 1px solid rgba(255,255,255,0.08);
      background: rgba(17, 24, 39, 0.65);
      border-radius: 18px;
      overflow: hidden;
    }
    .card-header {
      padding: 14px 14px 10px;
      display: flex;
      justify-content: space-between;
      gap: 10px;
      border-bottom: 1px solid rgba(255,255,255,0.06);
      background: rgba(0,0,0,0.12);
    }
    .card-title { font-size: 13px; letter-spacing: .35px; text-transform: uppercase; font-weight: 800; color: rgba(255,255,255,0.9); }
    .card-subtitle { margin-top: 6px; font-size: 12px; color: rgba(255,255,255,0.65); line-height: 1.35; }

    .metric-row {
      display: grid;
      grid-template-columns: repeat(6, 1fr);
      gap: 10px;
      padding: 14px;
    }
    .metric {
      border: 1px solid rgba(255,255,255,0.08);
      background: rgba(0,0,0,0.18);
      border-radius: 16px;
      padding: 12px 12px 10px;
      min-height: 78px;
    }
    .metric-label {
      font-size: 11px;
      text-transform: uppercase;
      letter-spacing: .35px;
      color: rgba(255,255,255,0.55);
    }
    .metric-value {
      margin-top: 7px;
      font-size: 20px;
      font-weight: 900;
      letter-spacing: .2px;
    }
    .metric-sub {
      margin-top: 6px;
      font-size: 12px;
      color: rgba(255,255,255,0.7);
    }

    .empty-text { padding: 14px; color: rgba(255,255,255,0.6); font-size: 13px; }

    .list { padding: 14px; display: flex; flex-direction: column; gap: 10px; }
    .list-item {
      border: 1px solid rgba(255,255,255,0.08);
      background: rgba(0,0,0,0.18);
      border-radius: 16px;
      padding: 12px 12px 10px;
    }
    .list-title { font-weight: 850; font-size: 13px; color: rgba(255,255,255,0.9); }
    .list-sub { margin-top: 6px; font-size: 12px; color: rgba(255,255,255,0.65); }
    .list-notes { margin-top: 8px; font-size: 13px; color: rgba(255,255,255,0.75); white-space: pre-wrap; line-height: 1.35; }

    .photos-grid {
      padding: 14px;
      display: grid;
      grid-template-columns: repeat(6, 1fr);
      gap: 10px;
    }
    .photo-card {
      border: 1px solid rgba(255,255,255,0.08);
      background: rgba(0,0,0,0.18);
      border-radius: 16px;
      overflow: hidden;
    }
    .photo-card img {
      width: 100%;
      height: 140px;
      object-fit: cover;
      display: block;
    }
    .photo-card-caption {
      padding: 10px 10px 9px;
      font-size: 12px;
      color: rgba(255,255,255,0.7);
      line-height: 1.25;
    }

    @media (max-width: 1040px) {
      .metric-row { grid-template-columns: repeat(3, 1fr); }
      .photos-grid { grid-template-columns: repeat(4, 1fr); }
      .row-3 { grid-template-columns: 1fr; }
      .row-2 { grid-template-columns: 1fr; }
    }
    @media (max-width: 640px) {
      .metric-row { grid-template-columns: repeat(2, 1fr); }
      .photos-grid { grid-template-columns: repeat(2, 1fr); }
      .pill { min-width: 140px; }
    }
  </style>
</head>

<body>
  <div class="page">
    <div class="header">
      <div class="title-wrap">
        <h1>Weekly Ops Dashboard</h1>
        <div class="subtitle">
          Week view (Mon–Fri). Filter by site/area with staffing, incidents, hospitality, Newcastle metrics, retail specials, weekly retail sales, and photo gallery.
        </div>
      </div>

      <div class="controls">
        <div class="pill">
          <div class="pill-label">Week</div>
          <div class="pill-value" id="weekLabel">–</div>
        </div>

        <div class="pill">
          <div class="pill-label">Site</div>
          <select id="siteFilter" class="select">
            <option value="All">All</option>
            <option value="London">London</option>
            <option value="Newcastle">Newcastle</option>
          </select>
        </div>

        <div class="pill">
          <div class="pill-label">Area</div>
          <select id="areaFilter" class="select">
            <option value="All">All</option>
            <option value="Retail">Retail</option>
            <option value="Hospitality">Hospitality</option>
            <option value="Kitchen">Kitchen</option>
            <option value="All Areas">All Areas</option>
          </select>
        </div>

        <div class="pill">
          <div class="pill-label">Pick a day</div>
          <input id="weekPicker" type="date" class="input" />
        </div>

        <button id="refreshBtn" class="btn">Refresh</button>
      </div>
    </div>

    <div id="errorMessage" class="error-banner"></div>

    <div class="grid">
      <div class="card">
        <div class="card-header">
          <div>
            <div class="card-title">Weekly Summary</div>
            <div class="card-subtitle">High-level totals for the selected week and filter.</div>
          </div>
        </div>

        <div class="metric-row">
          <div class="metric">
            <div class="metric-label">Total Logs</div>
            <div class="metric-value" id="kpiTotalLogs">0</div>
            <div class="metric-sub">Logs captured Mon–Fri</div>
          </div>

          <div class="metric">
            <div class="metric-label">Logs with Photos</div>
            <div class="metric-value" id="kpiLogsWithPhotos">0</div>
            <div class="metric-sub">Any photo attached</div>
          </div>

          <div class="metric">
            <div class="metric-label">Incidents</div>
            <div class="metric-value" id="kpiIncidents">0</div>
            <div class="metric-sub">Maintenance + H&amp;S</div>
          </div>

          <div class="metric">
            <div class="metric-label">Staffing Impacts</div>
            <div class="metric-value" id="kpiStaffing">0</div>
            <div class="metric-sub">Sickness + Holiday + Agency</div>
          </div>

          <div class="metric">
            <div class="metric-label">Retail Lunch Specials</div>
            <div class="metric-value" id="kpiRetailSpecials">0</div>
            <div class="metric-sub" id="kpiRetailSpecialsSub">Days with specials</div>
          </div>

          <div class="metric">
            <div class="metric-label">Retail Sales (Week)</div>
            <div class="metric-value" id="kpiRetailSales">£0.00</div>
            <div class="metric-sub" id="kpiRetailSalesSub">Transactions • SPH</div>
          </div>
        </div>
      </div>

      <div class="row-3">
        <div class="card">
          <div class="card-header">
            <div>
              <div class="card-title">Staffing Summary</div>
              <div class="card-subtitle">Totals for the week.</div>
            </div>
          </div>
          <div class="metric-row" style="grid-template-columns: repeat(3, 1fr);">
            <div class="metric">
              <div class="metric-label">Sickness</div>
              <div class="metric-value" id="staffSickness">0</div>
            </div>
            <div class="metric">
              <div class="metric-label">Holiday</div>
              <div class="metric-value" id="staffHoliday">0</div>
            </div>
            <div class="metric">
              <div class="metric-label">Agency</div>
              <div class="metric-value" id="staffAgency">0</div>
            </div>
          </div>
        </div>

        <div class="card">
          <div class="card-header">
            <div>
              <div class="card-title">Hospitality</div>
              <div class="card-subtitle">Day &amp; night event totals.</div>
            </div>
          </div>
          <div class="metric-row" style="grid-template-columns: repeat(3, 1fr);">
            <div class="metric">
              <div class="metric-label">Day Events</div>
              <div class="metric-value" id="hospDay">0</div>
            </div>
            <div class="metric">
              <div class="metric-label">Night Events</div>
              <div class="metric-value" id="hospNight">0</div>
            </div>
            <div class="metric">
              <div class="metric-label">Total</div>
              <div class="metric-value" id="hospTotal">0</div>
            </div>
          </div>
        </div>

        <div class="card">
          <div class="card-header">
            <div>
              <div class="card-title">Newcastle Free Breakfast</div>
              <div class="card-subtitle">Total and number of days (for the selected filter).</div>
            </div>
          </div>
          <div class="metric-row" style="grid-template-columns: 1fr;">
            <div class="metric">
              <div class="metric-label">Total Free Breakfast</div>
              <div class="metric-value" id="freeBreakfastTotal">0</div>
              <div class="metric-sub"><span id="freeBreakfastDays">0</span> day(s)</div>
            </div>
          </div>
        </div>
      </div>

      <div class="row-2">
        <div class="card">
          <div class="card-header">
            <div>
              <div class="card-title">Maintenance Incidents</div>
              <div class="card-subtitle">All maintenance issues for the week.</div>
            </div>
          </div>
          <div id="maintEmpty" class="empty-text">No maintenance incidents.</div>
          <div id="maintList" class="list"></div>
        </div>

        <div class="card">
          <div class="card-header">
            <div>
              <div class="card-title">H&amp;S Incidents</div>
              <div class="card-subtitle">All H&amp;S issues for the week.</div>
            </div>
          </div>
          <div id="hsEmpty" class="empty-text">No H&amp;S incidents.</div>
          <div id="hsList" class="list"></div>
        </div>
      </div>

      <div class="card">
        <div class="card-header">
          <div>
            <div class="card-title">Retail Lunch Specials</div>
            <div class="card-subtitle">All specials recorded for the week.</div>
          </div>
        </div>
        <div id="specialsEmpty" class="empty-text">No lunch specials recorded.</div>
        <div id="specialsList" class="list"></div>
      </div>

      <div class="card">
        <div class="card-header">
          <div>
            <div class="card-title">Weekly Retail Sales</div>
            <div class="card-subtitle">Sales captured via the Sales page (table: retail_sales).</div>
          </div>
        </div>
        <div class="metric-row" style="grid-template-columns: repeat(3, 1fr);">
          <div class="metric">
            <div class="metric-label">Total Sales</div>
            <div class="metric-value" id="salesTotal">£0.00</div>
          </div>
          <div class="metric">
            <div class="metric-label">Transactions</div>
            <div class="metric-value" id="salesTrans">0</div>
          </div>
          <div class="metric">
            <div class="metric-label">SPH</div>
            <div class="metric-value" id="salesSPH">£0.00</div>
          </div>
        </div>
        <div id="salesEmpty" class="empty-text">No retail sales for this week.</div>
        <div id="salesList" class="list"></div>
      </div>

      <div class="card">
        <div class="card-header">
          <div>
            <div class="card-title">Daily Notes</div>
            <div class="card-subtitle">Notes captured within the selected week.</div>
          </div>
        </div>
        <div id="notesEmpty" class="empty-text">No notes recorded for this week.</div>
        <div id="notesList" class="list"></div>
      </div>

      <div class="card">
        <div class="card-header">
          <div>
            <div class="card-title">Photo Gallery</div>
            <div class="card-subtitle">All photos uploaded within the selected week.</div>
          </div>
        </div>
        <div id="photosEmpty" class="empty-text">No photos uploaded this week.</div>
        <div id="photosGrid" class="photos-grid"></div>
      </div>
    </div>
  </div>

  <script type="module">
    import { supabase } from './supabase-config.js';

    const weekLabelEl = document.getElementById('weekLabel');
    const siteFilterEl = document.getElementById('siteFilter');
    const areaFilterEl = document.getElementById('areaFilter');
    const weekPickerEl = document.getElementById('weekPicker');
    const refreshBtn = document.getElementById('refreshBtn');
    const errorMessageEl = document.getElementById('errorMessage');

    const kpiTotalLogsEl = document.getElementById('kpiTotalLogs');
    const kpiLogsWithPhotosEl = document.getElementById('kpiLogsWithPhotos');
    const kpiIncidentsEl = document.getElementById('kpiIncidents');
    const kpiStaffingEl = document.getElementById('kpiStaffing');
    const kpiRetailSpecialsEl = document.getElementById('kpiRetailSpecials');
    const kpiRetailSpecialsSubEl = document.getElementById('kpiRetailSpecialsSub');
    const kpiRetailSalesEl = document.getElementById('kpiRetailSales');
    const kpiRetailSalesSubEl = document.getElementById('kpiRetailSalesSub');

    const staffSicknessEl = document.getElementById('staffSickness');
    const staffHolidayEl = document.getElementById('staffHoliday');
    const staffAgencyEl = document.getElementById('staffAgency');

    const hospDayEl = document.getElementById('hospDay');
    const hospNightEl = document.getElementById('hospNight');
    const hospTotalEl = document.getElementById('hospTotal');

    const freeBreakfastTotalEl = document.getElementById('freeBreakfastTotal');
    const freeBreakfastDaysEl = document.getElementById('freeBreakfastDays');

    const maintEmptyEl = document.getElementById('maintEmpty');
    const hsEmptyEl = document.getElementById('hsEmpty');
    const maintListEl = document.getElementById('maintList');
    const hsListEl = document.getElementById('hsList');

    const specialsEmptyEl = document.getElementById('specialsEmpty');
    const specialsListEl = document.getElementById('specialsList');

    const salesTotalEl = document.getElementById('salesTotal');
    const salesTransEl = document.getElementById('salesTrans');
    const salesSPHEl = document.getElementById('salesSPH');
    const salesEmptyEl = document.getElementById('salesEmpty');
    const salesListEl = document.getElementById('salesList');

    const notesEmptyEl = document.getElementById('notesEmpty');
    const notesListEl = document.getElementById('notesList');

    const photosEmptyEl = document.getElementById('photosEmpty');
    const photosGridEl = document.getElementById('photosGrid');

    function pad(n) { return String(n).padStart(2, '0'); }
    function dateKey(d) { return `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())}`; }

    function safeNum(v) {
      const n = Number(v);
      return Number.isFinite(n) ? n : 0;
    }

    function safeText(v) {
      if (v === null || v === undefined) return '';
      return String(v).trim();
    }
    
function isIncidentFlagTrue(v) {
  if (v === true) return true;
  if (v === false || v === null || v === undefined) return false;

  const s = String(v).trim().toLowerCase();
  // treat common "no" values as false
  if (!s) return false;
  if (["no", "none", "n/a", "na", "false", "0"].includes(s)) return false;

  // treat common "yes" values as true
  if (["yes", "y", "true", "1"].includes(s)) return true;

  // if it’s some other text, we only treat as true if it's not a "no" value
  return true;
}

function hasMeaningfulText(v) {
  const s = safeText(v).toLowerCase();
  if (!s) return false;
  if (["no", "none", "n/a", "na"].includes(s)) return false;
  return true;
}

    function startOfWeekMonday(anyDate) {
      const d = new Date(anyDate);
      const day = d.getDay(); // 0 Sun..6 Sat
      const diff = (day === 0 ? -6 : 1 - day);
      d.setDate(d.getDate() + diff);
      d.setHours(0,0,0,0);
      return d;
    }

    function formatRange(start, end) {
      const opts = { day:'2-digit', month:'short', year:'numeric' };
      return `${start.toLocaleDateString('en-GB', opts)} – ${end.toLocaleDateString('en-GB', opts)}`;
    }

    function applyFilters(rows) {
      const site = siteFilterEl.value || 'All';
      const area = areaFilterEl.value || 'All';

      let out = rows || [];

      if (site !== 'All') {
        const siteLc = site.toLowerCase();
        out = out.filter(r => safeText(r.site).toLowerCase().includes(siteLc));
      }

      if (area !== 'All') {
        const want = area.toLowerCase();
        out = out.filter(r => safeText(r.area).toLowerCase() === want);
      }

      return out;
    }

    function renderList(targetEl, emptyEl, items) {
      targetEl.innerHTML = '';
      if (!items || !items.length) {
        emptyEl.style.display = 'block';
        return;
      }
      emptyEl.style.display = 'none';

      targetEl.innerHTML = items.map(i => `
        <div class="list-item">
          <div class="list-title">${i.title}</div>
          ${i.sub ? `<div class="list-sub">${i.sub}</div>` : ``}
          <div class="list-notes">${i.notes}</div>
        </div>
      `).join('');
    }

    function clearAll() {
      errorMessageEl.style.display = 'none';
      errorMessageEl.textContent = '';

      kpiTotalLogsEl.textContent = '0';
      kpiLogsWithPhotosEl.textContent = '0';
      kpiIncidentsEl.textContent = '0';
      kpiStaffingEl.textContent = '0';
      kpiRetailSpecialsEl.textContent = '0';
      kpiRetailSpecialsSubEl.textContent = 'Days with specials';
      kpiRetailSalesEl.textContent = '£0.00';
      kpiRetailSalesSubEl.textContent = '0 tx • SPH £0.00';

      staffSicknessEl.textContent = '0';
      staffHolidayEl.textContent = '0';
      staffAgencyEl.textContent = '0';

      hospDayEl.textContent = '0';
      hospNightEl.textContent = '0';
      hospTotalEl.textContent = '0';

      freeBreakfastTotalEl.textContent = '0';
      freeBreakfastDaysEl.textContent = '0';

      maintListEl.innerHTML = '';
      hsListEl.innerHTML = '';
      specialsListEl.innerHTML = '';
      salesListEl.innerHTML = '';
      notesListEl.innerHTML = '';
      photosGridEl.innerHTML = '';

      maintEmptyEl.style.display = 'block';
      hsEmptyEl.style.display = 'block';
      specialsEmptyEl.style.display = 'block';
      salesEmptyEl.style.display = 'block';
      notesEmptyEl.style.display = 'block';
      photosEmptyEl.style.display = 'block';

      salesTotalEl.textContent = '£0.00';
      salesTransEl.textContent = '0';
      salesSPHEl.textContent = '£0.00';
    }

    async function loadWeeklyOpsLogs(startDateStr, endDateStr) {
      const { data, error } = await supabase
        .from('ops_logs')
        .select('*')
        .or(`and(log_date.gte.${startDateStr},log_date.lte.${endDateStr}),and(log_date.is.null,created_at.gte.${startDateStr}T00:00:00Z,created_at.lte.${endDateStr}T23:59:59Z)`)
        .order('log_date', { ascending: true })
        .order('created_at', { ascending: true });

      if (error) throw error;
      return data || [];
    }

    async function loadWeeklyRetailSales(startDateStr, endDateStr) {
      const { data, error } = await supabase
        .from('retail_sales')
        .select('sales_date, site, level, sales, transactions')
        .gte('sales_date', startDateStr)
        .lte('sales_date', endDateStr)
        .order('sales_date', { ascending: true })
        .order('level', { ascending: true });

      if (error) throw error;
      return data || [];
    }

    async function loadWeekly() {
      clearAll();

      const picked = weekPickerEl.value ? new Date(weekPickerEl.value + 'T00:00:00') : new Date();
      const start = startOfWeekMonday(picked);
      const end = new Date(start);
      end.setDate(end.getDate() + 4);
      end.setHours(23,59,59,999);

      const startStr = dateKey(start);
      const endStr = dateKey(end);

      weekLabelEl.textContent = formatRange(start, end);

      try {
        // ops_logs
        const opsAll = await loadWeeklyOpsLogs(startStr, endStr);
        const opsRows = applyFilters(opsAll);

        kpiTotalLogsEl.textContent = String(opsRows.length);

        // Photos (photo_url)
        const photos = opsRows
          .filter(r => !!r.photo_url)
          .map(r => ({
            url: r.photo_url,
            date: (r.log_date || (r.created_at ? String(r.created_at).slice(0,10) : '')),
            site: r.site || '',
            area: r.area || ''
          }));
        kpiLogsWithPhotosEl.textContent = String(photos.length);

        if (photos.length) {
          photosEmptyEl.style.display = 'none';
          photosGridEl.innerHTML = photos
            .sort((a,b) => (a.date < b.date ? -1 : 1))
            .map(p => `
              <div class="photo-card">
                <a href="${p.url}" target="_blank" rel="noopener noreferrer">
                  <img src="${p.url}" alt="Ops photo" />
                </a>
                <div class="photo-card-caption">
                  ${p.date}<br/>
                  ${p.site}${p.area ? ' • ' + p.area : ''}
                </div>
              </div>
            `).join('');
        }

        // Staffing (sickness_count, holiday_count, agency_count)
        const sickness = opsRows.reduce((s,r) => s + safeNum(r.sickness_count), 0);
        const holiday = opsRows.reduce((s,r) => s + safeNum(r.holiday_count), 0);
        const agency = opsRows.reduce((s,r) => s + safeNum(r.agency_count), 0);

        staffSicknessEl.textContent = String(sickness);
        staffHolidayEl.textContent = String(holiday);
        staffAgencyEl.textContent = String(agency);
        kpiStaffingEl.textContent = String(sickness + holiday + agency);

        // Hospitality (hosp_day_events, hosp_night_events)
        const hospDay = opsRows.reduce((s,r) => s + safeNum(r.hosp_day_events), 0);
        const hospNight = opsRows.reduce((s,r) => s + safeNum(r.hosp_night_events), 0);

        hospDayEl.textContent = String(hospDay);
        hospNightEl.textContent = String(hospNight);
        hospTotalEl.textContent = String(hospDay + hospNight);

        const maintItems = opsRows
  .filter(r =>
    isIncidentFlagTrue(r.maintenance_issue) ||
    hasMeaningfulText(r.maintenance_notes)
  )
  .map(r => ({
    title: `${r.site || 'Site'} • ${r.area || 'Area'} • ${r.log_date || (r.created_at ? String(r.created_at).slice(0,10) : '')}`,
    sub: '',
    notes: safeText(r.maintenance_notes) || 'Maintenance incident recorded (no details entered).'
  }));

const hsItems = opsRows
  .filter(r =>
    isIncidentFlagTrue(r.hs_issue) ||
    hasMeaningfulText(r.hs_notes)
  )
  .map(r => ({
    title: `${r.site || 'Site'} • ${r.area || 'Area'} • ${r.log_date || (r.created_at ? String(r.created_at).slice(0,10) : '')}`,
    sub: '',
    notes: safeText(r.hs_notes) || 'H&S incident recorded (no details entered).'
  }));

        renderList(maintListEl, maintEmptyEl, maintItems);
        renderList(hsListEl, hsEmptyEl, hsItems);
        kpiIncidentsEl.textContent = String(maintItems.length + hsItems.length);

        // Specials (retail_lunch_special_details)
        const specials = opsRows
          .filter(r => safeText(r.retail_lunch_special_details))
          .map(r => ({
            title: `${r.site || 'Site'} • ${r.area || 'Area'} • ${r.log_date || (r.created_at ? String(r.created_at).slice(0,10) : '')}`,
            sub: 'Lunch Special',
            notes: safeText(r.retail_lunch_special_details)
          }));
        renderList(specialsListEl, specialsEmptyEl, specials);

        const specialDays = new Set(specials.map(s => s.title.split(' • ').pop()));
        kpiRetailSpecialsEl.textContent = String(specialDays.size);
        kpiRetailSpecialsSubEl.textContent = `${specialDays.size} day(s) with specials`;

        // Free breakfast (free_breakfast_count)
        const fbRows = opsRows.filter(r => safeNum(r.free_breakfast_count) > 0);
        const fbTotal = fbRows.reduce((s,r) => s + safeNum(r.free_breakfast_count), 0);
        const fbDays = new Set(fbRows.map(r => r.log_date || (r.created_at ? String(r.created_at).slice(0,10) : '')));
        freeBreakfastTotalEl.textContent = String(fbTotal);
        freeBreakfastDaysEl.textContent = String(fbDays.size);

        // Notes (notes)
        const notes = opsRows
          .filter(r => safeText(r.notes))
          .map(r => ({
            title: `${r.site || 'Site'} • ${r.area || 'Area'} • ${r.log_date || (r.created_at ? String(r.created_at).slice(0,10) : '')}`,
            sub: '',
            notes: safeText(r.notes)
          }));
        renderList(notesListEl, notesEmptyEl, notes);

// retail_sales table (weekly aggregation by level)
const salesAll = await loadWeeklyRetailSales(startStr, endStr);

let salesRows = salesAll;
const site = siteFilterEl.value || 'All';
if (site !== 'All') {
  salesRows = salesRows.filter(r => safeText(r.site).toLowerCase().includes(site.toLowerCase()));
}

// Aggregate by level for the whole week
const byLevel = new Map(); // level -> { sales, tx }
for (const r of salesRows) {
  const level = safeText(r.level) || 'Unknown';
  const sales = safeNum(r.sales);
  const tx = safeNum(r.transactions);

  const cur = byLevel.get(level) || { sales: 0, tx: 0 };
  cur.sales += sales;
  cur.tx += tx;
  byLevel.set(level, cur);
}

// Totals
let grandSales = 0;
let grandTx = 0;
for (const v of byLevel.values()) {
  grandSales += v.sales;
  grandTx += v.tx;
}
const grandSPH = grandTx ? (grandSales / grandTx) : 0;

// Update summary tiles
salesTotalEl.textContent = `£${grandSales.toFixed(2)}`;
salesTransEl.textContent = String(grandTx);
salesSPHEl.textContent = `£${grandSPH.toFixed(2)}`;

kpiRetailSalesEl.textContent = `£${grandSales.toFixed(2)}`;
kpiRetailSalesSubEl.textContent = `${grandTx} tx • SPH £${grandSPH.toFixed(2)}`;

// Render per-level weekly totals (sorted)
salesListEl.innerHTML = '';
if (!byLevel.size) {
  salesEmptyEl.style.display = 'block';
} else {
  salesEmptyEl.style.display = 'none';

  const levelsSorted = Array.from(byLevel.entries())
    .sort((a, b) => {
      // try numeric sort (Level 4/5/7), otherwise alpha
      const an = parseFloat(String(a[0]).replace(/[^\d.]/g, ''));
      const bn = parseFloat(String(b[0]).replace(/[^\d.]/g, ''));
      if (Number.isFinite(an) && Number.isFinite(bn)) return an - bn;
      return String(a[0]).localeCompare(String(b[0]));
    });

  const rowsHtml = levelsSorted.map(([level, v]) => {
    const sph = v.tx ? (v.sales / v.tx) : 0;
    return `
      <div class="list-item">
        <div class="list-title">${safeText(level)} • Weekly Total</div>
        <div class="list-sub">Sales £${v.sales.toFixed(2)} • Transactions ${v.tx} • SPH £${sph.toFixed(2)}</div>
      </div>
    `;
  }).join('');

  const grandHtml = `
    <div class="list-item">
      <div class="list-title">Grand Total • Weekly</div>
      <div class="list-sub">Sales £${grandSales.toFixed(2)} • Transactions ${grandTx} • SPH £${grandSPH.toFixed(2)}</div>
    </div>
  `;

  salesListEl.innerHTML = rowsHtml + grandHtml;
}

      } catch (err) {
        console.error(err);
        errorMessageEl.textContent = `Error loading weekly data: ${err.message || err}`;
        errorMessageEl.style.display = 'block';
      }
    }

    weekPickerEl.value = dateKey(new Date());
    refreshBtn.addEventListener('click', loadWeekly);
    siteFilterEl.addEventListener('change', loadWeekly);
    areaFilterEl.addEventListener('change', loadWeekly);
    weekPickerEl.addEventListener('change', loadWeekly);

    loadWeekly();
  </script>
</body>
</html>
