<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Ops Log • Weekly Dashboard</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    body {
      margin: 0;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: #0b1220;
      color: #f9fafb;
      min-height: 100vh;
    }

    .wrap {
      max-width: 1240px;
      margin: 0 auto;
      padding: 18px 14px 42px;
    }

    .topbar {
      display: flex;
      flex-wrap: wrap;
      align-items: center;
      justify-content: space-between;
      gap: 12px;
      margin-bottom: 14px;
    }

    .brand {
      display: flex;
      gap: 10px;
      align-items: center;
    }

    .logo {
      width: 42px;
      height: 42px;
      border-radius: 12px;
      background: linear-gradient(135deg, #1f2a44, #0f172a);
      box-shadow: 0 0 0 1px rgba(255,255,255,0.06) inset, 0 12px 24px rgba(0,0,0,0.25);
      display: grid;
      place-items: center;
      font-weight: 800;
      letter-spacing: 0.5px;
      color: #93c5fd;
    }

    .titleblock .title {
      font-size: 18px;
      font-weight: 750;
      line-height: 1.2;
    }

    .titleblock .subtitle {
      font-size: 12px;
      color: rgba(255,255,255,0.68);
      margin-top: 2px;
    }

    .filters {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
      align-items: center;
      justify-content: flex-end;
    }

    .filter {
      background: rgba(255,255,255,0.05);
      border: 1px solid rgba(255,255,255,0.08);
      padding: 10px 12px;
      border-radius: 14px;
      display: flex;
      align-items: center;
      gap: 10px;
      min-width: 220px;
      box-shadow: 0 8px 18px rgba(0,0,0,0.20);
    }

    .filter label {
      font-size: 12px;
      color: rgba(255,255,255,0.72);
      white-space: nowrap;
    }

    select, input[type="date"] {
      background: rgba(0,0,0,0.25);
      border: 1px solid rgba(255,255,255,0.12);
      color: #f9fafb;
      padding: 8px 10px;
      border-radius: 10px;
      outline: none;
      width: 100%;
      font-size: 13px;
    }

    .grid {
      display: grid;
      grid-template-columns: 1fr;
      gap: 14px;
      margin-top: 14px;
    }

    .row-1, .row-2, .row-3, .row-4 {
      display: grid;
      gap: 14px;
    }

    .row-1 { grid-template-columns: repeat(4, minmax(0, 1fr)); }
    .row-2 { grid-template-columns: repeat(2, minmax(0, 1fr)); }
    .row-3 { grid-template-columns: repeat(3, minmax(0, 1fr)); }
    .row-4 { grid-template-columns: repeat(2, minmax(0, 1fr)); }

    @media (max-width: 1100px) {
      .row-1 { grid-template-columns: repeat(2, minmax(0, 1fr)); }
      .row-3 { grid-template-columns: repeat(2, minmax(0, 1fr)); }
      .row-4 { grid-template-columns: 1fr; }
    }

    @media (max-width: 640px) {
      .row-1, .row-2, .row-3 { grid-template-columns: 1fr; }
      .filter { min-width: 100%; }
    }

    .card {
      background: rgba(255,255,255,0.04);
      border: 1px solid rgba(255,255,255,0.08);
      border-radius: 18px;
      padding: 14px;
      box-shadow: 0 10px 24px rgba(0,0,0,0.24);
      position: relative;
      overflow: hidden;
    }

    .card::before {
      content: "";
      position: absolute;
      inset: -1px;
      background: radial-gradient(650px 140px at 15% 0%, rgba(59,130,246,0.18), transparent 65%),
                  radial-gradient(550px 160px at 85% 0%, rgba(236,72,153,0.14), transparent 60%);
      pointer-events: none;
    }

    .card > * { position: relative; }

    .card-header {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      gap: 10px;
      margin-bottom: 10px;
      flex-wrap: wrap;
    }

    .card-title {
      font-weight: 750;
      font-size: 14px;
      letter-spacing: 0.2px;
    }

    .card-subtitle {
      font-size: 12px;
      color: rgba(255,255,255,0.65);
      margin-top: 3px;
      line-height: 1.25;
    }

    .kpis {
      display: grid;
      grid-template-columns: repeat(3, minmax(0, 1fr));
      gap: 10px;
      margin-top: 6px;
    }

    .kpi {
      background: rgba(0,0,0,0.22);
      border: 1px solid rgba(255,255,255,0.08);
      border-radius: 14px;
      padding: 10px 10px 9px;
    }

    .kpi .label {
      font-size: 11px;
      color: rgba(255,255,255,0.65);
    }

    .kpi .value {
      font-size: 20px;
      font-weight: 800;
      margin-top: 2px;
      letter-spacing: 0.2px;
    }

    .kpi .sub {
      font-size: 11px;
      color: rgba(255,255,255,0.65);
      margin-top: 2px;
      line-height: 1.25;
    }

    .metric-row {
      display: grid;
      grid-template-columns: repeat(2, minmax(0, 1fr));
      gap: 10px;
    }

    .metric {
      background: rgba(0,0,0,0.22);
      border: 1px solid rgba(255,255,255,0.08);
      border-radius: 14px;
      padding: 10px;
    }

    .metric-label {
      font-size: 11px;
      color: rgba(255,255,255,0.65);
    }

    .metric-value {
      font-size: 18px;
      font-weight: 800;
      margin-top: 2px;
    }

    .metric-sub {
      font-size: 11px;
      color: rgba(255,255,255,0.62);
      margin-top: 2px;
      line-height: 1.25;
    }

    .list {
      display: grid;
      gap: 8px;
      margin-top: 10px;
    }

    .list-item {
      background: rgba(0,0,0,0.22);
      border: 1px solid rgba(255,255,255,0.08);
      border-radius: 14px;
      padding: 10px;
    }

    .list-title {
      font-weight: 700;
      font-size: 12px;
      color: rgba(255,255,255,0.92);
      display: flex;
      justify-content: space-between;
      gap: 10px;
      align-items: baseline;
    }

    .badge {
      font-size: 11px;
      color: rgba(255,255,255,0.70);
      background: rgba(255,255,255,0.06);
      border: 1px solid rgba(255,255,255,0.08);
      padding: 4px 8px;
      border-radius: 999px;
      white-space: nowrap;
    }

    .badge-strong {
      font-size: 11px;
      font-weight: 800;
      color: rgba(255,255,255,0.90);
      background: rgba(59,130,246,0.16);
      border: 1px solid rgba(59,130,246,0.35);
      padding: 6px 10px;
      border-radius: 999px;
      white-space: nowrap;
    }

    .badge-good {
      background: rgba(16,185,129,0.14);
      border: 1px solid rgba(16,185,129,0.30);
      color: rgba(209,250,229,0.95);
    }

    .badge-bad {
      background: rgba(239,68,68,0.14);
      border: 1px solid rgba(239,68,68,0.30);
      color: rgba(254,226,226,0.95);
    }

    .list-notes {
      font-size: 12px;
      color: rgba(255,255,255,0.75);
      margin-top: 6px;
      white-space: pre-wrap;
      line-height: 1.25;
    }

    .empty-text { padding: 8px 2px; font-size: 12px; color: rgba(255,255,255,0.65); }

    .pill {
      font-size: 11px;
      background: rgba(59,130,246,0.18);
      border: 1px solid rgba(59,130,246,0.35);
      color: rgba(219,234,254,0.92);
      padding: 6px 10px;
      border-radius: 999px;
      white-space: nowrap;
    }

    .error {
      display: none;
      margin-top: 10px;
      background: rgba(239,68,68,0.15);
      border: 1px solid rgba(239,68,68,0.35);
      color: rgba(254,226,226,0.92);
      padding: 10px 12px;
      border-radius: 14px;
      font-size: 12px;
      white-space: pre-wrap;
    }

    .btn {
      background: rgba(59,130,246,0.20);
      border: 1px solid rgba(59,130,246,0.42);
      color: rgba(219,234,254,0.95);
      padding: 10px 12px;
      border-radius: 14px;
      font-weight: 750;
      font-size: 13px;
      cursor: pointer;
      box-shadow: 0 10px 22px rgba(0,0,0,0.22);
      transition: transform .08s ease, filter .08s ease;
    }

    .btn:hover { filter: brightness(1.08); }
    .btn:active { transform: translateY(1px); }

    .btn-secondary {
      background: rgba(255,255,255,0.06);
      border: 1px solid rgba(255,255,255,0.10);
      color: rgba(255,255,255,0.88);
    }

    .photo-grid {
      display: grid;
      grid-template-columns: repeat(4, minmax(0, 1fr));
      gap: 10px;
      margin-top: 10px;
    }

    @media (max-width: 1100px) { .photo-grid { grid-template-columns: repeat(3, minmax(0, 1fr)); } }
    @media (max-width: 640px)  { .photo-grid { grid-template-columns: repeat(2, minmax(0, 1fr)); } }

    .thumb {
      border-radius: 16px;
      overflow: hidden;
      border: 1px solid rgba(255,255,255,0.10);
      background: rgba(0,0,0,0.20);
      box-shadow: 0 10px 18px rgba(0,0,0,0.20);
      cursor: pointer;
    }

    .thumb img {
      width: 100%;
      height: 150px;
      object-fit: cover;
      display: block;
    }

    .thumb .cap {
      padding: 8px 10px 10px;
      font-size: 11px;
      color: rgba(255,255,255,0.70);
      line-height: 1.25;
    }

    .modal {
      display: none;
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.65);
      z-index: 50;
      padding: 16px;
    }

    .modal.open { display: grid; place-items: center; }

    .modal-card {
      width: min(1100px, 96vw);
      background: rgba(255,255,255,0.05);
      border: 1px solid rgba(255,255,255,0.10);
      border-radius: 18px;
      overflow: hidden;
      box-shadow: 0 20px 60px rgba(0,0,0,0.45);
    }

    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 10px 12px;
      border-bottom: 1px solid rgba(255,255,255,0.10);
      background: rgba(0,0,0,0.20);
      gap: 10px;
    }

    .modal-header .mh-title {
      font-weight: 800;
      font-size: 13px;
      color: rgba(255,255,255,0.92);
      display: flex;
      align-items: center;
      gap: 10px;
      flex-wrap: wrap;
    }

    .close {
      border: 1px solid rgba(255,255,255,0.12);
      background: rgba(0,0,0,0.25);
      color: rgba(255,255,255,0.85);
      border-radius: 12px;
      padding: 8px 10px;
      cursor: pointer;
      font-weight: 800;
    }

    .modal-body {
      padding: 12px;
      display: grid;
      gap: 12px;
    }

    /* Charts */
    .chart-wrap {
      margin-top: 10px;
      background: rgba(0,0,0,0.18);
      border: 1px solid rgba(255,255,255,0.08);
      border-radius: 14px;
      padding: 10px;
    }

    .chart-head {
      display: flex;
      align-items: baseline;
      justify-content: space-between;
      gap: 10px;
      margin-bottom: 8px;
      flex-wrap: wrap;
    }

    .chart-head .left {
      font-size: 11px;
      color: rgba(255,255,255,0.70);
    }

    .chart-head .right {
      font-size: 11px;
      color: rgba(255,255,255,0.70);
      white-space: nowrap;
    }

    .legend {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
      margin-top: 6px;
    }

    .legend .key {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      font-size: 11px;
      color: rgba(255,255,255,0.72);
      padding: 4px 8px;
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,0.08);
      background: rgba(255,255,255,0.04);
    }

    .legend .swatch {
      width: 10px;
      height: 10px;
      border-radius: 3px;
      border: 1px solid rgba(255,255,255,0.22);
      background: rgba(255,255,255,0.20);
    }

    canvas {
      width: 100%;
      height: 190px;
      display: block;
      border-radius: 12px;
      background: rgba(0,0,0,0.18);
      border: 1px solid rgba(255,255,255,0.06);
    }

    /* WoW colour cues */
    .wow-pos { color: rgba(209,250,229,0.95); }
    .wow-pos strong { color: rgba(16,185,129,0.95); }
    .wow-neg { color: rgba(254,226,226,0.95); }
    .wow-neg strong { color: rgba(239,68,68,0.95); }
    .wow-neutral { color: rgba(255,255,255,0.70); }
    .wow-neutral strong { color: rgba(255,255,255,0.85); }

    .retail-hero {
      border: 1px solid rgba(59,130,246,0.20);
      box-shadow: 0 14px 34px rgba(0,0,0,0.28);
    }

    /* Drilldown table */
    .table-wrap {
      overflow: auto;
      border: 1px solid rgba(255,255,255,0.08);
      border-radius: 14px;
      background: rgba(0,0,0,0.18);
    }

    table {
      width: 100%;
      border-collapse: collapse;
      min-width: 860px;
    }

    th, td {
      padding: 10px 10px;
      border-bottom: 1px solid rgba(255,255,255,0.08);
      font-size: 12px;
      color: rgba(255,255,255,0.80);
      text-align: left;
      white-space: nowrap;
    }

    th {
      font-size: 11px;
      color: rgba(255,255,255,0.70);
      background: rgba(255,255,255,0.04);
      position: sticky;
      top: 0;
      z-index: 1;
    }

    .muted {
      color: rgba(255,255,255,0.62);
    }

    .controls-inline {
      display: flex;
      gap: 10px;
      align-items: center;
      flex-wrap: wrap;
    }

    .mini-filter {
      display: flex;
      gap: 8px;
      align-items: center;
      background: rgba(255,255,255,0.05);
      border: 1px solid rgba(255,255,255,0.08);
      padding: 8px 10px;
      border-radius: 14px;
    }

    .mini-filter label {
      font-size: 11px;
      color: rgba(255,255,255,0.70);
      white-space: nowrap;
    }

    .mini-filter select {
      width: 180px;
      padding: 8px 10px;
      border-radius: 10px;
      font-size: 12px;
    }
  </style>
</head>

<body>
  <div class="wrap">
    <div class="topbar">
      <div class="brand">
        <div class="logo">OL</div>
        <div class="titleblock">
          <div class="title">Weekly Dashboard</div>
          <div class="subtitle">Week view (Mon–Fri). Filter by site/area.</div>
        </div>
      </div>

      <div class="filters">
        <div class="filter">
          <label for="weekPicker">Week (pick any day)</label>
          <input type="date" id="weekPicker" />
        </div>

        <div class="filter">
          <label for="siteFilter">Site</label>
          <select id="siteFilter">
            <option value="All">All Sites</option>
            <option value="London">London</option>
            <option value="Newcastle">Newcastle</option>
          </select>
        </div>

        <div class="filter">
          <label for="areaFilter">Area</label>
          <select id="areaFilter">
            <option value="All">All Areas</option>
            <option value="Retail">Retail</option>
            <option value="Kitchen">Kitchen</option>
            <option value="Hospitality">Hospitality</option>
          </select>
        </div>

        <button class="btn" id="refreshBtn">Refresh</button>
      </div>
    </div>

    <div id="errorMessage" class="error"></div>

    <div class="grid">
      <!-- OVERVIEW -->
      <div class="row-1">
        <div class="card" style="grid-column: 1 / span 4; padding: 0;">
          <div style="padding: 14px 14px 0;">
            <div class="card-header" style="margin-bottom: 8px;">
              <div>
                <div class="card-title">Overview</div>
                <div class="card-subtitle">Totals for the selected week & filter.</div>
              </div>
              <div class="pill" id="weekLabel">Week</div>
            </div>

            <div class="kpis">
              <div class="kpi">
                <div class="label">Total Logs</div>
                <div class="value" id="kpiTotalLogs">0</div>
                <div class="sub">All entries captured</div>
              </div>
              <div class="kpi">
                <div class="label">Logs with Photos</div>
                <div class="value" id="kpiPhotos">0</div>
                <div class="sub">Any photo attached</div>
              </div>
              <div class="kpi">
                <div class="label">Incidents</div>
                <div class="value" id="kpiIncidents">0</div>
                <div class="sub">Maintenance + H&amp;S</div>
              </div>
              <div class="kpi">
                <div class="label">Staffing Impact</div>
                <div class="value" id="kpiStaffing">0</div>
                <div class="sub">Sick + Holiday + Agency</div>
              </div>
              <div class="kpi">
                <div class="label">Lunch Specials</div>
                <div class="value" id="kpiRetailSpecials">0</div>
                <div class="sub" id="kpiRetailSpecialsSub">Days with specials</div>
              </div>
              <div class="kpi">
                <div class="label">Retail Sales</div>
                <div class="value" id="kpiRetailSales">£0.00</div>
                <div class="sub" id="kpiRetailSalesSub">Transactions • SPH</div>
                <div class="sub" id="kpiRetailBreakdown" style="margin-top:6px; color: rgba(255,255,255,0.62);">
                  L7 £0 • L5 £0 • L4 £0 • L3 £0
                </div>
              </div>
            </div>
          </div>

          <div style="padding: 0 14px 14px;">
            <button id="generateWeeklySummaryBtn" class="btn">Generate Weekly Summary</button>

            <div id="weeklySummaryBox" style="display:none; margin-top:12px;" class="list-item">
              <div class="list-title">AI Weekly Summary</div>
              <div id="weeklySummaryText" class="list-notes" style="margin-top:8px;"></div>
            </div>
          </div>
        </div>
      </div>

      <!-- RETAIL SALES HERO -->
      <div class="row-1">
        <div class="card retail-hero" id="retailSalesCard" style="grid-column: 1 / span 4;">
          <div class="card-header">
            <div>
              <div class="card-title">Retail Sales (Weekly Totals)</div>
              <div class="card-subtitle">Levels 7/5/4/3 with SPH + change vs previous week, plus a Mon–Fri chart.</div>
            </div>

            <div style="display:flex; gap:8px; align-items:center; flex-wrap:wrap; justify-content:flex-end;">
              <div class="pill" id="salesWoWLabel">WoW</div>
              <div class="badge-strong badge-good" id="bestFloorBadge" style="display:none;"></div>
              <div class="badge-strong badge-bad" id="worstFloorBadge" style="display:none;"></div>
            </div>
          </div>

          <div class="metric-row" style="grid-template-columns: 1fr;">
            <div class="metric">
              <div class="metric-label">Grand Total</div>
              <div class="metric-value" id="salesTotal">£0.00</div>

              <div class="metric-sub" id="salesWoWLine">
                <span id="salesTx">0</span> tx • SPH <span id="salesSPH">£0.00</span><br/>
                vs last week:
                <span id="salesWoWValue"><strong>£0.00</strong></span>
                (<span id="salesWoWPct"><strong>0.0%</strong></span>)
              </div>
            </div>
          </div>

          <div class="chart-wrap">
            <div class="chart-head">
              <div class="left" id="retailChartLabel">Mon–Fri totals (stacked by level)</div>
              <div class="right" id="retailChartAvgLabel">Avg/day: £0.00</div>
            </div>
            <canvas id="retailSalesChart" width="900" height="320"></canvas>
            <div class="legend" id="retailChartLegend">
              <span class="key"><span class="swatch" data-swatch="lvl7"></span>Level 7</span>
              <span class="key"><span class="swatch" data-swatch="lvl5"></span>Level 5</span>
              <span class="key"><span class="swatch" data-swatch="lvl4"></span>Level 4</span>
              <span class="key"><span class="swatch" data-swatch="lvl3"></span>Level 3</span>
              <span class="key"><span class="swatch" data-swatch="avg"></span>Avg line</span>
            </div>
          </div>

          <div id="salesEmpty" class="empty-text">No retail sales for this week.</div>
          <div id="salesList" class="list"></div>
        </div>
      </div>

      <!-- CORE OPS ROW -->
      <div class="row-3">
        <div class="card">
          <div class="card-header">
            <div>
              <div class="card-title">Staffing Summary</div>
              <div class="card-subtitle">Totals for the week.</div>
            </div>

            <div style="display:flex; gap:10px; align-items:center;">
              <button class="btn btn-secondary" id="openStaffingDrillBtn">Staffing Drill-Down</button>
            </div>
          </div>

          <div class="metric-row" style="grid-template-columns: repeat(4, 1fr);">
            <div class="metric">
              <div class="metric-label">Sickness</div>
              <div class="metric-value" id="staffSickness">0</div>
            </div>
            <div class="metric">
              <div class="metric-label">Holiday</div>
              <div class="metric-value" id="staffHoliday">0</div>
            </div>
            <div class="metric">
              <div class="metric-label">Agency</div>
              <div class="metric-value" id="staffAgency">0</div>
            </div>
          </div>

          <div class="metric-sub" style="margin-top:10px;">
            Drill-down shows Mon–Fri breakdown and split by site/area.
          </div>
        </div>

        <div class="card">
          <div class="card-header">
            <div>
              <div class="card-title">Hospitality</div>
              <div class="card-subtitle">Day vs night events for the week.</div>
            </div>
          </div>
          <div class="metric-row" style="grid-template-columns: repeat(4, 1fr);">
            <div class="metric">
              <div class="metric-label">Day Events</div>
              <div class="metric-value" id="hospDay">0</div>
            </div>
            <div class="metric">
              <div class="metric-label">Night Events</div>
              <div class="metric-value" id="hospNight">0</div>
            </div>
            <div class="metric">
              <div class="metric-label">Places Events</div>
              <div class="metric-value" id="hospPlaces">0</div>
            </div>
            <div class="metric">
              <div class="metric-label">Total</div>
              <div class="metric-value" id="hospTotal">0</div>
            </div>
          </div>
        </div>

        <div class="card">
          <div class="card-header">
            <div>
              <div class="card-title">Newcastle Free Breakfast</div>
              <div class="card-subtitle">Total and number of days.</div>
            </div>
          </div>
          <div class="metric-row" style="grid-template-columns: 1fr;">
            <div class="metric">
              <div class="metric-label">Total Free Breakfast</div>
              <div class="metric-value" id="freeBreakfastTotal">0</div>
              <div class="metric-sub"><span id="freeBreakfastDays">0</span> day(s)</div>
            </div>
          </div>
        </div>
      </div>

      <!-- NEWCASTLE HOT LUNCHES -->
      <div class="row-3">
        <div class="card" id="hotLunchCard" style="grid-column: 1 / span 3;">
          <div class="card-header">
            <div>
              <div class="card-title">Newcastle Hot Lunches</div>
              <div class="card-subtitle">Weekly total + daily average, plus a Mon–Fri breakdown chart.</div>
            </div>
          </div>

          <div class="metric-row" style="grid-template-columns: repeat(2, 1fr);">
            <div class="metric">
              <div class="metric-label">Total Hot Lunch Dishes</div>
              <div class="metric-value" id="hotLunchTotal">0</div>
            </div>
            <div class="metric">
              <div class="metric-label">Average per Day</div>
              <div class="metric-value" id="hotLunchAvg">0</div>
              <div class="metric-sub"><span id="hotLunchDays">0</span> day(s) with entries</div>
            </div>
          </div>

          <div class="chart-wrap">
            <div class="chart-head">
              <div class="left" id="hotLunchChartLabel">Mon–Fri totals</div>
              <div class="right" id="hotLunchChartAvgLabel">Avg: 0</div>
            </div>
            <canvas id="hotLunchChart" width="900" height="320"></canvas>
          </div>
        </div>
      </div>

      <!-- INCIDENTS -->
      <div class="row-2">
        <div class="card">
          <div class="card-header">
            <div>
              <div class="card-title">Maintenance Incidents</div>
              <div class="card-subtitle">Only days with incidents show.</div>
            </div>
          </div>
          <div id="maintEmpty" class="empty-text">No maintenance incidents.</div>
          <div id="maintList" class="list"></div>
        </div>

        <div class="card">
          <div class="card-header">
            <div>
              <div class="card-title">H&amp;S Incidents</div>
              <div class="card-subtitle">Only days with incidents show.</div>
            </div>
          </div>
          <div id="hsEmpty" class="empty-text">No H&amp;S incidents.</div>
          <div id="hsList" class="list"></div>
        </div>
      </div>

      <!-- NOTES + SPECIALS + HOSP NOTES -->
      <div class="row-3">
        <div class="card">
          <div class="card-header">
            <div>
              <div class="card-title">Hospitality (Notes)</div>
              <div class="card-subtitle">Hospitality notes captured this week.</div>
            </div>
          </div>
          <div id="hospNotesEmpty" class="empty-text">No hospitality notes.</div>
          <div id="hospNotesList" class="list"></div>
        </div>

        <div class="card">
          <div class="card-header">
            <div>
              <div class="card-title">Retail Specials</div>
              <div class="card-subtitle">All specials recorded for the week.</div>
            </div>
          </div>
          <div id="specialsEmpty" class="empty-text">No lunch specials recorded.</div>
          <div id="specialsList" class="list"></div>
        </div>

        <div class="card">
          <div class="card-header">
            <div>
              <div class="card-title">Daily Notes</div>
              <div class="card-subtitle">Notes captured for the week.</div>
            </div>
          </div>
          <div id="notesEmpty" class="empty-text">No notes recorded.</div>
          <div id="notesList" class="list"></div>
        </div>
      </div>

      <!-- PHOTOS -->
      <div class="row-4">
        <div class="card" style="grid-column: 1 / span 2;">
          <div class="card-header">
            <div>
              <div class="card-title">Photo Gallery</div>
              <div class="card-subtitle">Click a thumbnail to view.</div>
            </div>
          </div>
          <div id="photosEmpty" class="empty-text">No photos uploaded.</div>
          <div id="photosGrid" class="photo-grid"></div>
        </div>
      </div>
    </div>
  </div>

  <!-- PHOTO MODAL -->
  <div class="modal" id="photoModal">
    <div class="modal-card">
      <div class="modal-header">
        <div class="mh-title" id="modalTitle">Photo</div>
        <button class="close" id="closeModalBtn">Close</button>
      </div>
      <div class="modal-body">
        <img id="modalImg" alt="Photo" />
        <div id="modalNotes" class="modal-notes"></div>
      </div>
    </div>
  </div>

  <!-- STAFFING DRILLDOWN MODAL -->
  <div class="modal" id="staffingModal">
    <div class="modal-card">
      <div class="modal-header">
        <div class="mh-title">
          Staffing Drill-Down
          <span class="pill" id="staffingWeekLabel">Week</span>
        </div>
        <button class="close" id="closeStaffingModalBtn">Close</button>
      </div>

      <div class="modal-body">
        <div class="controls-inline">
          <div class="mini-filter">
            <label for="staffingSiteSelect">Site</label>
            <select id="staffingSiteSelect">
              <option value="All">All</option>
              <option value="London">London</option>
              <option value="Newcastle">Newcastle</option>
            </select>
          </div>

          <div class="mini-filter">
            <label for="staffingAreaSelect">Area</label>
            <select id="staffingAreaSelect">
              <option value="All">All</option>
              <option value="Retail">Retail</option>
              <option value="Kitchen">Kitchen</option>
              <option value="Hospitality">Hospitality</option>
            </select>
          </div>

          <div class="mini-filter">
            <label>Legend</label>
            <div class="legend" style="margin-top:0;">
              <span class="key"><span class="swatch" id="swSick"></span>Sickness</span>
              <span class="key"><span class="swatch" id="swHol"></span>Holiday</span>
              <span class="key"><span class="swatch" id="swAg"></span>Agency</span>
              <span class="key"><span class="swatch" id="swAvg"></span>Avg line</span>
            </div>
          </div>
        </div>

        <div class="chart-wrap">
          <div class="chart-head">
            <div class="left" id="staffingChartLabel">Mon–Fri totals (stacked)</div>
            <div class="right" id="staffingChartAvgLabel">Avg/day: 0</div>
          </div>
          <canvas id="staffingChart" width="900" height="340"></canvas>
        </div>

        <div class="metric-row" style="grid-template-columns: repeat(4, 1fr);">
          <div class="metric">
            <div class="metric-label">Week Total (Sickness)</div>
            <div class="metric-value" id="staffingTotalSick">0</div>
          </div>
          <div class="metric">
            <div class="metric-label">Week Total (Holiday)</div>
            <div class="metric-value" id="staffingTotalHol">0</div>
          </div>
          <div class="metric">
            <div class="metric-label">Week Total (Agency)</div>
            <div class="metric-value" id="staffingTotalAg">0</div>
          </div>
        </div>

        <div class="table-wrap">
          <table>
            <thead>
              <tr>
                <th>Date</th>
                <th>Day</th>
                <th>Site</th>
                <th>Area</th>
                <th>Sick</th>
                <th>Holiday</th>
                <th>Agency</th>
              </tr>
            </thead>
            <tbody id="staffingTableBody">
              <tr><td colspan="7" class="muted">No staffing data.</td></tr>
            </tbody>
          </table>
        </div>

        <div class="muted" style="font-size:11px;">
          Note: This drill-down uses the full weekly log dataset and can be filtered independently of the main dashboard.
        </div>
      </div>
    </div>
  </div>

  <script type="module">
    import { supabase } from './supabase-config.js';

    const weekPickerEl = document.getElementById('weekPicker');
    const siteFilterEl = document.getElementById('siteFilter');
    const areaFilterEl = document.getElementById('areaFilter');
    const refreshBtn = document.getElementById('refreshBtn');

    const errorMessageEl = document.getElementById('errorMessage');
    const weekLabelEl = document.getElementById('weekLabel');

    const kpiTotalLogsEl = document.getElementById('kpiTotalLogs');
    const kpiPhotosEl = document.getElementById('kpiPhotos');
    const kpiIncidentsEl = document.getElementById('kpiIncidents');
    const kpiStaffingEl = document.getElementById('kpiStaffing');
    const kpiRetailSpecialsEl = document.getElementById('kpiRetailSpecials');
    const kpiRetailSpecialsSubEl = document.getElementById('kpiRetailSpecialsSub');
    const kpiRetailSalesEl = document.getElementById('kpiRetailSales');
    const kpiRetailSalesSubEl = document.getElementById('kpiRetailSalesSub');
    const kpiRetailBreakdownEl = document.getElementById('kpiRetailBreakdown');

    const staffSicknessEl = document.getElementById('staffSickness');
    const staffHolidayEl = document.getElementById('staffHoliday');
    const staffAgencyEl = document.getElementById('staffAgency');

    const hospDayEl = document.getElementById('hospDay');
    const hospNightEl = document.getElementById('hospNight');
    const hospPlacesEl = document.getElementById('hospPlaces');
    const hospTotalEl = document.getElementById('hospTotal');

    const freeBreakfastTotalEl = document.getElementById('freeBreakfastTotal');
    const freeBreakfastDaysEl = document.getElementById('freeBreakfastDays');

    const hotLunchTotalEl = document.getElementById('hotLunchTotal');
    const hotLunchAvgEl = document.getElementById('hotLunchAvg');
    const hotLunchDaysEl = document.getElementById('hotLunchDays');

    const hotLunchChartEl = document.getElementById('hotLunchChart');
    const hotLunchChartAvgLabelEl = document.getElementById('hotLunchChartAvgLabel');
    const hotLunchChartLabelEl = document.getElementById('hotLunchChartLabel');

    const maintEmptyEl = document.getElementById('maintEmpty');
    const maintListEl = document.getElementById('maintList');
    const hsEmptyEl = document.getElementById('hsEmpty');
    const hsListEl = document.getElementById('hsList');

    const hospNotesEmptyEl = document.getElementById('hospNotesEmpty');
    const hospNotesListEl = document.getElementById('hospNotesList');

    const specialsEmptyEl = document.getElementById('specialsEmpty');
    const specialsListEl = document.getElementById('specialsList');

    const notesEmptyEl = document.getElementById('notesEmpty');
    const notesListEl = document.getElementById('notesList');

    const photosEmptyEl = document.getElementById('photosEmpty');
    const photosGridEl = document.getElementById('photosGrid');

    const weeklySummaryBtn = document.getElementById('generateWeeklySummaryBtn');
    const weeklySummaryBox = document.getElementById('weeklySummaryBox');
    const weeklySummaryText = document.getElementById('weeklySummaryText');

    const photoModalEl = document.getElementById('photoModal');
    const modalTitleEl = document.getElementById('modalTitle');
    const modalImgEl = document.getElementById('modalImg');
    const modalNotesEl = document.getElementById('modalNotes');
    const closeModalBtn = document.getElementById('closeModalBtn');

    // Retail elements
    const salesTotalEl = document.getElementById('salesTotal');
    const salesTxEl = document.getElementById('salesTx');
    const salesSPHEl = document.getElementById('salesSPH');
    const salesWoWLabelEl = document.getElementById('salesWoWLabel');
    const salesWoWValueEl = document.getElementById('salesWoWValue');
    const salesWoWPctEl = document.getElementById('salesWoWPct');
    const salesWoWLineEl = document.getElementById('salesWoWLine');
    const salesEmptyEl = document.getElementById('salesEmpty');
    const salesListEl = document.getElementById('salesList');

    const retailSalesChartEl = document.getElementById('retailSalesChart');
    const retailChartAvgLabelEl = document.getElementById('retailChartAvgLabel');
    const retailChartLabelEl = document.getElementById('retailChartLabel');
    const retailChartLegendEl = document.getElementById('retailChartLegend');

    const bestFloorBadgeEl = document.getElementById('bestFloorBadge');
    const worstFloorBadgeEl = document.getElementById('worstFloorBadge');

    // Staffing drilldown elements
    const openStaffingDrillBtn = document.getElementById('openStaffingDrillBtn');
    const staffingModalEl = document.getElementById('staffingModal');
    const closeStaffingModalBtn = document.getElementById('closeStaffingModalBtn');
    const staffingWeekLabelEl = document.getElementById('staffingWeekLabel');

    const staffingSiteSelectEl = document.getElementById('staffingSiteSelect');
    const staffingAreaSelectEl = document.getElementById('staffingAreaSelect');

    const staffingChartEl = document.getElementById('staffingChart');
    const staffingChartLabelEl = document.getElementById('staffingChartLabel');
    const staffingChartAvgLabelEl = document.getElementById('staffingChartAvgLabel');

    const staffingTotalSickEl = document.getElementById('staffingTotalSick');
    const staffingTotalHolEl = document.getElementById('staffingTotalHol');
    const staffingTotalAgEl = document.getElementById('staffingTotalAg');

    const staffingTableBodyEl = document.getElementById('staffingTableBody');

    const swSickEl = document.getElementById('swSick');
    const swHolEl = document.getElementById('swHol');
    const swAgEl = document.getElementById('swAg');
    const swAvgEl = document.getElementById('swAvg');

    let opsRowsCache = [];           // filtered for page
    let opsRowsWeekAll = [];         // ALL weekly rows (for drilldown)

    let lastHotLunchChartPayload = null;
    let lastRetailChartPayload = null;
    let lastStaffingChartPayload = null;

    const CHART_COLORS = {
      lvl7Fill: 'rgba(59,130,246,0.55)',
      lvl7Stroke: 'rgba(59,130,246,0.85)',
      lvl5Fill: 'rgba(16,185,129,0.45)',
      lvl5Stroke: 'rgba(16,185,129,0.80)',
      lvl4Fill: 'rgba(236,72,153,0.42)',
      lvl4Stroke: 'rgba(236,72,153,0.80)',
      lvl3Fill: 'rgba(245,158,11,0.45)',
      lvl3Stroke: 'rgba(245,158,11,0.82)',
      avgLine: 'rgba(255,255,255,0.70)',
      grid: 'rgba(255,255,255,0.08)',
      textMain: 'rgba(255,255,255,0.85)',
      textSub: 'rgba(255,255,255,0.70)',
      labelSoft: 'rgba(255,255,255,0.45)',

      sickFill: 'rgba(239,68,68,0.40)',
      sickStroke: 'rgba(239,68,68,0.75)',
      holFill: 'rgba(59,130,246,0.40)',
      holStroke: 'rgba(59,130,246,0.78)',
      agFill: 'rgba(245,158,11,0.42)',
      agStroke: 'rgba(245,158,11,0.80)'
    };

    // Apply legend swatches
    (function initLegendSwatches(){
      if (retailChartLegendEl) {
        const swatches = retailChartLegendEl.querySelectorAll('.swatch');
        swatches.forEach(s => {
          const k = s.getAttribute('data-swatch');
          if (k === 'lvl7') s.style.background = CHART_COLORS.lvl7Fill;
          if (k === 'lvl5') s.style.background = CHART_COLORS.lvl5Fill;
          if (k === 'lvl4') s.style.background = CHART_COLORS.lvl4Fill;
          if (k === 'lvl3') s.style.background = CHART_COLORS.lvl3Fill;
          if (k === 'avg')  s.style.background = CHART_COLORS.avgLine;
        });
      }

      if (swSickEl) swSickEl.style.background = CHART_COLORS.sickFill;
      if (swHolEl)  swHolEl.style.background = CHART_COLORS.holFill;
      if (swAgEl)   swAgEl.style.background = CHART_COLORS.agFill;
      if (swAvgEl)  swAvgEl.style.background = CHART_COLORS.avgLine;
    })();

    function safeNum(v) {
      const n = Number(v);
      return Number.isFinite(n) ? n : 0;
    }

    function safeText(v) {
      return (v ?? '').toString().trim();
    }

    function hasMeaningfulText(v) {
      return safeText(v).length > 0;
    }

    function isIncidentFlagTrue(v) {
      const t = safeText(v).toLowerCase();
      return t === 'yes' || t === 'true' || t === '1';
    }

    function startOfWeekMonday(d) {
      const date = new Date(d);
      const day = date.getDay();
      const diff = (day === 0 ? -6 : 1) - day;
      date.setDate(date.getDate() + diff);
      date.setHours(0,0,0,0);
      return date;
    }

    function addDays(d, days) {
      const date = new Date(d);
      date.setDate(date.getDate() + days);
      return date;
    }

    function toISODate(d) {
      const yyyy = d.getFullYear();
      const mm = String(d.getMonth() + 1).padStart(2, '0');
      const dd = String(d.getDate()).padStart(2, '0');
      return `${yyyy}-${mm}-${dd}`;
    }

    function dayNameFromISO(iso) {
      const dt = new Date(iso + 'T00:00:00');
      const names = ['Sun','Mon','Tue','Wed','Thu','Fri','Sat'];
      return names[dt.getDay()];
    }

    function money(n) {
      return `£${Number(n || 0).toFixed(2)}`;
    }

    function calcSPH(sales, tx) {
      const s = safeNum(sales);
      const t = safeNum(tx);
      return t > 0 ? s / t : 0;
    }

    function fmtSignedMoney(n) {
      const v = Number(n || 0);
      const sign = v > 0 ? '+' : (v < 0 ? '-' : '');
      return `${sign}£${Math.abs(v).toFixed(2)}`;
    }

    function fmtSignedPctFrom(prev, curr) {
      const p = Number(prev || 0);
      const c = Number(curr || 0);
      if (p === 0) return '—';
      const pct = ((c - p) / p) * 100;
      const sign = pct > 0 ? '+' : (pct < 0 ? '-' : '');
      return `${sign}${Math.abs(pct).toFixed(1)}%`;
    }

    function wowClassFromDelta(delta, pctText) {
      if (pctText === '—') return 'wow-neutral';
      if (delta > 0.00001) return 'wow-pos';
      if (delta < -0.00001) return 'wow-neg';
      return 'wow-neutral';
    }

    function matchesFilter(row, site, area) {
      const rowSite = (row.site || '').toString();
      const rowArea = (row.area || '').toString();
      const siteOk = site === 'All' ? true : rowSite === site;
      const areaOk = area === 'All' ? true : rowArea === area;
      return siteOk && areaOk;
    }

    function renderList(containerEl, emptyEl, items) {
      containerEl.innerHTML = '';
      if (!items || items.length === 0) {
        emptyEl.style.display = 'block';
        return;
      }
      emptyEl.style.display = 'none';

      items.forEach(it => {
        const div = document.createElement('div');
        div.className = 'list-item';
        div.innerHTML = `
          <div class="list-title">
            <span>${it.title}</span>
            ${it.badge ? `<span class="badge">${it.badge}</span>` : ``}
          </div>
          <div class="list-notes">${(it.notes || '').replace(/</g, '&lt;')}</div>
        `;
        containerEl.appendChild(div);
      });
    }

    async function loadWeeklyOpsLogs(startDateStr, endDateStr) {
      const { data, error } = await supabase
        .from('ops_logs')
        .select('*')
        .or(`and(log_date.gte.${startDateStr},log_date.lte.${endDateStr}),and(log_date.is.null,created_at.gte.${startDateStr}T00:00:00Z,created_at.lte.${endDateStr}T23:59:59Z)`)
        .order('log_date', { ascending: true })
        .order('created_at', { ascending: true });

      if (error) throw error;
      return data || [];
    }

    async function loadWeeklyRetailSales(startDateStr, endDateStr) {
      const { data, error } = await supabase
        .from('retail_sales')
        .select('*')
        .gte('sales_date', startDateStr)
        .lte('sales_date', endDateStr)
        .order('sales_date', { ascending: true })
        .order('level', { ascending: true });

      if (error) throw error;
      return data || [];
    }

    function aggregateSalesByLevel(rows) {
      const levels = ['Level 7', 'Level 5', 'Level 4', 'Level 3'];
      const map = new Map();
      levels.forEach(l => map.set(l, { sales: 0, tx: 0 }));

      for (const r of (rows || [])) {
        const lvl = (r.level || '').toString();
        if (!map.has(lvl)) continue;
        const agg = map.get(lvl);
        agg.sales += safeNum(r.sales);
        agg.tx += safeNum(r.transactions);
      }
      return map;
    }

    function computeRetailSalesDaily(rows, weekStartStr) {
      const start = new Date(weekStartStr + 'T00:00:00');
      const dayKeys = [];
      for (let i = 0; i < 5; i++) dayKeys.push(toISODate(addDays(start, i)));

      const levels = ['Level 7', 'Level 5', 'Level 4', 'Level 3'];
      const totalsByLevel = {};
      levels.forEach(l => totalsByLevel[l] = new Map(dayKeys.map(d => [d, 0])));

      for (const r of (rows || [])) {
        const d = (r.sales_date || '').toString().slice(0, 10);
        const lvl = (r.level || '').toString();
        if (!dayKeys.includes(d)) continue;
        if (!totalsByLevel[lvl]) continue;
        totalsByLevel[lvl].set(d, (totalsByLevel[lvl].get(d) || 0) + safeNum(r.sales));
      }

      const labels = ['Mon', 'Tue', 'Wed', 'Thu', 'Fri'];

      const dayTotalsByLevel = {
        'Level 7': dayKeys.map(d => totalsByLevel['Level 7'].get(d) || 0),
        'Level 5': dayKeys.map(d => totalsByLevel['Level 5'].get(d) || 0),
        'Level 4': dayKeys.map(d => totalsByLevel['Level 4'].get(d) || 0),
        'Level 3': dayKeys.map(d => totalsByLevel['Level 3'].get(d) || 0),
      };

      const dailyGrand = dayKeys.map((_, i) =>
        dayTotalsByLevel['Level 7'][i] +
        dayTotalsByLevel['Level 5'][i] +
        dayTotalsByLevel['Level 4'][i] +
        dayTotalsByLevel['Level 3'][i]
      );

      const avgGrand = dailyGrand.reduce((s, v) => s + v, 0) / 5;

      return { labels, dayKeys, dayTotalsByLevel, dailyGrand, avgGrand };
    }

    function scaleCanvasToDisplaySize(canvas) {
      const rect = canvas.getBoundingClientRect();
      const dpr = Math.max(1, window.devicePixelRatio || 1);
      const width = Math.floor(rect.width * dpr);
      const height = Math.floor(rect.height * dpr);
      if (canvas.width !== width || canvas.height !== height) {
        canvas.width = width;
        canvas.height = height;
        return true;
      }
      return false;
    }

    function drawHotLunchChart(labels, values, avg, weekRangeText) {
      if (!hotLunchChartEl) return;

      scaleCanvasToDisplaySize(hotLunchChartEl);
      const ctx = hotLunchChartEl.getContext('2d');
      const w = hotLunchChartEl.width;
      const h = hotLunchChartEl.height;

      ctx.clearRect(0, 0, w, h);

      const padL = Math.floor(w * 0.06);
      const padR = Math.floor(w * 0.03);
      const padT = Math.floor(h * 0.10);
      const padB = Math.floor(h * 0.18);

      const plotW = w - padL - padR;
      const plotH = h - padT - padB;

      const maxV = Math.max(1, ...values, avg || 0);
      const yMax = maxV * 1.15;

      function yFor(v) {
        return padT + (plotH - (v / yMax) * plotH);
      }

      ctx.strokeStyle = CHART_COLORS.grid;
      ctx.lineWidth = 1;
      const gridCount = 4;
      for (let i = 0; i <= gridCount; i++) {
        const y = padT + (plotH / gridCount) * i;
        ctx.beginPath();
        ctx.moveTo(padL, y);
        ctx.lineTo(padL + plotW, y);
        ctx.stroke();
      }

      const n = values.length;
      const gap = Math.floor(plotW * 0.03);
      const barW = Math.floor((plotW - gap * (n - 1)) / n);

      for (let i = 0; i < n; i++) {
        const v = values[i] || 0;
        const x = padL + i * (barW + gap);
        const y = yFor(v);
        const bh = (padT + plotH) - y;

        ctx.fillStyle = CHART_COLORS.lvl7Fill;
        ctx.fillRect(x, y, barW, bh);

        ctx.strokeStyle = CHART_COLORS.lvl7Stroke;
        ctx.strokeRect(x + 0.5, y + 0.5, barW - 1, bh - 1);

        ctx.fillStyle = CHART_COLORS.textMain;
        ctx.font = `${Math.floor(h * 0.06)}px system-ui, -apple-system, Segoe UI, sans-serif`;
        ctx.textAlign = 'center';
        ctx.textBaseline = 'bottom';
        ctx.fillText(String(Math.round(v)), x + barW / 2, y - 6);

        ctx.fillStyle = CHART_COLORS.textSub;
        ctx.font = `${Math.floor(h * 0.055)}px system-ui, -apple-system, Segoe UI, sans-serif`;
        ctx.textBaseline = 'top';
        ctx.fillText(labels[i] || '', x + barW / 2, padT + plotH + 10);
      }

      const yAvg = yFor(avg || 0);
      ctx.strokeStyle = CHART_COLORS.lvl4Stroke;
      ctx.lineWidth = 2;
      ctx.beginPath();
      ctx.moveTo(padL, yAvg);
      ctx.lineTo(padL + plotW, yAvg);
      ctx.stroke();

      ctx.fillStyle = CHART_COLORS.lvl4Stroke;
      ctx.font = `${Math.floor(h * 0.055)}px system-ui, -apple-system, Segoe UI, sans-serif`;
      ctx.textAlign = 'left';
      ctx.textBaseline = 'bottom';
      ctx.fillText(`Avg ${Math.round(avg || 0)}`, padL + 6, yAvg - 6);

      if (weekRangeText) {
        ctx.fillStyle = CHART_COLORS.labelSoft;
        ctx.font = `${Math.floor(h * 0.05)}px system-ui, -apple-system, Segoe UI, sans-serif`;
        ctx.textAlign = 'right';
        ctx.textBaseline = 'top';
        ctx.fillText(weekRangeText, padL + plotW, 8);
      }
    }

    function drawRetailSalesChart(labels, dayTotalsByLevel, dailyGrand, avgGrand, weekRangeText) {
      if (!retailSalesChartEl) return;

      scaleCanvasToDisplaySize(retailSalesChartEl);
      const ctx = retailSalesChartEl.getContext('2d');
      const w = retailSalesChartEl.width;
      const h = retailSalesChartEl.height;

      ctx.clearRect(0, 0, w, h);

      const padL = Math.floor(w * 0.06);
      const padR = Math.floor(w * 0.03);
      const padT = Math.floor(h * 0.10);
      const padB = Math.floor(h * 0.18);

      const plotW = w - padL - padR;
      const plotH = h - padT - padB;

      const maxV = Math.max(1, ...(dailyGrand || [0]), avgGrand || 0);
      const yMax = maxV * 1.15;

      function yFor(v) {
        return padT + (plotH - (v / yMax) * plotH);
      }

      ctx.strokeStyle = CHART_COLORS.grid;
      ctx.lineWidth = 1;
      const gridCount = 4;
      for (let i = 0; i <= gridCount; i++) {
        const y = padT + (plotH / gridCount) * i;
        ctx.beginPath();
        ctx.moveTo(padL, y);
        ctx.lineTo(padL + plotW, y);
        ctx.stroke();
      }

      const n = labels.length;
      const gap = Math.floor(plotW * 0.03);
      const barW = Math.floor((plotW - gap * (n - 1)) / n);

      const lvl7 = dayTotalsByLevel['Level 7'] || [0,0,0,0,0];
      const lvl5 = dayTotalsByLevel['Level 5'] || [0,0,0,0,0];
      const lvl4 = dayTotalsByLevel['Level 4'] || [0,0,0,0,0];
      const lvl3 = dayTotalsByLevel['Level 3'] || [0,0,0,0,0];

      for (let i = 0; i < n; i++) {
        const x = padL + i * (barW + gap);

        const v7 = lvl7[i] || 0;
        const v5 = lvl5[i] || 0;
        const v4 = lvl4[i] || 0;
        const v3 = lvl3[i] || 0;
        const total = v7 + v5 + v4 + v3;

        let yBottom = padT + plotH;

        function drawSeg(val, fill, stroke) {
          if (val <= 0) return;
          const segH = (val / yMax) * plotH;
          const yTop = yBottom - segH;

          ctx.fillStyle = fill;
          ctx.fillRect(x, yTop, barW, segH);

          ctx.strokeStyle = stroke;
          ctx.strokeRect(x + 0.5, yTop + 0.5, barW - 1, Math.max(0, segH - 1));

          yBottom = yTop;
        }

        drawSeg(v3, CHART_COLORS.lvl3Fill, CHART_COLORS.lvl3Stroke);
        drawSeg(v4, CHART_COLORS.lvl4Fill, CHART_COLORS.lvl4Stroke);
        drawSeg(v5, CHART_COLORS.lvl5Fill, CHART_COLORS.lvl5Stroke);
        drawSeg(v7, CHART_COLORS.lvl7Fill, CHART_COLORS.lvl7Stroke);

        const yTopOfBar = yFor(total);
        ctx.fillStyle = CHART_COLORS.textMain;
        ctx.font = `${Math.floor(h * 0.055)}px system-ui, -apple-system, Segoe UI, sans-serif`;
        ctx.textAlign = 'center';
        ctx.textBaseline = 'bottom';
        ctx.fillText(`£${Math.round(total)}`, x + barW / 2, yTopOfBar - 6);

        ctx.fillStyle = CHART_COLORS.textSub;
        ctx.font = `${Math.floor(h * 0.055)}px system-ui, -apple-system, Segoe UI, sans-serif`;
        ctx.textBaseline = 'top';
        ctx.fillText(labels[i] || '', x + barW / 2, padT + plotH + 10);
      }

      const yAvg = yFor(avgGrand || 0);
      ctx.strokeStyle = CHART_COLORS.avgLine;
      ctx.lineWidth = 2;
      ctx.beginPath();
      ctx.moveTo(padL, yAvg);
      ctx.lineTo(padL + plotW, yAvg);
      ctx.stroke();

      ctx.fillStyle = CHART_COLORS.avgLine;
      ctx.font = `${Math.floor(h * 0.055)}px system-ui, -apple-system, Segoe UI, sans-serif`;
      ctx.textAlign = 'left';
      ctx.textBaseline = 'bottom';
      ctx.fillText(`Avg ${money(avgGrand || 0)}`, padL + 6, yAvg - 6);

      if (weekRangeText) {
        ctx.fillStyle = CHART_COLORS.labelSoft;
        ctx.font = `${Math.floor(h * 0.05)}px system-ui, -apple-system, Segoe UI, sans-serif`;
        ctx.textAlign = 'right';
        ctx.textBaseline = 'top';
        ctx.fillText(weekRangeText, padL + plotW, 8);
      }
    }

    function computeHotLunchDaily(opsRows, weekStartStr) {
      const start = new Date(weekStartStr + 'T00:00:00');
      const days = [];
      for (let i = 0; i < 5; i++) days.push(toISODate(addDays(start, i)));

      const totalsByDate = new Map();
      days.forEach(d => totalsByDate.set(d, 0));

      for (const r of opsRows) {
        if ((r.site || '') !== 'Newcastle') continue;
        const dateKey = (r.log_date || (r.created_at ? String(r.created_at).slice(0,10) : '')).slice(0,10);
        if (!totalsByDate.has(dateKey)) continue;
        totalsByDate.set(dateKey, totalsByDate.get(dateKey) + safeNum(r.hot_lunch_dishes));
      }

      const labels = ['Mon', 'Tue', 'Wed', 'Thu', 'Fri'];
      const values = days.map(d => totalsByDate.get(d) || 0);

      const daysWithEntries = new Set(
        opsRows
          .filter(r => (r.site || '') === 'Newcastle')
          .map(r => (r.log_date || (r.created_at ? String(r.created_at).slice(0,10) : '')).slice(0,10))
          .filter(d => totalsByDate.has(d))
      );

      const total = values.reduce((s,v) => s + v, 0);
      const avg = daysWithEntries.size ? (total / daysWithEntries.size) : 0;

      return { labels, values, total, avg, daysWithEntriesCount: daysWithEntries.size };
    }

    function clearRetailBadges() {
      bestFloorBadgeEl.style.display = 'none';
      worstFloorBadgeEl.style.display = 'none';
      bestFloorBadgeEl.textContent = '';
      worstFloorBadgeEl.textContent = '';
    }

    function applyRetailBadges(currMap) {
      clearRetailBadges();

      const floors = ['Level 7','Level 5','Level 4','Level 3'];
      const entries = floors.map(f => ({ floor: f, sales: (currMap.get(f)?.sales || 0) }));

      const any = entries.some(e => e.sales > 0);
      if (!any) return;

      entries.sort((a,b) => b.sales - a.sales);
      const best = entries[0];
      const worst = entries[entries.length - 1];

      bestFloorBadgeEl.textContent = `Best: ${best.floor} (${money(best.sales)})`;
      worstFloorBadgeEl.textContent = `Lowest: ${worst.floor} (${money(worst.sales)})`;

      bestFloorBadgeEl.style.display = 'inline-flex';
      worstFloorBadgeEl.style.display = 'inline-flex';
    }

    function setWoWColour(delta, pctText) {
      salesWoWLineEl.classList.remove('wow-pos','wow-neg','wow-neutral');
      salesWoWLineEl.classList.add(wowClassFromDelta(delta, pctText));
    }

    function renderRetail(currentRows, prevRows, prevStartStr, prevEndStr, weekStartStr, weekEndStr) {
      salesListEl.innerHTML = '';

      const currMap = aggregateSalesByLevel(currentRows);
      const prevMap = aggregateSalesByLevel(prevRows);

      salesWoWLabelEl.textContent = `${prevStartStr}→${prevEndStr}`;

      let grandCurrSales = 0, grandCurrTx = 0;
      let grandPrevSales = 0, grandPrevTx = 0;

      for (const lvl of ['Level 7','Level 5','Level 4','Level 3']) {
        const c = currMap.get(lvl) || { sales:0, tx:0 };
        const p = prevMap.get(lvl) || { sales:0, tx:0 };
        grandCurrSales += c.sales; grandCurrTx += c.tx;
        grandPrevSales += p.sales; grandPrevTx += p.tx;
      }

      const anyCurr = grandCurrSales > 0 || grandCurrTx > 0;
      salesEmptyEl.style.display = anyCurr ? 'none' : 'block';

      const grandSPH = calcSPH(grandCurrSales, grandCurrTx);
      salesTotalEl.textContent = money(grandCurrSales);
      salesTxEl.textContent = String(Math.round(grandCurrTx));
      salesSPHEl.textContent = money(grandSPH);

      const grandDelta = grandCurrSales - grandPrevSales;
      const grandPct = fmtSignedPctFrom(grandPrevSales, grandCurrSales);

      salesWoWValueEl.innerHTML = `<strong>${fmtSignedMoney(grandDelta)}</strong>`;
      salesWoWPctEl.innerHTML = `<strong>${grandPct}</strong>`;
      setWoWColour(grandDelta, grandPct);

      kpiRetailSalesEl.textContent = money(grandCurrSales);
      kpiRetailSalesSubEl.textContent = `${Math.round(grandCurrTx)} tx • SPH ${money(grandSPH)}`;

      const l7 = currMap.get('Level 7')?.sales || 0;
      const l5 = currMap.get('Level 5')?.sales || 0;
      const l4 = currMap.get('Level 4')?.sales || 0;
      const l3 = currMap.get('Level 3')?.sales || 0;
      kpiRetailBreakdownEl.textContent = `L7 ${money(l7)} • L5 ${money(l5)} • L4 ${money(l4)} • L3 ${money(l3)}`;

      applyRetailBadges(currMap);

      const items = [];
      for (const lvl of ['Level 7','Level 5','Level 4','Level 3']) {
        const c = currMap.get(lvl) || { sales:0, tx:0 };
        const p = prevMap.get(lvl) || { sales:0, tx:0 };

        const sph = calcSPH(c.sales, c.tx);
        const delta = c.sales - p.sales;
        const pct = fmtSignedPctFrom(p.sales, c.sales);

        items.push({
          title: lvl,
          badge: `SPH ${money(sph)}`,
          notes:
            `This week: ${money(c.sales)} • ${Math.round(c.tx)} tx\n` +
            `Vs last week: ${fmtSignedMoney(delta)} (${pct})`
        });
      }
      renderList(salesListEl, salesEmptyEl, items);

      const daily = computeRetailSalesDaily(currentRows, weekStartStr);
      retailChartLabelEl.textContent = `${weekStartStr} → ${weekEndStr} (Mon–Fri)`;
      retailChartAvgLabelEl.textContent = `Avg/day: ${money(daily.avgGrand)}`;

      lastRetailChartPayload = {
        labels: daily.labels,
        dayTotalsByLevel: daily.dayTotalsByLevel,
        dailyGrand: daily.dailyGrand,
        avgGrand: daily.avgGrand,
        weekRangeText: `${weekStartStr}→${weekEndStr}`
      };

      drawRetailSalesChart(
        lastRetailChartPayload.labels,
        lastRetailChartPayload.dayTotalsByLevel,
        lastRetailChartPayload.dailyGrand,
        lastRetailChartPayload.avgGrand,
        lastRetailChartPayload.weekRangeText
      );
    }

    // --- Staffing Drilldown (Option A) ---
    function computeStaffingDaily(rows, weekStartStr, siteFilter, areaFilter) {
      const start = new Date(weekStartStr + 'T00:00:00');
      const dayKeys = [];
      for (let i = 0; i < 5; i++) dayKeys.push(toISODate(addDays(start, i)));

      const keyOk = (r) => {
        const rs = (r.site || '').toString();
        const ra = (r.area || '').toString();
        if (siteFilter !== 'All' && rs !== siteFilter) return false;
        if (areaFilter !== 'All' && ra !== areaFilter) return false;
        return true;
      };

      const sick = dayKeys.map(() => 0);
      const hol = dayKeys.map(() => 0);
      const ag = dayKeys.map(() => 0);

      for (const r of (rows || [])) {
        if (!keyOk(r)) continue;
        const d = (r.log_date || (r.created_at ? String(r.created_at).slice(0,10) : '')).slice(0,10);
        const idx = dayKeys.indexOf(d);
        if (idx < 0) continue;

        sick[idx] += safeNum(r.sickness_count);
        hol[idx]  += safeNum(r.holiday_count);
        ag[idx]   += safeNum(r.agency_count);
      }

      const totals = {
        sick: sick.reduce((s,v) => s+v, 0),
        hol: hol.reduce((s,v) => s+v, 0),
        ag: ag.reduce((s,v) => s+v, 0),
      };

      const dailyGrand = dayKeys.map((_, i) => sick[i] + hol[i] + ag[i]);
      const avgGrand = dailyGrand.reduce((s,v) => s+v, 0) / 5;

      return {
        labels: ['Mon','Tue','Wed','Thu','Fri'],
        dayKeys,
        sick,
        hol,
        ag,
        totals,
        dailyGrand,
        avgGrand
      };
    }

    function drawStaffingChart(labels, sick, hol, ag, avgGrand, weekRangeText) {
      if (!staffingChartEl) return;

      scaleCanvasToDisplaySize(staffingChartEl);
      const ctx = staffingChartEl.getContext('2d');
      const w = staffingChartEl.width;
      const h = staffingChartEl.height;

      ctx.clearRect(0, 0, w, h);

      const padL = Math.floor(w * 0.06);
      const padR = Math.floor(w * 0.03);
      const padT = Math.floor(h * 0.10);
      const padB = Math.floor(h * 0.18);

      const plotW = w - padL - padR;
      const plotH = h - padT - padB;

      const dailyGrand = labels.map((_, i) => (sick[i]||0) + (hol[i]||0) + (ag[i]||0));
      const maxV = Math.max(1, ...dailyGrand, avgGrand || 0);
      const yMax = maxV * 1.20;

      function yFor(v) {
        return padT + (plotH - (v / yMax) * plotH);
      }

      // grid
      ctx.strokeStyle = CHART_COLORS.grid;
      ctx.lineWidth = 1;
      const gridCount = 4;
      for (let i = 0; i <= gridCount; i++) {
        const y = padT + (plotH / gridCount) * i;
        ctx.beginPath();
        ctx.moveTo(padL, y);
        ctx.lineTo(padL + plotW, y);
        ctx.stroke();
      }

      const n = labels.length;
      const gap = Math.floor(plotW * 0.03);
      const barW = Math.floor((plotW - gap * (n - 1)) / n);

      for (let i = 0; i < n; i++) {
        const x = padL + i * (barW + gap);

        const vS = sick[i] || 0;
        const vH = hol[i] || 0;
        const vA = ag[i] || 0;
        const total = vS + vH + vA;

        let yBottom = padT + plotH;

        function drawSeg(val, fill, stroke) {
          if (val <= 0) return;
          const segH = (val / yMax) * plotH;
          const yTop = yBottom - segH;

          ctx.fillStyle = fill;
          ctx.fillRect(x, yTop, barW, segH);

          ctx.strokeStyle = stroke;
          ctx.strokeRect(x + 0.5, yTop + 0.5, barW - 1, Math.max(0, segH - 1));

          yBottom = yTop;
        }

        // bottom -> top (agency, holiday, sickness)
        drawSeg(vA, CHART_COLORS.agFill, CHART_COLORS.agStroke);
        drawSeg(vH, CHART_COLORS.holFill, CHART_COLORS.holStroke);
        drawSeg(vS, CHART_COLORS.sickFill, CHART_COLORS.sickStroke);

        // label total
        const yTopOfBar = yFor(total);
        ctx.fillStyle = CHART_COLORS.textMain;
        ctx.font = `${Math.floor(h * 0.055)}px system-ui, -apple-system, Segoe UI, sans-serif`;
        ctx.textAlign = 'center';
        ctx.textBaseline = 'bottom';
        ctx.fillText(String(Math.round(total)), x + barW / 2, yTopOfBar - 6);

        // x labels
        ctx.fillStyle = CHART_COLORS.textSub;
        ctx.font = `${Math.floor(h * 0.055)}px system-ui, -apple-system, Segoe UI, sans-serif`;
        ctx.textBaseline = 'top';
        ctx.fillText(labels[i] || '', x + barW / 2, padT + plotH + 10);
      }

      // avg line
      const yAvg = yFor(avgGrand || 0);
      ctx.strokeStyle = CHART_COLORS.avgLine;
      ctx.lineWidth = 2;
      ctx.beginPath();
      ctx.moveTo(padL, yAvg);
      ctx.lineTo(padL + plotW, yAvg);
      ctx.stroke();

      ctx.fillStyle = CHART_COLORS.avgLine;
      ctx.font = `${Math.floor(h * 0.055)}px system-ui, -apple-system, Segoe UI, sans-serif`;
      ctx.textAlign = 'left';
      ctx.textBaseline = 'bottom';
      ctx.fillText(`Avg ${Math.round(avgGrand || 0)}`, padL + 6, yAvg - 6);

      if (weekRangeText) {
        ctx.fillStyle = CHART_COLORS.labelSoft;
        ctx.font = `${Math.floor(h * 0.05)}px system-ui, -apple-system, Segoe UI, sans-serif`;
        ctx.textAlign = 'right';
        ctx.textBaseline = 'top';
        ctx.fillText(weekRangeText, padL + plotW, 8);
      }
    }

    function renderStaffingDrilldown(weekStartStr, weekEndStr) {
      const sSite = staffingSiteSelectEl.value;
      const sArea = staffingAreaSelectEl.value;

      staffingWeekLabelEl.textContent = `${weekStartStr} → ${weekEndStr}`;
      staffingChartLabelEl.textContent = `${weekStartStr} → ${weekEndStr} (Mon–Fri) • ${sSite} • ${sArea}`;

      const computed = computeStaffingDaily(opsRowsWeekAll, weekStartStr, sSite, sArea);

      staffingChartAvgLabelEl.textContent = `Avg/day: ${Math.round(computed.avgGrand || 0)}`;

      staffingTotalSickEl.textContent = String(Math.round(computed.totals.sick));
      staffingTotalHolEl.textContent = String(Math.round(computed.totals.hol));
      staffingTotalAgEl.textContent = String(Math.round(computed.totals.ag));

      lastStaffingChartPayload = {
        labels: computed.labels,
        sick: computed.sick,
        hol: computed.hol,
        ag: computed.ag,
        avgGrand: computed.avgGrand,
        weekRangeText: `${weekStartStr}→${weekEndStr}`
      };

      drawStaffingChart(
        lastStaffingChartPayload.labels,
        lastStaffingChartPayload.sick,
        lastStaffingChartPayload.hol,
        lastStaffingChartPayload.ag,
        lastStaffingChartPayload.avgGrand,
        lastStaffingChartPayload.weekRangeText
      );

      // Table: show individual log rows that have staffing impact
      const start = new Date(weekStartStr + 'T00:00:00');
      const dayKeys = [];
      for (let i = 0; i < 5; i++) dayKeys.push(toISODate(addDays(start, i)));

      const rows = (opsRowsWeekAll || [])
        .filter(r => {
          const rs = (r.site || '').toString();
          const ra = (r.area || '').toString();
          if (sSite !== 'All' && rs !== sSite) return false;
          if (sArea !== 'All' && ra !== sArea) return false;

          const d = (r.log_date || (r.created_at ? String(r.created_at).slice(0,10) : '')).slice(0,10);
          if (!dayKeys.includes(d)) return false;

          const sick = safeNum(r.sickness_count);
          const hol = safeNum(r.holiday_count);
          const ag = safeNum(r.agency_count);
          return (sick + hol + ag) > 0;
        })
        .map(r => {
          const date = (r.log_date || (r.created_at ? String(r.created_at).slice(0,10) : '')).slice(0,10);
          return {
            date,
            day: dayNameFromISO(date),
            site: (r.site || '').toString() || '—',
            area: (r.area || '').toString() || '—',
            sick: safeNum(r.sickness_count),
            hol: safeNum(r.holiday_count),
            ag: safeNum(r.agency_count),
          };
        })
        .sort((a,b) => (a.date.localeCompare(b.date) || a.site.localeCompare(b.site) || a.area.localeCompare(b.area)));

      staffingTableBodyEl.innerHTML = '';
      if (rows.length === 0) {
        staffingTableBodyEl.innerHTML = `<tr><td colspan="7" class="muted">No staffing impact rows for this selection.</td></tr>`;
      } else {
        rows.forEach(r => {
          const tr = document.createElement('tr');
          tr.innerHTML = `
            <td>${r.date}</td>
            <td>${r.day}</td>
            <td>${r.site}</td>
            <td>${r.area}</td>
            <td>${Math.round(r.sick)}</td>
            <td>${Math.round(r.hol)}</td>
            <td>${Math.round(r.ag)}</td>
          `;
          staffingTableBodyEl.appendChild(tr);
        });
      }
    }

    function clearAll() {
      errorMessageEl.style.display = 'none';
      errorMessageEl.textContent = '';

      kpiTotalLogsEl.textContent = '0';
      kpiPhotosEl.textContent = '0';
      kpiIncidentsEl.textContent = '0';
      kpiStaffingEl.textContent = '0';
      kpiRetailSpecialsEl.textContent = '0';
      kpiRetailSpecialsSubEl.textContent = 'Days with specials';
      kpiRetailSalesEl.textContent = '£0.00';
      kpiRetailSalesSubEl.textContent = 'Transactions • SPH';
      kpiRetailBreakdownEl.textContent = 'L7 £0 • L5 £0 • L4 £0 • L3 £0';

      staffSicknessEl.textContent = '0';
      staffHolidayEl.textContent = '0';
      staffAgencyEl.textContent = '0';

      hospDayEl.textContent = '0';
      hospNightEl.textContent = '0';
      hospTotalEl.textContent = '0';

      freeBreakfastTotalEl.textContent = '0';
      freeBreakfastDaysEl.textContent = '0';

      hotLunchTotalEl.textContent = '0';
      hotLunchAvgEl.textContent = '0';
      hotLunchDaysEl.textContent = '0';
      hotLunchChartAvgLabelEl.textContent = 'Avg: 0';
      hotLunchChartLabelEl.textContent = 'Mon–Fri totals';

      salesTotalEl.textContent = '£0.00';
      salesTxEl.textContent = '0';
      salesSPHEl.textContent = '£0.00';
      salesWoWLabelEl.textContent = 'WoW';
      salesWoWValueEl.innerHTML = '<strong>£0.00</strong>';
      salesWoWPctEl.innerHTML = '<strong>0.0%</strong>';
      salesWoWLineEl.classList.remove('wow-pos','wow-neg','wow-neutral');
      salesWoWLineEl.classList.add('wow-neutral');

      clearRetailBadges();

      maintListEl.innerHTML = '';
      hsListEl.innerHTML = '';
      hospNotesListEl.innerHTML = '';
      specialsListEl.innerHTML = '';
      notesListEl.innerHTML = '';
      salesListEl.innerHTML = '';
      photosGridEl.innerHTML = '';

      maintEmptyEl.style.display = 'block';
      hsEmptyEl.style.display = 'block';
      hospNotesEmptyEl.style.display = 'block';
      specialsEmptyEl.style.display = 'block';
      notesEmptyEl.style.display = 'block';
      salesEmptyEl.style.display = 'block';
      photosEmptyEl.style.display = 'block';

      weeklySummaryBox.style.display = 'none';
      weeklySummaryText.textContent = '';

      drawHotLunchChart(['Mon','Tue','Wed','Thu','Fri'], [0,0,0,0,0], 0, '');
      drawRetailSalesChart(['Mon','Tue','Wed','Thu','Fri'], {
        'Level 7':[0,0,0,0,0],
        'Level 5':[0,0,0,0,0],
        'Level 4':[0,0,0,0,0],
        'Level 3':[0,0,0,0,0]
      }, [0,0,0,0,0], 0, '');

      // Reset staffing drilldown view (kept hidden unless modal open)
      staffingChartAvgLabelEl.textContent = 'Avg/day: 0';
      staffingTotalSickEl.textContent = '0';
      staffingTotalHolEl.textContent = '0';
      staffingTotalAgEl.textContent = '0';
      staffingTableBodyEl.innerHTML = `<tr><td colspan="7" class="muted">No staffing data.</td></tr>`;
      lastStaffingChartPayload = null;
    }

    async function loadWeekly() {
      clearAll();

      const picked = weekPickerEl.value ? new Date(weekPickerEl.value + 'T00:00:00') : new Date();
      const start = startOfWeekMonday(picked);
      const end = addDays(start, 4);

      const startStr = toISODate(start);
      const endStr = toISODate(end);

      const prevStart = addDays(start, -7);
      const prevEnd = addDays(end, -7);
      const prevStartStr = toISODate(prevStart);
      const prevEndStr = toISODate(prevEnd);

      weekLabelEl.textContent = `${startStr} → ${endStr}`;

      try {
        const [opsRowsRaw, salesCurrRaw, salesPrevRaw] = await Promise.all([
          loadWeeklyOpsLogs(startStr, endStr),
          loadWeeklyRetailSales(startStr, endStr),
          loadWeeklyRetailSales(prevStartStr, prevEndStr),
        ]);

        // store full weekly rows for drilldown
        opsRowsWeekAll = opsRowsRaw || [];

        const site = siteFilterEl.value;
        const area = areaFilterEl.value;

        const opsRows = (opsRowsRaw || []).filter(r => matchesFilter(r, site, area));
        opsRowsCache = opsRows;

        // KPIs
        kpiTotalLogsEl.textContent = String(opsRows.length);

        const withPhotos = opsRows.filter(r => !!safeText(r.photo_url));
        kpiPhotosEl.textContent = String(withPhotos.length);

        // Incidents
        const maintItems = opsRows
          .filter(r => isIncidentFlagTrue(r.maintenance_issue) || hasMeaningfulText(r.maintenance_notes))
          .map(r => ({
            title: `${r.site || 'Site'} • ${r.area || 'Area'} • ${r.log_date || (r.created_at ? String(r.created_at).slice(0,10) : '')}`,
            badge: '',
            notes: safeText(r.maintenance_notes) || '(No notes entered)'
          }));

        const hsItems = opsRows
          .filter(r => isIncidentFlagTrue(r.hs_issue) || hasMeaningfulText(r.hs_notes))
          .map(r => ({
            title: `${r.site || 'Site'} • ${r.area || 'Area'} • ${r.log_date || (r.created_at ? String(r.created_at).slice(0,10) : '')}`,
            badge: '',
            notes: safeText(r.hs_notes) || '(No notes entered)'
          }));

        renderList(maintListEl, maintEmptyEl, maintItems);
        renderList(hsListEl, hsEmptyEl, hsItems);
        kpiIncidentsEl.textContent = String(maintItems.length + hsItems.length);

        // Hospitality notes
        const hospNotes = opsRows
          .filter(r => (r.area || '') === 'Hospitality' && hasMeaningfulText(r.notes))
          .map(r => ({
            title: `${r.site || 'Site'} • ${r.log_date || (r.created_at ? String(r.created_at).slice(0,10) : '')}`,
            badge: '',
            notes: safeText(r.notes)
          }));
        renderList(hospNotesListEl, hospNotesEmptyEl, hospNotes);

        // Specials
        const specials = opsRows
          .filter(r => safeText(r.retail_lunch_special).toLowerCase() === 'yes')
          .map(r => ({
            title: `${r.site || 'Site'} • ${r.log_date || (r.created_at ? String(r.created_at).slice(0,10) : '')}`,
            badge: '',
            notes: safeText(r.retail_lunch_desc) || '(Special recorded – no details entered)'
          }));
        renderList(specialsListEl, specialsEmptyEl, specials);

        const specialDays = new Set(specials.map(s => s.title.split(' • ').pop()));
        kpiRetailSpecialsEl.textContent = String(specialDays.size);
        kpiRetailSpecialsSubEl.textContent = `${specialDays.size} day(s) with specials`;

        // Staffing
        const sickness = opsRows.reduce((s,r) => s + safeNum(r.sickness_count), 0);
        const holiday = opsRows.reduce((s,r) => s + safeNum(r.holiday_count), 0);
        const agency = opsRows.reduce((s,r) => s + safeNum(r.agency_count), 0);

        staffSicknessEl.textContent = String(sickness);
        staffHolidayEl.textContent = String(holiday);
        staffAgencyEl.textContent = String(agency);
        kpiStaffingEl.textContent = String(sickness + holiday + agency);

        // Hospitality day/night
        const hospDay = opsRows.reduce((s,r) => s + safeNum(r.hosp_day_events), 0);
        const hospNight = opsRows.reduce((s,r) => s + safeNum(r.hosp_night_events), 0);
        const hospPlaces = opsRows.reduce((s,r) => s + safeNum(r.hosp_places_events), 0);
        hospDayEl.textContent = String(hospDay);
        hospNightEl.textContent = String(hospNight);
        hospPlacesEl.textContent = String(hospPlaces);
        hospTotalEl.textContent = String(hospDay + hospNight + hospPlaces);

        // Free breakfast
        const fbRows = opsRows.filter(r => safeNum(r.free_breakfast_count) > 0);
        const fbTotal = fbRows.reduce((s,r) => s + safeNum(r.free_breakfast_count), 0);
        const fbDays = new Set(fbRows.map(r => (r.log_date || (r.created_at ? String(r.created_at).slice(0,10) : '')).slice(0,10)));
        freeBreakfastTotalEl.textContent = String(fbTotal);
        freeBreakfastDaysEl.textContent = String(fbDays.size);

        // Hot lunches + chart
        const hl = computeHotLunchDaily(opsRows, startStr);
        hotLunchTotalEl.textContent = String(Math.round(hl.total));
        hotLunchAvgEl.textContent = String(hl.daysWithEntriesCount ? Math.round(hl.avg) : 0);
        hotLunchDaysEl.textContent = String(hl.daysWithEntriesCount);

        hotLunchChartAvgLabelEl.textContent = `Avg: ${Math.round(hl.avg || 0)}`;
        hotLunchChartLabelEl.textContent = `${startStr} → ${endStr} (Mon–Fri)`;

        lastHotLunchChartPayload = {
          labels: hl.labels,
          values: hl.values,
          avg: hl.avg,
          weekRangeText: `${startStr}→${endStr}`
        };
        drawHotLunchChart(lastHotLunchChartPayload.labels, lastHotLunchChartPayload.values, lastHotLunchChartPayload.avg, lastHotLunchChartPayload.weekRangeText);

        // Notes
        const notes = opsRows
          .filter(r => hasMeaningfulText(r.notes))
          .map(r => ({
            title: `${r.site || 'Site'} • ${r.area || 'Area'} • ${r.log_date || (r.created_at ? String(r.created_at).slice(0,10) : '')}`,
            badge: '',
            notes: safeText(r.notes)
          }));
        renderList(notesListEl, notesEmptyEl, notes);

        // Retail
        renderRetail(salesCurrRaw || [], salesPrevRaw || [], prevStartStr, prevEndStr, startStr, endStr);

        // Photos
        photosGridEl.innerHTML = '';
        if (!withPhotos || withPhotos.length === 0) {
          photosEmptyEl.style.display = 'block';
        } else {
          photosEmptyEl.style.display = 'none';
          withPhotos.forEach(r => {
            const when = r.log_date || (r.created_at ? String(r.created_at).slice(0,10) : '');
            const cap = `${r.site || ''} • ${r.area || ''} • ${when}`;
            const notesTxt = safeText(r.notes);

            const div = document.createElement('div');
            div.className = 'thumb';
            div.innerHTML = `
              <img src="${r.photo_url}" alt="Photo" />
              <div class="cap">${cap}</div>
            `;
            div.addEventListener('click', () => {
              modalTitleEl.textContent = cap || 'Photo';
              modalImgEl.src = r.photo_url;
              modalNotesEl.textContent = notesTxt || '';
              photoModalEl.classList.add('open');
            });
            photosGridEl.appendChild(div);
          });
        }

        // If staffing modal is open, refresh it as well (keeps it in sync)
        if (staffingModalEl.classList.contains('open')) {
          renderStaffingDrilldown(startStr, endStr);
        }

      } catch (err) {
        errorMessageEl.style.display = 'block';
        errorMessageEl.textContent = `Error loading weekly dashboard:\n${err?.message || err}`;
      }
    }

    function generateWeeklySummaryText() {
      const lines = [];
      lines.push(`Weekly Operations Summary`);
      lines.push(`—————————————`);
      lines.push(`Week: ${weekLabelEl.textContent}`);
      lines.push('');

      lines.push(`Staffing Impact`);
      lines.push(`• Sickness: ${staffSicknessEl.textContent}`);
      lines.push(`• Holiday: ${staffHolidayEl.textContent}`);
      lines.push(`• Agency: ${staffAgencyEl.textContent}`);
      lines.push('');

      lines.push(`Hospitality`);
      lines.push(`• Day events: ${hospDayEl.textContent}`);
      lines.push(`• Night events: ${hospNightEl.textContent}`);
      lines.push('');

      lines.push(`Incidents`);
      lines.push(`• Maintenance: ${maintListEl.children.length}`);
      lines.push(`• H&S: ${hsListEl.children.length}`);
      lines.push('');

      lines.push(`Retail (Weekly)`);
      lines.push(`• Total sales: ${salesTotalEl.textContent} (vs last week ${salesWoWValueEl.textContent.replace(/<[^>]*>/g,'')} / ${salesWoWPctEl.textContent.replace(/<[^>]*>/g,'')})`);
      lines.push('');

      lines.push(`Newcastle`);
      lines.push(`• Free breakfasts: ${freeBreakfastTotalEl.textContent} over ${freeBreakfastDaysEl.textContent} day(s)`);
      lines.push(`• Hot lunches: ${hotLunchTotalEl.textContent} total (avg ${hotLunchAvgEl.textContent}/day over ${hotLunchDaysEl.textContent} day(s))`);
      lines.push('');

      if (notesListEl.children.length > 0) {
        lines.push(`Key Notes`);
        Array.from(notesListEl.children).slice(0, 5).forEach(item => {
          const txt = item.querySelector('.list-notes')?.textContent;
          if (txt) lines.push(`• ${txt}`);
        });
      }

      return lines.join('\n');
    }

    weeklySummaryBtn.addEventListener('click', () => {
      weeklySummaryBtn.textContent = 'Generating…';
      weeklySummaryBtn.disabled = true;

      if (Number(kpiTotalLogsEl.textContent || '0') === 0) {
        weeklySummaryText.textContent = 'No logs found for the selected week and filters.';
        weeklySummaryBox.style.display = 'block';
        weeklySummaryBtn.textContent = 'Generate Weekly Summary';
        weeklySummaryBtn.disabled = false;
        return;
      }

      weeklySummaryText.textContent = generateWeeklySummaryText();
      weeklySummaryBox.style.display = 'block';

      weeklySummaryBtn.textContent = 'Generate Weekly Summary';
      weeklySummaryBtn.disabled = false;
    });

    refreshBtn.addEventListener('click', loadWeekly);
    weekPickerEl.addEventListener('change', loadWeekly);
    siteFilterEl.addEventListener('change', loadWeekly);
    areaFilterEl.addEventListener('change', loadWeekly);

    // Photo modal close
    closeModalBtn.addEventListener('click', () => photoModalEl.classList.remove('open'));
    photoModalEl.addEventListener('click', (e) => {
      if (e.target === photoModalEl) photoModalEl.classList.remove('open');
    });

    // Staffing modal open/close
    openStaffingDrillBtn.addEventListener('click', () => {
      // derive week start/end from current picker
      const picked = weekPickerEl.value ? new Date(weekPickerEl.value + 'T00:00:00') : new Date();
      const start = startOfWeekMonday(picked);
      const end = addDays(start, 4);
      const startStr = toISODate(start);
      const endStr = toISODate(end);

      staffingModalEl.classList.add('open');
      renderStaffingDrilldown(startStr, endStr);
    });

    closeStaffingModalBtn.addEventListener('click', () => staffingModalEl.classList.remove('open'));
    staffingModalEl.addEventListener('click', (e) => {
      if (e.target === staffingModalEl) staffingModalEl.classList.remove('open');
    });

    staffingSiteSelectEl.addEventListener('change', () => {
      const picked = weekPickerEl.value ? new Date(weekPickerEl.value + 'T00:00:00') : new Date();
      const start = startOfWeekMonday(picked);
      const end = addDays(start, 4);
      renderStaffingDrilldown(toISODate(start), toISODate(end));
    });

    staffingAreaSelectEl.addEventListener('change', () => {
      const picked = weekPickerEl.value ? new Date(weekPickerEl.value + 'T00:00:00') : new Date();
      const start = startOfWeekMonday(picked);
      const end = addDays(start, 4);
      renderStaffingDrilldown(toISODate(start), toISODate(end));
    });

    // Responsive redraw
    window.addEventListener('resize', () => {
      if (lastHotLunchChartPayload) {
        drawHotLunchChart(
          lastHotLunchChartPayload.labels,
          lastHotLunchChartPayload.values,
          lastHotLunchChartPayload.avg,
          lastHotLunchChartPayload.weekRangeText
        );
      }
      if (lastRetailChartPayload) {
        drawRetailSalesChart(
          lastRetailChartPayload.labels,
          lastRetailChartPayload.dayTotalsByLevel,
          lastRetailChartPayload.dailyGrand,
          lastRetailChartPayload.avgGrand,
          lastRetailChartPayload.weekRangeText
        );
      }
      if (lastStaffingChartPayload) {
        drawStaffingChart(
          lastStaffingChartPayload.labels,
          lastStaffingChartPayload.sick,
          lastStaffingChartPayload.hol,
          lastStaffingChartPayload.ag,
          lastStaffingChartPayload.avgGrand,
          lastStaffingChartPayload.weekRangeText
        );
      }
    });

    if (!weekPickerEl.value) {
      weekPickerEl.value = toISODate(new Date());
    }

    loadWeekly();
  </script>
</body>
</html>

