<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Ops Log â€¢ Daily Overview</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    body {
      margin: 0;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: #0b1220;
      color: #f9fafb;
      display: flex;
      align-items: center;
      justify-content: center;
      min-height: 100vh;
    }

    .card {
      background: #020617;
      border-radius: 16px;
      padding: 24px 20px;
      max-width: 900px;
      width: 100%;
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.7);
      border: 1px solid #1f2937;
    }

    h1 {
      font-size: 1.6rem;
      margin-bottom: 0.25rem;
    }

    .subheading {
      font-size: 0.9rem;
      color: #9ca3af;
      margin-bottom: 1rem;
    }

    .summary-row {
      display: flex;
      flex-wrap: wrap;
      gap: 12px;
      margin-bottom: 16px;
    }

    .summary-box {
      flex: 1;
      min-width: 160px;
      background: #020617;
      border-radius: 12px;
      border: 1px solid #111827;
      padding: 10px 12px;
    }

    .summary-label {
      font-size: 0.8rem;
      color: #9ca3af;
      margin-bottom: 4px;
    }

    .summary-value {
      font-size: 1.1rem;
      font-weight: 600;
    }

    .chip {
      display: inline-flex;
      align-items: center;
      border-radius: 999px;
      border: 1px solid #374151;
      padding: 3px 8px;
      font-size: 0.75rem;
      color: #e5e7eb;
      margin-right: 6px;
      margin-bottom: 4px;
    }

    .logs-title {
      font-size: 0.9rem;
      text-transform: uppercase;
      letter-spacing: 0.08em;
      color: #6b7280;
      margin: 8px 0 6px;
    }

    .log-item {
      border-radius: 12px;
      border: 1px solid #111827;
      background: #020617;
      padding: 10px 12px;
      margin-bottom: 8px;
    }

    .log-header {
      display: flex;
      justify-content: space-between;
      gap: 8px;
      margin-bottom: 4px;
      font-size: 0.85rem;
    }

    .log-header-left {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
      align-items: center;
    }

    .log-site {
      font-weight: 600;
    }

    .log-time {
      font-size: 0.8rem;
      color: #9ca3af;
    }

    .log-tags {
      margin-bottom: 4px;
    }

    .log-notes {
      font-size: 0.85rem;
      color: #d1d5db;
      white-space: pre-wrap;
    }

    .empty-state {
      font-size: 0.9rem;
      color: #9ca3af;
      margin-top: 8px;
    }

    .controls {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 8px;
      margin-bottom: 12px;
      flex-wrap: wrap;
    }

    .date-label {
      font-size: 0.9rem;
      color: #e5e7eb;
    }

    .buttons-right {
      display: flex;
      gap: 8px;
    }

    button.nav {
      padding: 6px 10px;
      border-radius: 999px;
      border: 1px solid #374151;
      background: #020617;
      color: #e5e7eb;
      font-size: 0.8rem;
      cursor: pointer;
    }

    button.nav:hover {
      background: #111827;
    }

    a.button-link {
      display: inline-block;
      padding: 6px 10px;
      border-radius: 999px;
      border: 1px solid #374151;
      text-decoration: none;
      font-size: 0.8rem;
      color: #e5e7eb;
      background: #020617;
    }

    a.button-link:hover {
      background: #111827;
    }

    @media (max-width: 600px) {
      .log-header {
        flex-direction: column;
        align-items: flex-start;
      }
    }
  </style>
</head>
<body>
  <div class="card">
    <h1>Daily Overview</h1>
    <p class="subheading">
      Combined stats from all sites for a single day.
    </p>

    <div class="controls">
      <div class="date-label">
        Showing data for: <span id="dateLabel">â€“</span>
      </div>
      <div class="buttons-right">
        <button class="nav" id="prevDayBtn">â—€ Previous day</button>
        <button class="nav" id="todayBtn">Today</button>
        <a href="dashboard.html" class="button-link">Weekly dashboard</a>
        <a href="index.html" class="button-link">Back to site selection</a>
      </div>
    </div>

    <!-- Summary -->
    <div class="summary-row">
      <div class="summary-box">
        <div class="summary-label">Total logs</div>
        <div class="summary-value" id="totalLogs">0</div>
      </div>
      <div class="summary-box">
        <div class="summary-label">By site</div>
        <div class="summary-value" id="siteBreakdown">â€“</div>
      </div>
    </div>

    <div class="logs-title">Entries for this day</div>
    <div id="logsContainer"></div>
    <p id="emptyState" class="empty-state" style="display: none;">
      No logs found for this date yet.
    </p>
  </div>

  <script type="module">
    import { supabase } from './supabase-config.js';

    const dateLabelEl = document.getElementById('dateLabel');
    const totalLogsEl = document.getElementById('totalLogs');
    const siteBreakdownEl = document.getElementById('siteBreakdown');
    const logsContainer = document.getElementById('logsContainer');
    const emptyStateEl = document.getElementById('emptyState');

    const prevDayBtn = document.getElementById('prevDayBtn');
    const todayBtn = document.getElementById('todayBtn');

    let currentDate = null; // "YYYY-MM-DD"

    function formatDateLabel(date) {
      return date.toLocaleDateString('en-GB', {
        day: 'numeric',
        month: 'long',
        year: 'numeric'
      });
    }

    function toDateString(date) {
      const year = date.getFullYear();
      const month = String(date.getMonth() + 1).padStart(2, '0');
      const day = String(date.getDate()).padStart(2, '0');
      return `${year}-${month}-${day}`;
    }

    function parseISODateOnly(isoString) {
      return new Date(isoString);
    }

    async function loadDataForDate(dateStr) {
      currentDate = dateStr;

      const [year, month, day] = dateStr.split('-');
      const dateObj = new Date(Number(year), Number(month) - 1, Number(day));
      dateLabelEl.textContent = formatDateLabel(dateObj);

      logsContainer.innerHTML = '';
      totalLogsEl.textContent = 'â€¦';
      siteBreakdownEl.textContent = 'â€¦';
      emptyStateEl.style.display = 'none';

      // ðŸ”´ IMPORTANT CHANGE HERE:
      // We now filter by log_date (the day the log is for),
      // NOT by created_at (the day it was saved).
      const { data, error } = await supabase
        .from('ops_logs')
        .select('*')
        .eq('log_date', dateStr)
        .order('created_at', { ascending: false });

      if (error) {
        console.error('Error loading logs:', error);
        totalLogsEl.textContent = 'Error';
        siteBreakdownEl.textContent = 'Error';
        emptyStateEl.textContent = 'There was an error loading data.';
        emptyStateEl.style.display = 'block';
        return;
      }

      if (!data || data.length === 0) {
        totalLogsEl.textContent = '0';
        siteBreakdownEl.textContent = 'No data';
        emptyStateEl.textContent = 'No logs found for this date yet.';
        emptyStateEl.style.display = 'block';
        return;
      }

      // Summary
      totalLogsEl.textContent = data.length.toString();

      const siteCounts = data.reduce((acc, row) => {
        const site = row.site || 'Unknown';
        acc[site] = (acc[site] || 0) + 1;
        return acc;
      }, {});

      const siteText = Object.entries(siteCounts)
        .map(([site, count]) => `${site}: ${count}`)
        .join(' â€¢ ');

      siteBreakdownEl.textContent = siteText || 'â€“';

      // Render logs
      data.forEach((row) => {
        const item = document.createElement('div');
        item.className = 'log-item';

        const header = document.createElement('div');
        header.className = 'log-header';

        const headerLeft = document.createElement('div');
        headerLeft.className = 'log-header-left';

        const siteEl = document.createElement('span');
        siteEl.className = 'log-site';
        siteEl.textContent = row.site || 'Unknown';

        const areaEl = document.createElement('span');
        areaEl.className = 'chip';
        areaEl.textContent = row.area || 'No area';

        const timeEl = document.createElement('span');
        timeEl.className = 'log-time';
        const created = row.created_at ? parseISODateOnly(row.created_at) : null;
        timeEl.textContent = created
          ? created.toLocaleTimeString('en-GB', {
              hour: '2-digit',
              minute: '2-digit'
            })
          : '';

        headerLeft.appendChild(siteEl);
        headerLeft.appendChild(areaEl);
        header.appendChild(headerLeft);
        header.appendChild(timeEl);
        item.appendChild(header);

        // Tags row
        const tags = document.createElement('div');
        tags.className = 'log-tags';

        function addTag(text) {
          const t = document.createElement('span');
          t.className = 'chip';
          t.textContent = text;
          tags.appendChild(t);
        }

        // Staffing chips
        if (row.sickness_count && row.sickness_count !== '0') {
          addTag(`Sickness: ${row.sickness_count}`);
        }
        if (row.holiday_count && row.holiday_count !== '0') {
          addTag(`Holidays: ${row.holiday_count}`);
        }
        if (row.agency_count && row.agency_count !== '0') {
          addTag(`Agency: ${row.agency_count}`);
        }

        // Maintenance
        if (row.maintenance_issue === 'Yes') {
          addTag(
            `Maintenance issue (reported: ${row.maintenance_reported || 'n/a'})`
          );
        }

        // H&S / Food Safety
        if (row.hs_issue === 'Yes') {
          addTag(
            `H&S / Food Safety issue (reported: ${row.hs_reported || 'n/a'})`
          );
        }

        // Newcastle
        if (row.site === 'Newcastle' && row.hot_lunch_dishes != null) {
          addTag(
            `Hot lunch: ${row.hot_lunch_dishes} (${row.service_level || '-'})`
          );
        }

        // London Retail
        if (
          row.site === 'London' &&
          row.area === 'Retail' &&
          row.retail_lunch_special
        ) {
          addTag(
            `Retail lunch special: ${row.retail_lunch_special}${
              row.retail_lunch_desc ? ' âœ“' : ''
            }`
          );
        }

        // London Hospitality
        if (row.site === 'London' && row.area === 'Hospitality') {
          if (row.hosp_day_events != null || row.hosp_night_events != null) {
            addTag(
              `Events â€“ Day: ${row.hosp_day_events ?? 0}, Night: ${
                row.hosp_night_events ?? 0
              }`
            );
          }
        }

        if (tags.children.length > 0) {
          item.appendChild(tags);
        }

        // Notes section â€“ includes all detailed comments
        const detailLines = [];

        if (row.notes) {
          detailLines.push(`General: ${row.notes}`);
        }
        if (row.sickness_notes) {
          detailLines.push(`Sickness notes: ${row.sickness_notes}`);
        }
        if (row.holiday_notes) {
          detailLines.push(`Holiday notes: ${row.holiday_notes}`);
        }
        if (row.agency_notes) {
          detailLines.push(`Agency notes: ${row.agency_notes}`);
        }
        if (row.maintenance_notes) {
          detailLines.push(`Maintenance: ${row.maintenance_notes}`);
        }
        if (row.hs_notes) {
          detailLines.push(`H&S / Food Safety: ${row.hs_notes}`);
        }
        if (row.retail_lunch_desc) {
          detailLines.push(`Retail lunch: ${row.retail_lunch_desc}`);
        }

        if (detailLines.length > 0) {
          const notes = document.createElement('div');
          notes.className = 'log-notes';
          notes.textContent = detailLines.join('\n');
          item.appendChild(notes);
        }

        logsContainer.appendChild(item);
      });
    }

    function goToToday() {
      const now = new Date();
      const todayStr = toDateString(now);
      loadDataForDate(todayStr);
    }

    function changeDay(offset) {
      if (!currentDate) return;
      const [year, month, day] = currentDate.split('-');
      const d = new Date(Number(year), Number(month) - 1, Number(day));
      d.setDate(d.getDate() + offset);
      const newStr = toDateString(d);
      loadDataForDate(newStr);
    }

    prevDayBtn.addEventListener('click', () => changeDay(-1));
    todayBtn.addEventListener('click', goToToday);

    // Initial load: today
    goToToday();
  </script>
</body>
</html>
