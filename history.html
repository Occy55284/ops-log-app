<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Ops Log • Daily Overview</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    body {
      margin: 0;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: #0b1220;
      color: #f9fafb;
      display: flex;
      align-items: center;
      justify-content: center;
      min-height: 100vh;
    }

    .card {
      width: 100%;
      max-width: 960px;
      background: radial-gradient(circle at top left, rgba(56, 189, 248, 0.08), transparent 55%),
        radial-gradient(circle at bottom right, rgba(45, 212, 191, 0.06), transparent 55%),
        #020617;
      border-radius: 18px;
      border: 1px solid rgba(15, 23, 42, 0.9);
      padding: 20px 20px 18px;
      box-shadow:
        0 24px 60px rgba(15, 23, 42, 0.75),
        0 0 0 1px rgba(15, 23, 42, 0.9);
    }

    h1 {
      font-size: 1.4rem;
      letter-spacing: 0.16em;
      text-transform: uppercase;
      margin: 0 0 4px;
      color: #e5e7eb;
    }

    .subheading {
      margin: 0 0 16px;
      font-size: 0.90rem;
      color: #9ca3af;
    }

    .controls {
      display: flex;
      flex-wrap: wrap;
      align-items: center;
      justify-content: space-between;
      gap: 12px;
      margin-bottom: 16px;
    }

    .date-label {
      font-size: 0.9rem;
      color: #e5e7eb;
    }

    .date-label span {
      font-weight: 600;
      color: #facc15;
    }

    .buttons-right {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      align-items: center;
      justify-content: flex-end;
    }

    button,
    .button-link {
      border-radius: 999px;
      border: 1px solid rgba(55, 65, 81, 1);
      background: radial-gradient(circle at top, rgba(148, 163, 184, 0.15), rgba(15, 23, 42, 1));
      color: #e5e7eb;
      font-size: 0.8rem;
      padding: 6px 12px;
      cursor: pointer;
      text-decoration: none;
      display: inline-flex;
      align-items: center;
      gap: 6px;
      transition: background 0.15s ease, transform 0.12s ease, box-shadow 0.12s ease;
    }

    button:hover,
    .button-link:hover {
      background: radial-gradient(circle at top, rgba(248, 250, 252, 0.12), rgba(15, 23, 42, 1));
      box-shadow: 0 10px 30px rgba(15, 23, 42, 0.9);
      transform: translateY(-1px);
    }

    .nav {
      border-color: rgba(75, 85, 99, 1);
    }

    .summary-row {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 10px;
      margin-bottom: 14px;
    }

    .summary-box {
      border-radius: 12px;
      border: 1px solid #111827;
      background: #020617;
      padding: 10px 12px;
    }

    .summary-label {
      font-size: 0.72rem;
      letter-spacing: 0.12em;
      text-transform: uppercase;
      color: #9ca3af;
      margin-bottom: 4px;
    }

    .summary-value {
      font-size: 1.1rem;
      font-weight: 600;
      color: #e5e7eb;
    }

    .summary-value-small {
      font-size: 0.82rem;
      font-weight: 500;
      color: #e5e7eb;
      line-height: 1.4;
    }

    .logs-title {
      margin: 14px 0 8px;
      font-size: 0.9rem;
      font-weight: 500;
      color: #e5e7eb;
    }

    .empty-state {
      font-size: 0.85rem;
      color: #6b7280;
      margin-top: 6px;
    }

    .log-item {
      border-radius: 12px;
      border: 1px solid #111827;
      background: #020617;
      padding: 10px 12px;
      margin-bottom: 8px;
    }

    .log-header {
      display: flex;
      justify-content: space-between;
      gap: 8px;
      margin-bottom: 4px;
      font-size: 0.85rem;
    }

    .log-header-left {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
      align-items: center;
    }

    .log-site {
      font-weight: 600;
    }

    .chip {
      border-radius: 999px;
      background: rgba(31, 41, 55, 1);
      color: #e5e7eb;
      padding: 2px 8px;
      font-size: 0.7rem;
    }

    .log-time {
      font-size: 0.75rem;
      color: #9ca3af;
    }

    .log-tags {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
      margin: 6px 0;
    }

    .tag {
      font-size: 0.7rem;
      border-radius: 999px;
      padding: 2px 8px;
      background: rgba(17, 24, 39, 1);
      border: 1px solid rgba(55, 65, 81, 1);
      color: #e5e7eb;
      white-space: nowrap;
    }

    .log-notes {
      font-size: 0.78rem;
      color: #d1d5db;
      line-height: 1.5;
      margin-top: 4px;
    }

    .log-notes strong {
      color: #9ca3af;
      font-weight: 500;
    }

    @media (max-width: 640px) {
      .card {
        border-radius: 0;
        min-height: 100vh;
        max-width: 100%;
      }
    }
  </style>
</head>
<body>
  <div class="card">
    <h1>Daily Overview</h1>
    <p class="subheading">
      Combined stats from all sites for a single day, including retail sales.
    </p>

    <div class="controls">
      <div class="date-label">
        Showing data for: <span id="dateLabel">–</span>
      </div>
      <div class="buttons-right">
        <button class="nav" id="prevDayBtn">◀ Previous day</button>
        <button class="nav" id="todayBtn">Today</button>
        <a href="dashboard.html" class="button-link">Weekly dashboard</a>
        <a href="sales.html" class="button-link">Retail sales page</a>
        <a href="index.html" class="button-link">Back to site selection</a>
      </div>
    </div>

    <!-- Ops summary -->
    <div class="summary-row">
      <div class="summary-box">
        <div class="summary-label">Total logs</div>
        <div class="summary-value" id="totalLogs">0</div>
      </div>
      <div class="summary-box">
        <div class="summary-label">By site</div>
        <div class="summary-value-small" id="siteBreakdown">–</div>
      </div>
    </div>

    <!-- Retail sales summary -->
    <div class="summary-row">
      <div class="summary-box">
        <div class="summary-label">Retail sales (all levels)</div>
        <div class="summary-value" id="dailySalesTotal">£0.00</div>
      </div>
      <div class="summary-box">
        <div class="summary-label">Retail sales by level</div>
        <div class="summary-value-small" id="dailySalesLevels">No sales captured</div>
      </div>
    </div>

    <div class="logs-title">Entries for this day</div>
    <div id="logsContainer"></div>
    <p id="emptyState" class="empty-state" style="display: none;">
      No logs found for this date yet.
    </p>
  </div>

  <script type="module">
    import { supabase } from './supabase-config.js';

    const dateLabelEl = document.getElementById('dateLabel');
    const totalLogsEl = document.getElementById('totalLogs');
    const siteBreakdownEl = document.getElementById('siteBreakdown');
    const logsContainer = document.getElementById('logsContainer');
    const emptyStateEl = document.getElementById('emptyState');

    const dailySalesTotalEl = document.getElementById('dailySalesTotal');
    const dailySalesLevelsEl = document.getElementById('dailySalesLevels');

    const prevDayBtn = document.getElementById('prevDayBtn');
    const todayBtn = document.getElementById('todayBtn');

    let currentDate = null; // "YYYY-MM-DD"

    function formatDateLabel(date) {
      return date.toLocaleDateString('en-GB', {
        weekday: 'long',
        year: 'numeric',
        month: 'short',
        day: 'numeric',
      });
    }

    function toDateString(date) {
      const y = date.getFullYear();
      const m = String(date.getMonth() + 1).padStart(2, '0');
      const d = String(date.getDate()).padStart(2, '0');
      return `${y}-${m}-${d}`;
    }

    function parseISODateOnly(iso) {
      if (!iso) return null;
      const d = new Date(iso);
      if (Number.isNaN(d.getTime())) return null;
      return d;
    }

    function resetSalesSummary() {
      dailySalesTotalEl.textContent = '£0.00';
      dailySalesLevelsEl.textContent = 'No sales captured';
    }

    async function loadSalesForDate(dateStr) {
      resetSalesSummary();

      try {
        const { data, error } = await supabase
          .from('retail_sales')
          .select('*')
          .eq('sales_date', dateStr);

        if (error) {
          console.error('Error loading retail sales:', error);
          return;
        }

        if (!data || data.length === 0) {
          return;
        }

        let totalSales = 0;
        const byLevel = {};

        data.forEach((row) => {
          const level = row.level || 'Unknown';
          const sales = parseFloat(row.sales ?? 0);
          if (!Number.isFinite(sales)) return;

          totalSales += sales;
          byLevel[level] = (byLevel[level] || 0) + sales;
        });

        dailySalesTotalEl.textContent = '£' + totalSales.toFixed(2);

        const orderedLevels = ['Level 7', 'Level 5', 'Level 4', 'Level 3'];
        const parts = [];

        orderedLevels.forEach((lvl) => {
          if (byLevel[lvl]) {
            const short = lvl.replace('Level ', 'L');
            parts.push(`${short}: £${byLevel[lvl].toFixed(2)}`);
          }
        });

        // Any other levels not in the standard list
        Object.keys(byLevel).forEach((lvl) => {
          if (!orderedLevels.includes(lvl)) {
            parts.push(`${lvl}: £${byLevel[lvl].toFixed(2)}`);
          }
        });

        dailySalesLevelsEl.textContent =
          parts.length > 0 ? parts.join(' • ') : 'No sales captured';
      } catch (err) {
        console.error('Unexpected error loading retail sales:', err);
      }
    }

    async function loadDataForDate(dateStr) {
      currentDate = dateStr;

      const [year, month, day] = dateStr.split('-');
      const dateObj = new Date(Number(year), Number(month) - 1, Number(day));
      dateLabelEl.textContent = formatDateLabel(dateObj);

      logsContainer.innerHTML = '';
      totalLogsEl.textContent = '…';
      siteBreakdownEl.textContent = '…';
      emptyStateEl.style.display = 'none';

      // reset sales while we load
      resetSalesSummary();

      // OPS LOGS
      const { data, error } = await supabase
        .from('ops_logs')
        .select('*')
        .eq('log_date', dateStr)
        .order('log_date', { ascending: false })
        .order('created_at', { ascending: false });

      if (error) {
        console.error('Error loading logs:', error);
        totalLogsEl.textContent = 'Error';
        siteBreakdownEl.textContent = 'Error';
        emptyStateEl.textContent = 'There was an error loading data.';
        emptyStateEl.style.display = 'block';

        // still attempt to load sales
        await loadSalesForDate(dateStr);
        return;
      }

      if (!data || data.length === 0) {
        totalLogsEl.textContent = '0';
        siteBreakdownEl.textContent = 'No data';
        emptyStateEl.textContent = 'No logs found for this date yet.';
        emptyStateEl.style.display = 'block';

        // still attempt to load sales
        await loadSalesForDate(dateStr);
        return;
      }

      totalLogsEl.textContent = String(data.length);

      // Site breakdown
      const siteCounts = data.reduce((acc, row) => {
        const site = row.site || 'Unknown';
        acc[site] = (acc[site] || 0) + 1;
        return acc;
      }, {});

      const siteText = Object.entries(siteCounts)
        .map(([site, count]) => `${site}: ${count}`)
        .join(' • ');

      siteBreakdownEl.textContent = siteText || '–';

      // Render logs
      data.forEach((row) => {
        const item = document.createElement('div');
        item.className = 'log-item';

        const header = document.createElement('div');
        header.className = 'log-header';

        const headerLeft = document.createElement('div');
        headerLeft.className = 'log-header-left';

        const siteEl = document.createElement('span');
        siteEl.className = 'log-site';
        siteEl.textContent = row.site || 'Unknown';

        const areaEl = document.createElement('span');
        areaEl.className = 'chip';
        areaEl.textContent = row.area || 'No area';

        const timeEl = document.createElement('span');
        timeEl.className = 'log-time';
        const created = row.created_at ? parseISODateOnly(row.created_at) : null;
        timeEl.textContent = created
          ? created.toLocaleTimeString('en-GB', {
              hour: '2-digit',
              minute: '2-digit',
            })
          : '';

        headerLeft.appendChild(siteEl);
        headerLeft.appendChild(areaEl);

        header.appendChild(headerLeft);
        header.appendChild(timeEl);

        item.appendChild(header);

        // Tags row: quick view
        const tags = document.createElement('div');
        tags.className = 'log-tags';

        function addTag(text) {
          const t = document.createElement('span');
          t.className = 'tag';
          t.textContent = text;
          tags.appendChild(t);
        }

        // Staffing counts
        if (row.sickness_count != null && row.sickness_count > 0) {
          addTag(`Sick: ${row.sickness_count}`);
        }
        if (row.holiday_count != null && row.holiday_count > 0) {
          addTag(`Holiday: ${row.holiday_count}`);
        }
        if (row.agency_count != null && row.agency_count > 0) {
          addTag(`Agency: ${row.agency_count}`);
        }

        // Maintenance
        if (row.maintenance_issue === 'Yes') {
          addTag(
            `Maintenance issue (reported: ${row.maintenance_reported || 'n/a'})`
          );
        }

        // H&S / Food Safety
        if (row.hs_issue === 'Yes') {
          addTag(`H&S issue (reported: ${row.hs_reported || 'n/a'})`);
        }

        // Newcastle hot lunches
        if (row.site === 'Newcastle' && row.hot_lunch_dishes != null) {
          addTag(`Hot lunch dishes: ${row.hot_lunch_dishes}`);
        }

        // London Hospitality events
        if (row.site === 'London' && row.area === 'Hospitality') {
          const dayEv = row.hosp_day_events ?? 0;
          const nightEv = row.hosp_night_events ?? 0;
          if (dayEv || nightEv) {
            addTag(`Events – Day: ${dayEv} • Night: ${nightEv}`);
          }
        }

        if (tags.children.length > 0) {
          item.appendChild(tags);
        }

        // Notes section – detailed info
        const detailLines = [];

        if (row.notes) {
          detailLines.push(`<strong>General:</strong> ${row.notes}`);
        }
        if (row.sickness_notes) {
          detailLines.push(`<strong>Sickness:</strong> ${row.sickness_notes}`);
        }
        if (row.holiday_notes) {
          detailLines.push(`<strong>Holiday:</strong> ${row.holiday_notes}`);
        }
        if (row.agency_notes) {
          detailLines.push(`<strong>Agency:</strong> ${row.agency_notes}`);
        }
        if (row.maintenance_notes) {
          detailLines.push(
            `<strong>Maintenance:</strong> ${row.maintenance_notes}`
          );
        }
        if (row.hs_notes) {
          detailLines.push(`<strong>H&S:</strong> ${row.hs_notes}`);
        }
        if (row.retail_lunch_special || row.retail_lunch_desc) {
          const desc = `${row.retail_lunch_special || ''}${
            row.retail_lunch_desc ? ' – ' + row.retail_lunch_desc : ''
          }`.trim();
          if (desc) {
            detailLines.push(`<strong>Retail lunch:</strong> ${desc}`);
          }
        }

        if (detailLines.length > 0) {
          const notes = document.createElement('div');
          notes.className = 'log-notes';
          notes.innerHTML = detailLines.join('<br />');
          item.appendChild(notes);
        }

        logsContainer.appendChild(item);
      });

      // Finally load sales for this date
      await loadSalesForDate(dateStr);
    }

    function goToToday() {
      const now = new Date();
      const todayStr = toDateString(now);
      loadDataForDate(todayStr);
    }

    function changeDay(offset) {
      if (!currentDate) return;
      const [year, month, day] = currentDate.split('-');
      const d = new Date(Number(year), Number(month) - 1, Number(day));
      d.setDate(d.getDate() + offset);
      const newStr = toDateString(d);
      loadDataForDate(newStr);
    }

    prevDayBtn.addEventListener('click', () => changeDay(-1));
    todayBtn.addEventListener('click', goToToday);

    // Initial load: today
    goToToday();
  </script>
</body>
</html>
