<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Ops Log • Monthly Finance Admin</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    body {
      margin: 0;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: #0b1220;
      color: #f9fafb;
      min-height: 100vh;
    }

    .wrap {
      max-width: 1100px;
      margin: 0 auto;
      padding: 18px 14px 42px;
    }

    .card {
      background: rgba(255,255,255,0.04);
      border: 1px solid rgba(255,255,255,0.08);
      border-radius: 18px;
      padding: 14px;
      box-shadow: 0 10px 24px rgba(0,0,0,0.24);
      position: relative;
      overflow: hidden;
    }

    .card::before {
      content: "";
      position: absolute;
      inset: -1px;
      background: radial-gradient(650px 140px at 15% 0%, rgba(59,130,246,0.18), transparent 65%),
                  radial-gradient(550px 160px at 85% 0%, rgba(236,72,153,0.14), transparent 60%);
      pointer-events: none;
    }
    .card > * { position: relative; }

    .topbar {
      display: flex;
      flex-wrap: wrap;
      align-items: center;
      justify-content: space-between;
      gap: 12px;
      margin-bottom: 14px;
    }

    .title {
      font-size: 18px;
      font-weight: 800;
    }

    .subtitle {
      font-size: 12px;
      color: rgba(255,255,255,0.68);
      margin-top: 4px;
      line-height: 1.25;
    }

    .row {
      display: grid;
      grid-template-columns: repeat(3, minmax(0, 1fr));
      gap: 10px;
      margin-top: 12px;
    }

    @media (max-width: 900px) {
      .row { grid-template-columns: 1fr; }
    }

    label {
      font-size: 12px;
      color: rgba(255,255,255,0.72);
      display: block;
      margin-bottom: 6px;
    }

    select, input, textarea {
      width: 100%;
      background: rgba(0,0,0,0.25);
      border: 1px solid rgba(255,255,255,0.12);
      color: #f9fafb;
      padding: 10px 10px;
      border-radius: 12px;
      outline: none;
      font-size: 13px;
      box-sizing: border-box;
    }

    textarea { min-height: 90px; resize: vertical; }

    .section-title {
      margin-top: 14px;
      font-weight: 800;
      font-size: 13px;
      color: rgba(255,255,255,0.90);
    }

    .grid2 {
      display: grid;
      grid-template-columns: repeat(2, minmax(0, 1fr));
      gap: 10px;
      margin-top: 10px;
    }

    @media (max-width: 900px) {
      .grid2 { grid-template-columns: 1fr; }
    }

    .btnrow { display: flex; gap: 10px; flex-wrap: wrap; margin-top: 14px; }

    .btn {
      background: rgba(59,130,246,0.20);
      border: 1px solid rgba(59,130,246,0.42);
      color: rgba(219,234,254,0.95);
      padding: 10px 12px;
      border-radius: 14px;
      font-weight: 800;
      font-size: 13px;
      cursor: pointer;
      box-shadow: 0 10px 22px rgba(0,0,0,0.22);
      text-decoration: none;
      display: inline-flex;
      align-items: center;
      justify-content: center;
    }

    .btn-secondary {
      background: rgba(255,255,255,0.06);
      border: 1px solid rgba(255,255,255,0.10);
      color: rgba(255,255,255,0.88);
    }

    .msg {
      margin-top: 10px;
      font-size: 12px;
      padding: 10px 12px;
      border-radius: 14px;
      display: none;
      white-space: pre-wrap;
    }

    .msg.ok {
      display: block;
      background: rgba(16,185,129,0.14);
      border: 1px solid rgba(16,185,129,0.30);
      color: rgba(209,250,229,0.95);
    }

    .msg.err {
      display: block;
      background: rgba(239,68,68,0.15);
      border: 1px solid rgba(239,68,68,0.35);
      color: rgba(254,226,226,0.92);
    }
  </style>
</head>

<body>
  <div class="wrap">
    <div class="topbar">
      <div>
        <div class="title">Monthly Finance Admin</div>
        <div class="subtitle">
          Create/update monthly_finance_summary rows (Budget + Actual). GP% is entered manually.
        </div>
      </div>

      <div class="btnrow" style="margin-top:0;">
        <a class="btn btn-secondary" href="./monthly.html">Back to Monthly Dashboard</a>
        <a class="btn btn-secondary" href="./index.html">Home</a>
      </div>
    </div>

    <div class="card">
      <div class="row">
        <div>
          <label for="monthSelect">Month</label>
          <input id="monthSelect" type="month" />
        </div>
        <div>
          <label for="siteSelect">Site</label>
          <select id="siteSelect">
            <option value="London">London</option>
            <option value="Newcastle">Newcastle</option>
          </select>
        </div>
        <div>
          <label>&nbsp;</label>
          <button class="btn" id="loadBtn" type="button">Load</button>
        </div>
      </div>

      <div class="section-title">Budgets (Monthly)</div>
      <div class="grid2">
        <div><label>Budget Retail Sales (£)</label><input id="bRetail" type="number" step="0.01" /></div>
        <div><label>Budget Hospitality Sales (£)</label><input id="bHosp" type="number" step="0.01" /></div>
        <div><label>Budget Free Issue (£)</label><input id="bFree" type="number" step="0.01" /></div>
        <div><label>Budget Core Wages (£)</label><input id="bCore" type="number" step="0.01" /></div>
        <div><label>Budget Agency Spend (£)</label><input id="bAgency" type="number" step="0.01" /></div>
        <div><label>Budget GP (%)</label><input id="bGp" type="number" step="0.1" /></div>
      </div>

      <div class="section-title">Actuals (End of Month)</div>
      <div class="grid2">
        <div><label>Actual Retail Sales (£)</label><input id="aRetail" type="number" step="0.01" /></div>
        <div><label>Actual Hospitality Sales (£)</label><input id="aHosp" type="number" step="0.01" /></div>
        <div><label>Actual Free Issue (£)</label><input id="aFree" type="number" step="0.01" /></div>
        <div><label>Actual Core Wages (£)</label><input id="aCore" type="number" step="0.01" /></div>
        <div><label>Actual Agency Spend (£)</label><input id="aAgency" type="number" step="0.01" /></div>
        <div><label>Actual GP (%)</label><input id="aGp" type="number" step="0.1" /></div>
      </div>

      <div style="margin-top:10px;">
        <label>Notes (optional)</label>
        <textarea id="notes"></textarea>
      </div>

      <div class="btnrow">
        <button class="btn" id="saveBtn" type="button">Save (Upsert)</button>
        <button class="btn btn-secondary" id="clearBtn" type="button">Clear</button>
      </div>

      <div id="msgOk" class="msg ok"></div>
      <div id="msgErr" class="msg err"></div>
    </div>
  </div>

  <script type="module">
    import { supabase } from './supabase-config.js';

    const monthSelect = document.getElementById('monthSelect');
    const siteSelect = document.getElementById('siteSelect');
    const loadBtn = document.getElementById('loadBtn');
    const saveBtn = document.getElementById('saveBtn');
    const clearBtn = document.getElementById('clearBtn');

    const msgOk = document.getElementById('msgOk');
    const msgErr = document.getElementById('msgErr');

    const fields = {
      bRetail: document.getElementById('bRetail'),
      bHosp: document.getElementById('bHosp'),
      bFree: document.getElementById('bFree'),
      bCore: document.getElementById('bCore'),
      bAgency: document.getElementById('bAgency'),
      bGp: document.getElementById('bGp'),

      aRetail: document.getElementById('aRetail'),
      aHosp: document.getElementById('aHosp'),
      aFree: document.getElementById('aFree'),
      aCore: document.getElementById('aCore'),
      aAgency: document.getElementById('aAgency'),
      aGp: document.getElementById('aGp'),

      notes: document.getElementById('notes')
    };

    function showOk(t) { msgErr.style.display = 'none'; msgOk.textContent = t; msgOk.style.display = 'block'; }
    function showErr(t) { msgOk.style.display = 'none'; msgErr.textContent = t; msgErr.style.display = 'block'; }

    function n(v) {
      const x = Number(v);
      return Number.isFinite(x) ? x : 0;
    }

    function monthStartFromInput(monthYYYYMM) {
      if (!monthYYYYMM) return null;
      return `${monthYYYYMM}-01`;
    }

    function clearForm() {
      Object.values(fields).forEach(el => el.value = '');
      msgOk.style.display = 'none';
      msgErr.style.display = 'none';
    }

    async function loadRow() {
      msgOk.style.display = 'none';
      msgErr.style.display = 'none';

      const monthStart = monthStartFromInput(monthSelect.value);
      const site = siteSelect.value;

      if (!monthStart) { showErr('Please select a month.'); return; }

      const { data, error } = await supabase
        .from('monthly_finance_summary')
        .select('*')
        .eq('month_start', monthStart)
        .eq('site', site)
        .limit(1)
        .maybeSingle();

      if (error) { showErr(`Load error: ${error.message}`); return; }

      if (!data) {
        clearForm();
        showOk(`No row found for ${site} • ${monthStart}. Enter budgets/actuals and Save to create it.`);
        return;
      }

      fields.bRetail.value = data.budget_retail_sales ?? 0;
      fields.bHosp.value = data.budget_hospitality_sales ?? 0;
      fields.bFree.value = data.budget_free_issue ?? 0;
      fields.bCore.value = data.budget_core_wages ?? 0;
      fields.bAgency.value = data.budget_agency_spend ?? 0;
      fields.bGp.value = data.budget_gp_pct ?? 0;

      fields.aRetail.value = data.actual_retail_sales ?? 0;
      fields.aHosp.value = data.actual_hospitality_sales ?? 0;
      fields.aFree.value = data.actual_free_issue ?? 0;
      fields.aCore.value = data.actual_core_wages ?? 0;
      fields.aAgency.value = data.actual_agency_spend ?? 0;
      fields.aGp.value = data.actual_gp_pct ?? 0;

      fields.notes.value = data.notes ?? '';

      showOk(`Loaded ${site} • ${monthStart}.`);
    }

    async function saveRow() {
      msgOk.style.display = 'none';
      msgErr.style.display = 'none';

      const monthStart = monthStartFromInput(monthSelect.value);
      const site = siteSelect.value;

      if (!monthStart) { showErr('Please select a month.'); return; }

      const payload = {
        month_start: monthStart,
        site,

        budget_retail_sales: n(fields.bRetail.value),
        budget_hospitality_sales: n(fields.bHosp.value),
        budget_free_issue: n(fields.bFree.value),
        budget_core_wages: n(fields.bCore.value),
        budget_agency_spend: n(fields.bAgency.value),
        budget_gp_pct: n(fields.bGp.value),

        actual_retail_sales: n(fields.aRetail.value),
        actual_hospitality_sales: n(fields.aHosp.value),
        actual_free_issue: n(fields.aFree.value),
        actual_core_wages: n(fields.aCore.value),
        actual_agency_spend: n(fields.aAgency.value),
        actual_gp_pct: n(fields.aGp.value),

        notes: fields.notes.value || null
      };

      const { error } = await supabase
        .from('monthly_finance_summary')
        .upsert(payload, { onConflict: 'month_start,site' });

      if (error) {
        showErr(
          `Save error: ${error.message}\n\n` +
          `If you see an onConflict/duplicate issue, add a UNIQUE constraint on (month_start, site):\n` +
          `alter table public.monthly_finance_summary add constraint monthly_finance_summary_unique unique (month_start, site);`
        );
        return;
      }

      showOk(`Saved ${site} • ${monthStart}.`);
    }

    (function init() {
      const now = new Date();
      const yyyy = now.getFullYear();
      const mm = String(now.getMonth() + 1).padStart(2, '0');
      monthSelect.value = `${yyyy}-${mm}`;
    })();

    loadBtn.addEventListener('click', loadRow);
    saveBtn.addEventListener('click', saveRow);
    clearBtn.addEventListener('click', clearForm);
  </script>
</body>
</html>
