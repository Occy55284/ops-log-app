<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Ops Log • Monthly Finance Admin</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    body {
      margin: 0;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: #0b1220;
      color: #f9fafb;
      min-height: 100vh;
    }

    .page { max-width: 1100px; width: 100%; margin: 0 auto; padding: 24px; box-sizing: border-box; }

    .header {
      display: flex;
      flex-wrap: wrap;
      align-items: flex-end;
      justify-content: space-between;
      gap: 12px;
      margin-bottom: 18px;
    }

    h1 {
      margin: 0;
      font-size: 22px;
      letter-spacing: 0.03em;
      text-transform: uppercase;
      color: #e5e7eb;
    }

    .subtitle { font-size: 13px; color: #9ca3af; margin-top: 4px; max-width: 720px; }

    .controls { display: flex; align-items: center; gap: 10px; flex-wrap: wrap; }

    .pill {
      border-radius: 999px;
      background: rgba(15, 23, 42, 0.95);
      border: 1px solid rgba(148, 163, 184, 0.4);
      padding: 6px 12px;
      font-size: 12px;
      color: #e5e7eb;
      display: inline-flex;
      align-items: center;
      gap: 8px;
    }

    .pill-label {
      text-transform: uppercase;
      letter-spacing: 0.12em;
      font-size: 11px;
      color: #9ca3af;
      white-space: nowrap;
    }

    .pill input, .pill select {
      border: none;
      background: transparent;
      color: #e5e7eb;
      font-size: 12px;
      padding: 2px 4px;
      outline: none;
      cursor: pointer;
    }

    .pill select option { background: #020617; color: #e5e7eb; }

    .btn {
      border-radius: 999px;
      border: 1px solid rgba(94, 234, 212, 0.5);
      background: radial-gradient(circle at top left, rgba(45, 212, 191, 0.35), rgba(15, 23, 42, 1));
      color: #ecfeff;
      padding: 8px 14px;
      font-size: 12px;
      font-weight: 500;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      gap: 8px;
      box-shadow: 0 0 0 1px rgba(15, 23, 42, 1), 0 8px 18px rgba(45, 212, 191, 0.2);
      transition: transform 0.1s ease, box-shadow 0.1s ease, opacity 0.1s ease;
    }

    .btn:hover:not(:disabled) { transform: translateY(-1px); box-shadow: 0 0 0 1px rgba(15, 23, 42, 1), 0 12px 26px rgba(45, 212, 191, 0.28); }
    .btn:disabled { opacity: 0.45; cursor: default; }

    .btn-secondary {
      border-color: rgba(148, 163, 184, 0.6);
      background: radial-gradient(circle at top left, rgba(30, 64, 175, 0.4), rgba(15, 23, 42, 1));
    }

    .card {
      background: radial-gradient(circle at top left, rgba(30, 64, 175, 0.4), rgba(15, 23, 42, 0.98));
      border-radius: 18px;
      border: 1px solid rgba(148, 163, 184, 0.35);
      box-shadow: 0 0 0 1px rgba(15, 23, 42, 1), 0 18px 40px rgba(15, 23, 42, 0.9);
      padding: 14px;
      box-sizing: border-box;
      margin-top: 14px;
    }

    .card-header {
      display: flex;
      align-items: baseline;
      justify-content: space-between;
      gap: 8px;
      margin-bottom: 10px;
    }

    .card-title {
      font-size: 14px;
      letter-spacing: 0.11em;
      text-transform: uppercase;
      color: #e5e7eb;
    }

    .card-subtitle { font-size: 11px; color: #9ca3af; }

    .grid { display: grid; grid-template-columns: minmax(0, 1fr); gap: 12px; }
    .row-2 { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }
    @media (max-width: 900px) { .row-2 { grid-template-columns: 1fr; } }

    .metric {
      background: radial-gradient(circle at top left, rgba(15, 23, 42, 0.9), rgba(15, 23, 42, 1));
      border-radius: 14px;
      padding: 12px;
      border: 1px solid rgba(148, 163, 184, 0.5);
      box-shadow: 0 0 0 1px rgba(15, 23, 42, 1), 0 8px 18px rgba(15, 23, 42, 0.9);
    }

    .metric-label {
      font-size: 11px;
      letter-spacing: 0.12em;
      text-transform: uppercase;
      color: #9ca3af;
      margin-bottom: 8px;
    }

    .field { display: grid; grid-template-columns: 1fr; gap: 6px; margin-bottom: 10px; }
    .field label { font-size: 11px; color: #9ca3af; }
    .field input, .field textarea {
      background: rgba(2,6,23,0.55);
      border: 1px solid rgba(148,163,184,0.35);
      color: #e5e7eb;
      border-radius: 12px;
      padding: 10px 10px;
      font-size: 13px;
      outline: none;
    }
    .field textarea { min-height: 80px; resize: vertical; }

    .help { font-size: 11px; color: #9ca3af; margin-top: 8px; line-height: 1.35; }
    .banner {
      display:none;
      border-radius: 10px;
      border: 1px solid rgba(248, 113, 113, 0.7);
      background: rgba(127, 29, 29, 0.7);
      color: #fee2e2;
      padding: 8px 10px;
      font-size: 12px;
      margin-top: 12px;
      white-space: pre-wrap;
    }
    .banner.ok {
      border: 1px solid rgba(52, 211, 153, 0.7);
      background: rgba(6, 78, 59, 0.65);
      color: #d1fae5;
    }

    .split-actions { display:flex; gap:10px; flex-wrap:wrap; justify-content:flex-end; margin-top: 10px; }
  </style>
</head>

<body>
  <div class="page">
    <div class="header">
      <div>
        <h1>Monthly Finance Admin</h1>
        <div class="subtitle">
          Pre-load monthly budgets and update actuals at month-end. GP is stored as a percentage (no calculations).
        </div>
      </div>

      <div class="controls">
        <div class="pill">
          <div class="pill-label">Month</div>
          <input type="month" id="monthPicker" />
        </div>

        <div class="pill">
          <div class="pill-label">Site</div>
          <select id="sitePicker">
            <option value="London">London</option>
            <option value="Newcastle">Newcastle</option>
          </select>
        </div>

        <button class="btn btn-secondary" id="loadBtn">Load</button>
        <button class="btn" id="saveBtn">Save (Upsert)</button>
        <a class="btn btn-secondary" href="./monthly-dashboard.html" style="text-decoration:none;">Back to Monthly Dashboard</a>
      </div>
    </div>

    <div id="banner" class="banner"></div>

    <div class="card">
      <div class="card-header">
        <div>
          <div class="card-title">Budgets (Monthly)</div>
          <div class="card-subtitle">Enter budget values for the selected month/site.</div>
        </div>
      </div>

      <div class="row-2">
        <div class="metric">
          <div class="metric-label">Sales</div>
          <div class="field">
            <label>Budget Retail Sales (£)</label>
            <input id="b_retail_sales" type="number" step="0.01" />
          </div>
          <div class="field">
            <label>Budget Hospitality Sales (£)</label>
            <input id="b_hosp_sales" type="number" step="0.01" />
          </div>
          <div class="field">
            <label>Budget Free Issue (£)</label>
            <input id="b_free_issue" type="number" step="0.01" />
          </div>
        </div>

        <div class="metric">
          <div class="metric-label">Labour & GP</div>
          <div class="field">
            <label>Budget Core Wages (£)</label>
            <input id="b_core_wages" type="number" step="0.01" />
          </div>
          <div class="field">
            <label>Budget Agency Spend (£)</label>
            <input id="b_agency" type="number" step="0.01" />
          </div>
          <div class="field">
            <label>Budget GP (%)</label>
            <input id="b_gp" type="number" step="0.01" />
          </div>
        </div>
      </div>
    </div>

    <div class="card">
      <div class="card-header">
        <div>
          <div class="card-title">Actuals (Monthly)</div>
          <div class="card-subtitle">Update these at month-end.</div>
        </div>
      </div>

      <div class="row-2">
        <div class="metric">
          <div class="metric-label">Sales</div>
          <div class="field">
            <label>Actual Retail Sales (£)</label>
            <input id="a_retail_sales" type="number" step="0.01" />
          </div>
          <div class="field">
            <label>Actual Hospitality Sales (£)</label>
            <input id="a_hosp_sales" type="number" step="0.01" />
          </div>
          <div class="field">
            <label>Actual Free Issue (£)</label>
            <input id="a_free_issue" type="number" step="0.01" />
          </div>
        </div>

        <div class="metric">
          <div class="metric-label">Labour & GP</div>
          <div class="field">
            <label>Actual Core Wages (£)</label>
            <input id="a_core_wages" type="number" step="0.01" />
          </div>
          <div class="field">
            <label>Actual Agency Spend (£)</label>
            <input id="a_agency" type="number" step="0.01" />
          </div>
          <div class="field">
            <label>Actual GP (%)</label>
            <input id="a_gp" type="number" step="0.01" />
          </div>
        </div>
      </div>

      <div class="metric" style="margin-top:12px;">
        <div class="metric-label">Notes</div>
        <div class="field">
          <textarea id="notes" placeholder="Optional notes for this month/site..."></textarea>
        </div>
      </div>

      <div class="split-actions">
        <button class="btn btn-secondary" id="clearBtn">Clear Form</button>
      </div>

      <div class="help">
        Month key is saved as the 1st of the month (e.g. 2025-12-01). Use Save (Upsert) to create or overwrite the row.
      </div>
    </div>
  </div>

  <script type="module">
    import { supabase } from './supabase-config.js';

    const monthPicker = document.getElementById('monthPicker');
    const sitePicker = document.getElementById('sitePicker');
    const loadBtn = document.getElementById('loadBtn');
    const saveBtn = document.getElementById('saveBtn');
    const clearBtn = document.getElementById('clearBtn');
    const banner = document.getElementById('banner');

    const fields = {
      b_retail_sales: document.getElementById('b_retail_sales'),
      b_hosp_sales: document.getElementById('b_hosp_sales'),
      b_free_issue: document.getElementById('b_free_issue'),
      b_core_wages: document.getElementById('b_core_wages'),
      b_agency: document.getElementById('b_agency'),
      b_gp: document.getElementById('b_gp'),

      a_retail_sales: document.getElementById('a_retail_sales'),
      a_hosp_sales: document.getElementById('a_hosp_sales'),
      a_free_issue: document.getElementById('a_free_issue'),
      a_core_wages: document.getElementById('a_core_wages'),
      a_agency: document.getElementById('a_agency'),
      a_gp: document.getElementById('a_gp'),

      notes: document.getElementById('notes'),
    };

    function showBanner(msg, ok=false) {
      banner.classList.toggle('ok', ok);
      banner.textContent = msg;
      banner.style.display = 'block';
    }

    function hideBanner() {
      banner.style.display = 'none';
      banner.textContent = '';
      banner.classList.remove('ok');
    }

    function safeNum(v) {
      const n = Number(v);
      return Number.isFinite(n) ? n : 0;
    }

    function monthStartFromPicker() {
      const v = (monthPicker.value || '').trim(); // YYYY-MM
      if (!v) return null;
      return `${v}-01`;
    }

    function clearForm() {
      Object.values(fields).forEach(el => {
        if (el.tagName === 'TEXTAREA') el.value = '';
        else el.value = '';
      });
    }

    async function loadRow() {
      hideBanner();
      const month_start = monthStartFromPicker();
      const site = sitePicker.value;

      if (!month_start) {
        showBanner('Please select a month first.');
        return;
      }

      const { data, error } = await supabase
        .from('monthly_finance_summary')
        .select('*')
        .eq('month_start', month_start)
        .eq('site', site)
        .maybeSingle();

      if (error) {
        showBanner(`Load error:\n${error.message}`);
        return;
      }

      if (!data) {
        clearForm();
        showBanner('No row found yet for this month/site. Enter values and click Save (Upsert).', true);
        return;
      }

      fields.b_retail_sales.value = data.budget_retail_sales ?? 0;
      fields.b_hosp_sales.value = data.budget_hospitality_sales ?? 0;
      fields.b_free_issue.value = data.budget_free_issue ?? 0;
      fields.b_core_wages.value = data.budget_core_wages ?? 0;
      fields.b_agency.value = data.budget_agency_spend ?? 0;
      fields.b_gp.value = data.budget_gp_pct ?? 0;

      fields.a_retail_sales.value = data.actual_retail_sales ?? 0;
      fields.a_hosp_sales.value = data.actual_hospitality_sales ?? 0;
      fields.a_free_issue.value = data.actual_free_issue ?? 0;
      fields.a_core_wages.value = data.actual_core_wages ?? 0;
      fields.a_agency.value = data.actual_agency_spend ?? 0;
      fields.a_gp.value = data.actual_gp_pct ?? 0;

      fields.notes.value = data.notes ?? '';

      showBanner('Row loaded.', true);
    }

    async function saveRow() {
      hideBanner();
      const month_start = monthStartFromPicker();
      const site = sitePicker.value;

      if (!month_start) {
        showBanner('Please select a month first.');
        return;
      }

      saveBtn.disabled = true;
      saveBtn.textContent = 'Saving…';

      const payload = {
        month_start,
        site,

        budget_retail_sales: safeNum(fields.b_retail_sales.value),
        budget_hospitality_sales: safeNum(fields.b_hosp_sales.value),
        budget_free_issue: safeNum(fields.b_free_issue.value),
        budget_core_wages: safeNum(fields.b_core_wages.value),
        budget_agency_spend: safeNum(fields.b_agency.value),
        budget_gp_pct: safeNum(fields.b_gp.value),

        actual_retail_sales: safeNum(fields.a_retail_sales.value),
        actual_hospitality_sales: safeNum(fields.a_hosp_sales.value),
        actual_free_issue: safeNum(fields.a_free_issue.value),
        actual_core_wages: safeNum(fields.a_core_wages.value),
        actual_agency_spend: safeNum(fields.a_agency.value),
        actual_gp_pct: safeNum(fields.a_gp.value),

        notes: (fields.notes.value || '').toString().trim()
      };

      const { error } = await supabase
        .from('monthly_finance_summary')
        .upsert(payload, { onConflict: 'month_start,site' });

      saveBtn.disabled = false;
      saveBtn.textContent = 'Save (Upsert)';

      if (error) {
        showBanner(`Save error:\n${error.message}`);
        return;
      }

      showBanner('Saved successfully.', true);
    }

    // Defaults: current month
    const now = new Date();
    const yyyy = now.getFullYear();
    const mm = String(now.getMonth() + 1).padStart(2, '0');
    monthPicker.value = `${yyyy}-${mm}`;

    loadBtn.addEventListener('click', loadRow);
    saveBtn.addEventListener('click', saveRow);
    clearBtn.addEventListener('click', () => { hideBanner(); clearForm(); });

    // auto-load on change
    monthPicker.addEventListener('change', loadRow);
    sitePicker.addEventListener('change', loadRow);

    loadRow();
  </script>
</body>
</html>
