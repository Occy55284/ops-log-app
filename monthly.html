<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Ops Log • Monthly Dashboard</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    body {
      margin: 0;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: #0b1220;
      color: #f9fafb;
      display: flex;
      align-items: center;
      justify-content: center;
      min-height: 100vh;
    }

    .page {
      max-width: 1200px;
      width: 100%;
      padding: 24px;
      box-sizing: border-box;
    }

    .header {
      display: flex;
      flex-wrap: wrap;
      align-items: center;
      justify-content: space-between;
      gap: 12px;
      margin-bottom: 20px;
    }

    .title-wrap {
      display: flex;
      flex-direction: column;
      gap: 4px;
    }

    h1 {
      margin: 0;
      font-size: 24px;
      letter-spacing: 0.03em;
      text-transform: uppercase;
      color: #e5e7eb;
    }

    .subtitle {
      font-size: 13px;
      color: #9ca3af;
    }

    .controls {
      display: flex;
      align-items: center;
      gap: 10px;
      flex-wrap: wrap;
    }

    .pill {
      border-radius: 999px;
      background: rgba(15, 23, 42, 0.95);
      border: 1px solid rgba(148, 163, 184, 0.4);
      padding: 6px 12px;
      font-size: 12px;
      color: #e5e7eb;
      display: inline-flex;
      align-items: center;
      gap: 6px;
    }

    .pill-label {
      text-transform: uppercase;
      letter-spacing: 0.12em;
      font-size: 11px;
      color: #9ca3af;
    }

    .pill-value {
      font-weight: 500;
    }

    .pill-input {
      border: none;
      background: transparent;
      color: #e5e7eb;
      font-size: 12px;
      padding: 2px 4px;
      outline: none;
      cursor: pointer;
    }

    .pill-input::-webkit-calendar-picker-indicator {
      filter: invert(1);
      cursor: pointer;
    }

    .btn {
      border-radius: 999px;
      border: 1px solid rgba(94, 234, 212, 0.5);
      background: radial-gradient(circle at top left, rgba(45, 212, 191, 0.35), rgba(15, 23, 42, 1));
      color: #ecfeff;
      padding: 8px 14px;
      font-size: 12px;
      font-weight: 500;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      gap: 8px;
      box-shadow:
        0 0 0 1px rgba(15, 23, 42, 1),
        0 8px 18px rgba(45, 212, 191, 0.2);
      transition: transform 0.1s ease, box-shadow 0.1s ease, background 0.1s ease, opacity 0.1s ease;
      text-decoration: none;
    }

    .btn:hover:not(:disabled) {
      transform: translateY(-1px);
      box-shadow:
        0 0 0 1px rgba(15, 23, 42, 1),
        0 12px 26px rgba(45, 212, 191, 0.28);
    }

    .btn:disabled {
      opacity: 0.4;
      cursor: default;
      box-shadow:
        0 0 0 1px rgba(15, 23, 42, 1),
        0 4px 10px rgba(15, 23, 42, 0.6);
    }

    .btn-icon {
      font-size: 15px;
    }

    .btn-secondary {
      border-color: rgba(148, 163, 184, 0.6);
      background: radial-gradient(circle at top left, rgba(30, 64, 175, 0.4), rgba(15, 23, 42, 1));
    }

    .card {
      background: radial-gradient(circle at top left, rgba(30, 64, 175, 0.4), rgba(15, 23, 42, 0.98));
      border-radius: 18px;
      border: 1px solid rgba(148, 163, 184, 0.35);
      box-shadow:
        0 0 0 1px rgba(15, 23, 42, 1),
        0 18px 40px rgba(15, 23, 42, 0.9);
      padding: 14px;
      box-sizing: border-box;
    }

    .card-header {
      display: flex;
      align-items: baseline;
      justify-content: space-between;
      gap: 8px;
      margin-bottom: 10px;
    }

    .card-title {
      font-size: 14px;
      letter-spacing: 0.11em;
      text-transform: uppercase;
      color: #e5e7eb;
    }

    .card-subtitle {
      font-size: 11px;
      color: #9ca3af;
    }

    .metric-row {
      display: grid;
      grid-template-columns: repeat(3, minmax(0, 1fr));
      gap: 10px;
    }

    @media (max-width: 900px) {
      .metric-row {
        grid-template-columns: minmax(0, 1fr);
      }
      .page {
        padding: 16px;
      }
    }

    .metric {
      background: radial-gradient(circle at top left, rgba(15, 23, 42, 0.9), rgba(15, 23, 42, 1));
      border-radius: 14px;
      padding: 10px 10px 10px;
      border: 1px solid rgba(148, 163, 184, 0.5);
      box-shadow:
        0 0 0 1px rgba(15, 23, 42, 1),
        0 8px 18px rgba(15, 23, 42, 0.9);
    }

    .metric-label {
      font-size: 11px;
      letter-spacing: 0.12em;
      text-transform: uppercase;
      color: #9ca3af;
      margin-bottom: 6px;
    }

    .metric-value {
      font-size: 20px;
      font-weight: 600;
      color: #e5e7eb;
    }

    .metric-sub {
      font-size: 11px;
      color: #9ca3af;
      margin-top: 2px;
    }

    .divider {
      height: 1px;
      background: linear-gradient(to right, transparent, rgba(148, 163, 184, 0.4), transparent);
      margin: 12px 0;
    }

    .section-label {
      font-size: 11px;
      text-transform: uppercase;
      letter-spacing: 0.14em;
      color: #6b7280;
      margin: 18px 0 8px;
    }

    .error-banner {
      display: none;
      border-radius: 10px;
      border: 1px solid rgba(248, 113, 113, 0.7);
      background: rgba(127, 29, 29, 0.7);
      color: #fee2e2;
      padding: 8px 10px;
      font-size: 12px;
      margin-bottom: 12px;
    }

    .empty-text {
      font-size: 11px;
      color: #9ca3af;
      margin-top: 4px;
    }

    .notes-list {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .note-photo-thumb {
      margin-top: 6px;
      border-radius: 10px;
      max-width: 120px;
      max-height: 90px;
      object-fit: cover;
      border: 1px solid rgba(148, 163, 184, 0.5);
      display: block;
    }

    .note-photo-link {
      font-size: 11px;
      margin-top: 4px;
      display: inline-block;
      color: #7dd3fc;
      text-decoration: none;
    }

    .note-photo-link:hover {
      text-decoration: underline;
    }

    @media (max-width: 900px) {
      .header {
        align-items: flex-start;
      }
    }
  </style>
</head>
<body>
  <div class="page">
    <div class="header">
      <div class="title-wrap">
        <h1>Monthly Ops Dashboard</h1>
        <div class="subtitle">
          Snapshot of logs, staffing, incidents and notes for the selected month.
        </div>
      </div>
      <div class="controls">
        <div class="pill">
          <div class="pill-label">Month</div>
          <input type="month" id="monthInput" class="pill-input" />
        </div>
        <div class="pill">
          <div class="pill-label">Range</div>
          <div class="pill-value" id="rangeLabel">–</div>
        </div>
        <button class="btn btn-secondary" id="prevMonthBtn">
          <span class="btn-icon">◀</span>
          Previous
        </button>
        <button class="btn btn-secondary" id="nextMonthBtn">
          <span class="btn-icon">▶</span>
          Next
        </button>
        <button class="btn" id="latestMonthBtn">
          <span class="btn-icon">⟳</span>
          Latest month
        </button>
        <a href="dashboard.html" class="btn btn-secondary">Weekly view</a>
        <a href="log.html" class="btn">Daily log</a>
      </div>
    </div>

    <div id="errorMessage" class="error-banner"></div>

    <div class="card">
      <div class="card-header">
        <div>
          <div class="card-title">Monthly Overview</div>
          <div class="card-subtitle">Totals across ops_logs for the selected calendar month.</div>
        </div>
      </div>

      <div class="metric-row">
        <div class="metric">
          <div class="metric-label">Total Logs</div>
          <div class="metric-value" id="kpiTotalLogs">0</div>
          <div class="metric-sub" id="kpiTotalLogsSub">No logs this month</div>
        </div>
        <div class="metric">
          <div class="metric-label">Staffing Summary</div>
          <div class="metric-value" id="kpiStaffingTotals">–</div>
          <div class="metric-sub" id="kpiStaffingTotalsSub">Sick / Holiday / Agency</div>
        </div>
        <div class="metric">
          <div class="metric-label">Incidents</div>
          <div class="metric-value" id="kpiIncidentsTotals">–</div>
          <div class="metric-sub" id="kpiIncidentsTotalsSub">Maintenance &amp; H&amp;S</div>
        </div>
      </div>

      <div class="metric-row" style="margin-top:10px;">
        <div class="metric">
          <div class="metric-label">Logs by Site</div>
          <div class="metric-value" id="kpiLogsBySite">–</div>
          <div class="metric-sub" id="kpiLogsBySiteSub">Site split</div>
        </div>
        <div class="metric">
          <div class="metric-label">Data Completeness</div>
          <div class="metric-value" id="kpiDataHealth">–</div>
          <div class="metric-sub" id="kpiDataHealthSub">Logs with core detail</div>
        </div>
        <div class="metric">
          <div class="metric-label">Status</div>
          <div class="metric-value" id="kpiStatus">–</div>
          <div class="metric-sub" id="statusText">Loading…</div>
        </div>
      </div>

      <div class="divider"></div>

      <div class="section-label">Daily notes &amp; photos</div>
      <div id="notesEmptyNote" class="empty-text">No notes captured this month.</div>
      <div id="notesList" class="notes-list"></div>
    </div>
  </div>

  <script type="module">
    import { supabase } from './supabase-config.js';

    const monthInput = document.getElementById('monthInput');
    const rangeLabelEl = document.getElementById('rangeLabel');
    const errorMessageEl = document.getElementById('errorMessage');

    const prevMonthBtn = document.getElementById('prevMonthBtn');
    const nextMonthBtn = document.getElementById('nextMonthBtn');
    const latestMonthBtn = document.getElementById('latestMonthBtn');

    const kpiTotalLogsEl = document.getElementById('kpiTotalLogs');
    const kpiTotalLogsSubEl = document.getElementById('kpiTotalLogsSub');
    const kpiStaffingTotalsEl = document.getElementById('kpiStaffingTotals');
    const kpiStaffingTotalsSubEl = document.getElementById('kpiStaffingTotalsSub');
    const kpiIncidentsTotalsEl = document.getElementById('kpiIncidentsTotals');
    const kpiIncidentsTotalsSubEl = document.getElementById('kpiIncidentsTotalsSub');
    const kpiLogsBySiteEl = document.getElementById('kpiLogsBySite');
    const kpiLogsBySiteSubEl = document.getElementById('kpiLogsBySiteSub');
    const kpiDataHealthEl = document.getElementById('kpiDataHealth');
    const kpiDataHealthSubEl = document.getElementById('kpiDataHealthSub');
    const kpiStatusEl = document.getElementById('kpiStatus');
    const statusTextEl = document.getElementById('statusText');

    const notesEmptyNoteEl = document.getElementById('notesEmptyNote');
    const notesListEl = document.getElementById('notesList');

    let latestMonthKey = null; // "YYYY-MM"

    function parseCount(value) {
      if (!value) return 0;
      if (value === '3+') return 3;
      const n = parseInt(value, 10);
      return isNaN(n) ? 0 : n;
    }

    function safeNumber(val) {
      const n = Number(val);
      return Number.isFinite(n) ? n : 0;
    }

    function formatDateLabel(dateStr) {
      const d = new Date(dateStr);
      if (isNaN(d)) return dateStr;
      return d.toLocaleDateString('en-GB', {
        day: 'numeric',
        month: 'short'
      });
    }

    function getMonthRange(year, monthIndexZeroBased) {
      const start = new Date(year, monthIndexZeroBased, 1);
      const end = new Date(year, monthIndexZeroBased + 1, 0);
      const startISO = start.toISOString().slice(0, 10);
      const endISO = end.toISOString().slice(0, 10);
      return { start, end, startISO, endISO };
    }

    function setButtonsState() {
      if (!latestMonthKey) {
        nextMonthBtn.disabled = true;
        return;
      }
      const current = monthInput.value || latestMonthKey;
      nextMonthBtn.disabled = current >= latestMonthKey;
    }

    function setEmptyState(message = 'No logs for this month.') {
      kpiTotalLogsEl.textContent = '0';
      kpiTotalLogsSubEl.textContent = 'No logs this month';

      kpiStaffingTotalsEl.textContent = '–';
      kpiStaffingTotalsSubEl.textContent = 'No staffing data';

      kpiIncidentsTotalsEl.textContent = '0';
      kpiIncidentsTotalsSubEl.textContent = 'No incidents recorded';

      kpiLogsBySiteEl.textContent = '–';
      kpiLogsBySiteSubEl.textContent = 'No site data';

      kpiDataHealthEl.textContent = '–';
      kpiDataHealthSubEl.textContent = 'No logs';

      kpiStatusEl.textContent = 'OK';
      statusTextEl.textContent = message;

      notesListEl.innerHTML = '';
      notesEmptyNoteEl.style.display = 'block';
    }

    async function initMonthly() {
      errorMessageEl.style.display = 'none';
      errorMessageEl.textContent = '';

      try {
        const { data, error } = await supabase
          .from('ops_logs')
          .select('log_date')
          .not('log_date', 'is', null)
          .order('log_date', { ascending: false })
          .limit(1);

        if (error) {
          console.error('Error loading latest month:', error);
          errorMessageEl.textContent = 'There was an error loading monthly data.';
          errorMessageEl.style.display = 'block';
          setEmptyState('Error loading monthly data.');
          return;
        }

        if (!data || data.length === 0 || !data[0].log_date) {
          latestMonthKey = null;
          monthInput.value = '';
          rangeLabelEl.textContent = '–';
          setButtonsState();
          setEmptyState('No logs available yet.');
          return;
        }

        const latestDate = new Date(data[0].log_date);
        const year = latestDate.getFullYear();
        const month = String(latestDate.getMonth() + 1).padStart(2, '0');
        latestMonthKey = `${year}-${month}`;

        monthInput.value = latestMonthKey;
        setButtonsState();
        await loadMonthlyData();
      } catch (err) {
        console.error('Error initialising monthly dashboard:', err);
        errorMessageEl.textContent = 'There was an error initialising monthly data.';
        errorMessageEl.style.display = 'block';
        setEmptyState('Error initialising monthly data.');
      }
    }

    async function loadMonthlyData() {
      const monthVal = monthInput.value || latestMonthKey;
      if (!monthVal) {
        setEmptyState('No month selected.');
        return;
      }

      const [yearStr, monthStr] = monthVal.split('-');
      const year = parseInt(yearStr, 10);
      const monthIdx = parseInt(monthStr, 10) - 1;

      const { start, end, startISO, endISO } = getMonthRange(year, monthIdx);

      rangeLabelEl.textContent =
        start.toLocaleDateString('en-GB', {
          day: '2-digit',
          month: 'short',
          year: 'numeric',
        }) +
        ' – ' +
        end.toLocaleDateString('en-GB', {
          day: '2-digit',
          month: 'short',
          year: 'numeric',
        });

      statusTextEl.textContent = 'Loading monthly data…';
      kpiStatusEl.textContent = '…';

      errorMessageEl.style.display = 'none';
      errorMessageEl.textContent = '';

      try {
        const { data, error } = await supabase
          .from('ops_logs')
          .select('*')
          .gte('log_date', startISO)
          .lte('log_date', endISO)
          .order('log_date', { ascending: true })
          .order('created_at', { ascending: true });

        if (error) {
          console.error('Error loading monthly data:', error);
          errorMessageEl.textContent = 'There was an error loading monthly data.';
          errorMessageEl.style.display = 'block';
          setEmptyState('Error loading monthly data.');
          return;
        }

        const rows = data || [];

        if (!rows.length) {
          setEmptyState('No logs for this month.');
          return;
        }

        populateOverview(rows);
        populateNotes(rows);

        kpiStatusEl.textContent = 'OK';
        statusTextEl.textContent = 'Data loaded.';
      } catch (err) {
        console.error('Error loading monthly data:', err);
        errorMessageEl.textContent = 'There was an error loading monthly data.';
        errorMessageEl.style.display = 'block';
        setEmptyState('Error loading monthly data.');
      }
    }

    function populateOverview(rows) {
      const totalLogs = rows.length;
      kpiTotalLogsEl.textContent = totalLogs.toString();
      kpiTotalLogsSubEl.textContent = `Logs captured across ${new Set(rows.map(r => r.site)).size} sites`;

      // Staffing totals
      let totalSick = 0;
      let totalHoliday = 0;
      let totalAgency = 0;

      rows.forEach(row => {
        totalSick += parseCount(row.sickness_count);
        totalHoliday += parseCount(row.holiday_count);
        totalAgency += parseCount(row.agency_count);
      });

      const staffingTotal = totalSick + totalHoliday + totalAgency;
      kpiStaffingTotalsEl.textContent = staffingTotal.toString();
      kpiStaffingTotalsSubEl.textContent =
        `Sick: ${totalSick} • Holiday: ${totalHoliday} • Agency: ${totalAgency}`;

      // Incidents
      let maintenanceCount = 0;
      let maintenanceReported = 0;
      let hsCount = 0;
      let hsReported = 0;

      rows.forEach(row => {
        if (row.maintenance_issue && row.maintenance_issue !== 'None') {
          maintenanceCount++;
          if (row.maintenance_reported === 'Yes') {
            maintenanceReported++;
          }
        }

        if (row.hs_issue && row.hs_issue !== 'None') {
          hsCount++;
          if (row.hs_reported === 'Yes') {
            hsReported++;
          }
        }
      });

      const totalIncidents = maintenanceCount + hsCount;
      if (totalIncidents === 0) {
        kpiIncidentsTotalsEl.textContent = '0';
        kpiIncidentsTotalsSubEl.textContent = 'No incidents recorded';
      } else {
        kpiIncidentsTotalsEl.textContent = `${totalIncidents}`;
        kpiIncidentsTotalsSubEl.textContent =
          `Maint: ${maintenanceCount} (reported ${maintenanceReported}) • ` +
          `H&S: ${hsCount} (reported ${hsReported})`;
      }

      // Logs by site
      const logsBySiteMap = {};
      rows.forEach(row => {
        if (!row.site) return;
        logsBySiteMap[row.site] = (logsBySiteMap[row.site] || 0) + 1;
      });

      const siteEntries = Object.entries(logsBySiteMap)
        .sort((a, b) => b[1] - a[1]);

      if (siteEntries.length > 0) {
        const [topSite, topCount] = siteEntries[0];
        kpiLogsBySiteEl.textContent = `${topCount}`;
        const detail = siteEntries.map(([site, count]) => `${site} (${count})`).join(' • ');
        kpiLogsBySiteSubEl.textContent = detail;
      } else {
        kpiLogsBySiteEl.textContent = '–';
        kpiLogsBySiteSubEl.textContent = 'No site data';
      }

      // Data completeness (same logic as weekly)
      let completeCount = 0;
      rows.forEach(row => {
        const hasCore =
          (row.sickness_count && row.sickness_count !== '0') ||
          (row.holiday_count && row.holiday_count !== '0') ||
          (row.agency_count && row.agency_count !== '0') ||
          (row.notes && row.notes.trim() !== '');

        if (hasCore) completeCount++;
      });

      const completeness = rows.length > 0
        ? Math.round((completeCount / rows.length) * 100)
        : 0;

      kpiDataHealthEl.textContent = `${completeness}%`;
      kpiDataHealthSubEl.textContent = `${completeCount}/${rows.length} logs with core detail`;
    }

    function populateNotes(rows) {
      const notes = rows
        .filter(r => (r.notes && r.notes.trim() !== '') || r.photo_url)
        .map(r => ({
          notes: (r.notes || '').trim(),
          site: r.site || 'Unknown',
          area: r.area || '',
          photoUrl: r.photo_url || null,
          dateKey: r.log_date || (r.created_at ? r.created_at.substring(0, 10) : '')
        }))
        .sort((a, b) => a.dateKey < b.dateKey ? -1 : 1);

      notesListEl.innerHTML = '';

      if (!notes.length) {
        notesEmptyNoteEl.style.display = 'block';
        return;
      }

      notesEmptyNoteEl.style.display = 'none';

      notes.forEach(note => {
        const dateStr = note.dateKey ? formatDateLabel(note.dateKey) : 'Unknown';

        let html = `
          <div class="metric-label">Notes • ${note.site}${note.area ? ' • ' + note.area : ''}</div>
          <div class="metric-sub"><strong>${dateStr}</strong></div>
        `;

        if (note.notes) {
          html += `<div class="metric-sub">${note.notes}</div>`;
        } else {
          html += `<div class="metric-sub"><span style="opacity:0.7;">No text notes – photo only.</span></div>`;
        }

        if (note.photoUrl) {
          html += `
            <a class="note-photo-link" href="${note.photoUrl}" target="_blank" rel="noopener noreferrer">
              View photo in full size
            </a>
            <img class="note-photo-thumb" src="${note.photoUrl}" alt="Log photo thumbnail" />
          `;
        }

        const div = document.createElement('div');
        div.className = 'metric';
        div.innerHTML = html;
        notesListEl.appendChild(div);
      });
    }

    function changeMonth(delta) {
      if (!latestMonthKey) return;

      const current = monthInput.value || latestMonthKey;
      const [yearStr, monthStr] = current.split('-');
      let year = parseInt(yearStr, 10);
      let monthIndex = parseInt(monthStr, 10) - 1;

      monthIndex += delta; // delta can be -1 or +1

      if (monthIndex < 0) {
        year -= 1;
        monthIndex += 12;
      } else if (monthIndex > 11) {
        year += 1;
        monthIndex -= 12;
      }

      const newMonth = String(monthIndex + 1).padStart(2, '0');
      const newKey = `${year}-${newMonth}`;

      // Don't go into future beyond latestMonthKey
      if (delta > 0 && latestMonthKey && newKey > latestMonthKey) {
        return;
      }

      monthInput.value = newKey;
      setButtonsState();
      loadMonthlyData();
    }

    // Event handlers
    monthInput.addEventListener('change', () => {
      setButtonsState();
      loadMonthlyData();
    });

    prevMonthBtn.addEventListener('click', () => {
      changeMonth(-1);
    });

    nextMonthBtn.addEventListener('click', () => {
      changeMonth(1);
    });

    latestMonthBtn.addEventListener('click', () => {
      if (!latestMonthKey) return;
      monthInput.value = latestMonthKey;
      setButtonsState();
      loadMonthlyData();
    });

    // Init
    initMonthly();
  </script>
</body>
</html>
