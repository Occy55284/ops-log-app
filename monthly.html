<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Ops Log • Monthly Dashboard</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    body {
      margin: 0;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: #0b1220;
      color: #f9fafb;
      min-height: 100vh;
    }

    .wrap {
      max-width: 1400px;
      margin: 0 auto;
      padding: 18px 14px 42px;
    }

    .topbar {
      display: flex;
      flex-wrap: wrap;
      align-items: center;
      justify-content: space-between;
      gap: 12px;
      margin-bottom: 14px;
    }

    .brand { display: flex; gap: 10px; align-items: center; }

    .logo {
      width: 42px; height: 42px; border-radius: 12px;
      background: linear-gradient(135deg, #1f2a44, #0f172a);
      box-shadow: 0 0 0 1px rgba(255,255,255,0.06) inset, 0 12px 24px rgba(0,0,0,0.25);
      display: grid; place-items: center;
      font-weight: 800; letter-spacing: 0.5px;
      color: #93c5fd;
    }

    .titleblock .title { font-size: 18px; font-weight: 750; line-height: 1.2; }
    .titleblock .subtitle { font-size: 12px; color: rgba(255,255,255,0.68); margin-top: 2px; }

    .filters { display: flex; gap: 10px; flex-wrap: wrap; align-items: center; justify-content: flex-end; }

    .filter {
      background: rgba(255,255,255,0.05);
      border: 1px solid rgba(255,255,255,0.08);
      padding: 10px 12px;
      border-radius: 14px;
      display: flex;
      align-items: center;
      gap: 10px;
      min-width: 220px;
      box-shadow: 0 8px 18px rgba(0,0,0,0.20);
    }

    .filter label {
      font-size: 12px;
      color: rgba(255,255,255,0.72);
      white-space: nowrap;
    }

    select {
      background: rgba(0,0,0,0.25);
      border: 1px solid rgba(255,255,255,0.12);
      color: #f9fafb;
      padding: 8px 10px;
      border-radius: 10px;
      outline: none;
      width: 100%;
      font-size: 13px;
    }

    .btn {
      background: rgba(59,130,246,0.20);
      border: 1px solid rgba(59,130,246,0.42);
      color: rgba(219,234,254,0.95);
      padding: 10px 12px;
      border-radius: 14px;
      font-weight: 750;
      font-size: 13px;
      cursor: pointer;
      box-shadow: 0 10px 22px rgba(0,0,0,0.22);
      transition: transform .08s ease, filter .08s ease;
      text-decoration: none;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
    }
    .btn:hover { filter: brightness(1.08); }
    .btn:active { transform: translateY(1px); }

    .btn-secondary {
      background: rgba(255,255,255,0.06);
      border: 1px solid rgba(255,255,255,0.10);
      color: rgba(255,255,255,0.88);
    }

    .pill {
      font-size: 11px;
      background: rgba(59,130,246,0.18);
      border: 1px solid rgba(59,130,246,0.35);
      color: rgba(219,234,254,0.92);
      padding: 6px 10px;
      border-radius: 999px;
      white-space: nowrap;
    }

    .error {
      display: none;
      margin-top: 10px;
      background: rgba(239,68,68,0.15);
      border: 1px solid rgba(239,68,68,0.35);
      color: rgba(254,226,226,0.92);
      padding: 10px 12px;
      border-radius: 14px;
      font-size: 12px;
      white-space: pre-wrap;
    }

    .grid { display: grid; grid-template-columns: 1fr; gap: 14px; margin-top: 14px; }
    .row-1, .row-2, .row-3 { display: grid; gap: 14px; }
    .row-1 { grid-template-columns: repeat(3, minmax(0, 1fr)); }
    .row-2 { grid-template-columns: repeat(2, minmax(0, 1fr)); }
    .row-3 { grid-template-columns: repeat(3, minmax(0, 1fr)); }

    @media (max-width: 1100px) {
      .row-1 { grid-template-columns: repeat(2, minmax(0, 1fr)); }
      .row-3 { grid-template-columns: repeat(2, minmax(0, 1fr)); }
    }
    @media (max-width: 640px) {
      .row-1, .row-2, .row-3 { grid-template-columns: 1fr; }
      .filter { min-width: 100%; }
    }

    .card {
      background: rgba(255,255,255,0.04);
      border: 1px solid rgba(255,255,255,0.08);
      border-radius: 18px;
      padding: 14px;
      box-shadow: 0 10px 24px rgba(0,0,0,0.24);
      position: relative;
      overflow: hidden;
    }

    .card::before {
      content: "";
      position: absolute;
      inset: -1px;
      background: radial-gradient(650px 140px at 15% 0%, rgba(59,130,246,0.18), transparent 65%),
                  radial-gradient(550px 160px at 85% 0%, rgba(236,72,153,0.14), transparent 60%);
      pointer-events: none;
    }
    .card > * { position: relative; }

    .card-header {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      gap: 10px;
      margin-bottom: 10px;
      flex-wrap: wrap;
    }

    .card-title { font-weight: 750; font-size: 14px; letter-spacing: 0.2px; }
    .card-subtitle { font-size: 12px; color: rgba(255,255,255,0.65); margin-top: 3px; line-height: 1.25; }

    .kpis { display: grid; grid-template-columns: repeat(3, minmax(0, 1fr)); gap: 10px; margin-top: 6px; }
    .kpi { background: rgba(0,0,0,0.22); border: 1px solid rgba(255,255,255,0.08); border-radius: 14px; padding: 10px 10px 9px; }
    .kpi .label { font-size: 11px; color: rgba(255,255,255,0.65); }
    .kpi .value { font-size: 20px; font-weight: 800; margin-top: 2px; letter-spacing: 0.2px; }
    .kpi .sub { font-size: 11px; color: rgba(255,255,255,0.65); margin-top: 2px; line-height: 1.25; }

    .metric-row { display: grid; grid-template-columns: repeat(2, minmax(0, 1fr)); gap: 10px; }
    .metric { background: rgba(0,0,0,0.22); border: 1px solid rgba(255,255,255,0.08); border-radius: 14px; padding: 10px; }
    .metric-label { font-size: 11px; color: rgba(255,255,255,0.65); }
    .metric-value { font-size: 18px; font-weight: 800; margin-top: 2px; }
    .metric-sub { font-size: 11px; color: rgba(255,255,255,0.62); margin-top: 2px; line-height: 1.25; }

    /* Hospitality events mix bar */
    .hosp-mixbar {
      margin-top: 12px;
      height: 12px;
      border-radius: 999px;
      overflow: hidden;
      display: flex;
      background: rgba(255,255,255,0.08);
      border: 1px solid rgba(255,255,255,0.10);
    }
    .hosp-mixseg { height: 100%; }
    .hosp-mixseg.day { background: rgba(59,130,246,0.75); }
    .hosp-mixseg.eve { background: rgba(16,185,129,0.70); }
    .hosp-mixseg.plc { background: rgba(236,72,153,0.65); }
    .hosp-mixlegend {
      margin-top: 8px;
      display: flex;
      gap: 12px;
      flex-wrap: wrap;
      color: rgba(255,255,255,0.62);
      font-size: 11px;
    }
    .hosp-mixkey { display: inline-flex; align-items: center; gap: 6px; }
    .hosp-mixdot { width: 10px; height: 10px; border-radius: 3px; display: inline-block; }
    .hosp-mixdot.day { background: rgba(59,130,246,0.75); }
    .hosp-mixdot.eve { background: rgba(16,185,129,0.70); }
    .hosp-mixdot.plc { background: rgba(236,72,153,0.65); }


    .list { display: grid; gap: 8px; margin-top: 10px; }
    .list-item { background: rgba(0,0,0,0.22); border: 1px solid rgba(255,255,255,0.08); border-radius: 14px; padding: 10px; }
    .list-title {
      font-weight: 700;
      font-size: 12px;
      color: rgba(255,255,255,0.92);
      display: flex;
      justify-content: space-between;
      gap: 10px;
      align-items: baseline;
    }
    .badge {
      font-size: 11px;
      color: rgba(255,255,255,0.70);
      background: rgba(255,255,255,0.06);
      border: 1px solid rgba(255,255,255,0.08);
      padding: 4px 8px;
      border-radius: 999px;
      white-space: nowrap;
    }
    .list-notes { font-size: 12px; color: rgba(255,255,255,0.75); margin-top: 6px; white-space: pre-wrap; line-height: 1.25; }
    .empty-text { padding: 8px 2px; font-size: 12px; color: rgba(255,255,255,0.65); }




    /* Retail sales bar chart */
    .bar-chart { display: grid; gap: 10px; margin-top: 12px; }
    .bar-row {
      display: grid;
      grid-template-columns: 170px 1fr 120px;
      gap: 12px;
      align-items: center;
      padding: 10px;
      border-radius: 16px;
      background: rgba(0,0,0,0.18);
      border: 1px solid rgba(255,255,255,0.08);
    }
    .bar-left { min-width: 0; }
    .bar-label { font-weight: 800; font-size: 12px; color: rgba(255,255,255,0.92); }
    .bar-meta { margin-top: 4px; font-size: 11px; color: rgba(255,255,255,0.62); }
    .bar-track {
      height: 14px;
      border-radius: 999px;
      background: rgba(255,255,255,0.08);
      border: 1px solid rgba(255,255,255,0.10);
      overflow: hidden;
    }
    .bar-fill { height: 100%; border-radius: 999px; }
    .bar-fill.l7 { background: rgba(59,130,246,0.75); }
    .bar-fill.l5 { background: rgba(16,185,129,0.70); }
    .bar-fill.l4 { background: rgba(236,72,153,0.65); }
    .bar-fill.l3 { background: rgba(245,158,11,0.70); }

    /* Newcastle monthly production chart */
    .nc-mixbar {
      height: 12px;
      border-radius: 999px;
      overflow: hidden;
      background: rgba(255,255,255,0.08);
      border: 1px solid rgba(255,255,255,0.10);
      display: flex;
      margin-top: 10px;
    }
    .nc-mixseg { height: 100%; }
    .nc-mixseg.hot { background: rgba(59,130,246,0.75); }
    .nc-mixseg.free { background: rgba(16,185,129,0.70); }

    .nc-legend {
      margin-top: 8px;
      display: flex;
      gap: 12px;
      flex-wrap: wrap;
      color: rgba(255,255,255,0.62);
      font-size: 11px;
    }
    .nc-key { display: inline-flex; align-items: center; gap: 6px; }
    .nc-dot { width: 10px; height: 10px; border-radius: 3px; display: inline-block; }
    .nc-dot.hot { background: rgba(59,130,246,0.75); }
    .nc-dot.free { background: rgba(16,185,129,0.70); }

    .nc-chart { display: grid; gap: 8px; margin-top: 12px; }
    .nc-row {
      display: grid;
      grid-template-columns: 86px 1fr 70px;
      gap: 12px;
      align-items: center;
      padding: 10px;
      border-radius: 16px;
      background: rgba(0,0,0,0.18);
      border: 1px solid rgba(255,255,255,0.08);
    }
    .nc-date { font-weight: 800; font-size: 12px; color: rgba(255,255,255,0.90); }
    .nc-track {
      height: 14px;
      border-radius: 999px;
      background: rgba(255,255,255,0.08);
      border: 1px solid rgba(255,255,255,0.10);
      overflow: hidden;
      display: flex;
    }
    .nc-seg { height: 100%; }
    .nc-seg.hot { background: rgba(59,130,246,0.75); }
    .nc-seg.free { background: rgba(16,185,129,0.70); }
    .nc-total {
      font-weight: 900;
      font-size: 12px;
      color: rgba(255,255,255,0.92);
      text-align: right;
      white-space: nowrap;
    }
    @media (max-width: 640px) {
      .nc-row { grid-template-columns: 1fr; }
      .nc-total { text-align: left; }
    }

    .bar-right {
      font-weight: 900;
      font-size: 12px;
      color: rgba(255,255,255,0.92);
      text-align: right;
      white-space: nowrap;
    }
    @media (max-width: 900px) {
      .bar-row { grid-template-columns: 140px 1fr 96px; }
    }
    @media (max-width: 640px) {
      .bar-row { grid-template-columns: 1fr; }
      .bar-right { text-align: left; }
    }
    
    /* Modal thumbs */
    .modal-thumbs{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      margin-top:12px;
    }
    .modal-thumbs img{
      width:78px;
      height:56px;
      object-fit:cover;
      border-radius:10px;
      border:1px solid rgba(255,255,255,0.12);
      cursor:pointer;
      opacity:0.8;
    }
    .modal-thumbs img.active{
      outline:2px solid rgba(56,189,248,0.85);
      opacity:1;
    }

/* Photos */
    .photos-grid {
      display: grid;
      grid-template-columns: repeat(4, minmax(0, 1fr));
      gap: 10px;
      margin-top: 10px;
    }
    @media (max-width: 1100px) { .photos-grid { grid-template-columns: repeat(3, minmax(0, 1fr)); } }
    @media (max-width: 640px)  { .photos-grid { grid-template-columns: repeat(2, minmax(0, 1fr)); } }

    .photo-card {
      border-radius: 16px;
      overflow: hidden;
      border: 1px solid rgba(255,255,255,0.10);
      background: rgba(0,0,0,0.20);
      box-shadow: 0 10px 18px rgba(0,0,0,0.20);
      cursor: pointer;
    }
    .photo-card img {
      width: 100%;
      height: 150px;
      object-fit: cover;
      display: block;
    }
    .photo-card-caption {
      padding: 8px 10px 10px;
      font-size: 11px;
      color: rgba(255,255,255,0.70);
      line-height: 1.25;
    }

    /* Photo modal */
    .modal {
      display: none;
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.70);
      z-index: 60;
      padding: 16px;
    }
    .modal.open { display: grid; place-items: center; }
    .modal-card {
      width: min(1100px, 96vw);
      background: rgba(255,255,255,0.05);
      border: 1px solid rgba(255,255,255,0.10);
      border-radius: 18px;
      overflow: hidden;
      box-shadow: 0 20px 60px rgba(0,0,0,0.45);
    }
    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 10px 12px;
      border-bottom: 1px solid rgba(255,255,255,0.10);
      background: rgba(0,0,0,0.20);
      gap: 10px;
    }
    .modal-header .mh-title {
      font-weight: 800;
      font-size: 13px;
      color: rgba(255,255,255,0.92);
      display: flex;
      align-items: center;
      gap: 10px;
      flex-wrap: wrap;
    }
    .close {
      border: 1px solid rgba(255,255,255,0.12);
      background: rgba(0,0,0,0.25);
      color: rgba(255,255,255,0.85);
      border-radius: 12px;
      padding: 8px 10px;
      cursor: pointer;
      font-weight: 800;
    }
    .modal-body { padding: 12px; display: grid; gap: 12px; }
    .modal-body img { width: 100%; border-radius: 14px; border: 1px solid rgba(255,255,255,0.10); }
    /* Finance visualisation */
.fin-ytd{
  margin-top: 10px;
  padding: 10px;
  border-radius: 14px;
  border: 1px solid rgba(255,255,255,0.08);
  background: rgba(255,255,255,0.03);
}
.fin-ytd-title{
  font-size: 12px;
  font-weight: 800;
  margin-bottom: 8px;
  color: rgba(255,255,255,0.85);
}

    .fin-viz{
      display:grid;
      grid-template-columns: 2fr 1fr;
      gap: 12px;
      margin-top: 12px;
    }
    .fin-bars{ display:grid; gap: 10px; }
    .fin-bar{
      padding: 10px 10px 12px;
      border-radius: 14px;
      border: 1px solid rgba(255,255,255,0.08);
      background: rgba(255,255,255,0.04);
      box-shadow: 0 10px 22px rgba(0,0,0,0.20);
    }
    .fin-bar-top{
      display:flex;
      align-items: baseline;
      justify-content: space-between;
      gap: 10px;
      margin-bottom: 8px;
    }
    .fin-bar-title{ font-weight: 750; font-size: 12px; }
    .fin-bar-nums{ font-size: 11px; color: rgba(255,255,255,0.70); white-space: nowrap; }

    .bar-track{
      position: relative;
      height: 10px;
      border-radius: 999px;
      background: rgba(255,255,255,0.07);
      overflow:hidden;
    }
    .bar-budget{
      position:absolute; inset:0 auto 0 0;
      height:100%;
      background: rgba(147,197,253,0.40);
      border-radius: 999px;
    }
    .bar-actual{
      position:absolute; inset:0 auto 0 0;
      height:100%;
      background: rgba(52,211,153,0.55);
      border-radius: 999px;
      box-shadow: 0 0 0 1px rgba(0,0,0,0.12) inset;
    }
    .fin-bar-foot{
      display:flex; justify-content: space-between; gap: 8px;
      margin-top: 8px; font-size: 11px; color: rgba(255,255,255,0.66);
    }
    .var-pill{
      padding: 4px 8px;
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,0.10);
      background: rgba(255,255,255,0.05);
      font-weight: 650;
    }

    .var-pill.var-good{
      background: rgba(34,197,94,0.12);
      border-color: rgba(34,197,94,0.35);
      color: rgba(220,252,231,0.95);
    }
    .var-pill.var-bad{
      background: rgba(239,68,68,0.12);
      border-color: rgba(239,68,68,0.35);
      color: rgba(254,226,226,0.95);
    }
    .var-pill.var-neutral{
      background: rgba(251,191,36,0.10);
      border-color: rgba(251,191,36,0.28);
      color: rgba(254,243,199,0.92);
    }

    /* Optional: tint actual bar to match variance */
    .fin-bar.var-good .bar-actual{ background: rgba(34,197,94,0.55); }
    .fin-bar.var-bad .bar-actual{ background: rgba(239,68,68,0.45); }
    .fin-bar.var-neutral .bar-actual{ background: rgba(251,191,36,0.42); }

    /* Export snapshot modal */
    .textarea{
      width: 100%;
      min-height: 260px;
      resize: vertical;
      background: rgba(0,0,0,0.25);
      border: 1px solid rgba(255,255,255,0.12);
      color: rgba(255,255,255,0.90);
      padding: 10px 12px;
      border-radius: 14px;
      font-size: 12px;
      line-height: 1.35;
      outline: none;
      white-space: pre;
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
    }
    .modal-actions{ display:flex; gap:10px; flex-wrap:wrap; }

    .gp-gauge{
      width: 100%;
      min-height: 168px;
      border-radius: 16px;
      border: 1px solid rgba(255,255,255,0.08);
      background: rgba(255,255,255,0.04);
      box-shadow: 0 10px 22px rgba(0,0,0,0.20);
      display:grid;
      place-items:center;
      padding: 14px 12px;
    }
    .gp-donut{
      width: 132px; height: 132px;
      border-radius: 999px;
      display:grid;
      place-items:center;
      background: conic-gradient(rgba(52,211,153,0.85) 0deg, rgba(52,211,153,0.85) 0deg, rgba(255,255,255,0.10) 0deg);
    }
    .gp-inner{
      width: 104px; height: 104px;
      border-radius: 999px;
      background: #0b1220;
      border: 1px solid rgba(255,255,255,0.08);
      display:flex;
      flex-direction: column;
      align-items:center;
      justify-content:center;
      text-align:center;
      padding: 6px;
    }
    .gp-big{ font-size: 18px; font-weight: 800; letter-spacing: 0.2px; }
    .gp-sub{ font-size: 11px; color: rgba(255,255,255,0.66); margin-top: 4px; }

    .fin-notes{
      margin-top: 10px;
      padding: 10px 10px;
      border-radius: 14px;
      border: 1px solid rgba(255,255,255,0.08);
      background: rgba(255,255,255,0.03);
      font-size: 12px;
      color: rgba(255,255,255,0.80);
      white-space: pre-wrap;
      line-height: 1.35;
    }

    .financeAllSitesCards{
      display:grid;
      grid-template-columns: repeat(2, minmax(0, 1fr));
      gap: 12px;
      margin-top: 12px;
    }

    @media (max-width: 980px){
      .fin-viz{ grid-template-columns: 1fr; }
      .financeAllSitesCards{ grid-template-columns: 1fr; }
    }


  

    /* Release 2: staffing ranked bars */
    .rank-grid{
      display:grid;
      grid-template-columns: repeat(2, minmax(0, 1fr));
      gap: 12px;
      margin-top: 12px;
    }
    .rank-card{
      border: 1px solid rgba(255,255,255,0.08);
      background: rgba(255,255,255,0.03);
      border-radius: 16px;
      padding: 12px;
      box-shadow: 0 10px 22px rgba(0,0,0,0.18);
    }
    .rank-head{ margin-bottom: 10px; }
    .rank-title{ font-weight: 800; font-size: 13px; letter-spacing: 0.2px; }
    .rank-sub{ margin-top: 2px; font-size: 11px; color: rgba(255,255,255,0.65); }
    .rank-list{ display:grid; gap: 8px; }
    .rank-row{
      display:grid;
      grid-template-columns: 1fr auto;
      gap: 10px;
      align-items:center;
    }
    .rank-name{ font-size: 12px; color: rgba(255,255,255,0.88); overflow:hidden; text-overflow: ellipsis; white-space: nowrap; }
    .rank-count{ font-size: 12px; font-weight: 750; color: rgba(255,255,255,0.88); }
    .rank-track{
      grid-column: 1 / -1;
      height: 10px;
      border-radius: 999px;
      background: rgba(255,255,255,0.07);
      overflow:hidden;
    }
    .rank-fill{
      height: 100%;
      border-radius: 999px;
      background: rgba(147,197,253,0.55);
    }
    @media (max-width: 980px){
      .rank-grid{ grid-template-columns: 1fr; }
    }
</style>
</head>

<body>
  <div class="wrap">
    <div class="topbar">
      <div class="brand">
        <div class="logo">OL</div>
        <div class="titleblock">
          <div class="title">Monthly Dashboard</div>
          <div class="subtitle">Month view. Filter by site.</div>
        </div>
      </div>

      <div class="filters">
        <a class="btn btn-secondary" href="./index.html">Home</a>

        <button class="btn btn-secondary" id="prevMonthBtn">◀</button>
        <div class="pill" id="monthLabel" title="Click to choose month">Month</div>
        <input type="month" id="monthPicker" style="position:absolute; opacity:0; width:1px; height:1px; pointer-events:none;" />
        <button class="btn btn-secondary" id="nextMonthBtn">▶</button>
        <button class="btn" id="latestMonthBtn">Latest</button>

        <a class="btn" href="./monthly-finance-admin.html">Finance Admin</a>

        <div class="filter">
          <label for="siteFilter">Site</label>
          <select id="siteFilter">
            <option value="All">All Sites</option>
            <option value="London">London</option>
            <option value="Newcastle">Newcastle</option>
          </select>
        </div>

        <button class="btn" id="refreshBtn">Refresh</button>
        <button class="btn btn-secondary" id="exportBtn">Export Snapshot</button>
      </div>
    </div>

    <div id="errorMessage" class="error"></div>

    <div class="grid">
      <!-- Overview -->
      <div class="row-1">
        <div class="card" style="grid-column: 1 / span 3; padding: 0;">
          <div style="padding: 14px 14px 14px;">
            <div class="card-header" style="margin-bottom: 8px;">
              <div>
                <div class="card-title">Overview</div>
                <div class="card-subtitle">Totals for the selected month & filter.</div>
              </div>
              <div class="pill" id="monthRangePill">Month</div>
            </div>

            <div class="kpis">
              <div class="kpi">
                <div class="label">Total Logs</div>
                <div class="value" id="kpiTotalLogs">0</div>
                <div class="sub">All entries captured</div>
              </div>
              <div class="kpi">
                <div class="label">Staffing Impact</div>
                <div class="value" id="kpiStaffingSum">0</div>
                <div class="sub" id="kpiStaffingSub">Sick • Holiday</div>
              </div>
              <div class="kpi">
                <div class="label">Retail Sales</div>
                <div class="value" id="kpiRetailSales">£0.00</div>
                <div class="sub" id="kpiRetailSub">Transactions • SPH</div>
              </div>
            </div>
          </div>

        </div>
      </div>

      <!-- Finance -->
      <div class="row-2">
        <div class="card" style="grid-column: 1 / span 2;">
          <div class="card-header">
            <div>
              <div class="card-title">Finance Snapshot (Budget vs Actual)</div>
              <div class="card-subtitle">Uses monthly_finance_summary. GP% displayed as entered.</div>
            </div>
            <div class="pill" id="financePill">Finance</div>
          </div>

          <div id="financeEmpty" class="empty-text">
            No finance row found for this month/site yet. Click “Finance Admin” (top right) to create one.
          </div>

          <div class="fin-viz" id="financeViz" style="display:none;">
            <div class="fin-bars" id="finBars"></div>
            <div class="fin-ytd" id="finYtd" style="display:none;"></div>

            <div>
              <div class="gp-gauge">
                <div class="gp-donut" id="gpDonut">
                  <div class="gp-inner">
                    <div class="gp-big" id="gpGaugeVal">0%</div>
                    <div class="gp-sub" id="gpGaugeSub">Bgt 0%</div>
                  </div>
                </div>
              </div>

              <div class="fin-notes" id="finNotes" style="display:none;"></div>
            </div>
          </div>

          <div id="financeGrid" class="metric-row" style="grid-template-columns: repeat(3, minmax(0, 1fr)); display:none;">
            <div class="metric">
              <div class="metric-label">Total Sales (£)</div>
              <div class="metric-value" id="finSalesActual">£0.00</div>
              <div class="metric-sub">Budget: <span id="finSalesBudget">£0.00</span> • Var: <span id="finSalesVar">£0.00</span></div>
            </div>
            <div class="metric">
              <div class="metric-label">Labour (£) (Core + Cost to Client)</div>
              <div class="metric-value" id="finLabourActual">£0.00</div>
              <div class="metric-sub">Budget: <span id="finLabourBudget">£0.00</span> • Var: <span id="finLabourVar">£0.00</span></div>
            </div>
            <div class="metric">
              <div class="metric-label">GP %</div>
              <div class="metric-value" id="finGpActual">0%</div>
              <div class="metric-sub">Budget: <span id="finGpBudget">0%</span></div>
            </div>

            <div class="metric">
              <div class="metric-label">Retail Sales (£)</div>
              <div class="metric-value" id="finRetailActual">£0.00</div>
              <div class="metric-sub">Budget: <span id="finRetailBudget">£0.00</span></div>
            </div>
            <div class="metric">
              <div class="metric-label">Hospitality Sales (£)</div>
              <div class="metric-value" id="finHospActual">£0.00</div>
              <div class="metric-sub">Budget: <span id="finHospBudget">£0.00</span></div>
            </div>
            <div class="metric">
              <div class="metric-label">Free Issue (£)</div>
              <div class="metric-value" id="finFreeActual">£0.00</div>
              <div class="metric-sub">Budget: <span id="finFreeBudget">£0.00</span></div>
            </div>
          </div>

          <div class="metric-sub" style="margin-top:10px;">
            If Site = All, finance is displayed as a per-site list (London + Newcastle) rather than a combined total.
          </div>

          <div id="financeAllSitesList" class="list" style="display:none;"></div>
        </div>
      </div>

      <!-- Staffing + incidents -->
      <div class="row-3">
        <div class="card">
          <div class="card-header">
            <div>
              <div class="card-title">Staffing Summary</div>
              <div class="card-subtitle">Totals for the month.</div>
            </div>
          </div>
          <div class="metric-row" style="grid-template-columns: repeat(2, 1fr);">
  <div class="metric"><div class="metric-label">Sickness</div><div class="metric-value" id="staffSick">0</div></div>
  <div class="metric"><div class="metric-label">Holiday</div><div class="metric-value" id="staffHol">0</div></div>
</div>

<div class="rank-grid">
  <div class="rank-card">
    <div class="rank-head">
      <div class="rank-title">Sickness • top names</div>
      <div class="rank-sub">Count of days mentioned in logs this month.</div>
    </div>
    <div id="sickRankEmpty" class="empty-text">No sickness names recorded.</div>
    <div id="sickRankList" class="rank-list"></div>
  </div>

  <div class="rank-card">
    <div class="rank-head">
      <div class="rank-title">Holidays • top names</div>
      <div class="rank-sub">Count of days mentioned in logs this month.</div>
    </div>
    <div id="holRankEmpty" class="empty-text">No holiday names recorded.</div>
    <div id="holRankList" class="rank-list"></div>
  </div>
</div>
        </div>

        <div class="card">
          <div class="card-header">
            <div>
              <div class="card-title">Maintenance Incidents</div>
              <div class="card-subtitle">Only items with incidents show.</div>
            </div>
          </div>
          <div id="maintEmpty" class="empty-text">No maintenance incidents.</div>
          <div id="maintList" class="list"></div>
        </div>

        <div class="card">
          <div class="card-header">
            <div>
              <div class="card-title">H&amp;S Incidents</div>
              <div class="card-subtitle">Only items with incidents show.</div>
            </div>
          </div>
          <div id="hsEmpty" class="empty-text">No H&amp;S incidents.</div>
          <div id="hsList" class="list"></div>
        </div>
      </div>

      <div class="card" id="hospEventsCard" style="display:none;">
        <div class="card-header">
          <div>
            <div class="card-title">London Hospitality • Events</div>
            <div class="card-subtitle">Totals for the month (day / evening / places).</div>
          </div>
          <div class="pill">London</div>
        </div>
        <div id="hospEventsEmpty" class="empty-text" style="display:none;">No hospitality event entries for this month.</div>
        <div id="hospEventsMetrics">
          <div class="metric-row" style="grid-template-columns: repeat(4, 1fr);">
            <div class="metric">
              <div class="metric-label">Day Events</div>
              <div class="metric-value" id="mHospDay">0</div>
              <div class="metric-sub" id="mHospDayPct">0%</div>
            </div>
            <div class="metric">
              <div class="metric-label">Evening Events</div>
              <div class="metric-value" id="mHospNight">0</div>
              <div class="metric-sub" id="mHospNightPct">0%</div>
            </div>
            <div class="metric">
              <div class="metric-label">Places Events</div>
              <div class="metric-value" id="mHospPlaces">0</div>
              <div class="metric-sub" id="mHospPlacesPct">0%</div>
            </div>
            <div class="metric">
              <div class="metric-label">Total</div>
              <div class="metric-value" id="mHospTotal">0</div>
              <div class="metric-sub" id="mHospTotalPct">0%</div>
            </div>
          </div>

          <div class="hosp-mixbar" id="hospMixBar" title="Event mix (share of total)">
            <div class="hosp-mixseg day" id="hospMixDay" style="width:0%"></div>
            <div class="hosp-mixseg eve" id="hospMixEve" style="width:0%"></div>
            <div class="hosp-mixseg plc" id="hospMixPlc" style="width:0%"></div>
          </div>

          <div class="hosp-mixlegend" id="hospMixLegend">
            <span class="hosp-mixkey"><span class="hosp-mixdot day"></span>Day</span>
            <span class="hosp-mixkey"><span class="hosp-mixdot eve"></span>Evening</span>
            <span class="hosp-mixkey"><span class="hosp-mixdot plc"></span>Places</span>
          </div>
        </div>

        <!-- Staff Meals + Wastage -->
        <div class="card" id="staffMealsCard" style="display:none;">
          <div class="card-header">
            <div>
              <div class="card-title">Staff Meals (Monthly)</div>
              <div class="card-subtitle">Estimated meal cost based on trading days and fixed assumptions.</div>
            </div>
            <div class="pill" id="staffMealsPill">London</div>
          </div>

          <div class="metric-row" style="grid-template-columns: 1fr;">
            <div class="metric">
              <div class="metric-label">Total Staff Meal Cost</div>
              <div class="metric-value" id="staffMealsTotal">£0.00</div>
              <div class="metric-sub" id="staffMealsMeta">0 staff/day • 0 trading day(s) • £0.00 cost/person/day</div>
              <div class="metric-sub" id="staffMealsMeta2">Meal value £0.00 pp/day • Cost rate 0% • Total meal value £0.00</div>
            </div>
          </div>
        </div>

        <div class="card" id="wastageCard" style="display:none;">
          <div class="card-header">
            <div>
              <div class="card-title">Wastage (Monthly)</div>
              <div class="card-subtitle">Fixed wastage % applied to London retail sales.</div>
            </div>
            <div class="pill" id="wastagePill">London</div>
          </div>

          <div class="metric-row" style="grid-template-columns: 1fr;">
            <div class="metric">
              <div class="metric-label">Wastage Cost</div>
              <div class="metric-value" id="wastageTotal">£0.00</div>
              <div class="metric-sub" id="wastageMeta">Wastage 0% • Retail sales £0.00</div>
            </div>
          </div>
        </div>


      </div>


      <!-- London Retail – Lunch Specials -->
      <div class="row-2">
        <div class="card" style="grid-column: 1 / span 2;">
          <div class="card-header">
            <div>
              <div class="card-title">London Retail • Lunch Specials</div>
              <div class="card-subtitle">All lunch specials recorded for the selected month (from daily ops logs).</div>
            </div>
            <div class="pill" id="specialsPill">Specials</div>
          </div>

          <div id="specialsMonthlyEmpty" class="empty-text">No lunch specials recorded.</div>
          <div id="specialsMonthlyList" class="list"></div>
        </div>
      </div>

      
      <!-- Newcastle – Hot Lunches + Free Breakfast -->
      <div class="row-2" id="newcastleMonthlyRow">
        <div class="card" style="grid-column: 1 / span 2;" id="newcastleMonthlyCard">
          <div class="card-header">
            <div>
              <div class="card-title">Newcastle • Monthly Production</div>
              <div class="card-subtitle">Hot lunches and free breakfasts recorded in daily logs for the selected month.</div>
            </div>
            <div class="pill" id="newcastlePill">Newcastle</div>
          </div>

          <div id="newcastleMonthlyEmpty" class="empty-text">Select <strong>Newcastle</strong> (or <strong>All Sites</strong>) to view Newcastle monthly totals.</div>

          <div id="newcastleMonthlyMetrics">
            <div class="metric-row" style="grid-template-columns: repeat(4, 1fr);">
              <div class="metric">
                <div class="metric-label">Total Hot Lunch Dishes</div>
                <div class="metric-value" id="ncHotLunchTotal">0</div>
                <div class="metric-sub" id="ncHotLunchSub">0 day(s) • Avg 0/day</div>
                <div class="metric-sub" id="ncHotLunchPct">0%</div>
              </div>
              <div class="metric">
                <div class="metric-label">Total Free Breakfast</div>
                <div class="metric-value" id="ncFreeBreakfastTotal">0</div>
                <div class="metric-sub" id="ncFreeBreakfastSub">0 day(s)</div>
                <div class="metric-sub" id="ncFreeBreakfastPct">0%</div>
              </div>
              <div class="metric">
                <div class="metric-label">Total Production</div>
                <div class="metric-value" id="ncTotalProduction">0</div>
                <div class="metric-sub" id="ncTotalProductionSub">0 active day(s) • Avg 0/day</div>
              </div>
              <div class="metric">
                <div class="metric-label">Peak Day</div>
                <div class="metric-value" id="ncPeakTotal">0</div>
                <div class="metric-sub" id="ncPeakTotalSub">—</div>
              </div>
            </div>

            <div id="ncMixBar" class="nc-mixbar" style="display:none;">
              <div class="nc-mixseg hot" id="ncMixHot" style="width:0%"></div>
              <div class="nc-mixseg free" id="ncMixFree" style="width:0%"></div>
            </div>
            <div id="ncLegend" class="nc-legend" style="display:none;">
              <div class="nc-key"><span class="nc-dot hot"></span>Hot lunches</div>
              <div class="nc-key"><span class="nc-dot free"></span>Free breakfasts</div>
            </div>

            <div id="ncMonthlyChart" class="nc-chart"></div>
            <div class="metric-sub" id="ncMonthlyChartHint" style="margin-top:6px; display:none;"></div>
          </div>
        </div>
      </div>

<!-- Retail + Photos -->
      <div class="row-2">
        <div class="card">
          <div class="card-header">
            <div>
              <div class="card-title">Retail Sales (Monthly)</div>
              <div class="card-subtitle">Totals by level for the month (from retail_sales).</div>
            </div>
          </div>

          <div class="metric-row" style="grid-template-columns: 1fr;">
            <div class="metric">
              <div class="metric-label">Total</div>
              <div class="metric-value" id="retailTotal">£0.00</div>
              <div class="metric-sub" id="retailSub">0 tx • SPH £0.00</div>
              <div class="metric-sub" id="retailBreakdown" style="margin-top:6px;">L7 £0 • L5 £0 • L4 £0 • L3 £0</div>
            </div>
          </div>

          <div id="retailBarChart" class="bar-chart"></div>
        </div>

        <div class="card">
          <div class="card-header">
            <div>
              <div class="card-title">Photo Gallery</div>
              <div class="card-subtitle">All photos uploaded within the selected month.</div>
            </div>
          </div>
          <div id="photosEmpty" class="empty-text">No photos uploaded this month.</div>
          <div id="photosGrid" class="photos-grid"></div>
        </div>
      </div>
    </div>
  </div>

  <!-- Photo modal -->
  <div class="modal" id="photoModal">
    <div class="modal-card">
      <div class="modal-header">
        <div class="mh-title" id="photoModalTitle">Photo</div>
        <button class="close" id="closePhotoModalBtn">Close</button>
      </div>
      <div class="modal-body">
        <img id="photoModalImg" alt="Photo" />
        <div id="photoModalThumbs" class="modal-thumbs"></div>
        <div class="metric-sub" id="photoModalMeta"></div>
      </div>
    </div>
  </div>


  <!-- Export Snapshot modal -->
  <div class="modal" id="exportModal">
    <div class="modal-card">
      <div class="modal-header">
        <div class="mh-title">Monthly Snapshot • <span id="exportMetaPill" class="pill">—</span></div>
        <button class="close" id="closeExportModalBtn">Close</button>
      </div>
      <div class="modal-body">
        <textarea id="exportText" class="textarea" readonly></textarea>
        <div class="modal-actions">
          <button class="btn" id="copyExportBtn">Copy</button>
          <button class="btn btn-secondary" id="downloadExportBtn">Download .txt</button>
        </div>
        <div class="metric-sub" id="exportHint" style="margin-top:2px;"></div>
      </div>
    </div>
  </div>


  <script type="module">
    import { supabase } from './supabase-config.js';

    // --- Monthly Finance Controls (fixed assumptions) ---
    // Staff meals: value per person per day (£) and cost rate (food cost % of value)
    const STAFF_PER_DAY = 33;
    const STAFF_MEAL_VALUE_PP_DAY = 14.00;
    const STAFF_MEAL_COST_RATE = 0.44; // 44%

    // Wastage: fixed % of London retail sales (update as agreed)
    const WASTAGE_PCT_LONDON = 0.03; // 3.0%

    const errorMessageEl = document.getElementById('errorMessage');

    const prevMonthBtn = document.getElementById('prevMonthBtn');
    const nextMonthBtn = document.getElementById('nextMonthBtn');
    const latestMonthBtn = document.getElementById('latestMonthBtn');
    const refreshBtn = document.getElementById('refreshBtn');
    const exportBtn = document.getElementById('exportBtn');

    const exportModalEl = document.getElementById('exportModal');
    const closeExportModalBtn = document.getElementById('closeExportModalBtn');
    const exportTextEl = document.getElementById('exportText');
    const exportMetaPillEl = document.getElementById('exportMetaPill');
    const copyExportBtn = document.getElementById('copyExportBtn');
    const downloadExportBtn = document.getElementById('downloadExportBtn');
    const exportHintEl = document.getElementById('exportHint');

    const monthLabelEl = document.getElementById('monthLabel');
    const monthPickerEl = document.getElementById('monthPicker');
    const monthRangePillEl = document.getElementById('monthRangePill');
    const siteFilterEl = document.getElementById('siteFilter');

    const kpiTotalLogsEl = document.getElementById('kpiTotalLogs');
    const kpiStaffingSumEl = document.getElementById('kpiStaffingSum');
    const kpiStaffingSubEl = document.getElementById('kpiStaffingSub');
    const kpiRetailSalesEl = document.getElementById('kpiRetailSales');
    const kpiRetailSubEl = document.getElementById('kpiRetailSub');

    const staffSickEl = document.getElementById('staffSick');
    const staffHolEl = document.getElementById('staffHol');

    const sickRankEmptyEl = document.getElementById('sickRankEmpty');
    const sickRankListEl = document.getElementById('sickRankList');
    const holRankEmptyEl = document.getElementById('holRankEmpty');
    const holRankListEl = document.getElementById('holRankList');
const maintEmptyEl = document.getElementById('maintEmpty');
    const maintListEl = document.getElementById('maintList');
    const hsEmptyEl = document.getElementById('hsEmpty');
    const hsListEl = document.getElementById('hsList');

    const hospEventsCardEl = document.getElementById('hospEventsCard');
    const hospEventsEmptyEl = document.getElementById('hospEventsEmpty');
    const hospEventsMetricsEl = document.getElementById('hospEventsMetrics');
    const mHospDayEl = document.getElementById('mHospDay');
    const mHospNightEl = document.getElementById('mHospNight');
    const mHospPlacesEl = document.getElementById('mHospPlaces');
    const mHospTotalEl = document.getElementById('mHospTotal');
    const staffMealsCardEl = document.getElementById('staffMealsCard');
    const staffMealsTotalEl = document.getElementById('staffMealsTotal');
    const staffMealsMetaEl = document.getElementById('staffMealsMeta');
    const staffMealsMeta2El = document.getElementById('staffMealsMeta2');

    const wastageCardEl = document.getElementById('wastageCard');
    const wastageTotalEl = document.getElementById('wastageTotal');
    const wastageMetaEl = document.getElementById('wastageMeta');


    const mHospDayPctEl = document.getElementById('mHospDayPct');
    const mHospNightPctEl = document.getElementById('mHospNightPct');
    const mHospPlacesPctEl = document.getElementById('mHospPlacesPct');
    const mHospTotalPctEl = document.getElementById('mHospTotalPct');

    const hospMixBarEl = document.getElementById('hospMixBar');
    const hospMixDayEl = document.getElementById('hospMixDay');
    const hospMixEveEl = document.getElementById('hospMixEve');
    const hospMixPlcEl = document.getElementById('hospMixPlc');

    const specialsMonthlyEmptyEl = document.getElementById('specialsMonthlyEmpty');
    const specialsMonthlyListEl = document.getElementById('specialsMonthlyList');

    // Newcastle monthly (hot lunches + free breakfast)
    const newcastleMonthlyRowEl = document.getElementById('newcastleMonthlyRow');
    const newcastleMonthlyEmptyEl = document.getElementById('newcastleMonthlyEmpty');
    const newcastleMonthlyMetricsEl = document.getElementById('newcastleMonthlyMetrics');
    const ncHotLunchTotalEl = document.getElementById('ncHotLunchTotal');
    const ncHotLunchPctEl = document.getElementById('ncHotLunchPct');
    const ncFreeBreakfastPctEl = document.getElementById('ncFreeBreakfastPct');
    const ncMixBarEl = document.getElementById('ncMixBar');
    const ncMixHotEl = document.getElementById('ncMixHot');
    const ncMixFreeEl = document.getElementById('ncMixFree');
    const ncLegendEl = document.getElementById('ncLegend');
    const ncTotalProductionEl = document.getElementById('ncTotalProduction');
    const ncTotalProductionSubEl = document.getElementById('ncTotalProductionSub');
    const ncPeakTotalEl = document.getElementById('ncPeakTotal');
    const ncPeakTotalSubEl = document.getElementById('ncPeakTotalSub');
    const ncMonthlyChartEl = document.getElementById('ncMonthlyChart');
    const ncMonthlyChartHintEl = document.getElementById('ncMonthlyChartHint');
    const ncHotLunchSubEl = document.getElementById('ncHotLunchSub');
    const ncFreeBreakfastTotalEl = document.getElementById('ncFreeBreakfastTotal');
    const ncFreeBreakfastSubEl = document.getElementById('ncFreeBreakfastSub');


    const retailTotalEl = document.getElementById('retailTotal');
    const retailSubEl = document.getElementById('retailSub');
    const retailBreakdownEl = document.getElementById('retailBreakdown');
    const retailBarChartEl = document.getElementById('retailBarChart');

    const photosEmptyEl = document.getElementById('photosEmpty');
    const photosGridEl = document.getElementById('photosGrid');

    const photoModalEl = document.getElementById('photoModal');
    const photoModalImgEl = document.getElementById('photoModalImg');
    const photoModalThumbsEl = document.getElementById('photoModalThumbs');
    const photoModalMetaEl = document.getElementById('photoModalMeta');
    const closePhotoModalBtn = document.getElementById('closePhotoModalBtn');

    // Finance UI
    const financePillEl = document.getElementById('financePill');
    const financeEmptyEl = document.getElementById('financeEmpty');
    const financeGridEl = document.getElementById('financeGrid');
    const financeAllSitesListEl = document.getElementById('financeAllSitesList');
  const financeAllSitesYtdEl  = document.getElementById('financeAllSitesYtd');
    const financeVizEl = document.getElementById('financeViz');
    const finBarsEl = document.getElementById('finBars');
    const gpDonutEl = document.getElementById('gpDonut');
    const gpGaugeValEl = document.getElementById('gpGaugeVal');
    const gpGaugeSubEl = document.getElementById('gpGaugeSub');
    const finNotesEl = document.getElementById('finNotes');
const finYtdEl = document.getElementById('finYtd');

    const finSalesActualEl = document.getElementById('finSalesActual');
    const finSalesBudgetEl = document.getElementById('finSalesBudget');
    const finSalesVarEl = document.getElementById('finSalesVar');

    const finLabourActualEl = document.getElementById('finLabourActual');
    const finLabourBudgetEl = document.getElementById('finLabourBudget');
    const finLabourVarEl = document.getElementById('finLabourVar');

    const finGpActualEl = document.getElementById('finGpActual');
    const finGpBudgetEl = document.getElementById('finGpBudget');

    const finRetailActualEl = document.getElementById('finRetailActual');
    const finRetailBudgetEl = document.getElementById('finRetailBudget');

    const finHospActualEl = document.getElementById('finHospActual');
    const finHospBudgetEl = document.getElementById('finHospBudget');

    const finFreeActualEl = document.getElementById('finFreeActual');
    const finFreeBudgetEl = document.getElementById('finFreeBudget');

    let currentMonthOffset = 0;

    // Snapshot export state (kept up to date as data loads)
    const snapshotState = {
      monthLabel: '',
      monthStartStr: '',
      monthRange: '',
      site: '',
      totalLogs: 0,
      staffing: { sick: 0, holiday: 0 },
      incidents: { maintenance: 0, hs: 0 },
      finance: null
    ,
      staffMeals: null,
      wastage: null
};

    function fmtPct1(n) {
      if (!isFinite(n) || n <= 0) return '0%';
      return `${n.toFixed(1)}%`;
    }


    function fmtGBP(n) {
      const v = Number(n);
      const safe = Number.isFinite(v) ? v : 0;
      const sign = safe < 0 ? '-' : '';
      const abs = Math.abs(safe);
      return `${sign}£${abs.toFixed(2)}`;
    }
    function fmtShortDate(iso){
      // iso: YYYY-MM-DD
      if(!iso) return '—';
      const d = new Date(iso + 'T00:00:00');
      const wd = ['Sun','Mon','Tue','Wed','Thu','Fri','Sat'][d.getDay()] || '';
      const dd = String(d.getDate()).padStart(2,'0');
      const mm = String(d.getMonth()+1).padStart(2,'0');
      return `${wd} ${dd}/${mm}`;
    }

function safeNum(v) {
      const n = Number(v);
      return Number.isFinite(n) ? n : 0;
    }

    function safeText(v) { return (v ?? '').toString().trim(); }
    function hasText(v) { return safeText(v).length > 0; }

    function escapeHtml(str){
      return String(str ?? '')
        .replace(/&/g,'&amp;')
        .replace(/</g,'&lt;')
        .replace(/>/g,'&gt;')
        .replace(/"/g,'&quot;')
        .replace(/'/g,'&#39;');
    }

    // Release 2: parse names from sickness/holiday notes and build ranked counts
    function normaliseNameToken(t){
      let s = (t || '').toString().trim();
      if (!s) return '';
      // Remove leading bullets / dashes
      s = s.replace(/^[-•\s]+/, '').trim();
      // Collapse spaces
      s = s.replace(/\s+/g, ' ').trim();
      // Remove obvious role-only tokens
      const lower = s.toLowerCase();
      const stop = ['chef','cook','barista','supervisor','porter','agency','cover','shift','am','pm','full day','half day'];
      if (stop.includes(lower)) return '';
      // Very short tokens are rarely useful
      if (s.length < 2) return '';
      return s;
    }

    function extractNameTokens(notes){
      const raw = safeText(notes);
      if (!raw) return [];
      // Split by commas, newlines, semicolons, slashes, ampersands, "and"
      const cleaned = raw
        .replace(/\band\b/gi, ',')
        .replace(/[\n;\/|]+/g, ',')
        .replace(/&/g, ',');
      return cleaned
        .split(',')
        .map(normaliseNameToken)
        .filter(Boolean);
    }

    function buildNameCounts(rows, notesField){
      const counts = {};
      (rows || []).forEach(r => {
        const tokens = extractNameTokens(r?.[notesField]);
        // De-dupe per log row so one note doesn't double-count the same name
        const uniq = Array.from(new Set(tokens.map(t => t.toLowerCase())));

        uniq.forEach(lc => {
          // Recover the original casing from first occurrence
          const original = tokens.find(t => t.toLowerCase() === lc) || lc;
          counts[original] = (counts[original] || 0) + 1;
        });
      });
      return counts;
    }

    function renderRankList(listEl, emptyEl, counts){
      if (!listEl || !emptyEl) return;
      const entries = Object.entries(counts || {})
        .map(([name, count]) => ({ name, count: safeNum(count) }))
        .filter(e => e.count > 0)
        .sort((a,b) => b.count - a.count || a.name.localeCompare(b.name))
        .slice(0, 8);

      if (!entries.length) {
        emptyEl.style.display = 'block';
        listEl.innerHTML = '';
        return;
      }

      emptyEl.style.display = 'none';
      const maxV = Math.max(...entries.map(e => e.count), 1);

      listEl.innerHTML = entries.map(e => {
        const pct = Math.max(8, Math.round((e.count / maxV) * 100)); // ensure visible bar
        return `
          <div class="rank-row">
            <div class="rank-name" title="${escapeHtml(e.name)}">${escapeHtml(e.name)}</div>
            <div class="rank-count">${e.count}</div>
            <div class="rank-track"><div class="rank-fill" style="width:${pct}%"></div></div>
          </div>
        `;
      }).join('');
    }


    function money(n) { return `£${Number(n || 0).toFixed(2)}`; }
    function pct(n) { return `${Number(n || 0).toFixed(1)}%`; }

    function clamp01(x){ return Math.max(0, Math.min(1, x)); }

    function metricHigherIsBetter(label, isPercent=false){
      const s = String(label || '').toLowerCase();
      if (isPercent) return true;
      if (s.includes('sales') || s.includes('revenue')) return true;
      if (s.includes('wage') || s.includes('labour') || s.includes('free issue') || s.includes('cost to client') || s.includes('agency')) return false;
      return true;
    }

    function varianceClassFor(label, variance, budget, opts={}){
      const isPercent = !!opts.isPercent;
      const higherIsBetter = metricHigherIsBetter(label, isPercent);
      const b = safeNum(budget);
      const v = safeNum(variance);

      let neutral = false;
      if (isPercent){
        neutral = Math.abs(v) <= 0.2;
      } else if (b > 0){
        neutral = Math.abs(v / b) <= 0.02;
      } else {
        neutral = Math.abs(v) <= 50;
      }

      if (neutral) return 'var-neutral';

      const favourable = higherIsBetter ? (v > 0) : (v < 0);
      return favourable ? 'var-good' : 'var-bad';
    }

    function barRowHTML(label, actual, budget) {
      const a = safeNum(actual);
      const b = safeNum(budget);
      const maxV = Math.max(a, b, 1);
      const budgetPct = clamp01(b / maxV) * 100;
      const actualPct = clamp01(a / maxV) * 100;
      const variance = a - b;

      const abs = money(Math.abs(variance));
      const sign = variance > 0 ? '+' : (variance < 0 ? '-' : '');
      const varLabel = `${sign}${abs}`;

      const cls = varianceClassFor(label, variance, b);

      return `
        <div class="fin-bar ${cls}">
          <div class="fin-bar-top">
            <div class="fin-bar-title">${label}</div>
            <div class="fin-bar-nums">Act ${money(a)} • Bgt ${money(b)}</div>
          </div>

          <div class="bar-track" aria-label="${label} budget vs actual">
            <div class="bar-budget" style="width:${budgetPct}%;"></div>
            <div class="bar-actual" style="width:${actualPct}%;"></div>
          </div>

          <div class="fin-bar-foot">
            <span>Variance</span>
            <span class="var-pill ${cls}">${varLabel}</span>
          </div>
        </div>
      `;
    }

    
function gpRowHTML(label, actualPctVal, budgetPctVal) {
  const a = safeNum(actualPctVal);
  const b = safeNum(budgetPctVal);
  const maxV = 100;
  const budgetPct = clamp01(b / maxV) * 100;
  const actualPct = clamp01(a / maxV) * 100;
  const variance = a - b;
  const sign = variance > 0 ? '+' : (variance < 0 ? '' : '');
  const varLabel = `${sign}${variance.toFixed(1)} pp`;
  const cls = varianceClassFor(label, variance, 100, {isPercent:true});

  return `
    <div class="fin-bar ${cls}">
      <div class="fin-bar-top">
        <div class="fin-bar-title">${label}</div>
        <div class="fin-bar-nums">Act ${pct(a)} • Bgt ${pct(b)}</div>
      </div>

      <div class="bar-track" aria-label="${label} budget vs actual">
        <div class="bar-budget" style="width:${budgetPct}%;"></div>
        <div class="bar-actual" style="width:${actualPct}%;"></div>
      </div>

      <div class="fin-bar-foot">
        <span>Variance</span>
        <span class="var-pill ${cls}">${varLabel}</span>
      </div>
    </div>
  `;
}

function setGpGauge(actualGpPct, budgetGpPct){
      const a = safeNum(actualGpPct);
      const b = safeNum(budgetGpPct);
      const aDeg = clamp01(a / 100) * 360;

      if (gpDonutEl) {
        gpDonutEl.style.background =
          `conic-gradient(rgba(52,211,153,0.85) 0deg, rgba(52,211,153,0.85) ${aDeg}deg, rgba(255,255,255,0.10) ${aDeg}deg)`;
      }
      if (gpGaugeValEl) gpGaugeValEl.textContent = pct(a);
      if (gpGaugeSubEl) gpGaugeSubEl.textContent = `Bgt ${pct(b)}`;
    }


    function isIncidentFlagTrue(v) {
      const t = safeText(v).toLowerCase();
      return t === 'yes' || t === 'true' || t === '1';
    }

    function toISODate(d) {
      const yyyy = d.getFullYear();
      const mm = String(d.getMonth() + 1).padStart(2, '0');
      const dd = String(d.getDate()).padStart(2, '0');
      return `${yyyy}-${mm}-${dd}`;
    }

    function dateKeyFromRow(r){
      const ld = r?.log_date;
      if (ld) return String(ld).slice(0,10);
      const ca = r?.created_at;
      return ca ? String(ca).slice(0,10) : '';
    }


    function startOfMonth(d) {
      const x = new Date(d);
      x.setDate(1);
      x.setHours(0,0,0,0);
      return x;
    }

    function endOfMonth(d) {
      const x = new Date(d);
      x.setMonth(x.getMonth() + 1);
      x.setDate(0);
      x.setHours(0,0,0,0);
      return x;
    }

    function monthLabelFromDate(d) {
      const fmt = new Intl.DateTimeFormat('en-GB', { month: 'long', year: 'numeric' });
      return fmt.format(d);
    }

    function calcSPH(sales, tx) {
      const s = safeNum(sales);
      const t = safeNum(tx);
      return t > 0 ? s / t : 0;
    }

    function renderList(containerEl, emptyEl, items) {
      containerEl.innerHTML = '';
      if (!items || items.length === 0) {
        emptyEl.style.display = 'block';
        return;
      }
      emptyEl.style.display = 'none';

      items.forEach(it => {
        const div = document.createElement('div');
        div.className = 'list-item';
        div.innerHTML = `
          <div class="list-title">
            <span>${it.title}</span>
            ${it.badge ? `<span class="badge">${it.badge}</span>` : ``}
          </div>
          <div class="list-notes">${(it.notes || '').replace(/</g, '&lt;')}</div>
        `;
        containerEl.appendChild(div);
      });
    }

    function clearUI() {
      errorMessageEl.style.display = 'none';
      errorMessageEl.textContent = '';

      kpiTotalLogsEl.textContent = '0';
      kpiStaffingSumEl.textContent = '0';
      kpiStaffingSubEl.textContent = 'Sick • Holiday';
      kpiRetailSalesEl.textContent = '£0.00';
      kpiRetailSubEl.textContent = 'Transactions • SPH';

      staffSickEl.textContent = '0';
      staffHolEl.textContent = '0';

      if (sickRankEmptyEl) sickRankEmptyEl.style.display = 'block';
      if (sickRankListEl) sickRankListEl.innerHTML = '';
      if (holRankEmptyEl) holRankEmptyEl.style.display = 'block';
      if (holRankListEl) holRankListEl.innerHTML = '';
maintListEl.innerHTML = '';
      hsListEl.innerHTML = '';
      maintEmptyEl.style.display = 'block';
      hsEmptyEl.style.display = 'block';

      if (specialsMonthlyListEl) specialsMonthlyListEl.innerHTML = '';
      if (specialsMonthlyEmptyEl) {
        specialsMonthlyEmptyEl.style.display = 'block';
        specialsMonthlyEmptyEl.textContent = 'No lunch specials recorded.';
      }

      retailTotalEl.textContent = '£0.00';
      retailSubEl.textContent = '0 tx • SPH £0.00';
      retailBreakdownEl.textContent = 'L7 £0 • L5 £0 • L4 £0 • L3 £0';
      retailBarChartEl.innerHTML = '';

      photosGridEl.innerHTML = '';
      photosEmptyEl.style.display = 'block';

      financePillEl.textContent = 'Finance';
      financeEmptyEl.style.display = 'block';
      financeGridEl.style.display = 'none';
        if (financeVizEl) financeVizEl.style.display = 'none';
      financeAllSitesListEl.style.display = 'none';
      financeAllSitesListEl.innerHTML = '';
    }

    async function loadMonthlyFinance(monthStartStr, site) {
  snapshotState.finance = null;
  try {
    // All Sites: show per-site finance cards
    if (site === 'All') {
      const { data, error } = await supabase
        .from('monthly_finance_summary')
        .select('*')
        .eq('month_start', monthStartStr)
        .order('site', { ascending: true });

      if (error) throw error;

      financePillEl.textContent = `Finance • ${monthStartStr}`;
      financeEmptyEl.style.display = (data && data.length) ? 'none' : 'block';
      if (financeVizEl) financeVizEl.style.display = 'none';
      if (finYtdEl) { finYtdEl.style.display = 'none'; finYtdEl.innerHTML = ''; }

      financeAllSitesListEl.style.display = (data && data.length) ? 'grid' : 'none';
      financeAllSitesListEl.innerHTML = '';

      snapshotState.finance = {
        mode: 'all',
        monthStartStr,
        rows: (data || []).map(r => ({
          site: r.site,
          budget: {
            retail: safeNum(r.budget_retail_sales),
            hospitality: safeNum(r.budget_hospitality_sales),
            free_issue: safeNum(r.budget_free_issue),
            core_wages: safeNum(r.budget_core_wages),
            cost_to_client: safeNum(r.budget_agency_spend),
            gp_pct: safeNum(r.budget_gp_pct),
          },
          actual: {
            retail: safeNum(r.actual_retail_sales),
            hospitality: safeNum(r.actual_hospitality_sales),
            free_issue: safeNum(r.actual_free_issue),
            core_wages: safeNum(r.actual_core_wages),
            cost_to_client: safeNum(r.actual_agency_spend),
            gp_pct: safeNum(r.actual_gp_pct),
          },
          notes: safeText(r.notes || '')
        })),
        ytd: []
      };

      if (data && data.length) {
        financeAllSitesListEl.innerHTML = data.map(r => {
          const bRetail = safeNum(r.budget_retail_sales);
          const aRetail = safeNum(r.actual_retail_sales);
          const bHosp   = safeNum(r.budget_hospitality_sales);
          const aHosp   = safeNum(r.actual_hospitality_sales);
          const bFree   = safeNum(r.budget_free_issue);
          const aFree   = safeNum(r.actual_free_issue);

          const bCore   = safeNum(r.budget_core_wages);
          const aCore   = safeNum(r.actual_core_wages);
          const bCtc    = safeNum(r.budget_agency_spend);   // Cost to Client (budget)
          const aCtc    = safeNum(r.actual_agency_spend);   // Cost to Client (actual)

          const bGp     = safeNum(r.budget_gp_pct);
          const aGp     = safeNum(r.actual_gp_pct);

          const budgetSales = bRetail + bHosp;
          const actualSales = aRetail + aHosp;

          const budgetLab = bCore + bCtc;
          const actualLab = aCore + aCtc;

          const notes = safeText(r.notes || '');

          return `
            <div class="fin-bar" style="padding:14px;">
              <div class="fin-bar-top" style="margin-bottom:10px;">
                <div class="fin-bar-title">${safeText(r.site)} • ${monthStartStr}</div>
                <div class="fin-bar-nums">GP ${pct(r.actual_gp_pct)} • Bgt ${pct(r.budget_gp_pct)}</div>
              </div>

              <div class="fin-bars">
                                ${barRowHTML('Retail Sales', aRetail, bRetail)}
                ${barRowHTML('Hospitality Sales', aHosp, bHosp)}
                ${barRowHTML('Free Issue', aFree, bFree)}
                ${barRowHTML('Core Wages', aCore, bCore)}
                ${barRowHTML('Cost to Client', aCtc, bCtc)}
                              </div>

              ${notes ? `<div class="fin-notes" style="display:block; margin-top:12px;">${notes.replace(/</g,'&lt;')}</div>` : ``}
            </div>
          `;
        }).join('');
      }

      // All-sites YTD (calendar year-to-date) – per site summary (Total Sales + Labour)
      const year = parseInt(String(monthStartStr).slice(0,4), 10);
      const monthNum = parseInt(String(monthStartStr).slice(5,7), 10);
      const fyYear = (monthNum >= 9) ? year : (year - 1);
      const fyStartStr = `${fyYear}-09-01`;

      if (financeAllSitesYtdEl) { financeAllSitesYtdEl.style.display = 'none'; financeAllSitesYtdEl.innerHTML = ''; }

      const { data: ytdAllRows, error: ytdAllErr } = await supabase
        .from('monthly_finance_summary')
        .select('*')
        .in('site', ['London','Newcastle'])
        .gte('month_start', fyStartStr)
        .lte('month_start', monthStartStr);

      if (!ytdAllErr && ytdAllRows && ytdAllRows.length) {
        // store YTD totals for export
        const sumFor = (rows, field) => rows.reduce((acc, r) => acc + safeNum(r[field]), 0);
        const sites = ['London','Newcastle'];
        if (snapshotState.finance && snapshotState.finance.mode === 'all') {
          snapshotState.finance.ytd = sites.map(s => {
            const rows = ytdAllRows.filter(r => r.site === s);

            const ytdBRetail = sumFor(rows, 'budget_retail_sales');
            const ytdARetail = sumFor(rows, 'actual_retail_sales');

            const ytdBHosp   = sumFor(rows, 'budget_hospitality_sales');
            const ytdAHosp   = sumFor(rows, 'actual_hospitality_sales');

            const ytdBFree   = sumFor(rows, 'budget_free_issue');
            const ytdAFree   = sumFor(rows, 'actual_free_issue');

            const ytdBCore   = sumFor(rows, 'budget_core_wages');
            const ytdACore   = sumFor(rows, 'actual_core_wages');

            const ytdBCtc    = sumFor(rows, 'budget_agency_spend');
            const ytdACtc    = sumFor(rows, 'actual_agency_spend');

            // GP% is stored as a percentage per month; for YTD we use a simple average of months with a value.
            const avgFor = (rows, field) => {
              const vals = (rows || [])
                .map(r => r?.[field])
                .filter(v => v !== null && v !== undefined && v !== '' && Number.isFinite(Number(v)))
                .map(v => Number(v));
              if (!vals.length) return 0;
              return vals.reduce((a,b)=>a+b,0) / vals.length;
            };

            const ytdBGp = avgFor(rows, 'budget_gp_pct');
            const ytdAGp = avgFor(rows, 'actual_gp_pct');

            return {
              site: s,
              budget: { retail: ytdBRetail, hospitality: ytdBHosp, free_issue: ytdBFree, core_wages: ytdBCore, cost_to_client: ytdBCtc, gp_pct: ytdBGp },
              actual: { retail: ytdARetail, hospitality: ytdAHosp, free_issue: ytdAFree, core_wages: ytdACore, cost_to_client: ytdACtc, gp_pct: ytdAGp },
              fyStartStr,
              monthStartStr
            };
          });
        }
      }

      if (!ytdAllErr && ytdAllRows && ytdAllRows.length && financeAllSitesYtdEl) {
        const sumFor = (rows, field) => rows.reduce((acc, r) => acc + safeNum(r[field]), 0);

        const sites = ['London','Newcastle'];
        financeAllSitesYtdEl.style.display = 'grid';
        financeAllSitesYtdEl.innerHTML = sites.map(s => {
          const rows = ytdAllRows.filter(r => r.site === s);

          const ytdBRetail = sumFor(rows, 'budget_retail_sales');
          const ytdARetail = sumFor(rows, 'actual_retail_sales');
          const ytdBHosp   = sumFor(rows, 'budget_hospitality_sales');
          const ytdAHosp   = sumFor(rows, 'actual_hospitality_sales');

          const ytdBFree   = sumFor(rows, 'budget_free_issue');
          const ytdAFree   = sumFor(rows, 'actual_free_issue');

          const ytdBCore   = sumFor(rows, 'budget_core_wages');
          const ytdACore   = sumFor(rows, 'actual_core_wages');
          const ytdBCtc    = sumFor(rows, 'budget_agency_spend');
          const ytdACtc    = sumFor(rows, 'actual_agency_spend');

          const avgFor = (rows, field) => {
            const vals = (rows || [])
              .map(r => r?.[field])
              .filter(v => v !== null && v !== undefined && v !== '' && Number.isFinite(Number(v)))
              .map(v => Number(v));
            if (!vals.length) return 0;
            return vals.reduce((a,b)=>a+b,0) / vals.length;
          };

          const ytdBGp = avgFor(rows, 'budget_gp_pct');
          const ytdAGp = avgFor(rows, 'actual_gp_pct');

          return `
            <div class="fin-bar" style="padding:14px;">
              <div class="fin-bar-top" style="margin-bottom:10px;">
                <div class="fin-bar-title">${s} • YTD</div>
                <div class="fin-bar-nums">${fyStartStr} → ${monthStartStr}</div>
              </div>
              <div class="fin-bars">
                ${barRowHTML('Retail Sales', ytdARetail, ytdBRetail)}
                ${barRowHTML('Hospitality Sales', ytdAHosp, ytdBHosp)}
                ${barRowHTML('Free Issue', ytdAFree, ytdBFree)}
                ${barRowHTML('Core Wages', ytdACore, ytdBCore)}
                ${barRowHTML('Cost to Client', ytdACtc, ytdBCtc)}
                ${gpRowHTML('Gross Profit %', ytdAGp, ytdBGp)}
              </div>
            </div>
          `;
        }).join('');
      }

      return;
    }

    // Single site: fetch correct row explicitly (prevents "wrong site" bleed-through)
    const { data: row, error } = await supabase
      .from('monthly_finance_summary')
      .select('*')
      .eq('month_start', monthStartStr)
      .eq('site', site)
      .maybeSingle();

    if (error) throw error;

    financePillEl.textContent = `Finance • ${site} • ${monthStartStr}`;
    financeEmptyEl.style.display = row ? 'none' : 'block';
    financeAllSitesListEl.style.display = 'none';

    if (!row) {
      if (financeVizEl) financeVizEl.style.display = 'none';
      if (finYtdEl) { finYtdEl.style.display = 'none'; finYtdEl.innerHTML = ''; }
      return;
    }

    // Values (headline fields)
    const bRetail = safeNum(row.budget_retail_sales);
    const aRetail = safeNum(row.actual_retail_sales);

    const bHosp   = safeNum(row.budget_hospitality_sales);
    const aHosp   = safeNum(row.actual_hospitality_sales);

    const bFree   = safeNum(row.budget_free_issue);
    const aFree   = safeNum(row.actual_free_issue);

    const bCore   = safeNum(row.budget_core_wages);
    const aCore   = safeNum(row.actual_core_wages);

    const bCtc    = safeNum(row.budget_agency_spend); // Cost to Client (budget)
    const aCtc    = safeNum(row.actual_agency_spend); // Cost to Client (actual)

    const bGp     = safeNum(row.budget_gp_pct);
    const aGp     = safeNum(row.actual_gp_pct);

    snapshotState.finance = {
      mode: 'single',
      monthStartStr,
      rows: [{
        site,
        budget: { retail: bRetail, hospitality: bHosp, free_issue: bFree, core_wages: bCore, cost_to_client: bCtc, gp_pct: bGp },
        actual: { retail: aRetail, hospitality: aHosp, free_issue: aFree, core_wages: aCore, cost_to_client: aCtc, gp_pct: aGp },
        notes: safeText(row.notes || '')
      }],
      ytd: []
    };

    const budgetSales = bRetail + bHosp;
    const actualSales = aRetail + aHosp;

    const budgetLab   = bCore + bCtc;
    const actualLab   = aCore + aCtc;

    // Visual summary (bars + GP gauge + notes)
    if (financeVizEl) financeVizEl.style.display = 'grid';

    if (finBarsEl) {
      finBarsEl.innerHTML =
        barRowHTML('Retail Sales', aRetail, bRetail) +
        barRowHTML('Hospitality Sales', aHosp, bHosp) +
        barRowHTML('Free Issue', aFree, bFree) +
        barRowHTML('Core Wages', aCore, bCore) +
        barRowHTML('Cost to Client', aCtc, bCtc) +
        gpRowHTML('Gross Profit %', aGp, bGp);
    }

    setGpGauge(safeNum(row.actual_gp_pct), safeNum(row.budget_gp_pct));

    const notes = safeText(row.notes || '');
    if (finNotesEl) {
      if (notes) {
        finNotesEl.style.display = 'block';
        finNotesEl.textContent = notes;
      } else {
        finNotesEl.style.display = 'none';
        finNotesEl.textContent = '';
      }
    }

    // YTD (calendar year-to-date) – totals vs budget
    const year = parseInt(String(monthStartStr).slice(0,4), 10);
    const monthNum = parseInt(String(monthStartStr).slice(5,7), 10);
    const fyYear = (monthNum >= 9) ? year : (year - 1);
    const fyStartStr = `${fyYear}-09-01`;

    async function fetchYtdRows(siteName){
      const { data: rows, error } = await supabase
        .from('monthly_finance_summary')
        .select('*')
        .eq('site', siteName)
        .gte('month_start', fyStartStr)
        .lte('month_start', monthStartStr)
        .order('month_start', { ascending: true });

      if (error) throw error;
      return rows || [];
    }

    function renderYtd(siteLabel, ytdRows){
      if (!ytdRows || !ytdRows.length) return '';

      const sum = (rows, col) => rows.reduce((acc, r) => acc + safeNum(r[col]), 0);

      const ytdBRetail = sum(ytdRows, 'budget_retail_sales');
      const ytdARetail = sum(ytdRows, 'actual_retail_sales');

      const ytdBHosp   = sum(ytdRows, 'budget_hospitality_sales');
      const ytdAHosp   = sum(ytdRows, 'actual_hospitality_sales');

      const ytdBCore   = sum(ytdRows, 'budget_core_wages');
      const ytdACore   = sum(ytdRows, 'actual_core_wages');

      const ytdBCtc    = sum(ytdRows, 'budget_agency_spend');
      const ytdACtc    = sum(ytdRows, 'actual_agency_spend');

      const ytdBFree   = sum(ytdRows, 'budget_free_issue');
      const ytdAFree   = sum(ytdRows, 'actual_free_issue');

      // GP% is stored as a percentage per month; for YTD we use a simple average of months with a value.
      const avgFor = (rows, field) => {
        const vals = (rows || [])
          .map(r => r?.[field])
          .filter(v => v !== null && v !== undefined && v !== '' && Number.isFinite(Number(v)))
          .map(v => Number(v));
        if (!vals.length) return 0;
        return vals.reduce((a,b)=>a+b,0) / vals.length;
      };

      const ytdBGp = avgFor(ytdRows, 'budget_gp_pct');
      const ytdAGp = avgFor(ytdRows, 'actual_gp_pct');

      // Update export state
      if (snapshotState.finance && snapshotState.finance.mode === 'single') {
        snapshotState.finance.ytd = [{
          site: siteLabel,
          budget: { retail: ytdBRetail, hospitality: ytdBHosp, free_issue: ytdBFree, core_wages: ytdBCore, cost_to_client: ytdBCtc, gp_pct: ytdBGp },
          actual: { retail: ytdARetail, hospitality: ytdAHosp, free_issue: ytdAFree, core_wages: ytdACore, cost_to_client: ytdACtc, gp_pct: ytdAGp },
          fyStartStr,
          monthStartStr
        }];
      }

      return `
        <div class="fin-ytd-card">
          <div class="fin-ytd-card-title">${safeText(siteLabel)}</div>
          <div class="fin-bars">
            ${barRowHTML('Retail Sales', ytdARetail, ytdBRetail)}
            ${barRowHTML('Hospitality Sales', ytdAHosp, ytdBHosp)}
            ${barRowHTML('Free Issue', ytdAFree, ytdBFree)}
            ${barRowHTML('Core Wages', ytdACore, ytdBCore)}
            ${barRowHTML('Cost to Client', ytdACtc, ytdBCtc)}
            ${gpRowHTML('Gross Profit %', ytdAGp, ytdBGp)}
          </div>
        </div>
      `;
    }

    if (finYtdEl) {
      // Always hide by default; show only when we have rows to present
      finYtdEl.style.display = 'none';
      finYtdEl.innerHTML = '';

      if (site === 'All Sites') {
        const [lonRows, newRows] = await Promise.all([
          fetchYtdRows('London'),
          fetchYtdRows('Newcastle')
        ]);

        const lonHTML = renderYtd('London', lonRows);
        const newHTML = renderYtd('Newcastle', newRows);

        if (lonHTML || newHTML) {
          finYtdEl.style.display = 'block';
          finYtdEl.innerHTML = `
            <div class="fin-ytd-title">Year-to-date (YTD)</div>
            <div class="fin-ytd-grid">
              ${lonHTML || ''}
              ${newHTML || ''}
            </div>
          `;
        }
      } else {
        const ytdRows = await fetchYtdRows(site);
        const html = renderYtd(site, ytdRows);

        if (html) {
          finYtdEl.style.display = 'block';
          finYtdEl.innerHTML = `
            <div class="fin-ytd-title">Year-to-date (YTD)</div>
            ${html}
          `;
        }
      }
    }

  } catch (err) {
    console.error(err);
    financeEmptyEl.style.display = 'block';
    financeEmptyEl.textContent = 'Finance error: ' + (err?.message || err);
    if (financeVizEl) financeVizEl.style.display = 'none';
    if (finYtdEl) { finYtdEl.style.display = 'none'; finYtdEl.innerHTML = ''; }
    financeAllSitesListEl.style.display = 'none';
  }
}


async function loadMonthlyRetailSales(startStr, endStr, site) {
      let q = supabase
        .from('retail_sales')
        .select('*')
        .gte('sales_date', startStr)
        .lte('sales_date', endStr);

      if (site !== 'All') q = q.eq('site', site);

      const { data, error } = await q.order('sales_date', { ascending: true });
      if (error) throw error;

      const totals = {
        allSales: 0, allTrans: 0,
        L7: { sales: 0, trans: 0 },
        L5: { sales: 0, trans: 0 },
        L4: { sales: 0, trans: 0 },
        L3: { sales: 0, trans: 0 },
      };

      (data || []).forEach(r => {
        const lvl = (r.level || '').toString();
        const sales = safeNum(r.sales);
        const tx = safeNum(r.transactions);

        totals.allSales += sales;
        totals.allTrans += tx;

        if (lvl === 'Level 7') { totals.L7.sales += sales; totals.L7.trans += tx; }
        if (lvl === 'Level 5') { totals.L5.sales += sales; totals.L5.trans += tx; }
        if (lvl === 'Level 4') { totals.L4.sales += sales; totals.L4.trans += tx; }
        if (lvl === 'Level 3') { totals.L3.sales += sales; totals.L3.trans += tx; }
      });

      return totals;
    }



    async function loadLondonRetailSalesAndTradingDays(startStr, endStr) {
      let q = supabase
        .from('retail_sales')
        .select('sales_date, sales')
        .gte('sales_date', startStr)
        .lte('sales_date', endStr)
        .eq('site', 'London');

      const { data, error } = await q;
      if (error) throw error;

      let totalSales = 0;
      const days = new Set();

      (data || []).forEach(r => {
        const d = (r.sales_date || '').toString().slice(0,10);
        if (d) days.add(d);
        totalSales += safeNum(r.sales);
      });

      return { totalSales, tradingDays: days.size };
    }

    
    function renderRetailSales(totals) {
      const sph = calcSPH(totals.allSales, totals.allTrans);

      retailTotalEl.textContent = money(totals.allSales);
      retailSubEl.textContent = `${Math.round(totals.allTrans)} tx • SPH ${money(sph)}`;
      retailBreakdownEl.textContent =
        `L7 ${money(totals.L7.sales)} • L5 ${money(totals.L5.sales)} • L4 ${money(totals.L4.sales)} • L3 ${money(totals.L3.sales)}`;

      kpiRetailSalesEl.textContent = money(totals.allSales);
      kpiRetailSubEl.textContent = `${Math.round(totals.allTrans)} tx • SPH ${money(sph)}`;

      // Bar chart by level (monthly totals)
      retailBarChartEl.innerHTML = '';
      const levels = [
        { key: 'L7', name: 'Level 7', s: totals.L7.sales, t: totals.L7.trans, cls: 'l7' },
        { key: 'L5', name: 'Level 5', s: totals.L5.sales, t: totals.L5.trans, cls: 'l5' },
        { key: 'L4', name: 'Level 4', s: totals.L4.sales, t: totals.L4.trans, cls: 'l4' },
        { key: 'L3', name: 'Level 3', s: totals.L3.sales, t: totals.L3.trans, cls: 'l3' },
      ];

      const maxSales = Math.max(1, ...levels.map(l => safeNum(l.s)));

      levels.forEach(l => {
        const pct = Math.max(0, Math.min(100, (safeNum(l.s) / maxSales) * 100));
        const row = document.createElement('div');
        row.className = 'bar-row';
        row.title = `${l.name} • Sales ${money(l.s)} • Tx ${Math.round(l.t)} • SPH ${money(calcSPH(l.s, l.t))}`;
        row.innerHTML = `
          <div class="bar-left">
            <div class="bar-label">${l.name}</div>
            <div class="bar-meta">${Math.round(l.t)} tx • SPH ${money(calcSPH(l.s, l.t))}</div>
          </div>
          <div class="bar-track">
            <div class="bar-fill ${l.cls}" style="width:${pct}%;"></div>
          </div>
          <div class="bar-right">${money(l.s)}</div>
        `;
        retailBarChartEl.appendChild(row);
      });
    }

    async function loadMonthlyOpsLogs(startStr, endStr, site) {
      let q = supabase
        .from('ops_logs')
        .select('*')
        .or(
          `and(log_date.gte.${startStr},log_date.lte.${endStr}),and(log_date.is.null,created_at.gte.${startStr}T00:00:00Z,created_at.lte.${endStr}T23:59:59Z)`
        )
        .order('log_date', { ascending: true })
        .order('created_at', { ascending: true });

      if (site !== 'All') q = q.eq('site', site);

      const { data, error } = await q;
      if (error) throw error;
      return data || [];
    }

    
    async function loadPhotosByLogId(logIds) {
      const out = {};
      const ids = (logIds || []).filter(Boolean);
      if (!ids.length) return out;

      // Supabase IN() has practical limits; chunk for safety.
      const chunkSize = 100;
      for (let i = 0; i < ids.length; i += chunkSize) {
        const chunk = ids.slice(i, i + chunkSize);
        const { data, error } = await supabase
          .from('ops_log_photos')
          .select('log_id, photo_url, created_at')
          .in('log_id', chunk)
          .order('created_at', { ascending: true });

        if (error) throw error;
        (data || []).forEach(row => {
          const k = row.log_id;
          if (!out[k]) out[k] = [];
          if (row.photo_url) out[k].push(row.photo_url);
        });
      }
      return out;
    }

    
    function renderPhotos(opsRows, photosByLogId = {}) {
      // Build a flat list of photos from either legacy ops_logs.photo_url or multi-photo ops_log_photos
      const out = [];
      (opsRows || []).forEach(r => {
        const d = (r.log_date || (r.created_at ? String(r.created_at).slice(0,10) : '')).slice(0,10) || '—';
        const meta = `${d} • ${r.site || '—'}${r.area ? ' • ' + r.area : ''}`;

        const urls = (photosByLogId && photosByLogId[r.id] && photosByLogId[r.id].length)
          ? photosByLogId[r.id]
          : (r.photo_url ? [r.photo_url] : []);

        urls.forEach((u, idx) => {
          if (!u) return;
          out.push({
            url: u,
            meta,
            date: d,
            site: r.site || '—',
            area: r.area || '—',
            logId: r.id,
            idx,
            count: urls.length
          });
        });
      });

      if (!out.length) {
        photosEmptyEl.style.display = 'block';
        photosGridEl.innerHTML = '';
        return;
      }

      photosEmptyEl.style.display = 'none';
      out.sort((a,b) => (a.date < b.date ? -1 : a.date > b.date ? 1 : 0));

      photosGridEl.innerHTML = out.map(p => `
        <div class="photo-card" data-logid="${p.logId}" data-idx="${p.idx}" data-meta="${p.meta}">
          <img src="${p.url}" alt="Ops photo" />
          <div class="photo-card-caption">${p.date}<br/>${p.site}${p.area ? ' • ' + p.area : ''}${p.count > 1 ? ` • ${p.idx+1}/${p.count}` : ''}</div>
        </div>
      `).join('');

      // Delegated click: open modal and allow browsing all photos for that log
      photosGridEl.querySelectorAll('.photo-card').forEach(el => {
        el.addEventListener('click', (e) => {
          e.preventDefault();
          e.stopPropagation();
          const logId = Number(el.getAttribute('data-logid'));
          const startIdx = Number(el.getAttribute('data-idx') || '0');
          const meta = el.getAttribute('data-meta') || '';

          const urls = (photosByLogId && photosByLogId[logId] && photosByLogId[logId].length)
            ? photosByLogId[logId]
            : [];

          // Fallback: if multi list missing, use the clicked image src
          const fallbackUrl = el.querySelector('img')?.getAttribute('src') || '';
          const list = urls.length ? urls : (fallbackUrl ? [fallbackUrl] : []);

          let currentIdx = Math.min(Math.max(startIdx, 0), Math.max(list.length - 1, 0));
          photoModalImgEl.src = list[currentIdx] || '';
          photoModalMetaEl.textContent = meta;

          // thumbs
          const thumbsEl = document.getElementById('photoModalThumbs');
          if (thumbsEl) {
            thumbsEl.innerHTML = '';
            list.forEach((u, i) => {
              const t = document.createElement('img');
              t.src = u;
              t.alt = `Photo ${i+1}`;
              if (i === currentIdx) t.classList.add('active');
              t.addEventListener('click', (e) => {
                e.preventDefault();
                e.stopPropagation();
                currentIdx = i;
                photoModalImgEl.src = list[currentIdx] || '';
                Array.from(thumbsEl.querySelectorAll('img')).forEach((im, j) => {
                  im.classList.toggle('active', j === currentIdx);
                });
              });
              thumbsEl.appendChild(t);
            });
          }

          photoModalEl.classList.add('open');
        });
      });
    }

    async function loadMonth() {
      clearUI();

      nextMonthBtn.disabled = currentMonthOffset === 0;

      const anchor = new Date();
      const target = new Date(anchor);
      target.setMonth(target.getMonth() + currentMonthOffset);

      const monthStart = startOfMonth(target);
      const monthEnd = endOfMonth(target);

      const startStr = toISODate(monthStart);
      const endStr = toISODate(monthEnd);

      const monthStartStr = toISODate(monthStart);
      const site = siteFilterEl.value;

      monthLabelEl.textContent = monthLabelFromDate(target);
      monthRangePillEl.textContent = `${startStr} → ${endStr}`;

      snapshotState.monthLabel = monthLabelFromDate(target);
      snapshotState.monthStartStr = monthStartStr;
      snapshotState.monthRange = `${startStr} → ${endStr}`;
      snapshotState.site = site;

      try {
        const [opsRows, retailTotals] = await Promise.all([
          loadMonthlyOpsLogs(startStr, endStr, site),
          loadMonthlyRetailSales(startStr, endStr, site),
        ]);

        kpiTotalLogsEl.textContent = String(opsRows.length);

        const sick = opsRows.reduce((s,r) => s + safeNum(r.sickness_count), 0);
        const hol  = opsRows.reduce((s,r) => s + safeNum(r.holiday_count), 0);

        staffSickEl.textContent = String(sick);
        staffHolEl.textContent  = String(hol);

        kpiStaffingSumEl.textContent = String(sick + hol);
        kpiStaffingSubEl.textContent = `Sick: ${sick} • Holiday: ${hol}`;

        // Ranked name breakdowns (from notes)
        const sickCounts = buildNameCounts(opsRows, 'sickness_notes');
        const holCounts  = buildNameCounts(opsRows, 'holiday_notes');

        renderRankList(sickRankListEl, sickRankEmptyEl, sickCounts);
        renderRankList(holRankListEl, holRankEmptyEl, holCounts);

        snapshotState.totalLogs = opsRows.length;
        snapshotState.staffing = { sick, holiday: hol, sickCounts, holidayCounts: holCounts };

        // London Hospitality events (Day / Evening / Places)
        const includeLondon = site === 'London' || site === 'All';
        hospEventsCardEl.style.display = includeLondon ? '' : 'none';

        if (includeLondon) {
          const hospRows = (opsRows || []).filter(r => r.site === 'London' && r.area === 'Hospitality');

          const hospDay = hospRows.reduce((s,r) => s + safeNum(r.hosp_day_events), 0);
          const hospNight = hospRows.reduce((s,r) => s + safeNum(r.hosp_night_events), 0);
          const hospPlaces = hospRows.reduce((s,r) => s + safeNum(r.hosp_places_events), 0);
          const hospTotal = hospDay + hospNight + hospPlaces;

          mHospDayEl.textContent = String(hospDay);
          mHospNightEl.textContent = String(hospNight);
          mHospPlacesEl.textContent = String(hospPlaces);
          mHospTotalEl.textContent = String(hospTotal);

          const pctDay = hospTotal > 0 ? (hospDay / hospTotal) * 100 : 0;
          const pctEve = hospTotal > 0 ? (hospNight / hospTotal) * 100 : 0;
          const pctPlc = hospTotal > 0 ? (hospPlaces / hospTotal) * 100 : 0;

          if (mHospDayPctEl) mHospDayPctEl.textContent = fmtPct1(pctDay);
          if (mHospNightPctEl) mHospNightPctEl.textContent = fmtPct1(pctEve);
          if (mHospPlacesPctEl) mHospPlacesPctEl.textContent = fmtPct1(pctPlc);
          if (mHospTotalPctEl) mHospTotalPctEl.textContent = hospTotal > 0 ? '100%' : '0%';

          if (hospMixDayEl) hospMixDayEl.style.width = `${pctDay}%`;
          if (hospMixEveEl) hospMixEveEl.style.width = `${pctEve}%`;
          if (hospMixPlcEl) hospMixPlcEl.style.width = `${pctPlc}%`;
          if (hospMixBarEl) hospMixBarEl.title = `Day ${fmtPct1(pctDay)} • Evening ${fmtPct1(pctEve)} • Places ${fmtPct1(pctPlc)}`;

          const hasAny = hospRows.length > 0 && hospTotal > 0;
          hospEventsEmptyEl.style.display = hasAny ? 'none' : '';
          hospEventsMetricsEl.style.display = hasAny ? '' : 'none';

          if (hospMixBarEl) hospMixBarEl.style.display = hasAny ? '' : 'none';
          const hospMixLegendEl = document.getElementById('hospMixLegend');
          if (hospMixLegendEl) hospMixLegendEl.style.display = hasAny ? '' : 'none';

          snapshotState.hospEvents = { day: hospDay, night: hospNight, places: hospPlaces, total: hospTotal };
        } else {
          snapshotState.hospEvents = null;
        }


        // Staff Meals + Wastage (London only; shown for London / All Sites)
        const showLondonRollups = site === 'London' || site === 'All';
        if (staffMealsCardEl) staffMealsCardEl.style.display = showLondonRollups ? '' : 'none';
        if (wastageCardEl) wastageCardEl.style.display = showLondonRollups ? '' : 'none';

        if (showLondonRollups) {
          const { totalSales: londonRetailSales, tradingDays } = await loadLondonRetailSalesAndTradingDays(startStr, endStr);

          // Staff meals
          const costPerPersonPerDay = STAFF_MEAL_VALUE_PP_DAY * STAFF_MEAL_COST_RATE;
          const totalMealValue = STAFF_PER_DAY * tradingDays * STAFF_MEAL_VALUE_PP_DAY;
          const totalMealCost = STAFF_PER_DAY * tradingDays * costPerPersonPerDay;

          if (staffMealsTotalEl) staffMealsTotalEl.textContent = fmtGBP(totalMealCost);
          if (staffMealsMetaEl) staffMealsMetaEl.textContent = `${STAFF_PER_DAY} staff/day • ${tradingDays} trading day(s) • ${fmtGBP(costPerPersonPerDay)} cost/person/day`;
          if (staffMealsMeta2El) staffMealsMeta2El.textContent = `Meal value ${fmtGBP(STAFF_MEAL_VALUE_PP_DAY)} pp/day • Cost rate ${(STAFF_MEAL_COST_RATE*100).toFixed(0)}% • Total meal value ${fmtGBP(totalMealValue)}`;

          // Wastage
          const wastageCost = londonRetailSales * WASTAGE_PCT_LONDON;
          if (wastageTotalEl) wastageTotalEl.textContent = fmtGBP(wastageCost);
          if (wastageMetaEl) wastageMetaEl.textContent = `Wastage ${(WASTAGE_PCT_LONDON*100).toFixed(1)}% • Retail sales ${fmtGBP(londonRetailSales)}`;

          snapshotState.staffMeals = { staffPerDay: STAFF_PER_DAY, tradingDays, valuePerPersonPerDay: STAFF_MEAL_VALUE_PP_DAY, costRate: STAFF_MEAL_COST_RATE, totalValue: totalMealValue, totalCost: totalMealCost };
          snapshotState.wastage = { pct: WASTAGE_PCT_LONDON, retailSales: londonRetailSales, cost: wastageCost };
        } else {
          snapshotState.staffMeals = null;
          snapshotState.wastage = null;
        }


        const maintItems = [];
        const hsItems = [];

        opsRows.forEach(r => {
          const date = (r.log_date || (r.created_at ? String(r.created_at).slice(0,10) : '')).slice(0,10);
          const titleBase = `${r.site || 'Site'} • ${r.area || 'Area'} • ${date || '—'}`;

          if (isIncidentFlagTrue(r.maintenance_issue) || hasText(r.maintenance_notes)) {
            maintItems.push({ title: titleBase, badge: '', notes: safeText(r.maintenance_notes) || '(No notes entered)' });
          }
          if (isIncidentFlagTrue(r.hs_issue) || hasText(r.hs_notes)) {
            hsItems.push({ title: titleBase, badge: '', notes: safeText(r.hs_notes) || '(No notes entered)' });
          }
        });

        renderList(maintListEl, maintEmptyEl, maintItems);
        renderList(hsListEl, hsEmptyEl, hsItems);

        snapshotState.incidents = { maintenance: maintItems.length, hs: hsItems.length };

        // London Retail lunch specials (from daily ops logs)
        if (specialsMonthlyListEl && specialsMonthlyEmptyEl) {
          let specials = [];
          if (site === 'Newcastle') {
            specialsMonthlyListEl.innerHTML = '';
            specialsMonthlyEmptyEl.style.display = 'block';
            specialsMonthlyEmptyEl.textContent = 'Not applicable for Newcastle (London Retail only).';
            snapshotState.specials = { count: 0, days: 0 };
          } else {
            specials = opsRows
              .filter(r => (r.site || '') === 'London')
              .filter(r => (r.area || '') === 'Retail')
              .filter(r => safeText(r.retail_lunch_special).toLowerCase() === 'yes')
              .map(r => {
                const date = (r.log_date || (r.created_at ? String(r.created_at).slice(0,10) : '')).slice(0,10);
                return {
                  title: `London • ${date || '—'}`,
                  badge: '',
                  notes: safeText(r.retail_lunch_desc) || '(Special recorded – no details entered)'
                };
              });

            // sort oldest → newest
            specials.sort((a,b) => (a.title < b.title ? -1 : 1));
            renderList(specialsMonthlyListEl, specialsMonthlyEmptyEl, specials);

            const specialDays = new Set(specials.map(s => (s.title.split(' • ')[1] || '').trim()).filter(Boolean));
            snapshotState.specials = {
              count: specials.length,
              days: specialDays.size
            };
          }
        }

        // Newcastle monthly: hot lunches + free breakfast
        if (newcastleMonthlyRowEl && newcastleMonthlyEmptyEl && newcastleMonthlyMetricsEl) {
          const showNc = (site === 'Newcastle' || site === 'All');
          newcastleMonthlyRowEl.style.display = showNc ? 'grid' : 'none';

          if (!showNc) {
            // nothing else to do
          } else {
            const ncRows = (site === 'Newcastle') ? opsRows : opsRows.filter(r => (r.site || '') === 'Newcastle');

            // Build daily totals map for chart + peak day calculations
            const daily = new Map(); // dateKey -> { hl, fb }
            (ncRows || []).forEach(r => {
              const k = dateKeyFromRow(r);
              if (!k) return;
              const hl = safeNum(r.hot_lunch_dishes);
              const fb = safeNum(r.free_breakfast_count);
              if (!daily.has(k)) daily.set(k, { hl: 0, fb: 0 });
              const v = daily.get(k);
              v.hl += hl;
              v.fb += fb;
            });

            const datesWithEntries = [...daily.entries()]
              .map(([k,v]) => ({ date: k, hl: v.hl, fb: v.fb, total: (v.hl + v.fb) }))
              .filter(d => d.total > 0)
              .sort((a,b) => (a.date < b.date ? -1 : 1));

            const hlTotal = datesWithEntries.reduce((s,d) => s + d.hl, 0);
            const fbTotal = datesWithEntries.reduce((s,d) => s + d.fb, 0);
            const totalProd = hlTotal + fbTotal;

            const hlDays = new Set(datesWithEntries.filter(d => d.hl > 0).map(d => d.date));
            const fbDays = new Set(datesWithEntries.filter(d => d.fb > 0).map(d => d.date));
            const activeDays = datesWithEntries.length;

            const anyData = totalProd > 0;
            newcastleMonthlyEmptyEl.style.display = anyData ? 'none' : 'block';
            newcastleMonthlyMetricsEl.style.display = anyData ? 'block' : 'none';

            const hlAvg = hlDays.size ? (hlTotal / hlDays.size) : 0;

            if (ncHotLunchTotalEl) ncHotLunchTotalEl.textContent = String(Math.round(hlTotal));
            if (ncHotLunchSubEl) ncHotLunchSubEl.textContent = `${hlDays.size} day(s) • Avg ${Math.round(hlAvg)}/day`;

            if (ncFreeBreakfastTotalEl) ncFreeBreakfastTotalEl.textContent = String(Math.round(fbTotal));
            if (ncFreeBreakfastSubEl) ncFreeBreakfastSubEl.textContent = `${fbDays.size} day(s)`;

            const pctHot = totalProd > 0 ? (hlTotal / totalProd) * 100 : 0;
            const pctFree = totalProd > 0 ? (fbTotal / totalProd) * 100 : 0;

            if (ncHotLunchPctEl) ncHotLunchPctEl.textContent = fmtPct1(pctHot);
            if (ncFreeBreakfastPctEl) ncFreeBreakfastPctEl.textContent = fmtPct1(pctFree);

            if (ncMixBarEl) ncMixBarEl.style.display = anyData ? '' : 'none';
            if (ncLegendEl) ncLegendEl.style.display = anyData ? '' : 'none';
            if (ncMixHotEl) ncMixHotEl.style.width = `${pctHot}%`;
            if (ncMixFreeEl) ncMixFreeEl.style.width = `${pctFree}%`;
            if (ncMixBarEl) ncMixBarEl.title = `Hot lunches ${fmtPct1(pctHot)} • Free breakfasts ${fmtPct1(pctFree)}`;

            const avgActive = activeDays ? (totalProd / activeDays) : 0;
            if (ncTotalProductionEl) ncTotalProductionEl.textContent = String(Math.round(totalProd));
            if (ncTotalProductionSubEl) ncTotalProductionSubEl.textContent = `${activeDays} active day(s) • Avg ${Math.round(avgActive)}/day`;

            // Peak day (total production)
            let peak = { date: '', total: 0 };
            datesWithEntries.forEach(d => {
              if (d.total > peak.total) peak = { date: d.date, total: d.total };
            });
            if (ncPeakTotalEl) ncPeakTotalEl.textContent = String(Math.round(peak.total || 0));
            if (ncPeakTotalSubEl) ncPeakTotalSubEl.textContent = peak.date ? fmtShortDate(peak.date) : '—';

            // Render stacked daily bar chart
            if (ncMonthlyChartEl) {
              ncMonthlyChartEl.innerHTML = '';
              const maxTotal = Math.max(0, ...datesWithEntries.map(d => d.total));
              datesWithEntries.forEach(d => {
                const row = document.createElement('div');
                row.className = 'nc-row';

                const left = document.createElement('div');
                left.className = 'nc-date';
                left.textContent = fmtShortDate(d.date);

                const track = document.createElement('div');
                track.className = 'nc-track';

                const wrap = document.createElement('div');
                wrap.style.display = 'flex';
                wrap.style.height = '100%';
                const w = (maxTotal > 0) ? (d.total / maxTotal) * 100 : 0;
                wrap.style.width = `${w}%`;

                const hotSeg = document.createElement('div');
                hotSeg.className = 'nc-seg hot';
                hotSeg.style.width = d.total ? `${(d.hl / d.total) * 100}%` : '0%';

                const freeSeg = document.createElement('div');
                freeSeg.className = 'nc-seg free';
                freeSeg.style.width = d.total ? `${(d.fb / d.total) * 100}%` : '0%';

                wrap.appendChild(hotSeg);
                wrap.appendChild(freeSeg);
                track.appendChild(wrap);

                const right = document.createElement('div');
                right.className = 'nc-total';
                right.textContent = String(Math.round(d.total));

                row.appendChild(left);
                row.appendChild(track);
                row.appendChild(right);

                row.title = `Hot lunches ${Math.round(d.hl)} • Free breakfasts ${Math.round(d.fb)} • Total ${Math.round(d.total)}`;

                ncMonthlyChartEl.appendChild(row);
              });

              if (ncMonthlyChartHintEl) {
                ncMonthlyChartHintEl.style.display = anyData ? '' : 'none';
                ncMonthlyChartHintEl.textContent = anyData
                  ? `Daily total production for ${activeDays} day(s) with entries (stacked: hot lunches + free breakfasts).`
                  : '';
              }
            }

            snapshotState.newcastleMonthly = {
              hotLunchTotal: Math.round(hlTotal),
              hotLunchDays: hlDays.size,
              hotLunchAvg: hlDays.size ? Math.round(hlAvg) : 0,
              freeBreakfastTotal: Math.round(fbTotal),
              freeBreakfastDays: fbDays.size,
              totalProduction: Math.round(totalProd),
              activeDays: activeDays,
              avgPerActiveDay: activeDays ? Math.round(avgActive) : 0,
              peakDay: peak.date || null,
              peakTotal: Math.round(peak.total || 0)
            };
          }
        }

        renderRetailSales(retailTotals);
        const photosByLogId = await loadPhotosByLogId((opsRows || []).map(r => r.id));
        renderPhotos(opsRows, photosByLogId);

        await loadMonthlyFinance(monthStartStr, site);

      } catch (err) {
        errorMessageEl.style.display = 'block';
        errorMessageEl.textContent = `Error loading monthly dashboard:\n${err?.message || err}`;
      }
    }

    prevMonthBtn.addEventListener('click', () => { currentMonthOffset -= 1; loadMonth(); });
    nextMonthBtn.addEventListener('click', () => { if (currentMonthOffset < 0) { currentMonthOffset += 1; loadMonth(); } });
    latestMonthBtn.addEventListener('click', () => { currentMonthOffset = 0; loadMonth(); });

    // Month picker (jump to any month)
    function monthInputValueFromOffset(offset){
      const d = new Date();
      d.setDate(1);
      d.setMonth(d.getMonth() + offset);
      const yyyy = d.getFullYear();
      const mm = String(d.getMonth() + 1).padStart(2, '0');
      return `${yyyy}-${mm}`;
    }

    function offsetFromMonthInput(value){
      // value: YYYY-MM
      const [y, m] = (value || '').split('-').map(Number);
      if (!y || !m) return 0;
      const now = new Date();
      const base = new Date(now.getFullYear(), now.getMonth(), 1);
      const target = new Date(y, m - 1, 1);
      return (target.getFullYear() - base.getFullYear()) * 12 + (target.getMonth() - base.getMonth());
    }

    monthLabelEl.addEventListener('click', () => {
      if (!monthPickerEl) return;
      monthPickerEl.value = monthInputValueFromOffset(currentMonthOffset);
      monthPickerEl.showPicker ? monthPickerEl.showPicker() : monthPickerEl.click();
    });

    if (monthPickerEl) {
      monthPickerEl.addEventListener('change', async () => {
        currentMonthOffset = offsetFromMonthInput(monthPickerEl.value);
        await loadMonth();
      });
    }

    refreshBtn.addEventListener('click', loadMonth);
    siteFilterEl.addEventListener('change', loadMonth);


    function buildSnapshotText() {
      const lines = [];
      const site = snapshotState.site || 'All Sites';
      const monthLabel = snapshotState.monthLabel || snapshotState.monthStartStr || '—';
      lines.push(`OPS LOG • MONTHLY SNAPSHOT`);
      lines.push(`${monthLabel} • ${site}`);
      if (snapshotState.monthRange) lines.push(`Range: ${snapshotState.monthRange}`);
      lines.push('');

      // Staffing + incidents headline
      lines.push(`Operations headline`);
      lines.push(`- Logs submitted: ${snapshotState.totalLogs ?? 0}`);
      lines.push(`- Staffing impact: Sick ${snapshotState.staffing?.sick ?? 0} • Holiday ${snapshotState.staffing?.holiday ?? 0}`);
      lines.push(`- Incidents: Maintenance ${snapshotState.incidents?.maintenance ?? 0} • H&S ${snapshotState.incidents?.hs ?? 0}`);
      if ((snapshotState.site || 'All') !== 'Newcastle') {
        lines.push(`- Lunch specials (London Retail): ${snapshotState.specials?.days ?? 0} day(s)`);
        if (snapshotState.hospEvents) {
          lines.push(`- Hospitality events (London): Day ${snapshotState.hospEvents.day ?? 0} • Evening ${snapshotState.hospEvents.night ?? 0} • Places ${snapshotState.hospEvents.places ?? 0} (Total ${snapshotState.hospEvents.total ?? 0})`);
        }
      }

      // Newcastle monthly production (hot lunches + free breakfast)
      if ((snapshotState.site || 'All') !== 'London') {
        const nc = snapshotState.newcastleMonthly;
        if (nc) {
          lines.push(`- Newcastle hot lunches: ${nc.hotLunchTotal ?? 0} over ${nc.hotLunchDays ?? 0} day(s) (avg ${nc.hotLunchAvg ?? 0}/day)`);
          lines.push(`- Newcastle free breakfasts: ${nc.freeBreakfastTotal ?? 0} over ${nc.freeBreakfastDays ?? 0} day(s)`);
        }
      }

      lines.push('');

      // Finance snapshot
      const fin = snapshotState.finance;
      if (!fin || !fin.rows || fin.rows.length === 0) {
        lines.push('Finance Snapshot: No finance row found for this month/site.');
      } else {
        lines.push('Finance Snapshot (Budget vs Actual)');
        const fmt = (n) => money(safeNum(n));
        const fmtVar = (a,b) => {
          const v = safeNum(a) - safeNum(b);
          const sign = v > 0 ? '+' : (v < 0 ? '-' : '');
          return `${sign}${fmt(Math.abs(v))}`;
        };
        const fmtPp = (a,b) => {
          const v = safeNum(a) - safeNum(b);
          const sign = v > 0 ? '+' : '';
          return `${sign}${v.toFixed(1)} pp`;
        };

        fin.rows.forEach(r => {
          const s = r.site || site;
          if (fin.mode === 'all') lines.push(`
${s}`);
          lines.push(`- Retail Sales: Act ${fmt(r.actual.retail)} • Bgt ${fmt(r.budget.retail)} • Var ${fmtVar(r.actual.retail, r.budget.retail)}`);
          lines.push(`- Hospitality Sales: Act ${fmt(r.actual.hospitality)} • Bgt ${fmt(r.budget.hospitality)} • Var ${fmtVar(r.actual.hospitality, r.budget.hospitality)}`);
          lines.push(`- Free Issue: Act ${fmt(r.actual.free_issue)} • Bgt ${fmt(r.budget.free_issue)} • Var ${fmtVar(r.actual.free_issue, r.budget.free_issue)}`);
          lines.push(`- Core Wages: Act ${fmt(r.actual.core_wages)} • Bgt ${fmt(r.budget.core_wages)} • Var ${fmtVar(r.actual.core_wages, r.budget.core_wages)}`);
          lines.push(`- Cost to Client: Act ${fmt(r.actual.cost_to_client)} • Bgt ${fmt(r.budget.cost_to_client)} • Var ${fmtVar(r.actual.cost_to_client, r.budget.cost_to_client)}`);
          lines.push(`- Gross Profit %: Act ${pct(r.actual.gp_pct)} • Bgt ${pct(r.budget.gp_pct)} • Var ${fmtPp(r.actual.gp_pct, r.budget.gp_pct)}`);
          if (r.notes) lines.push(`  Notes: ${String(r.notes).replace(/\s+/g,' ').trim()}`);
        });
      }

      // YTD
      if (fin && fin.ytd && fin.ytd.length) {
        lines.push('');
        lines.push('Year-to-date (YTD) vs Budget');
        const fmt = (n) => money(safeNum(n));
        const fmtVar = (a,b) => {
          const v = safeNum(a) - safeNum(b);
          const sign = v > 0 ? '+' : (v < 0 ? '-' : '');
          return `${sign}${fmt(Math.abs(v))}`;
        };
        const fmtPp = (a,b) => {
          const v = safeNum(a) - safeNum(b);
          const sign = v > 0 ? '+' : '';
          return `${sign}${v.toFixed(1)} pp`;
        };



        fin.ytd.forEach(y => {
          const s = y.site || site;
          lines.push(`\n${s} (YTD)`);
          lines.push(`- Retail Sales: Act ${fmt(y.actual?.retail)} • Bgt ${fmt(y.budget?.retail)} • Var ${fmtVar(y.actual?.retail, y.budget?.retail)}`);
          lines.push(`- Hospitality Sales: Act ${fmt(y.actual?.hospitality)} • Bgt ${fmt(y.budget?.hospitality)} • Var ${fmtVar(y.actual?.hospitality, y.budget?.hospitality)}`);
          lines.push(`- Free Issue: Act ${fmt(y.actual?.free_issue)} • Bgt ${fmt(y.budget?.free_issue)} • Var ${fmtVar(y.actual?.free_issue, y.budget?.free_issue)}`);
          lines.push(`- Core Wages: Act ${fmt(y.actual?.core_wages)} • Bgt ${fmt(y.budget?.core_wages)} • Var ${fmtVar(y.actual?.core_wages, y.budget?.core_wages)}`);
          lines.push(`- Cost to Client: Act ${fmt(y.actual?.cost_to_client)} • Bgt ${fmt(y.budget?.cost_to_client)} • Var ${fmtVar(y.actual?.cost_to_client, y.budget?.cost_to_client)}`);
          lines.push(`- Gross Profit %: Act ${pct(y.actual?.gp_pct)} • Bgt ${pct(y.budget?.gp_pct)} • Var ${fmtPp(y.actual?.gp_pct, y.budget?.gp_pct)}`);
        });
      }

      return lines.join('\n');
    }

    function openExportModal() {
      const meta = `${snapshotState.monthLabel || snapshotState.monthStartStr || '—'} • ${snapshotState.site || 'All Sites'}`;
      if (exportMetaPillEl) exportMetaPillEl.textContent = meta;
      if (exportTextEl) exportTextEl.value = buildSnapshotText();
      if (exportHintEl) exportHintEl.textContent = 'Tip: You can copy this straight into an email or client report.';
      exportModalEl.classList.add('open');
    }

    exportBtn.addEventListener('click', () => openExportModal());

    closeExportModalBtn.addEventListener('click', () => exportModalEl.classList.remove('open'));
    exportModalEl.addEventListener('click', (e) => {
      if (e.target === exportModalEl) exportModalEl.classList.remove('open');
    });

    copyExportBtn.addEventListener('click', async () => {
      try {
        await navigator.clipboard.writeText(exportTextEl.value || '');
        if (exportHintEl) exportHintEl.textContent = 'Copied to clipboard.';
      } catch (e) {
        // Fallback
        exportTextEl.focus();
        exportTextEl.select();
        document.execCommand('copy');
        if (exportHintEl) exportHintEl.textContent = 'Copied to clipboard.';
      }
    });

    downloadExportBtn.addEventListener('click', () => {
      const text = exportTextEl.value || '';
      const blob = new Blob([text], { type: 'text/plain;charset=utf-8' });
      const a = document.createElement('a');
      const fileSafe = (snapshotState.monthLabel || snapshotState.monthStartStr || 'snapshot').replace(/[^a-z0-9]+/gi,'-').toLowerCase();
      a.href = URL.createObjectURL(blob);
      a.download = `ops-log-monthly-snapshot-${fileSafe}.txt`;
      document.body.appendChild(a);
      a.click();
      setTimeout(() => {
        URL.revokeObjectURL(a.href);
        a.remove();
      }, 0);
    });


    closePhotoModalBtn.addEventListener('click', () => photoModalEl.classList.remove('open'));
    photoModalEl.addEventListener('click', (e) => {
      if (e.target === photoModalEl) photoModalEl.classList.remove('open');
    });

    loadMonth();
  </script>
</body>
</html>
