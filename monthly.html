<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Ops Log • Monthly Dashboard</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    body {
      margin: 0;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: #0b1220;
      color: #f9fafb;
      min-height: 100vh;
    }

    .wrap {
      max-width: 1400px;
      margin: 0 auto;
      padding: 18px 14px 42px;
    }

    .topbar {
      display: flex;
      flex-wrap: wrap;
      align-items: center;
      justify-content: space-between;
      gap: 12px;
      margin-bottom: 14px;
    }

    .brand { display: flex; gap: 10px; align-items: center; }

    .logo {
      width: 42px; height: 42px; border-radius: 12px;
      background: linear-gradient(135deg, #1f2a44, #0f172a);
      box-shadow: 0 0 0 1px rgba(255,255,255,0.06) inset, 0 12px 24px rgba(0,0,0,0.25);
      display: grid; place-items: center;
      font-weight: 800; letter-spacing: 0.5px;
      color: #93c5fd;
    }

    .titleblock .title { font-size: 18px; font-weight: 750; line-height: 1.2; }
    .titleblock .subtitle { font-size: 12px; color: rgba(255,255,255,0.68); margin-top: 2px; }

    .filters { display: flex; gap: 10px; flex-wrap: wrap; align-items: center; justify-content: flex-end; }

    .filter {
      background: rgba(255,255,255,0.05);
      border: 1px solid rgba(255,255,255,0.08);
      padding: 10px 12px;
      border-radius: 14px;
      display: flex;
      align-items: center;
      gap: 10px;
      min-width: 220px;
      box-shadow: 0 8px 18px rgba(0,0,0,0.20);
    }

    .filter label {
      font-size: 12px;
      color: rgba(255,255,255,0.72);
      white-space: nowrap;
    }

    select {
      background: rgba(0,0,0,0.25);
      border: 1px solid rgba(255,255,255,0.12);
      color: #f9fafb;
      padding: 8px 10px;
      border-radius: 10px;
      outline: none;
      width: 100%;
      font-size: 13px;
    }

    .btn {
      background: rgba(59,130,246,0.20);
      border: 1px solid rgba(59,130,246,0.42);
      color: rgba(219,234,254,0.95);
      padding: 10px 12px;
      border-radius: 14px;
      font-weight: 750;
      font-size: 13px;
      cursor: pointer;
      box-shadow: 0 10px 22px rgba(0,0,0,0.22);
      transition: transform .08s ease, filter .08s ease;
      text-decoration: none;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
    }
    .btn:hover { filter: brightness(1.08); }
    .btn:active { transform: translateY(1px); }

    .btn-secondary {
      background: rgba(255,255,255,0.06);
      border: 1px solid rgba(255,255,255,0.10);
      color: rgba(255,255,255,0.88);
    }

    .pill {
      font-size: 11px;
      background: rgba(59,130,246,0.18);
      border: 1px solid rgba(59,130,246,0.35);
      color: rgba(219,234,254,0.92);
      padding: 6px 10px;
      border-radius: 999px;
      white-space: nowrap;
    }

    .error {
      display: none;
      margin-top: 10px;
      background: rgba(239,68,68,0.15);
      border: 1px solid rgba(239,68,68,0.35);
      color: rgba(254,226,226,0.92);
      padding: 10px 12px;
      border-radius: 14px;
      font-size: 12px;
      white-space: pre-wrap;
    }

    .grid { display: grid; grid-template-columns: 1fr; gap: 14px; margin-top: 14px; }
    .row-1, .row-2, .row-3 { display: grid; gap: 14px; }
    .row-1 { grid-template-columns: repeat(3, minmax(0, 1fr)); }
    .row-2 { grid-template-columns: repeat(2, minmax(0, 1fr)); }
    .row-3 { grid-template-columns: repeat(3, minmax(0, 1fr)); }

    @media (max-width: 1100px) {
      .row-1 { grid-template-columns: repeat(2, minmax(0, 1fr)); }
      .row-3 { grid-template-columns: repeat(2, minmax(0, 1fr)); }
    }
    @media (max-width: 640px) {
      .row-1, .row-2, .row-3 { grid-template-columns: 1fr; }
      .filter { min-width: 100%; }
    }

    .card {
      background: rgba(255,255,255,0.04);
      border: 1px solid rgba(255,255,255,0.08);
      border-radius: 18px;
      padding: 14px;
      box-shadow: 0 10px 24px rgba(0,0,0,0.24);
      position: relative;
      overflow: hidden;
    }

    .card::before {
      content: "";
      position: absolute;
      inset: -1px;
      background: radial-gradient(650px 140px at 15% 0%, rgba(59,130,246,0.18), transparent 65%),
                  radial-gradient(550px 160px at 85% 0%, rgba(236,72,153,0.14), transparent 60%);
      pointer-events: none;
    }
    .card > * { position: relative; }

    .card-header {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      gap: 10px;
      margin-bottom: 10px;
      flex-wrap: wrap;
    }

    .card-title { font-weight: 750; font-size: 14px; letter-spacing: 0.2px; }
    .card-subtitle { font-size: 12px; color: rgba(255,255,255,0.65); margin-top: 3px; line-height: 1.25; }

    .kpis { display: grid; grid-template-columns: repeat(3, minmax(0, 1fr)); gap: 10px; margin-top: 6px; }
    .kpi { background: rgba(0,0,0,0.22); border: 1px solid rgba(255,255,255,0.08); border-radius: 14px; padding: 10px 10px 9px; }
    .kpi .label { font-size: 11px; color: rgba(255,255,255,0.65); }
    .kpi .value { font-size: 20px; font-weight: 800; margin-top: 2px; letter-spacing: 0.2px; }
    .kpi .sub { font-size: 11px; color: rgba(255,255,255,0.65); margin-top: 2px; line-height: 1.25; }

    .metric-row { display: grid; grid-template-columns: repeat(2, minmax(0, 1fr)); gap: 10px; }
    .metric { background: rgba(0,0,0,0.22); border: 1px solid rgba(255,255,255,0.08); border-radius: 14px; padding: 10px; }
    .metric-label { font-size: 11px; color: rgba(255,255,255,0.65); }
    .metric-value { font-size: 18px; font-weight: 800; margin-top: 2px; }
    .metric-sub { font-size: 11px; color: rgba(255,255,255,0.62); margin-top: 2px; line-height: 1.25; }

    .list { display: grid; gap: 8px; margin-top: 10px; }
    .list-item { background: rgba(0,0,0,0.22); border: 1px solid rgba(255,255,255,0.08); border-radius: 14px; padding: 10px; }
    .list-title {
      font-weight: 700;
      font-size: 12px;
      color: rgba(255,255,255,0.92);
      display: flex;
      justify-content: space-between;
      gap: 10px;
      align-items: baseline;
    }
    .badge {
      font-size: 11px;
      color: rgba(255,255,255,0.70);
      background: rgba(255,255,255,0.06);
      border: 1px solid rgba(255,255,255,0.08);
      padding: 4px 8px;
      border-radius: 999px;
      white-space: nowrap;
    }
    .list-notes { font-size: 12px; color: rgba(255,255,255,0.75); margin-top: 6px; white-space: pre-wrap; line-height: 1.25; }
    .empty-text { padding: 8px 2px; font-size: 12px; color: rgba(255,255,255,0.65); }

    /* Photos */
    .photos-grid {
      display: grid;
      grid-template-columns: repeat(4, minmax(0, 1fr));
      gap: 10px;
      margin-top: 10px;
    }
    @media (max-width: 1100px) { .photos-grid { grid-template-columns: repeat(3, minmax(0, 1fr)); } }
    @media (max-width: 640px)  { .photos-grid { grid-template-columns: repeat(2, minmax(0, 1fr)); } }

    .photo-card {
      border-radius: 16px;
      overflow: hidden;
      border: 1px solid rgba(255,255,255,0.10);
      background: rgba(0,0,0,0.20);
      box-shadow: 0 10px 18px rgba(0,0,0,0.20);
      cursor: pointer;
    }
    .photo-card img {
      width: 100%;
      height: 150px;
      object-fit: cover;
      display: block;
    }
    .photo-card-caption {
      padding: 8px 10px 10px;
      font-size: 11px;
      color: rgba(255,255,255,0.70);
      line-height: 1.25;
    }

    /* Photo modal */
    .modal {
      display: none;
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.70);
      z-index: 60;
      padding: 16px;
    }
    .modal.open { display: grid; place-items: center; }
    .modal-card {
      width: min(1100px, 96vw);
      background: rgba(255,255,255,0.05);
      border: 1px solid rgba(255,255,255,0.10);
      border-radius: 18px;
      overflow: hidden;
      box-shadow: 0 20px 60px rgba(0,0,0,0.45);
    }
    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 10px 12px;
      border-bottom: 1px solid rgba(255,255,255,0.10);
      background: rgba(0,0,0,0.20);
      gap: 10px;
    }
    .modal-header .mh-title {
      font-weight: 800;
      font-size: 13px;
      color: rgba(255,255,255,0.92);
      display: flex;
      align-items: center;
      gap: 10px;
      flex-wrap: wrap;
    }
    .close {
      border: 1px solid rgba(255,255,255,0.12);
      background: rgba(0,0,0,0.25);
      color: rgba(255,255,255,0.85);
      border-radius: 12px;
      padding: 8px 10px;
      cursor: pointer;
      font-weight: 800;
    }
    .modal-body { padding: 12px; display: grid; gap: 12px; }
    .modal-body img { width: 100%; border-radius: 14px; border: 1px solid rgba(255,255,255,0.10); }
  </style>
</head>

<body>
  <div class="wrap">
    <div class="topbar">
      <div class="brand">
        <div class="logo">OL</div>
        <div class="titleblock">
          <div class="title">Monthly Dashboard</div>
          <div class="subtitle">Month view. Filter by site.</div>
        </div>
      </div>

      <div class="filters">
        <a class="btn btn-secondary" href="./index.html">Home</a>

        <button class="btn btn-secondary" id="prevMonthBtn">◀</button>
        <div class="pill" id="monthLabel">Month</div>
        <button class="btn btn-secondary" id="nextMonthBtn">▶</button>
        <button class="btn" id="latestMonthBtn">Latest</button>

        <a class="btn" href="./monthly-finance-admin.html">Finance Admin</a>

        <div class="filter">
          <label for="siteFilter">Site</label>
          <select id="siteFilter">
            <option value="All">All Sites</option>
            <option value="London">London</option>
            <option value="Newcastle">Newcastle</option>
          </select>
        </div>

        <button class="btn" id="refreshBtn">Refresh</button>
      </div>
    </div>

    <div id="errorMessage" class="error"></div>

    <div class="grid">
      <!-- Overview -->
      <div class="row-1">
        <div class="card" style="grid-column: 1 / span 3; padding: 0;">
          <div style="padding: 14px 14px 14px;">
            <div class="card-header" style="margin-bottom: 8px;">
              <div>
                <div class="card-title">Overview</div>
                <div class="card-subtitle">Totals for the selected month & filter.</div>
              </div>
              <div class="pill" id="monthRangePill">Month</div>
            </div>

            <div class="kpis">
              <div class="kpi">
                <div class="label">Total Logs</div>
                <div class="value" id="kpiTotalLogs">0</div>
                <div class="sub">All entries captured</div>
              </div>
              <div class="kpi">
                <div class="label">Staffing Impact</div>
                <div class="value" id="kpiStaffingSum">0</div>
                <div class="sub" id="kpiStaffingSub">Sick • Holiday</div>
              </div>
              <div class="kpi">
                <div class="label">Retail Sales</div>
                <div class="value" id="kpiRetailSales">£0.00</div>
                <div class="sub" id="kpiRetailSub">Transactions • SPH</div>
              </div>
            </div>

            <div style="margin-top: 12px;">
              <button id="generateMonthlySummaryBtn" class="btn">Generate Monthly Summary</button>

              <div id="monthlySummaryBox" style="display:none; margin-top:12px;" class="list-item">
                <div class="list-title">AI Monthly Summary</div>
                <div id="monthlySummaryText" class="list-notes" style="margin-top:8px;"></div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Finance -->
      <div class="row-2">
        <div class="card" style="grid-column: 1 / span 2;">
          <div class="card-header">
            <div>
              <div class="card-title">Finance Snapshot (Budget vs Actual)</div>
              <div class="card-subtitle">Uses monthly_finance_summary. GP% displayed as entered.</div>
            </div>
            <div class="pill" id="financePill">Finance</div>
          </div>

          <div id="financeEmpty" class="empty-text">
            No finance row found for this month/site yet. Click “Finance Admin” (top right) to create one.
          </div>

          <div id="financeGrid" class="metric-row" style="grid-template-columns: repeat(3, minmax(0, 1fr)); display:none;">
            <div class="metric">
              <div class="metric-label">Total Sales (£)</div>
              <div class="metric-value" id="finSalesActual">£0.00</div>
              <div class="metric-sub">Budget: <span id="finSalesBudget">£0.00</span> • Var: <span id="finSalesVar">£0.00</span></div>
            </div>
            <div class="metric">
              <div class="metric-label">Labour (£) (Core + Agency)</div>
              <div class="metric-value" id="finLabourActual">£0.00</div>
              <div class="metric-sub">Budget: <span id="finLabourBudget">£0.00</span> • Var: <span id="finLabourVar">£0.00</span></div>
            </div>
            <div class="metric">
              <div class="metric-label">GP %</div>
              <div class="metric-value" id="finGpActual">0%</div>
              <div class="metric-sub">Budget: <span id="finGpBudget">0%</span></div>
            </div>

            <div class="metric">
              <div class="metric-label">Retail Sales (£)</div>
              <div class="metric-value" id="finRetailActual">£0.00</div>
              <div class="metric-sub">Budget: <span id="finRetailBudget">£0.00</span> • Var: <span id="finRetailVar">£0.00</span></div>
            </div>
            <div class="metric">
              <div class="metric-label">Hospitality Sales (£)</div>
              <div class="metric-value" id="finHospActual">£0.00</div>
              <div class="metric-sub">Budget: <span id="finHospBudget">£0.00</span> • Var: <span id="finHospVar">£0.00</span></div>
            </div>
            <div class="metric">
              <div class="metric-label">Free Issue (£)</div>
              <div class="metric-value" id="finFreeActual">£0.00</div>
              <div class="metric-sub">Budget: <span id="finFreeBudget">£0.00</span> • Var: <span id="finFreeVar">£0.00</span></div>
            </div>
          </div>

          <div id="financeNotesBox" class="list-item" style="display:none; margin-top:10px;">
            <div class="list-title">
              <span>Finance Notes</span>
              <span class="badge">From Finance Admin</span>
            </div>
            <div id="financeNotesText" class="list-notes" style="margin-top:8px;"></div>
          </div>

          <div class="metric-sub" style="margin-top:10px;">
            If Site = All, finance is displayed as a per-site list (London + Newcastle) rather than a combined total.
          </div>

          <div id="financeAllSitesList" class="list" style="display:none;"></div>
        </div>
      </div>

      <!-- Staffing + incidents -->
      <div class="row-3">
        <div class="card">
          <div class="card-header">
            <div>
              <div class="card-title">Staffing Summary</div>
              <div class="card-subtitle">Totals for the month.</div>
            </div>
          </div>
          <div class="metric-row" style="grid-template-columns: repeat(2, 1fr);">
            <div class="metric"><div class="metric-label">Sickness</div><div class="metric-value" id="staffSick">0</div></div>
            <div class="metric"><div class="metric-label">Holiday</div><div class="metric-value" id="staffHol">0</div></div>
          </div>

          <div class="list" style="margin-top:10px; grid-template-columns: 1fr;">
            <div class="list-item">
              <div class="list-title"><span>Sickness breakdown</span><span class="badge">Names from daily logs</span></div>
              <div id="staffSickBreakdown" class="list-notes" style="margin-top:8px;">—</div>
            </div>
            <div class="list-item">
              <div class="list-title"><span>Holiday breakdown</span><span class="badge">Names from daily logs</span></div>
              <div id="staffHolBreakdown" class="list-notes" style="margin-top:8px;">—</div>
            </div>
          </div>
        </div>

        <div class="card">
          <div class="card-header">
            <div>
              <div class="card-title">Maintenance Incidents</div>
              <div class="card-subtitle">Only items with incidents show.</div>
            </div>
          </div>
          <div id="maintEmpty" class="empty-text">No maintenance incidents.</div>
          <div id="maintList" class="list"></div>
        </div>

        <div class="card">
          <div class="card-header">
            <div>
              <div class="card-title">H&amp;S Incidents</div>
              <div class="card-subtitle">Only items with incidents show.</div>
            </div>
          </div>
          <div id="hsEmpty" class="empty-text">No H&amp;S incidents.</div>
          <div id="hsList" class="list"></div>
        </div>
      </div>

      <!-- Retail + Photos -->
      <div class="row-2">
        <div class="card">
          <div class="card-header">
            <div>
              <div class="card-title">Retail Sales (Monthly)</div>
              <div class="card-subtitle">Totals by level for the month (from retail_sales).</div>
            </div>
          </div>

          <div class="metric-row" style="grid-template-columns: 1fr;">
            <div class="metric">
              <div class="metric-label">Total</div>
              <div class="metric-value" id="retailTotal">£0.00</div>
              <div class="metric-sub" id="retailSub">0 tx • SPH £0.00</div>
              <div class="metric-sub" id="retailBreakdown" style="margin-top:6px;">L7 £0 • L5 £0 • L4 £0 • L3 £0</div>
            </div>
          </div>

          <div class="chart-wrap" style="margin-top:10px;">
            <div class="chart-head" style="display:flex; justify-content:space-between; align-items:baseline; gap:10px; flex-wrap:wrap;">
              <div class="left" id="monthlyRetailChartLabel" style="font-size:12px; color: rgba(255,255,255,0.75);">Weekly totals within the month (stacked by level)</div>
              <div class="right" id="monthlyRetailChartAvgLabel" style="font-size:12px; color: rgba(255,255,255,0.65);">Avg/week: £0.00</div>
            </div>
            <canvas id="monthlyRetailSalesChart" width="900" height="320" style="width:100%; height:260px; border-radius:16px; margin-top:10px; background: rgba(0,0,0,0.18); border: 1px solid rgba(255,255,255,0.08);"></canvas>
            <div class="legend" id="monthlyRetailChartLegend" style="display:flex; gap:12px; flex-wrap:wrap; margin-top:10px; font-size:12px; color: rgba(255,255,255,0.7);">
              <span class="key"><span class="swatch" data-swatch="lvl7"></span>Level 7</span>
              <span class="key"><span class="swatch" data-swatch="lvl5"></span>Level 5</span>
              <span class="key"><span class="swatch" data-swatch="lvl4"></span>Level 4</span>
              <span class="key"><span class="swatch" data-swatch="lvl3"></span>Level 3</span>
              <span class="key"><span class="swatch" data-swatch="avg"></span>Avg line</span>
            </div>
          </div>

          <div id="retailLevelsList" class="list"></div>
        </div>

        <div class="card">
          <div class="card-header">
            <div>
              <div class="card-title">Photo Gallery</div>
              <div class="card-subtitle">All photos uploaded within the selected month.</div>
            </div>
          </div>
          <div id="photosEmpty" class="empty-text">No photos uploaded this month.</div>
          <div id="photosGrid" class="photos-grid"></div>
        </div>
      </div>
    </div>
  </div>

  <!-- Photo modal -->
  <div class="modal" id="photoModal">
    <div class="modal-card">
      <div class="modal-header">
        <div class="mh-title" id="photoModalTitle">Photo</div>
        <button class="close" id="closePhotoModalBtn">Close</button>
      </div>
      <div class="modal-body">
        <img id="photoModalImg" alt="Photo" />
        <div class="metric-sub" id="photoModalMeta"></div>
      </div>
    </div>
  </div>

  <script type="module">
    import { supabase } from './supabase-config.js';

    const errorMessageEl = document.getElementById('errorMessage');

    const prevMonthBtn = document.getElementById('prevMonthBtn');
    const nextMonthBtn = document.getElementById('nextMonthBtn');
    const latestMonthBtn = document.getElementById('latestMonthBtn');
    const refreshBtn = document.getElementById('refreshBtn');

    const monthLabelEl = document.getElementById('monthLabel');
    const monthRangePillEl = document.getElementById('monthRangePill');
    const siteFilterEl = document.getElementById('siteFilter');

    const kpiTotalLogsEl = document.getElementById('kpiTotalLogs');
    const kpiStaffingSumEl = document.getElementById('kpiStaffingSum');
    const kpiStaffingSubEl = document.getElementById('kpiStaffingSub');
    const kpiRetailSalesEl = document.getElementById('kpiRetailSales');
    const kpiRetailSubEl = document.getElementById('kpiRetailSub');

    // Monthly summary (AI-style template)
    const monthlySummaryBtn = document.getElementById('generateMonthlySummaryBtn');
    const monthlySummaryBox = document.getElementById('monthlySummaryBox');
    const monthlySummaryText = document.getElementById('monthlySummaryText');

    const staffSickEl = document.getElementById('staffSick');
    const staffHolEl = document.getElementById('staffHol');
    const staffSickBreakdownEl = document.getElementById('staffSickBreakdown');
    const staffHolBreakdownEl = document.getElementById('staffHolBreakdown');

    const maintEmptyEl = document.getElementById('maintEmpty');
    const maintListEl = document.getElementById('maintList');
    const hsEmptyEl = document.getElementById('hsEmpty');
    const hsListEl = document.getElementById('hsList');

    const retailTotalEl = document.getElementById('retailTotal');
    const retailSubEl = document.getElementById('retailSub');
    const retailBreakdownEl = document.getElementById('retailBreakdown');
    const retailLevelsListEl = document.getElementById('retailLevelsList');

    const monthlyRetailSalesChartEl = document.getElementById('monthlyRetailSalesChart');
    const monthlyRetailChartAvgLabelEl = document.getElementById('monthlyRetailChartAvgLabel');

    // Monthly retail chart (weekly totals within month)
    const monthlyRetailChartEl = document.getElementById('monthlyRetailSalesChart');
    const monthlyRetailChartAvgLabelEl = document.getElementById('monthlyRetailChartAvgLabel');

    const photosEmptyEl = document.getElementById('photosEmpty');
    const photosGridEl = document.getElementById('photosGrid');

    const photoModalEl = document.getElementById('photoModal');
    const photoModalImgEl = document.getElementById('photoModalImg');
    const photoModalMetaEl = document.getElementById('photoModalMeta');
    const closePhotoModalBtn = document.getElementById('closePhotoModalBtn');

    // Finance UI
    const financePillEl = document.getElementById('financePill');
    const financeEmptyEl = document.getElementById('financeEmpty');
    const financeGridEl = document.getElementById('financeGrid');
    const financeAllSitesListEl = document.getElementById('financeAllSitesList');
    const financeNotesBoxEl = document.getElementById('financeNotesBox');
    const financeNotesTextEl = document.getElementById('financeNotesText');

    const finSalesActualEl = document.getElementById('finSalesActual');
    const finSalesBudgetEl = document.getElementById('finSalesBudget');
    const finSalesVarEl = document.getElementById('finSalesVar');

    const finLabourActualEl = document.getElementById('finLabourActual');
    const finLabourBudgetEl = document.getElementById('finLabourBudget');
    const finLabourVarEl = document.getElementById('finLabourVar');

    const finGpActualEl = document.getElementById('finGpActual');
    const finGpBudgetEl = document.getElementById('finGpBudget');

    const finRetailActualEl = document.getElementById('finRetailActual');
    const finRetailBudgetEl = document.getElementById('finRetailBudget');
    const finRetailVarEl = document.getElementById('finRetailVar');

    const finHospActualEl = document.getElementById('finHospActual');
    const finHospBudgetEl = document.getElementById('finHospBudget');
    const finHospVarEl = document.getElementById('finHospVar');

    const finFreeActualEl = document.getElementById('finFreeActual');
    const finFreeBudgetEl = document.getElementById('finFreeBudget');
    const finFreeVarEl = document.getElementById('finFreeVar');

    let currentMonthOffset = 0;
    let lastOpsRows = [];
    let lastRetailRes = { totals: null, rows: [] };
    let lastFinanceRes = null;
    let lastSiteFilter = 'All';
    let lastMonthRangeText = '';
    let lastMonthLabelText = '';

    function safeNum(v) {
      const n = Number(v);
      return Number.isFinite(n) ? n : 0;
    }

    function safeText(v) { return (v ?? '').toString().trim(); }
    function hasText(v) { return safeText(v).length > 0; }

    function money(n) { return `£${Number(n || 0).toFixed(2)}`; }
    function pct(n) { return `${Number(n || 0).toFixed(1)}%`; }

    function isIncidentFlagTrue(v) {
      const t = safeText(v).toLowerCase();
      return t === 'yes' || t === 'true' || t === '1';
    }

    function toISODate(d) {
      const yyyy = d.getFullYear();
      const mm = String(d.getMonth() + 1).padStart(2, '0');
      const dd = String(d.getDate()).padStart(2, '0');
      return `${yyyy}-${mm}-${dd}`;
    }

    function startOfMonth(d) {
      const x = new Date(d);
      x.setDate(1);
      x.setHours(0,0,0,0);
      return x;
    }

    function endOfMonth(d) {
      const x = new Date(d);
      x.setMonth(x.getMonth() + 1);
      x.setDate(0);
      x.setHours(0,0,0,0);
      return x;
    }

    function monthLabelFromDate(d) {
      const fmt = new Intl.DateTimeFormat('en-GB', { month: 'long', year: 'numeric' });
      return fmt.format(d);
    }

    function calcSPH(sales, tx) {
      const s = safeNum(sales);
      const t = safeNum(tx);
      return t > 0 ? s / t : 0;
    }

    // --- Retail chart helpers (mirrors weekly dashboard style) ---
    const CHART_COLORS = {
      grid: 'rgba(255,255,255,0.10)',
      textMain: 'rgba(255,255,255,0.92)',
      textSub: 'rgba(255,255,255,0.68)',
      labelSoft: 'rgba(255,255,255,0.55)',

      lvl7Fill: 'rgba(59,130,246,0.35)',
      lvl7Stroke: 'rgba(59,130,246,0.65)',
      lvl5Fill: 'rgba(236,72,153,0.25)',
      lvl5Stroke: 'rgba(236,72,153,0.55)',
      lvl4Fill: 'rgba(16,185,129,0.22)',
      lvl4Stroke: 'rgba(16,185,129,0.50)',
      lvl3Fill: 'rgba(250,204,21,0.22)',
      lvl3Stroke: 'rgba(250,204,21,0.50)',

      avgLine: 'rgba(255,255,255,0.55)'
    };

    function startOfWeekMonday(d) {
      const x = new Date(d);
      const day = x.getDay(); // 0=Sun
      const diff = (day === 0 ? -6 : 1) - day;
      x.setDate(x.getDate() + diff);
      x.setHours(0,0,0,0);
      return x;
    }

    function scaleCanvasToDisplaySize(canvas) {
      const rect = canvas.getBoundingClientRect();
      const dpr = Math.max(1, window.devicePixelRatio || 1);
      const width = Math.floor(rect.width * dpr);
      const height = Math.floor(rect.height * dpr);
      if (canvas.width !== width || canvas.height !== height) {
        canvas.width = width;
        canvas.height = height;
        return true;
      }
      return false;
    }

    function drawRetailStackedChart(labels, totalsByLevel, grandTotals, avg, rangeText) {
      if (!monthlyRetailSalesChartEl) return;

      scaleCanvasToDisplaySize(monthlyRetailSalesChartEl);
      const ctx = monthlyRetailSalesChartEl.getContext('2d');
      const w = monthlyRetailSalesChartEl.width;
      const h = monthlyRetailSalesChartEl.height;

      ctx.clearRect(0, 0, w, h);

      const padL = Math.floor(w * 0.06);
      const padR = Math.floor(w * 0.03);
      const padT = Math.floor(h * 0.10);
      const padB = Math.floor(h * 0.22);

      const plotW = w - padL - padR;
      const plotH = h - padT - padB;

      const maxV = Math.max(1, ...(grandTotals || [0]), avg || 0);
      const yMax = maxV * 1.15;

      function yFor(v) {
        return padT + (plotH - (v / yMax) * plotH);
      }

      ctx.strokeStyle = CHART_COLORS.grid;
      ctx.lineWidth = 1;
      const gridCount = 4;
      for (let i = 0; i <= gridCount; i++) {
        const y = padT + (plotH / gridCount) * i;
        ctx.beginPath();
        ctx.moveTo(padL, y);
        ctx.lineTo(padL + plotW, y);
        ctx.stroke();
      }

      const n = labels.length;
      if (n === 0) return;

      const gap = Math.floor(plotW * 0.03);
      const barW = Math.floor((plotW - gap * (n - 1)) / n);

      const lvl7 = totalsByLevel['Level 7'] || new Array(n).fill(0);
      const lvl5 = totalsByLevel['Level 5'] || new Array(n).fill(0);
      const lvl4 = totalsByLevel['Level 4'] || new Array(n).fill(0);
      const lvl3 = totalsByLevel['Level 3'] || new Array(n).fill(0);

      for (let i = 0; i < n; i++) {
        const x = padL + i * (barW + gap);

        const v7 = lvl7[i] || 0;
        const v5 = lvl5[i] || 0;
        const v4 = lvl4[i] || 0;
        const v3 = lvl3[i] || 0;
        const total = v7 + v5 + v4 + v3;

        let yBottom = padT + plotH;

        function drawSeg(val, fill, stroke) {
          if (val <= 0) return;
          const segH = (val / yMax) * plotH;
          const yTop = yBottom - segH;
          ctx.fillStyle = fill;
          ctx.fillRect(x, yTop, barW, segH);
          ctx.strokeStyle = stroke;
          ctx.strokeRect(x + 0.5, yTop + 0.5, barW - 1, Math.max(0, segH - 1));
          yBottom = yTop;
        }

        drawSeg(v3, CHART_COLORS.lvl3Fill, CHART_COLORS.lvl3Stroke);
        drawSeg(v4, CHART_COLORS.lvl4Fill, CHART_COLORS.lvl4Stroke);
        drawSeg(v5, CHART_COLORS.lvl5Fill, CHART_COLORS.lvl5Stroke);
        drawSeg(v7, CHART_COLORS.lvl7Fill, CHART_COLORS.lvl7Stroke);

        const yTopOfBar = yFor(total);
        ctx.fillStyle = CHART_COLORS.textMain;
        ctx.font = `${Math.floor(h * 0.055)}px system-ui, -apple-system, Segoe UI, sans-serif`;
        ctx.textAlign = 'center';
        ctx.textBaseline = 'bottom';
        ctx.fillText(`£${Math.round(total)}`, x + barW / 2, yTopOfBar - 6);

        ctx.fillStyle = CHART_COLORS.textSub;
        ctx.font = `${Math.floor(h * 0.05)}px system-ui, -apple-system, Segoe UI, sans-serif`;
        ctx.textBaseline = 'top';
        ctx.fillText(labels[i] || '', x + barW / 2, padT + plotH + 10);
      }

      const yAvg = yFor(avg || 0);
      ctx.strokeStyle = CHART_COLORS.avgLine;
      ctx.lineWidth = 2;
      ctx.beginPath();
      ctx.moveTo(padL, yAvg);
      ctx.lineTo(padL + plotW, yAvg);
      ctx.stroke();

      ctx.fillStyle = CHART_COLORS.avgLine;
      ctx.font = `${Math.floor(h * 0.05)}px system-ui, -apple-system, Segoe UI, sans-serif`;
      ctx.textAlign = 'left';
      ctx.textBaseline = 'bottom';
      ctx.fillText(`Avg ${money(avg || 0)}`, padL + 6, yAvg - 6);

      if (rangeText) {
        ctx.fillStyle = CHART_COLORS.labelSoft;
        ctx.font = `${Math.floor(h * 0.045)}px system-ui, -apple-system, Segoe UI, sans-serif`;
        ctx.textAlign = 'right';
        ctx.textBaseline = 'top';
        ctx.fillText(rangeText, padL + plotW, 8);
      }
    }

    function computeMonthlyRetailWeeklyChart(rows, startStr, endStr) {
      // Groups daily retail_sales rows by WC Monday within the selected month
      const byWeek = new Map();

      (rows || []).forEach(r => {
        const dStr = (r.sales_date || '').toString().slice(0, 10);
        if (!dStr) return;
        if (dStr < startStr || dStr > endStr) return;
        const d = new Date(dStr + 'T00:00:00');
        const wk = toISODate(startOfWeekMonday(d));
        if (!byWeek.has(wk)) {
          byWeek.set(wk, {
            'Level 7': 0,
            'Level 5': 0,
            'Level 4': 0,
            'Level 3': 0
          });
        }
        const lvl = (r.level || '').toString();
        if (!byWeek.get(wk)[lvl] && byWeek.get(wk)[lvl] !== 0) return;
        byWeek.get(wk)[lvl] += safeNum(r.sales);
      });

      const weekKeys = Array.from(byWeek.keys()).sort();
      const labels = weekKeys.map(wk => {
        const d = new Date(wk + 'T00:00:00');
        const dd = String(d.getDate()).padStart(2, '0');
        const mon = new Intl.DateTimeFormat('en-GB', { month: 'short' }).format(d);
        return `WC ${dd} ${mon}`;
      });

      const totalsByLevel = {
        'Level 7': weekKeys.map(wk => byWeek.get(wk)['Level 7'] || 0),
        'Level 5': weekKeys.map(wk => byWeek.get(wk)['Level 5'] || 0),
        'Level 4': weekKeys.map(wk => byWeek.get(wk)['Level 4'] || 0),
        'Level 3': weekKeys.map(wk => byWeek.get(wk)['Level 3'] || 0)
      };

      const grandTotals = weekKeys.map((_, i) =>
        totalsByLevel['Level 7'][i] +
        totalsByLevel['Level 5'][i] +
        totalsByLevel['Level 4'][i] +
        totalsByLevel['Level 3'][i]
      );

      const avg = grandTotals.length ? (grandTotals.reduce((s,v) => s + v, 0) / grandTotals.length) : 0;
      return { labels, totalsByLevel, grandTotals, avg };
    }

    function renderList(containerEl, emptyEl, items) {
      containerEl.innerHTML = '';
      if (!items || items.length === 0) {
        emptyEl.style.display = 'block';
        return { mode: 'all', rows: data || [] };
      }
      emptyEl.style.display = 'none';

      items.forEach(it => {
        const div = document.createElement('div');
        div.className = 'list-item';
        div.innerHTML = `
          <div class="list-title">
            <span>${it.title}</span>
            ${it.badge ? `<span class="badge">${it.badge}</span>` : ``}
          </div>
          <div class="list-notes">${(it.notes || '').replace(/</g, '&lt;')}</div>
        `;
        containerEl.appendChild(div);
      });
    }

    function parseNamesFromNotes(text) {
      // Accept comma/semicolon/newline separated values.
      const raw = safeText(text);
      if (!raw) return [];
      return raw
        .split(/\n|,|;|\u2022|\-|\t/)
        .map(s => s.trim())
        .filter(Boolean)
        .map(s => s.replace(/\s{2,}/g, ' '));
    }

    function buildBreakdownText(map) {
      const entries = Array.from(map.entries()).sort((a,b) => b[1] - a[1]);
      if (!entries.length) return '—';
      return entries
        .slice(0, 20)
        .map(([name, count]) => `${name} — ${count} day(s)`)
        .join('\n');
    }

    function clearUI() {
      errorMessageEl.style.display = 'none';
      errorMessageEl.textContent = '';

      kpiTotalLogsEl.textContent = '0';
      kpiStaffingSumEl.textContent = '0';
      kpiStaffingSubEl.textContent = 'Sick • Holiday';
      kpiRetailSalesEl.textContent = '£0.00';
      kpiRetailSubEl.textContent = 'Transactions • SPH';

      staffSickEl.textContent = '0';
      staffHolEl.textContent = '0';
      staffSickBreakdownEl.textContent = '—';
      staffHolBreakdownEl.textContent = '—';

      monthlySummaryBox.style.display = 'none';
      monthlySummaryText.textContent = '';

      maintListEl.innerHTML = '';
      hsListEl.innerHTML = '';
      maintEmptyEl.style.display = 'block';
      hsEmptyEl.style.display = 'block';

      retailTotalEl.textContent = '£0.00';
      retailSubEl.textContent = '0 tx • SPH £0.00';
      retailBreakdownEl.textContent = 'L7 £0 • L5 £0 • L4 £0 • L3 £0';
      retailLevelsListEl.innerHTML = '';

      monthlyRetailChartAvgLabelEl.textContent = 'Avg/week: £0.00';
      try {
        if (monthlyRetailSalesChartEl) {
          const ctx = monthlyRetailSalesChartEl.getContext('2d');
          ctx && ctx.clearRect(0, 0, monthlyRetailSalesChartEl.width, monthlyRetailSalesChartEl.height);
        }
      } catch { /* no-op */ }

      photosGridEl.innerHTML = '';
      photosEmptyEl.style.display = 'block';

      financePillEl.textContent = 'Finance';
      financeEmptyEl.style.display = 'block';
      financeGridEl.style.display = 'none';
      financeNotesBoxEl.style.display = 'none';
      financeNotesTextEl.textContent = '';
      financeAllSitesListEl.style.display = 'none';
      financeAllSitesListEl.innerHTML = '';
    }

    async function loadMonthlyFinance(monthStartStr, site) {
      if (site === 'All') {
        const { data, error } = await supabase
          .from('monthly_finance_summary')
          .select('*')
          .eq('month_start', monthStartStr)
          .order('site', { ascending: true });

        if (error) throw error;

        financePillEl.textContent = `Finance • ${monthStartStr}`;
        financeEmptyEl.style.display = (data && data.length) ? 'none' : 'block';
        financeGridEl.style.display = 'none';
        financeNotesBoxEl.style.display = 'none';
        financeNotesTextEl.textContent = '';

        financeAllSitesListEl.style.display = (data && data.length) ? 'grid' : 'none';
        financeAllSitesListEl.innerHTML = '';

        if (data && data.length) {
          const items = data.map(r => {
            const budgetSales = safeNum(r.budget_retail_sales) + safeNum(r.budget_hospitality_sales);
            const actualSales = safeNum(r.actual_retail_sales) + safeNum(r.actual_hospitality_sales);
            const budgetLab  = safeNum(r.budget_core_wages) + safeNum(r.budget_agency_spend);
            const actualLab  = safeNum(r.actual_core_wages) + safeNum(r.actual_agency_spend);

            return {
              title: `${r.site} • ${monthStartStr}`,
              badge: `GP ${pct(r.actual_gp_pct)} (Bgt ${pct(r.budget_gp_pct)})`,
              notes:
                `Total Sales: ${money(actualSales)} (Bgt ${money(budgetSales)})\n` +
                `Retail: ${money(r.actual_retail_sales)} (Bgt ${money(r.budget_retail_sales)})\n` +
                `Hospitality: ${money(r.actual_hospitality_sales)} (Bgt ${money(r.budget_hospitality_sales)})\n` +
                `Free Issue: ${money(r.actual_free_issue)} (Bgt ${money(r.budget_free_issue)})\n` +
                `Labour: ${money(actualLab)} (Bgt ${money(budgetLab)})` +
                (hasText(r.notes) ? `\n\nNotes: ${safeText(r.notes)}` : '')
            };
          });

          const dummyEmpty = document.createElement('div');
          renderList(financeAllSitesListEl, dummyEmpty, items);
        }

        return { mode: 'site', row: null };
      }

      const { data, error } = await supabase
        .from('monthly_finance_summary')
        .select('*')
        .eq('month_start', monthStartStr)
        .eq('site', site)
        .limit(1)
        .maybeSingle();

      if (error) throw error;

      financePillEl.textContent = `Finance • ${site} • ${monthStartStr}`;

      if (!data) {
        financeEmptyEl.style.display = 'block';
        financeGridEl.style.display = 'none';
        financeAllSitesListEl.style.display = 'none';
        return;
      }

      financeEmptyEl.style.display = 'none';
      financeAllSitesListEl.style.display = 'none';
      financeGridEl.style.display = 'grid';

      const budgetSales = safeNum(data.budget_retail_sales) + safeNum(data.budget_hospitality_sales);
      const actualSales = safeNum(data.actual_retail_sales) + safeNum(data.actual_hospitality_sales);

      const budgetLab  = safeNum(data.budget_core_wages) + safeNum(data.budget_agency_spend);
      const actualLab  = safeNum(data.actual_core_wages) + safeNum(data.actual_agency_spend);

      finSalesActualEl.textContent = money(actualSales);
      finSalesBudgetEl.textContent = money(budgetSales);
      finSalesVarEl.textContent = money(actualSales - budgetSales);

      finLabourActualEl.textContent = money(actualLab);
      finLabourBudgetEl.textContent = money(budgetLab);
      finLabourVarEl.textContent = money(actualLab - budgetLab);

      finGpActualEl.textContent = pct(data.actual_gp_pct);
      finGpBudgetEl.textContent = pct(data.budget_gp_pct);

      finRetailActualEl.textContent = money(data.actual_retail_sales);
      finRetailBudgetEl.textContent = money(data.budget_retail_sales);
      finRetailVarEl.textContent = money(safeNum(data.actual_retail_sales) - safeNum(data.budget_retail_sales));

      finHospActualEl.textContent = money(data.actual_hospitality_sales);
      finHospBudgetEl.textContent = money(data.budget_hospitality_sales);
      finHospVarEl.textContent = money(safeNum(data.actual_hospitality_sales) - safeNum(data.budget_hospitality_sales));
      finHospVarEl.textContent = money(safeNum(data.actual_hospitality_sales) - safeNum(data.budget_hospitality_sales));

      finFreeActualEl.textContent = money(data.actual_free_issue);
      finFreeBudgetEl.textContent = money(data.budget_free_issue);
      finFreeVarEl.textContent = money(safeNum(data.actual_free_issue) - safeNum(data.budget_free_issue));
      finFreeVarEl.textContent = money(safeNum(data.actual_free_issue) - safeNum(data.budget_free_issue));
      finFreeVarEl.textContent = money(safeNum(data.actual_free_issue) - safeNum(data.budget_free_issue));

      const notesTxt = safeText(data.notes);
      if (notesTxt) {
        financeNotesTextEl.textContent = notesTxt;
        financeNotesBoxEl.style.display = 'block';
      } else {
        financeNotesTextEl.textContent = '';
        financeNotesBoxEl.style.display = 'none';
      }

      return { mode: 'site', row: data };
    }

    async function loadMonthlyRetailSales(startStr, endStr, site) {
      let q = supabase
        .from('retail_sales')
        .select('*')
        .gte('sales_date', startStr)
        .lte('sales_date', endStr);

      if (site !== 'All') q = q.eq('site', site);

      const { data, error } = await q.order('sales_date', { ascending: true });
      if (error) throw error;

      const totals = {
        allSales: 0, allTrans: 0,
        L7: { sales: 0, trans: 0 },
        L5: { sales: 0, trans: 0 },
        L4: { sales: 0, trans: 0 },
        L3: { sales: 0, trans: 0 },
      };

      (data || []).forEach(r => {
        const lvl = (r.level || '').toString();
        const sales = safeNum(r.sales);
        const tx = safeNum(r.transactions);

        totals.allSales += sales;
        totals.allTrans += tx;

        if (lvl === 'Level 7') { totals.L7.sales += sales; totals.L7.trans += tx; }
        if (lvl === 'Level 5') { totals.L5.sales += sales; totals.L5.trans += tx; }
        if (lvl === 'Level 4') { totals.L4.sales += sales; totals.L4.trans += tx; }
        if (lvl === 'Level 3') { totals.L3.sales += sales; totals.L3.trans += tx; }
      });

      return { totals, rows: data || [] };
    }

    function renderRetailSales(totals) {
      const sph = calcSPH(totals.allSales, totals.allTrans);

      retailTotalEl.textContent = money(totals.allSales);
      retailSubEl.textContent = `${Math.round(totals.allTrans)} tx • SPH ${money(sph)}`;
      retailBreakdownEl.textContent =
        `L7 ${money(totals.L7.sales)} • L5 ${money(totals.L5.sales)} • L4 ${money(totals.L4.sales)} • L3 ${money(totals.L3.sales)}`;

      kpiRetailSalesEl.textContent = money(totals.allSales);
      kpiRetailSubEl.textContent = `${Math.round(totals.allTrans)} tx • SPH ${money(sph)}`;

      retailLevelsListEl.innerHTML = '';
      const levels = [
        { name: 'Level 7', s: totals.L7.sales, t: totals.L7.trans },
        { name: 'Level 5', s: totals.L5.sales, t: totals.L5.trans },
        { name: 'Level 4', s: totals.L4.sales, t: totals.L4.trans },
        { name: 'Level 3', s: totals.L3.sales, t: totals.L3.trans },
      ];

      levels.forEach(l => {
        const div = document.createElement('div');
        div.className = 'list-item';
        div.innerHTML = `
          <div class="list-title">
            <span>${l.name}</span>
            <span class="badge">SPH ${money(calcSPH(l.s, l.t))}</span>
          </div>
          <div class="list-notes">Sales: ${money(l.s)} • Transactions: ${Math.round(l.t)}</div>
        `;
        retailLevelsListEl.appendChild(div);
      });
    }

    function formatWeekLabel(weekStartStr) {
      // weekStartStr is YYYY-MM-DD (Monday)
      const d = new Date(weekStartStr + 'T00:00:00');
      const dd = String(d.getDate()).padStart(2, '0');
      const mmm = d.toLocaleString('en-GB', { month: 'short' });
      return `WC ${dd} ${mmm}`;
    }

    function computeMonthlyWeeklyChartData(retailRows) {
      // Group all rows in the month into week-start buckets (Mon-based), and sum by level.
      const levels = ['Level 7', 'Level 5', 'Level 4', 'Level 3'];
      const weeks = new Map(); // weekStart -> { level -> sales }

      for (const r of (retailRows || [])) {
        const ds = (r.sales_date || '').toString().slice(0, 10);
        if (!ds) continue;
        const d = new Date(ds + 'T00:00:00');
        const wk = toISODate(startOfWeekMonday(d));
        if (!weeks.has(wk)) {
          const obj = {};
          levels.forEach(l => obj[l] = 0);
          weeks.set(wk, obj);
        }
        const lvl = (r.level || '').toString();
        if (!levels.includes(lvl)) continue;
        weeks.get(wk)[lvl] += safeNum(r.sales);
      }

      const weekKeys = Array.from(weeks.keys()).sort();
      const labels = weekKeys.map(formatWeekLabel);

      const dayTotalsByLevel = {
        'Level 7': weekKeys.map(k => weeks.get(k)['Level 7'] || 0),
        'Level 5': weekKeys.map(k => weeks.get(k)['Level 5'] || 0),
        'Level 4': weekKeys.map(k => weeks.get(k)['Level 4'] || 0),
        'Level 3': weekKeys.map(k => weeks.get(k)['Level 3'] || 0)
      };

      const dailyGrand = weekKeys.map((_, i) =>
        (dayTotalsByLevel['Level 7'][i] || 0) +
        (dayTotalsByLevel['Level 5'][i] || 0) +
        (dayTotalsByLevel['Level 4'][i] || 0) +
        (dayTotalsByLevel['Level 3'][i] || 0)
      );

      const avgGrand = dailyGrand.length ? (dailyGrand.reduce((s, v) => s + v, 0) / dailyGrand.length) : 0;

      return { labels, dayTotalsByLevel, dailyGrand, avgGrand, weekCount: weekKeys.length };
    }

    async function loadMonthlyOpsLogs(startStr, endStr, site) {
      let q = supabase
        .from('ops_logs')
        .select('*')
        .or(
          `and(log_date.gte.${startStr},log_date.lte.${endStr}),and(log_date.is.null,created_at.gte.${startStr}T00:00:00Z,created_at.lte.${endStr}T23:59:59Z)`
        )
        .order('log_date', { ascending: true })
        .order('created_at', { ascending: true });

      if (site !== 'All') q = q.eq('site', site);

      const { data, error } = await q;
      if (error) throw error;
      return data || [];
    }

    function renderPhotos(opsRows) {
      const photos = (opsRows || [])
        .filter(r => !!r.photo_url)
        .map(r => {
          const d = (r.log_date || (r.created_at ? String(r.created_at).slice(0,10) : '')).slice(0,10);
          return {
            url: r.photo_url,
            date: d || '—',
            site: r.site || '—',
            area: r.area || '—'
          };
        });

      if (!photos.length) {
        photosEmptyEl.style.display = 'block';
        photosGridEl.innerHTML = '';
        return;
      }

      photosEmptyEl.style.display = 'none';
      photos.sort((a,b) => (a.date < b.date ? -1 : 1));

      photosGridEl.innerHTML = photos.map(p => `
        <div class="photo-card" data-url="${p.url}" data-meta="${p.date} • ${p.site} • ${p.area}">
          <img src="${p.url}" alt="Ops photo" />
          <div class="photo-card-caption">${p.date}<br/>${p.site}${p.area ? ' • ' + p.area : ''}</div>
        </div>
      `).join('');

      photosGridEl.querySelectorAll('.photo-card').forEach(el => {
        el.addEventListener('click', () => {
          const url = el.getAttribute('data-url');
          const meta = el.getAttribute('data-meta') || '';
          photoModalImgEl.src = url;
          photoModalMetaEl.textContent = meta;
          photoModalEl.classList.add('open');
        });
      });
    }

    async function loadMonth() {
      clearUI();

      nextMonthBtn.disabled = currentMonthOffset === 0;

      const anchor = new Date();
      const target = new Date(anchor);
      target.setMonth(target.getMonth() + currentMonthOffset);

      const monthStart = startOfMonth(target);
      const monthEnd = endOfMonth(target);

      const startStr = toISODate(monthStart);
      const endStr = toISODate(monthEnd);

      const monthStartStr = toISODate(monthStart);
      const site = siteFilterEl.value;

      monthLabelEl.textContent = monthLabelFromDate(target);
      monthRangePillEl.textContent = `${startStr} → ${endStr}`;

      try {
        const [opsRows, retailRes] = await Promise.all([
          loadMonthlyOpsLogs(startStr, endStr, site),
          loadMonthlyRetailSales(startStr, endStr, site),
        ]);

        kpiTotalLogsEl.textContent = String(opsRows.length);

        const sickTotal = opsRows.reduce((s,r) => s + safeNum(r.sickness_count), 0);
        const holTotal  = opsRows.reduce((s,r) => s + safeNum(r.holiday_count), 0);

        // Name breakdowns (from sickness_notes / holiday_notes)
        const sickMap = new Map();
        const holMap = new Map();

        opsRows.forEach(r => {
          const sCount = safeNum(r.sickness_count);
          const hCount = safeNum(r.holiday_count);

          if (sCount > 0) {
            const names = parseNamesFromNotes(r.sickness_notes);
            if (names.length) {
              names.forEach(n => sickMap.set(n, (sickMap.get(n) || 0) + 1));
            } else {
              sickMap.set('Unspecified', (sickMap.get('Unspecified') || 0) + 1);
            }
          }

          if (hCount > 0) {
            const names = parseNamesFromNotes(r.holiday_notes);
            if (names.length) {
              names.forEach(n => holMap.set(n, (holMap.get(n) || 0) + 1));
            } else {
              holMap.set('Unspecified', (holMap.get('Unspecified') || 0) + 1);
            }
          }
        });

        staffSickEl.textContent = String(sickTotal);
        staffHolEl.textContent  = String(holTotal);

        staffSickBreakdownEl.textContent = buildBreakdownText(sickMap);
        staffHolBreakdownEl.textContent  = buildBreakdownText(holMap);

        kpiStaffingSumEl.textContent = String(sickTotal + holTotal);
        kpiStaffingSubEl.textContent = `Sick: ${sickTotal} • Holiday: ${holTotal}`;

        const maintItems = [];
        const hsItems = [];

        opsRows.forEach(r => {
          const date = (r.log_date || (r.created_at ? String(r.created_at).slice(0,10) : '')).slice(0,10);
          const titleBase = `${r.site || 'Site'} • ${r.area || 'Area'} • ${date || '—'}`;

          if (isIncidentFlagTrue(r.maintenance_issue) || hasText(r.maintenance_notes)) {
            maintItems.push({ title: titleBase, badge: '', notes: safeText(r.maintenance_notes) || '(No notes entered)' });
          }
          if (isIncidentFlagTrue(r.hs_issue) || hasText(r.hs_notes)) {
            hsItems.push({ title: titleBase, badge: '', notes: safeText(r.hs_notes) || '(No notes entered)' });
          }
        });

        renderList(maintListEl, maintEmptyEl, maintItems);
        renderList(hsListEl, hsEmptyEl, hsItems);

        renderRetailSales(retailRes.totals);

        // Sales graph (weekly totals within the month)
        const chartData = computeMonthlyWeeklyChartData(retailRes.rows);
        monthlyRetailChartAvgLabelEl.textContent = `Avg/week: ${money(chartData.avgGrand)}`;
        drawRetailStackedChart(chartData.labels, chartData.dayTotalsByLevel, chartData.dailyGrand, chartData.avgGrand, monthRangePillEl.textContent);
        renderPhotos(opsRows);

        lastFinanceRes = await loadMonthlyFinance(monthStartStr, site);

        // Cache for monthly summary generation
        lastOpsRows = opsRows;
        lastRetailRes = retailRes;
        lastSiteFilter = site;
        lastMonthRangeText = monthRangePillEl.textContent;
        lastMonthLabelText = monthLabelEl.textContent;

      } catch (err) {
        errorMessageEl.style.display = 'block';
        errorMessageEl.textContent = `Error loading monthly dashboard:\n${err?.message || err}`;
      }
    }

    function generateMonthlySummaryText() {
      const opsRows = lastOpsRows || [];
      const photosCount = opsRows.filter(r => !!r.photo_url).length;

      const sickTotal = opsRows.reduce((s,r) => s + safeNum(r.sickness_count), 0);
      const holTotal  = opsRows.reduce((s,r) => s + safeNum(r.holiday_count), 0);

      const maintCount = opsRows.filter(r => isIncidentFlagTrue(r.maintenance_issue) || hasText(r.maintenance_notes)).length;
      const hsCount = opsRows.filter(r => isIncidentFlagTrue(r.hs_issue) || hasText(r.hs_notes)).length;

      const topNotes = opsRows
        .filter(r => hasText(r.notes))
        .slice(-40)
        .map(r => {
          const date = (r.log_date || (r.created_at ? String(r.created_at).slice(0,10) : '')).slice(0,10);
          return `${r.site || 'Site'} — ${r.area || 'Area'} — ${date || '—'}\n  ${safeText(r.notes)}`;
        })
        .slice(-8)
        .reverse();

      const retailTotals = lastRetailRes?.totals || { allSales: 0, allTrans: 0 };
      const retailSPH = calcSPH(retailTotals.allSales, retailTotals.allTrans);

      // Staffing breakdown summaries (top 8)
      const sickMap = new Map();
      const holMap = new Map();
      opsRows.forEach(r => {
        if (safeNum(r.sickness_count) > 0) {
          const names = parseNamesFromNotes(r.sickness_notes);
          (names.length ? names : ['Unspecified']).forEach(n => sickMap.set(n, (sickMap.get(n) || 0) + 1));
        }
        if (safeNum(r.holiday_count) > 0) {
          const names = parseNamesFromNotes(r.holiday_notes);
          (names.length ? names : ['Unspecified']).forEach(n => holMap.set(n, (holMap.get(n) || 0) + 1));
        }
      });

      function topN(map, n) {
        return Array.from(map.entries())
          .sort((a,b) => b[1] - a[1])
          .slice(0, n)
          .map(([name, count]) => `${name} (${count})`)
          .join(', ');
      }

      const lines = [];
      lines.push('Monthly Ops Summary');
      lines.push('---------------------');
      lines.push(`Month: ${lastMonthLabelText || '—'} (${lastMonthRangeText || '—'})`);
      lines.push(`Filter: ${lastSiteFilter || 'All'}`);
      lines.push('');
      lines.push(`Total Logs: ${opsRows.length}`);
      lines.push(`Logs with photos: ${photosCount}`);
      lines.push('');
      lines.push('Staffing Impact');
      lines.push('---------------------');
      lines.push(`• Sick: ${sickTotal}` + (sickTotal ? ` (${topN(sickMap, 8) || '—'})` : ''));
      lines.push(`• Holiday: ${holTotal}` + (holTotal ? ` (${topN(holMap, 8) || '—'})` : ''));
      lines.push('');
      lines.push('Incidents');
      lines.push('---------------------');
      lines.push(`• Maintenance incidents: ${maintCount}`);
      lines.push(`• H&S incidents: ${hsCount}`);
      lines.push('');
      lines.push('Retail');
      lines.push('---------------------');
      lines.push(`• Sales: ${money(retailTotals.allSales)} • Tx: ${Math.round(retailTotals.allTrans || 0)} • SPH: ${money(retailSPH)}`);

      // Finance summary
      lines.push('');
      lines.push('Finance');
      lines.push('---------------------');
      if (!lastFinanceRes) {
        lines.push('• No finance data loaded.');
      } else if (lastFinanceRes.mode === 'all') {
        const rows = lastFinanceRes.rows || [];
        if (!rows.length) {
          lines.push('• No finance rows found for this month.');
        } else {
          rows.forEach(r => {
            const bSales = safeNum(r.budget_retail_sales) + safeNum(r.budget_hospitality_sales);
            const aSales = safeNum(r.actual_retail_sales) + safeNum(r.actual_hospitality_sales);
            const varSales = aSales - bSales;
            lines.push(`• ${r.site}: Sales ${money(aSales)} (Bgt ${money(bSales)} • Var ${money(varSales)}) • GP ${pct(r.actual_gp_pct)}`);
            if (hasText(r.notes)) lines.push(`  Notes: ${safeText(r.notes)}`);
          });
        }
      } else {
        const r = lastFinanceRes.row;
        if (!r) {
          lines.push('• No finance row found for this month/site.');
        } else {
          const bSales = safeNum(r.budget_retail_sales) + safeNum(r.budget_hospitality_sales);
          const aSales = safeNum(r.actual_retail_sales) + safeNum(r.actual_hospitality_sales);
          const bLab = safeNum(r.budget_core_wages) + safeNum(r.budget_agency_spend);
          const aLab = safeNum(r.actual_core_wages) + safeNum(r.actual_agency_spend);
          lines.push(`• Total Sales: ${money(aSales)} (Bgt ${money(bSales)} • Var ${money(aSales - bSales)})`);
          lines.push(`• Labour: ${money(aLab)} (Bgt ${money(bLab)} • Var ${money(aLab - bLab)})`);
          lines.push(`• GP: ${pct(r.actual_gp_pct)} (Bgt ${pct(r.budget_gp_pct)})`);
          if (hasText(r.notes)) lines.push(`• Notes: ${safeText(r.notes)}`);
        }
      }

      if (topNotes.length) {
        lines.push('');
        lines.push('Key Notes');
        lines.push('---------------------');
        topNotes.forEach(n => lines.push(`• ${n}`));
      }

      return lines.join('\n');
    }

    prevMonthBtn.addEventListener('click', () => { currentMonthOffset -= 1; loadMonth(); });
    nextMonthBtn.addEventListener('click', () => { if (currentMonthOffset < 0) { currentMonthOffset += 1; loadMonth(); } });
    latestMonthBtn.addEventListener('click', () => { currentMonthOffset = 0; loadMonth(); });

    refreshBtn.addEventListener('click', loadMonth);
    siteFilterEl.addEventListener('change', loadMonth);

    if (monthlySummaryBtn) {
      monthlySummaryBtn.addEventListener('click', () => {
        const txt = generateMonthlySummaryText();
        monthlySummaryText.style.whiteSpace = 'pre-wrap';
        monthlySummaryText.textContent = txt;
        monthlySummaryBox.style.display = 'block';
      });
    }

    closePhotoModalBtn.addEventListener('click', () => photoModalEl.classList.remove('open'));
    photoModalEl.addEventListener('click', (e) => {
      if (e.target === photoModalEl) photoModalEl.classList.remove('open');
    });

    loadMonth();
  </script>
</body>
</html>
