<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Ops Log • Monthly Dashboard</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    body {
      margin: 0;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: #0b1220;
      color: #f9fafb;
      display: flex;
      align-items: center;
      justify-content: center;
      min-height: 100vh;
    }

    .page { max-width: 1400px; width: 100%; padding: 18px 14px 42px; }

    .topbar {
      display: flex;
      flex-wrap: wrap;
      align-items: center;
      justify-content: space-between;
      gap: 12px;
      margin-bottom: 14px;
    }

    .brand { display: flex; gap: 10px; align-items: center; }

    .logo {
      width: 42px; height: 42px; border-radius: 12px;
      background: linear-gradient(135deg, #1f2a44, #0f172a);
      box-shadow: 0 0 0 1px rgba(255,255,255,0.06) inset, 0 12px 24px rgba(0,0,0,0.25);
      display: grid; place-items: center;
      font-weight: 800; letter-spacing: 0.5px; color: #93c5fd;
    }

    .titleblock .title { font-size: 18px; font-weight: 750; line-height: 1.2; }
    .titleblock .subtitle { font-size: 12px; color: rgba(255,255,255,0.68); margin-top: 2px; }

    .filters { display: flex; gap: 10px; flex-wrap: wrap; align-items: center; justify-content: flex-end; }

    .filter {
      background: rgba(255,255,255,0.05);
      border: 1px solid rgba(255,255,255,0.08);
      padding: 10px 12px;
      border-radius: 14px;
      display: flex;
      align-items: center;
      gap: 10px;
      min-width: 220px;
      box-shadow: 0 8px 18px rgba(0,0,0,0.20);
    }

    .filter label { font-size: 12px; color: rgba(255,255,255,0.72); white-space: nowrap; }

    select {
      background: rgba(0,0,0,0.25);
      border: 1px solid rgba(255,255,255,0.12);
      color: #f9fafb;
      padding: 8px 10px;
      border-radius: 10px;
      outline: none;
      width: 100%;
      font-size: 13px;
    }

    .btn {
      background: rgba(59,130,246,0.20);
      border: 1px solid rgba(59,130,246,0.42);
      color: rgba(219,234,254,0.95);
      padding: 10px 12px;
      border-radius: 14px;
      font-weight: 750;
      font-size: 13px;
      cursor: pointer;
      box-shadow: 0 10px 22px rgba(0,0,0,0.22);
      transition: transform .08s ease, filter .08s ease;
    }
    .btn:hover { filter: brightness(1.08); }
    .btn:active { transform: translateY(1px); }

    .btn-secondary {
      background: rgba(255,255,255,0.06);
      border: 1px solid rgba(255,255,255,0.10);
      color: rgba(255,255,255,0.88);
    }

    .pill {
      font-size: 11px;
      background: rgba(59,130,246,0.18);
      border: 1px solid rgba(59,130,246,0.35);
      color: rgba(219,234,254,0.92);
      padding: 6px 10px;
      border-radius: 999px;
      white-space: nowrap;
    }

    .error {
      display: none;
      margin-top: 10px;
      background: rgba(239,68,68,0.15);
      border: 1px solid rgba(239,68,68,0.35);
      color: rgba(254,226,226,0.92);
      padding: 10px 12px;
      border-radius: 14px;
      font-size: 12px;
      white-space: pre-wrap;
    }

    .grid { display: grid; grid-template-columns: 1fr; gap: 14px; margin-top: 14px; }

    .row-1, .row-2, .row-3 { display: grid; gap: 14px; }
    .row-1 { grid-template-columns: repeat(3, minmax(0, 1fr)); }
    .row-2 { grid-template-columns: repeat(2, minmax(0, 1fr)); }
    .row-3 { grid-template-columns: repeat(3, minmax(0, 1fr)); }

    @media (max-width: 1100px) {
      .row-1 { grid-template-columns: repeat(2, minmax(0, 1fr)); }
      .row-3 { grid-template-columns: repeat(2, minmax(0, 1fr)); }
    }
    @media (max-width: 640px) {
      .row-1, .row-2, .row-3 { grid-template-columns: 1fr; }
      .filter { min-width: 100%; }
    }

    .card {
      background: rgba(255,255,255,0.04);
      border: 1px solid rgba(255,255,255,0.08);
      border-radius: 18px;
      padding: 14px;
      box-shadow: 0 10px 24px rgba(0,0,0,0.24);
      position: relative;
      overflow: hidden;
    }

    .card::before {
      content: "";
      position: absolute;
      inset: -1px;
      background: radial-gradient(650px 140px at 15% 0%, rgba(59,130,246,0.18), transparent 65%),
                  radial-gradient(550px 160px at 85% 0%, rgba(236,72,153,0.14), transparent 60%);
      pointer-events: none;
    }
    .card > * { position: relative; }

    .card-header { display: flex; justify-content: space-between; align-items: flex-start; gap: 10px; margin-bottom: 10px; flex-wrap: wrap; }
    .card-title { font-weight: 750; font-size: 14px; letter-spacing: 0.2px; }
    .card-subtitle { font-size: 12px; color: rgba(255,255,255,0.65); margin-top: 3px; line-height: 1.25; }

    .kpis { display: grid; grid-template-columns: repeat(3, minmax(0, 1fr)); gap: 10px; margin-top: 6px; }
    .kpi { background: rgba(0,0,0,0.22); border: 1px solid rgba(255,255,255,0.08); border-radius: 14px; padding: 10px 10px 9px; }
    .kpi .label { font-size: 11px; color: rgba(255,255,255,0.65); }
    .kpi .value { font-size: 20px; font-weight: 800; margin-top: 2px; letter-spacing: 0.2px; }
    .kpi .sub { font-size: 11px; color: rgba(255,255,255,0.65); margin-top: 2px; line-height: 1.25; }

    .metric-row { display: grid; grid-template-columns: repeat(2, minmax(0, 1fr)); gap: 10px; }
    .metric { background: rgba(0,0,0,0.22); border: 1px solid rgba(255,255,255,0.08); border-radius: 14px; padding: 10px; }
    .metric-label { font-size: 11px; color: rgba(255,255,255,0.65); }
    .metric-value { font-size: 18px; font-weight: 800; margin-top: 2px; }
    .metric-sub { font-size: 11px; color: rgba(255,255,255,0.62); margin-top: 2px; line-height: 1.25; }

    .list { display: grid; gap: 8px; margin-top: 10px; }
    .list-item { background: rgba(0,0,0,0.22); border: 1px solid rgba(255,255,255,0.08); border-radius: 14px; padding: 10px; }
    .list-title { font-weight: 700; font-size: 12px; color: rgba(255,255,255,0.92); display: flex; justify-content: space-between; gap: 10px; align-items: baseline; }
    .badge {
      font-size: 11px;
      color: rgba(255,255,255,0.70);
      background: rgba(255,255,255,0.06);
      border: 1px solid rgba(255,255,255,0.08);
      padding: 4px 8px;
      border-radius: 999px;
      white-space: nowrap;
    }
    .list-notes { font-size: 12px; color: rgba(255,255,255,0.75); margin-top: 6px; white-space: pre-wrap; line-height: 1.25; }
    .empty-text { padding: 8px 2px; font-size: 12px; color: rgba(255,255,255,0.65); }

    .modal {
      display: none;
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.65);
      z-index: 50;
      padding: 16px;
    }
    .modal.open { display: grid; place-items: center; }

    .modal-card {
      width: min(1100px, 96vw);
      background: rgba(255,255,255,0.05);
      border: 1px solid rgba(255,255,255,0.10);
      border-radius: 18px;
      overflow: hidden;
      box-shadow: 0 20px 60px rgba(0,0,0,0.45);
    }

    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 10px 12px;
      border-bottom: 1px solid rgba(255,255,255,0.10);
      background: rgba(0,0,0,0.20);
      gap: 10px;
    }

    .modal-header .mh-title {
      font-weight: 800;
      font-size: 13px;
      color: rgba(255,255,255,0.92);
      display: flex;
      align-items: center;
      gap: 10px;
      flex-wrap: wrap;
    }

    .close {
      border: 1px solid rgba(255,255,255,0.12);
      background: rgba(0,0,0,0.25);
      color: rgba(255,255,255,0.85);
      border-radius: 12px;
      padding: 8px 10px;
      cursor: pointer;
      font-weight: 800;
    }

    .modal-body { padding: 12px; display: grid; gap: 12px; }
  </style>
</head>

<body>
  <div class="page">
    <div class="topbar">
      <div class="brand">
        <div class="logo">OL</div>
        <div class="titleblock">
          <div class="title">Monthly Dashboard</div>
          <div class="subtitle">Month view. Filter by site.</div>
        </div>
      </div>

      <div class="filters">
        <button class="btn btn-secondary" id="prevMonthBtn">◀</button>
        <div class="pill" id="monthLabel">Month</div>
        <button class="btn btn-secondary" id="nextMonthBtn">▶</button>
        <button class="btn" id="latestMonthBtn">Latest</button>

        <div class="filter">
          <label for="siteFilter">Site</label>
          <select id="siteFilter">
            <option value="All">All Sites</option>
            <option value="London">London</option>
            <option value="Newcastle">Newcastle</option>
          </select>
        </div>

        <button class="btn" id="generateMonthlySummaryBtn">Generate Summary</button>
      </div>
    </div>

    <div id="errorMessage" class="error"></div>

    <div class="grid">
      <div class="row-1">
        <div class="card" style="grid-column: 1 / span 3; padding: 0;">
          <div style="padding: 14px 14px 0;">
            <div class="card-header" style="margin-bottom: 8px;">
              <div>
                <div class="card-title">Overview</div>
                <div class="card-subtitle">Totals for the selected month & filter.</div>
              </div>
              <div class="pill" id="monthPill">Month</div>
            </div>

            <div class="kpis">
              <div class="kpi">
                <div class="label">Total Logs</div>
                <div class="value" id="kpiTotalLogs">0</div>
                <div class="sub">All entries captured</div>
              </div>
              <div class="kpi">
                <div class="label">Staffing Impact</div>
                <div class="value" id="kpiStaffingSum">0</div>
                <div class="sub" id="kpiStaffingSub">Sick • Holiday • Agency</div>
              </div>
              <div class="kpi">
                <div class="label">Retail Sales</div>
                <div class="value" id="kpiRetailSales">£0.00</div>
                <div class="sub" id="kpiRetailSub">Transactions • SPH</div>
              </div>
            </div>
          </div>

          <div style="padding: 0 14px 14px;">
            <div id="monthlySummaryBox" style="display:none; margin-top:12px;" class="list-item">
              <div class="list-title">Monthly Summary</div>
              <div id="monthlySummaryText" class="list-notes" style="margin-top:8px;"></div>
            </div>
          </div>
        </div>
      </div>

      <div class="row-3">
        <div class="card">
          <div class="card-header">
            <div>
              <div class="card-title">Staffing Summary</div>
              <div class="card-subtitle">Totals for the month.</div>
            </div>
          </div>
          <div class="metric-row" style="grid-template-columns: repeat(3, 1fr);">
            <div class="metric"><div class="metric-label">Sickness</div><div class="metric-value" id="staffSick">0</div></div>
            <div class="metric"><div class="metric-label">Holiday</div><div class="metric-value" id="staffHol">0</div></div>
            <div class="metric"><div class="metric-label">Agency</div><div class="metric-value" id="staffAg">0</div></div>
          </div>
        </div>

        <div class="card">
          <div class="card-header">
            <div>
              <div class="card-title">Maintenance Incidents</div>
              <div class="card-subtitle">Only items with incidents show.</div>
            </div>
          </div>
          <div id="maintEmpty" class="empty-text">No maintenance incidents.</div>
          <div id="maintList" class="list"></div>
        </div>

        <div class="card">
          <div class="card-header">
            <div>
              <div class="card-title">H&amp;S Incidents</div>
              <div class="card-subtitle">Only items with incidents show.</div>
            </div>
          </div>
          <div id="hsEmpty" class="empty-text">No H&amp;S incidents.</div>
          <div id="hsList" class="list"></div>
        </div>
      </div>

      <div class="row-2">
        <div class="card">
          <div class="card-header">
            <div>
              <div class="card-title">Retail Sales (Monthly)</div>
              <div class="card-subtitle">Totals by level for the month.</div>
            </div>
          </div>
          <div class="metric-row" style="grid-template-columns: 1fr;">
            <div class="metric">
              <div class="metric-label">Total</div>
              <div class="metric-value" id="retailTotal">£0.00</div>
              <div class="metric-sub" id="retailSub">0 tx • SPH £0.00</div>
              <div class="metric-sub" id="retailBreakdown" style="margin-top:6px;">L7 £0 • L5 £0 • L4 £0 • L3 £0</div>
            </div>
          </div>
          <div id="retailLevelsList" class="list"></div>
        </div>

        <div class="card">
          <div class="card-header">
            <div>
              <div class="card-title">Notes</div>
              <div class="card-subtitle">All notes recorded for the month.</div>
            </div>
          </div>
          <div id="notesEmpty" class="empty-text">No notes recorded.</div>
          <div id="notesList" class="list"></div>
        </div>
      </div>
    </div>

    <!-- Summary modal (kept for compatibility) -->
    <div class="modal" id="summaryModal">
      <div class="modal-card">
        <div class="modal-header">
          <div class="mh-title">Monthly Summary</div>
          <button id="closeSummaryBtn" class="btn btn-secondary" style="padding:6px 14px; font-size:12px;">Close</button>
        </div>
        <div class="modal-body">
          <div class="list-item" style="margin:0;">
            <div class="list-title">Summary</div>
            <div id="summaryModalText" class="list-notes" style="margin-top:8px;"></div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script type="module">
    import { supabase } from './supabase-config.js';

    const monthLabelEl = document.getElementById('monthLabel');
    const monthPillEl = document.getElementById('monthPill');
    const errorMessageEl = document.getElementById('errorMessage');
    const siteFilterEl = document.getElementById('siteFilter');
    const prevMonthBtn = document.getElementById('prevMonthBtn');
    const nextMonthBtn = document.getElementById('nextMonthBtn');
    const latestMonthBtn = document.getElementById('latestMonthBtn');

    const kpiTotalLogsEl = document.getElementById('kpiTotalLogs');
    const kpiStaffingSumEl = document.getElementById('kpiStaffingSum');
    const kpiStaffingSubEl = document.getElementById('kpiStaffingSub');
    const kpiRetailSalesEl = document.getElementById('kpiRetailSales');
    const kpiRetailSubEl = document.getElementById('kpiRetailSub');

    const staffSickEl = document.getElementById('staffSick');
    const staffHolEl = document.getElementById('staffHol');
    const staffAgEl = document.getElementById('staffAg');

    const maintEmptyEl = document.getElementById('maintEmpty');
    const maintListEl = document.getElementById('maintList');
    const hsEmptyEl = document.getElementById('hsEmpty');
    const hsListEl = document.getElementById('hsList');

    const retailTotalEl = document.getElementById('retailTotal');
    const retailSubEl = document.getElementById('retailSub');
    const retailBreakdownEl = document.getElementById('retailBreakdown');
    const retailLevelsListEl = document.getElementById('retailLevelsList');

    const notesEmptyEl = document.getElementById('notesEmpty');
    const notesListEl = document.getElementById('notesList');

    const generateMonthlySummaryBtn = document.getElementById('generateMonthlySummaryBtn');
    const monthlySummaryBox = document.getElementById('monthlySummaryBox');
    const monthlySummaryText = document.getElementById('monthlySummaryText');

    const summaryModal = document.getElementById('summaryModal');
    const summaryModalText = document.getElementById('summaryModalText');
    const closeSummaryBtn = document.getElementById('closeSummaryBtn');

    let currentMonthOffset = 0;
    let currentSiteFilter = 'All';

    function safeNum(v) {
      const n = Number(v);
      return Number.isFinite(n) ? n : 0;
    }
    function safeText(v) { return (v ?? '').toString().trim(); }
    function hasMeaningfulText(v) { return safeText(v).length > 0; }
    function money(n) { return `£${Number(n || 0).toFixed(2)}`; }
    function calcSPH(sales, tx) { const s = safeNum(sales); const t = safeNum(tx); return t > 0 ? (s / t) : 0; }

    function toISODate(d) {
      const yyyy = d.getFullYear();
      const mm = String(d.getMonth() + 1).padStart(2, '0');
      const dd = String(d.getDate()).padStart(2, '0');
      return `${yyyy}-${mm}-${dd}`;
    }

    function startOfMonth(d) {
      const x = new Date(d);
      x.setDate(1);
      x.setHours(0,0,0,0);
      return x;
    }

    function endOfMonth(d) {
      const x = new Date(d);
      x.setMonth(x.getMonth() + 1);
      x.setDate(0);
      x.setHours(0,0,0,0);
      return x;
    }

    function monthLabelFromDate(d) {
      const fmt = new Intl.DateTimeFormat('en-GB', { month: 'long', year: 'numeric' });
      return fmt.format(d);
    }

    function applySiteFilter(rows) {
      if (currentSiteFilter === 'All') return rows;
      return (rows || []).filter(r => (r.site || '') === currentSiteFilter);
    }

    function isIncidentFlagTrue(v) {
      const t = safeText(v).toLowerCase();
      return t === 'yes' || t === 'true' || t === '1';
    }

    function renderList(containerEl, emptyEl, items) {
      containerEl.innerHTML = '';
      if (!items || items.length === 0) {
        emptyEl.style.display = 'block';
        return;
      }
      emptyEl.style.display = 'none';
      items.forEach(it => {
        const div = document.createElement('div');
        div.className = 'list-item';
        div.innerHTML = `
          <div class="list-title">
            <span>${it.title}</span>
            ${it.badge ? `<span class="badge">${it.badge}</span>` : ``}
          </div>
          <div class="list-notes">${(it.notes || '').replace(/</g, '&lt;')}</div>
        `;
        containerEl.appendChild(div);
      });
    }

    async function ensureLatestMonthAnchor() {
      // Keep it simple: latest month is "this month" unless you later add a month table
      return true;
    }

    async function loadMonthlyRetailSales(startStr, endStr) {
      const { data, error } = await supabase
        .from('retail_sales')
        .select('*')
        .gte('sales_date', startStr)
        .lte('sales_date', endStr);

      if (error) {
        console.error('Retail sales monthly error:', error);
        return {
          allSales: 0, allTrans: 0,
          L7: { sales: 0, trans: 0 },
          L5: { sales: 0, trans: 0 },
          L4: { sales: 0, trans: 0 },
          L3: { sales: 0, trans: 0 },
        };
      }

      const totals = {
        allSales: 0, allTrans: 0,
        L7: { sales: 0, trans: 0 },
        L5: { sales: 0, trans: 0 },
        L4: { sales: 0, trans: 0 },
        L3: { sales: 0, trans: 0 },
      };

      (data || []).forEach(r => {
        const lvl = (r.level || '').toString();
        const sales = safeNum(r.sales);
        const tx = safeNum(r.transactions);

        totals.allSales += sales;
        totals.allTrans += tx;

        if (lvl === 'Level 7') { totals.L7.sales += sales; totals.L7.trans += tx; }
        if (lvl === 'Level 5') { totals.L5.sales += sales; totals.L5.trans += tx; }
        if (lvl === 'Level 4') { totals.L4.sales += sales; totals.L4.trans += tx; }
        if (lvl === 'Level 3') { totals.L3.sales += sales; totals.L3.trans += tx; }
      });

      return totals;
    }

    function renderRetailSales(totals) {
      const sph = calcSPH(totals.allSales, totals.allTrans);
      retailTotalEl.textContent = money(totals.allSales);
      retailSubEl.textContent = `${Math.round(totals.allTrans)} tx • SPH ${money(sph)}`;
      retailBreakdownEl.textContent = `L7 ${money(totals.L7.sales)} • L5 ${money(totals.L5.sales)} • L4 ${money(totals.L4.sales)} • L3 ${money(totals.L3.sales)}`;

      kpiRetailSalesEl.textContent = money(totals.allSales);
      kpiRetailSubEl.textContent = `${Math.round(totals.allTrans)} tx • SPH ${money(sph)}`;

      retailLevelsListEl.innerHTML = '';
      const levels = [
        { name: 'Level 7', s: totals.L7.sales, t: totals.L7.trans },
        { name: 'Level 5', s: totals.L5.sales, t: totals.L5.trans },
        { name: 'Level 4', s: totals.L4.sales, t: totals.L4.trans },
        { name: 'Level 3', s: totals.L3.sales, t: totals.L3.trans },
      ];

      levels.forEach(l => {
        const div = document.createElement('div');
        div.className = 'list-item';
        div.innerHTML = `
          <div class="list-title">
            <span>${l.name}</span>
            <span class="badge">SPH ${money(calcSPH(l.s, l.t))}</span>
          </div>
          <div class="list-notes">Sales: ${money(l.s)} • Transactions: ${Math.round(l.t)}</div>
        `;
        retailLevelsListEl.appendChild(div);
      });
    }

    function setEmptyLists() {
      maintListEl.innerHTML = '';
      hsListEl.innerHTML = '';
      notesListEl.innerHTML = '';
      maintEmptyEl.style.display = 'block';
      hsEmptyEl.style.display = 'block';
      notesEmptyEl.style.display = 'block';
    }

    async function loadMonthlyData() {
      errorMessageEl.style.display = 'none';
      errorMessageEl.textContent = '';

      try {
        await ensureLatestMonthAnchor();
      } catch (e) {
        console.error(e);
        errorMessageEl.textContent = 'There was an error loading the monthly dashboard.';
        errorMessageEl.style.display = 'block';
        return;
      }

      nextMonthBtn.disabled = currentMonthOffset === 0;

      const anchor = new Date();
      const target = new Date(anchor);
      target.setMonth(target.getMonth() + currentMonthOffset);

      const monthStart = startOfMonth(target);
      const monthEnd = endOfMonth(target);

      const startStr = toISODate(monthStart);
      const endStr = toISODate(monthEnd);

      const monthLabel = monthLabelFromDate(target);

      monthLabelEl.textContent = monthLabel;
      monthPillEl.textContent = `${startStr} → ${endStr}`;

      // OPS LOGS (FIXED: include created_at fallback when log_date is null)
      const { data: opsRowsRaw, error: opsErr } = await supabase
        .from('ops_logs')
        .select('*')
        // Include both:
        // 1) rows that have log_date within the month, and
        // 2) legacy rows where log_date is NULL (use created_at as fallback)
        .or(
          `and(log_date.gte.${startStr},log_date.lte.${endStr}),and(log_date.is.null,created_at.gte.${startStr}T00:00:00Z,created_at.lte.${endStr}T23:59:59Z)`
        )
        .order('log_date', { ascending: true })
        .order('created_at', { ascending: true });

      if (opsErr) {
        console.error('Ops monthly error:', opsErr);
        errorMessageEl.textContent = 'There was an error loading the monthly dashboard.';
        errorMessageEl.style.display = 'block';
        return;
      }

      const opsRows = applySiteFilter(opsRowsRaw || []);

      // KPI: total logs
      kpiTotalLogsEl.textContent = String(opsRows.length);

      // Staffing totals
      const sick = opsRows.reduce((s, r) => s + safeNum(r.sickness_count), 0);
      const hol  = opsRows.reduce((s, r) => s + safeNum(r.holiday_count), 0);
      const ag   = opsRows.reduce((s, r) => s + safeNum(r.agency_count), 0);

      staffSickEl.textContent = String(sick);
      staffHolEl.textContent  = String(hol);
      staffAgEl.textContent   = String(ag);

      kpiStaffingSumEl.textContent = String(sick + hol + ag);
      kpiStaffingSubEl.textContent = `Sick: ${sick} • Holiday: ${hol} • Agency: ${ag}`;

      // Retail sales
      const retailTotals = await loadMonthlyRetailSales(startStr, endStr);
      renderRetailSales(retailTotals);

      setEmptyLists();

      // Incidents
      const maintItems = [];
      const hsItems = [];

      opsRows.forEach(r => {
        const date = r.log_date || (r.created_at ? String(r.created_at).slice(0,10) : '');
        const titleBase = `${r.site || 'Site'} • ${r.area || 'Area'} • ${date}`;

        if (isIncidentFlagTrue(r.maintenance_issue) || hasMeaningfulText(r.maintenance_notes)) {
          maintItems.push({
            title: titleBase,
            badge: '',
            notes: safeText(r.maintenance_notes) || '(No notes entered)'
          });
        }

        if (isIncidentFlagTrue(r.hs_issue) || hasMeaningfulText(r.hs_notes)) {
          hsItems.push({
            title: titleBase,
            badge: '',
            notes: safeText(r.hs_notes) || '(No notes entered)'
          });
        }
      });

      renderList(maintListEl, maintEmptyEl, maintItems);
      renderList(hsListEl, hsEmptyEl, hsItems);

      // Notes
      const notes = opsRows
        .filter(r => hasMeaningfulText(r.notes))
        .map(r => {
          const date = r.log_date || (r.created_at ? String(r.created_at).slice(0,10) : '');
          return {
            title: `${r.site || 'Site'} • ${r.area || 'Area'} • ${date}`,
            badge: '',
            notes: safeText(r.notes)
          };
        });

      renderList(notesListEl, notesEmptyEl, notes);

      // Hide summary box on refresh
      monthlySummaryBox.style.display = 'none';
      monthlySummaryText.textContent = '';
    }

    function buildMonthlySummaryText() {
      const lines = [];
      lines.push(`Monthly Ops Summary`);
      lines.push(`—————————————`);
      lines.push(`Month: ${monthLabelEl.textContent}`);
      lines.push(`Filter: ${siteFilterEl.options[siteFilterEl.selectedIndex].text}`);
      lines.push('');
      lines.push(`Logs: ${kpiTotalLogsEl.textContent}`);
      lines.push('');
      lines.push(`Staffing Impact`);
      lines.push(`• Sickness: ${staffSickEl.textContent}`);
      lines.push(`• Holiday: ${staffHolEl.textContent}`);
      lines.push(`• Agency: ${staffAgEl.textContent}`);
      lines.push('');
      lines.push(`Retail Sales`);
      lines.push(`• Total: ${retailTotalEl.textContent}`);
      lines.push(`• ${retailSubEl.textContent}`);
      return lines.join('\n');
    }

    generateMonthlySummaryBtn.addEventListener('click', () => {
      const text = buildMonthlySummaryText();
      monthlySummaryText.textContent = text;
      monthlySummaryBox.style.display = 'block';

      summaryModalText.textContent = text;
      summaryModal.classList.add('open');
    });

    closeSummaryBtn.addEventListener('click', () => summaryModal.classList.remove('open'));
    summaryModal.addEventListener('click', (e) => {
      if (e.target === summaryModal) summaryModal.classList.remove('open');
    });

    prevMonthBtn.addEventListener('click', () => { currentMonthOffset -= 1; loadMonthlyData(); });
    nextMonthBtn.addEventListener('click', () => { if (currentMonthOffset < 0) { currentMonthOffset += 1; loadMonthlyData(); } });
    latestMonthBtn.addEventListener('click', () => { currentMonthOffset = 0; loadMonthlyData(); });

    siteFilterEl.addEventListener('change', (e) => {
      currentSiteFilter = e.target.value;
      loadMonthlyData();
    });

    loadMonthlyData();
  </script>
</body>
</html>
